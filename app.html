<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sessionably - Practice Management</title>
    <meta name="description" content="HIPAA-compliant clinical documentation platform with modern UI and advanced features">

    <!-- Favicons -->
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="192x192" href="/android-chrome-192x192.png">
    <link rel="icon" type="image/png" sizes="512x512" href="/android-chrome-512x512.png">
    <link rel="manifest" href="/site.webmanifest">
    <meta name="theme-color" content="#1A1A2E">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="dns-prefetch" href="https://js.stripe.com">
    <link rel="preload" href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Plus+Jakarta+Sans:wght@400;500;600;700;800&family=Kalam:wght@300;400;700&display=swap" as="style" onload="this.onload=null;this.rel='stylesheet'">
    <noscript><link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Plus+Jakarta+Sans:wght@400;500;600;700;800&family=Kalam:wght@300;400;700&display=swap" rel="stylesheet"></noscript>
    <script src="https://js.stripe.com/v3/" defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>
        // Configure PDF.js worker
        if (typeof pdfjsLib !== 'undefined') {
            pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
        }
    </script>
    <style>
        
        :root {
            /* Sessionably Brand Color Palette */
            --primary-color: #00B4A6;           /* Primary Teal */
            --primary-hover: #009688;           /* Dark Teal */
            --primary-light: #26C6BA;           /* Light Teal */
            --primary-subtle: #E0F7F5;          /* Very light teal background */
            --secondary-color: #888888;         /* Grey for secondary elements */
            --accent-color: #F4A443;            /* Accent Amber */
            --success-color: #10B981;           /* Green for success states */
            --warning-color: #F59E0B;           /* Amber/orange for warnings */
            --danger-color: #EF4444;            /* Red for errors/danger */

            /* Text Colors */
            --text-primary: #1A1A2E;            /* Navy for main text */
            --text-secondary: #888888;          /* Medium grey for secondary text */
            --text-tertiary: #9EA4AA;           /* Light grey for tertiary text */
            --text-muted: #CBD5E0;              /* Very light grey for muted text */

            /* Background Colors */
            --background-gradient: linear-gradient(135deg, #FAFAFA 0%, #F5F5F5 100%);
            --surface-color: #FFFFFF;           /* Main surface/card background */
            --surface-elevated: #FFFFFF;        /* Elevated surfaces */
            --surface-hover: #F8F9FA;           /* Hover state background */

            /* Border Colors */
            --border-color: #E8EAED;            /* Subtle borders */
            --border-color-hover: #D1D5DB;      /* Border on hover */
            --border-color-focus: #00B4A6;      /* Border on focus */

            /* Shadows - SimplePractice-style layered shadows */
            --shadow-xs: 0 1px 2px 0 rgba(0, 0, 0, 0.03);
            --shadow-sm: 0 1px 3px 0 rgba(0, 0, 0, 0.05), 0 1px 2px -1px rgba(0, 0, 0, 0.05);
            --shadow: 0 2px 4px -1px rgba(0, 0, 0, 0.06), 0 4px 6px -1px rgba(0, 0, 0, 0.10);
            --shadow-md: 0 4px 8px -2px rgba(0, 0, 0, 0.08), 0 6px 12px -2px rgba(0, 0, 0, 0.12);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.10), 0 4px 6px -4px rgba(0, 0, 0, 0.10);
            --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.10), 0 8px 10px -6px rgba(0, 0, 0, 0.10);
            --shadow-2xl: 0 25px 50px -12px rgba(0, 0, 0, 0.25);

            /* Legacy shadow names for backward compatibility */
            --shadow-light: var(--shadow-sm);
            --shadow-medium: var(--shadow);
            --shadow-heavy: var(--shadow-lg);

            /* Spacing Scale */
            --spacing-xs: 4px;
            --spacing-sm: 8px;
            --spacing-md: 16px;
            --spacing-lg: 24px;
            --spacing-xl: 32px;
            --spacing-2xl: 48px;

            /* Border Radius */
            --border-radius-sm: 6px;
            --border-radius: 8px;
            --border-radius-md: 10px;
            --border-radius-lg: 12px;
            --border-radius-xl: 16px;
            --border-radius-full: 9999px;

            /* Transitions */
            --transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            --transition-fast: all 0.15s cubic-bezier(0.4, 0, 0.2, 1);
            --transition-slow: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        * { 
            margin: 0; 
            padding: 0; 
            box-sizing: border-box; 
        }

        *:focus {
            outline: 2px solid var(--primary-color);
            outline-offset: 2px;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: var(--background-gradient);
            min-height: 100vh;
            line-height: 1.6;
            color: var(--text-primary);
            scroll-behavior: smooth;
        }

        h1, h2, h3, h4, h5, h6 {
            font-family: 'Plus Jakarta Sans', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            font-weight: 700;
            letter-spacing: -0.02em;
        }

        /* Reduced motion support */
        @media (prefers-reduced-motion: reduce) {
            *, *::before, *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }
        .auth-container {
            max-width: 450px; 
            margin: 100px auto; 
            background: var(--surface-color); 
            padding: 48px 40px; 
            border-radius: var(--border-radius); 
            box-shadow: var(--shadow-heavy);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            animation: slideUp 0.6s ease-out;
        }

        @keyframes slideUp {
            from { 
                opacity: 0; 
                transform: translateY(30px); 
            }
            to { 
                opacity: 1; 
                transform: translateY(0); 
            }
        }

        .auth-container h2 { 
            margin-bottom: 16px; 
            color: var(--primary-color); 
            text-align: center; 
            font-size: 28px;
            font-weight: 600;
        }

        .auth-container .subtitle {
            text-align: center;
            color: var(--text-secondary);
            margin-bottom: 32px;
            font-size: 14px;
        }

        .auth-tabs { 
            display: flex; 
            gap: 8px; 
            margin-bottom: 32px; 
            background: #f8f9fa;
            padding: 4px;
            border-radius: 8px;
        }

        .auth-tab {
            flex: 1; 
            padding: 12px 16px; 
            border: none; 
            border-radius: 6px;
            background: transparent; 
            cursor: pointer; 
            text-align: center; 
            transition: var(--transition);
            font-weight: 500;
            font-size: 14px;
            color: var(--text-secondary);
        }

        .auth-tab.active { 
            background: var(--surface-color); 
            color: var(--primary-color); 
            box-shadow: var(--shadow-light);
        }

        .auth-tab:focus {
            outline: 2px solid var(--primary-color);
            outline-offset: 2px;
        }

        .auth-form { display: none; }
        .auth-form.active { display: block; }
        .app-container { 
            display: none; 
            min-height: 100vh; 
            background: var(--background-gradient);
            color: var(--text-primary);
        }
        .client-portal { display: none; min-height: 100vh; background: var(--surface-color); }
        
        .header {
            background: var(--surface-color); 
            padding: 24px 40px; 
            box-shadow: var(--shadow-light);
            display: flex; 
            justify-content: space-between; 
            align-items: center;
            backdrop-filter: blur(10px);
            border-bottom: 1px solid var(--border-color);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header h1 {
            color: var(--primary-color);
            font-size: 28px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .header .logo {
            height: 40px;
            width: auto;
        }

        .logo-container {
            display: flex;
            align-items: center;
            gap: 16px;
            text-decoration: none;
        }

        .logo-icon {
            height: 50px;
            width: auto;
        }

        .logo-text-container {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .logo-wordmark {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            font-size: 24px;
            font-weight: 600;
            letter-spacing: 3px;
            text-transform: uppercase;
            color: var(--text-primary);
            line-height: 1;
        }

        .logo-tagline {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            font-size: 9px;
            font-weight: 400;
            letter-spacing: 1.5px;
            text-transform: uppercase;
            color: var(--text-secondary);
            line-height: 1;
        }

        .auth-container .logo-container {
            justify-content: center;
            margin-bottom: 24px;
        }

        .auth-container .logo-icon {
            height: 40px;
        }

        .auth-container .logo-wordmark {
            font-size: 20px;
        }

        .auth-container .logo-tagline {
            font-size: 8px;
        }

        .header h1 .logo-container {
            gap: 12px;
        }

        .header h1 .logo-icon {
            height: 35px;
        }

        .header h1 .logo-wordmark {
            font-size: 20px;
            letter-spacing: 2px;
        }

        .header h1 .logo-tagline {
            font-size: 7px;
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .notification-bell {
            position: relative;
            cursor: pointer;
            padding: 8px;
            border-radius: 8px;
            transition: var(--transition);
            background: transparent;
            border: none;
            font-size: 20px;
        }

        .notification-bell:hover {
            background: var(--surface-hover);
        }

        .subscription-status {
            background: linear-gradient(135deg, #f59e0b, #d97706);
            color: white;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            box-shadow: 0 2px 8px rgba(245, 158, 11, 0.3);
            animation: pulse 2s infinite;
        }

        .subscription-status.trial-ending {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            animation: pulse 1s infinite;
        }

        .subscription-status.active {
            background: linear-gradient(135deg, #10b981, #059669);
            animation: none;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .subscription-status-card {
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: 20px;
            margin-bottom: 20px;
        }

        .subscription-status-card.trial {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            border-color: #f59e0b;
        }

        .subscription-status-card.active {
            background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
            border-color: #10b981;
        }

        .subscription-status-card.expired {
            background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
            border-color: #ef4444;
        }

        .subscription-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }

        .subscription-info-item {
            text-align: center;
        }

        .subscription-info-label {
            font-size: 12px;
            color: var(--text-secondary);
            margin-bottom: 5px;
        }

        .subscription-info-value {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .subscription-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .billing-history-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .billing-history-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            border-bottom: 1px solid var(--border-color);
        }

        .billing-history-item:last-child {
            border-bottom: none;
        }

        .billing-history-date {
            font-weight: 600;
            color: var(--text-primary);
        }

        .billing-history-amount {
            font-weight: 600;
            color: var(--primary-color);
        }

        .billing-history-status {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        /* Sidebar Navigation */
        .sidebar {
            position: fixed;
            left: 0;
            top: 77px; /* Below header */
            width: 260px;
            height: calc(100vh - 77px);
            background: var(--surface-color);
            border-right: 1px solid var(--border-color);
            box-shadow: var(--shadow-sm);
            overflow-y: auto;
            z-index: 50;
            transition: var(--transition);
        }

        .sidebar-nav {
            padding: 16px 0;
        }

        .tab-btn {
            width: 100%;
            padding: 14px 24px;
            border: none;
            background: transparent;
            color: var(--text-secondary);
            cursor: pointer;
            font-weight: 500;
            font-size: 14px;
            transition: var(--transition);
            white-space: nowrap;
            display: flex;
            align-items: center;
            gap: 12px;
            text-align: left;
            border-left: 3px solid transparent;
        }

        .tab-btn:hover {
            color: var(--primary-color);
            background: rgba(67, 97, 238, 0.05);
        }

        .tab-btn.active {
            color: var(--primary-color);
            border-left-color: var(--primary-color);
            background: rgba(67, 97, 238, 0.08);
            font-weight: 600;
        }

        .tab-btn:focus {
            outline: 2px solid var(--primary-color);
            outline-offset: -2px;
        }

        /* Main content area with sidebar */
        .app-content-wrapper {
            margin-left: 260px;
            transition: var(--transition);
        }

        /* Enhanced Content Area */
        .content {
            padding: 40px;
            max-width: 1400px;
            margin: 0 auto;
        }

        .content-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 32px;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--border-color);
        }

        .content-header h2 {
            font-size: 28px;
            font-weight: 700;
            color: var(--text-primary);
            margin: 0;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Enhanced Card Styling */
        .card {
            background: var(--surface-color);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-light);
            border: 1px solid var(--border-color);
            transition: var(--transition);
            overflow: hidden;
        }

        .card:hover {
            box-shadow: var(--shadow-medium);
            transform: translateY(-2px);
        }

        .card-header {
            padding: 20px 24px;
            border-bottom: 1px solid var(--border-color);
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
        }

        .card-header h3 {
            margin: 0;
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .card-content {
            padding: 24px;
        }

        /* Analytics Grid */
        .analytics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 24px;
            margin-bottom: 32px;
        }

        .stat-card {
            background: var(--surface-color);
            border-radius: var(--border-radius);
            padding: 24px;
            box-shadow: var(--shadow-light);
            border: 1px solid var(--border-color);
            transition: var(--transition);
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--primary-color), var(--accent-color));
        }

        .stat-card:hover {
            box-shadow: var(--shadow-medium);
            transform: translateY(-4px);
        }

        .stat-card h3 {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-secondary);
            margin: 0 0 12px 0;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .stat-number {
            font-size: 32px;
            font-weight: 700;
            color: var(--primary-color);
            margin: 0;
        }

        /* Charts Container */
        .charts-container {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 24px;
        }

        .chart-card {
            background: var(--surface-color);
            border-radius: var(--border-radius);
            padding: 24px;
            box-shadow: var(--shadow-light);
            border: 1px solid var(--border-color);
        }

        .chart-card h3 {
            margin: 0 0 20px 0;
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
        }

        /* Grid Layout - Single Column for Clients */
        .grid {
            display: flex;
            flex-direction: column;
            gap: 12px;
            max-width: 900px;
        }

        /* Search Input */
        .search-input {
            width: 100%;
            padding: 16px 20px;
            border: 2px solid var(--border-color);
            border-radius: var(--border-radius);
            font-size: 16px;
            margin-bottom: 24px;
            background: var(--surface-color);
            color: var(--text-primary);
            transition: var(--transition);
        }

        .search-input:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
            outline: none;
        }

        .search-input::placeholder {
            color: var(--text-secondary);
        }

        /* Notification Badge */
        .notification-badge {
            background: var(--primary-color);
            color: white;
            border-radius: 12px;
            padding: 2px 8px;
            font-size: 11px;
            font-weight: 600;
            margin-left: 8px;
        }

        /* Calendar Controls */
        .calendar-controls {
            display: flex;
            align-items: center;
            gap: 16px;
            margin-bottom: 24px;
            padding: 20px;
            background: var(--surface-color);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-light);
            border: 1px solid var(--border-color);
        }

        .calendar-controls h3 {
            margin: 0;
            font-size: 20px;
            font-weight: 600;
            color: var(--text-primary);
            flex: 1;
            text-align: center;
        }

        .calendar-view-toggle {
            display: flex;
            gap: 4px;
            background: #f8f9fa;
            padding: 4px;
            border-radius: 8px;
        }

        .calendar-view-toggle .btn {
            padding: 8px 16px;
            font-size: 12px;
            border-radius: 6px;
        }

        .calendar-view-toggle .btn.active {
            background: var(--primary-color);
            color: white;
        }

        /* Enhanced Modal Styling */
        .modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
            animation: fadeIn 0.3s ease-out;
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal-content {
            background: var(--surface-color);
            padding: 32px;
            border-radius: var(--border-radius);
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--shadow-heavy);
            border: 1px solid var(--border-color);
            animation: slideUp 0.3s ease-out;
        }

        .modal-header {
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--border-color);
        }

        .modal-header h2 {
            font-size: 24px;
            font-weight: 700;
            color: var(--text-primary);
            margin: 0;
        }

        .modal-actions {
            display: flex;
            gap: 12px;
            margin-top: 24px;
            justify-content: flex-end;
        }

        .close-btn {
            position: absolute;
            top: 16px;
            right: 16px;
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--text-secondary);
            transition: var(--transition);
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
        }

        .close-btn:hover {
            color: var(--text-primary);
            background: var(--border-color);
        }

        /* Enhanced Form Styling */
        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--text-primary);
            font-size: 14px;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 14px 16px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            font-size: 14px;
            font-family: inherit;
            transition: var(--transition);
            background: var(--surface-color);
            color: var(--text-primary);
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
            outline: none;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 120px;
        }

        /* Enhanced List Styling */
        .list-item {
            background: var(--surface-color);
            border-radius: var(--border-radius);
            padding: 20px;
            margin-bottom: 16px;
            box-shadow: var(--shadow-light);
            border: 1px solid var(--border-color);
            transition: var(--transition);
            cursor: pointer;
        }

        .list-item:hover {
            box-shadow: var(--shadow-medium);
            transform: translateY(-2px);
        }

        .list-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .list-item-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
            margin: 0;
        }

        .list-item-meta {
            font-size: 12px;
            color: var(--text-secondary);
            margin: 0;
        }

        .list-item-content {
            color: var(--text-secondary);
            line-height: 1.5;
        }

        /* Status Badges */
        .status-badge {
            padding: 4px 12px;
            border-radius: 16px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .status-badge.pending {
            background: #fef3c7;
            color: #92400e;
        }

        .status-badge.completed {
            background: #d1fae5;
            color: #065f46;
        }

        .status-badge.cancelled {
            background: #fee2e2;
            color: #991b1b;
        }

        .status-badge.scheduled {
            background: #dbeafe;
            color: #1e40af;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .content {
                padding: 20px;
            }

            .tabs {
                padding: 0 20px;
            }

            .tab-btn {
                padding: 12px 16px;
                font-size: 13px;
            }

            .analytics-grid {
                grid-template-columns: 1fr;
            }

            .charts-container {
                grid-template-columns: 1fr;
            }

            .grid {
                grid-template-columns: 1fr;
            }

            .modal-content {
                padding: 24px;
                margin: 20px;
            }

            .content-header {
                flex-direction: column;
                gap: 16px;
                align-items: flex-start;
            }

            .calendar-controls {
                flex-direction: column;
                gap: 12px;
            }
        }

        .billing-history-status.paid {
            background: #d1fae5;
            color: #065f46;
        }

        /* Enhanced User Menu Styling */
        .user-menu {
            position: relative;
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 8px 16px;
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: var(--transition);
            background: rgba(37, 99, 235, 0.05);
            border: 1px solid rgba(37, 99, 235, 0.1);
        }

        .user-menu:hover {
            background: rgba(37, 99, 235, 0.1);
            border-color: rgba(37, 99, 235, 0.2);
        }

        .user-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: var(--primary-color);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 14px;
        }

        .user-menu-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            background: var(--surface-color);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-heavy);
            border: 1px solid var(--border-color);
            min-width: 240px;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: var(--transition);
        }

        .user-menu-dropdown.active {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .user-menu-header {
            padding: 16px 20px;
            border-bottom: 1px solid var(--border-color);
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
        }

        .user-menu-header-name {
            font-weight: 600;
            color: var(--text-primary);
            font-size: 14px;
        }

        .user-menu-header-email {
            font-size: 12px;
            color: var(--text-secondary);
            margin-top: 2px;
        }

        .user-menu-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 20px;
            cursor: pointer;
            transition: var(--transition);
            border-bottom: 1px solid var(--border-color);
        }

        .user-menu-item:last-child {
            border-bottom: none;
        }

        .user-menu-item:hover {
            background: rgba(37, 99, 235, 0.05);
        }

        .user-menu-item-icon {
            width: 16px;
            height: 16px;
            color: var(--text-secondary);
        }

        .user-menu-item-text {
            flex: 1;
            font-size: 14px;
            color: var(--text-primary);
        }

        .user-menu-item-arrow {
            color: var(--text-secondary);
            font-size: 12px;
        }

        /* Handwritten Style Elements */
        .handwritten-note {
            font-family: 'Kalam', 'Comic Sans MS', cursive;
            font-weight: 400;
            font-size: 16px;
            color: var(--text-primary);
            transform: rotate(-1deg);
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.1);
            background: transparent;
            border: none;
            padding: 8px 16px;
            margin: 8px 0;
        }

        /* Enhanced Loading States */
        .loading-spinner {
            width: 20px;
            height: 20px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top: 2px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Enhanced Error Messages */
        .error-message {
            background: #fee2e2;
            color: #991b1b;
            padding: 12px 16px;
            border-radius: 8px;
            border: 1px solid #fecaca;
            font-size: 14px;
            margin: 12px 0;
        }

        .success-message {
            background: #d1fae5;
            color: #065f46;
            padding: 12px 16px;
            border-radius: 8px;
            border: 1px solid #a7f3d0;
            font-size: 14px;
            margin: 12px 0;
        }

        /* Enhanced Calendar Styling */
        .calendar-container {
            background: var(--surface-color);
            border-radius: var(--border-radius);
            padding: 24px;
            box-shadow: var(--shadow-light);
            border: 1px solid var(--border-color);
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 1px;
            background: var(--border-color);
            border-radius: 8px;
            overflow: hidden;
        }

        .calendar-day {
            background: var(--surface-color);
            padding: 12px 8px;
            text-align: center;
            font-size: 14px;
            font-weight: 500;
            color: var(--text-primary);
            min-height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .calendar-day.other-month {
            color: var(--text-secondary);
            background: #f8f9fa;
        }

        .calendar-day.today {
            background: var(--primary-color);
            color: white;
            font-weight: 600;
        }

        .calendar-day.has-appointment {
            background: rgba(37, 99, 235, 0.1);
            border: 2px solid var(--primary-color);
        }

        /* Enhanced Appointments List */
        .appointments-list {
            margin-top: 24px;
        }

        .appointment-item {
            background: var(--surface-color);
            border-radius: var(--border-radius);
            padding: 20px;
            margin-bottom: 16px;
            box-shadow: var(--shadow-light);
            border: 1px solid var(--border-color);
            transition: var(--transition);
            cursor: pointer;
        }

        .appointment-item:hover {
            box-shadow: var(--shadow-medium);
            transform: translateY(-2px);
        }

        .appointment-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .appointment-time {
            font-size: 18px;
            font-weight: 600;
            color: var(--primary-color);
        }

        .appointment-client {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .appointment-details {
            color: var(--text-secondary);
            font-size: 14px;
        }

        /* Loading State Styling */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(5px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .loading-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .loading-content {
            text-align: center;
            background: var(--surface-color);
            padding: 40px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-heavy);
            border: 1px solid var(--border-color);
        }

        .loading-spinner-large {
            width: 40px;
            height: 40px;
            border: 4px solid var(--border-color);
            border-top: 4px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        .loading-text {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
            margin: 0;
        }

        .billing-history-status.pending {
            background: #fef3c7;
            color: #92400e;
        }

        .billing-history-status.failed {
            background: #fee2e2;
            color: #991b1b;
        }

        .user-menu {
            position: relative;
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
            transition: var(--transition);
        }

        .user-menu:hover {
            background: #f8f9fa;
        }

        .user-avatar {
            width: 32px;
            height: 32px;
            background: var(--primary-color);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
        }

        .user-menu-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            margin-top: 8px;
            background: var(--surface-color);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-medium);
            min-width: 220px;
            z-index: 1000;
            display: none;
            overflow: hidden;
            border: 1px solid var(--border-color);
        }

        .user-menu-dropdown.active {
            display: block;
            animation: slideDown 0.2s ease-out;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .user-menu-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            cursor: pointer;
            transition: var(--transition);
            color: var(--text-primary);
            border-bottom: 1px solid var(--border-color);
        }

        .user-menu-item:last-child {
            border-bottom: none;
        }

        .user-menu-item:hover {
            background: #f8f9fa;
        }

        .user-menu-item-icon {
            width: 20px;
            height: 20px;
            color: var(--text-secondary);
        }

        .user-menu-item-text {
            flex: 1;
            font-size: 14px;
        }

        .user-menu-item-arrow {
            color: var(--text-secondary);
            font-size: 12px;
        }

        .user-menu-header {
            padding: 16px;
            border-bottom: 1px solid var(--border-color);
            background: #f8f9fa;
        }

        .user-menu-header-name {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 4px;
        }

        .user-menu-header-email {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .tabs { 
            background: var(--surface-color); 
            display: flex; 
            padding: 0 40px; 
            box-shadow: 0 2px 8px rgba(0,0,0,0.05); 
            border-bottom: 1px solid var(--border-color);
            overflow-x: auto;
        }

        .tab-btn {
            padding: 16px 24px; 
            border: none; 
            background: none; 
            cursor: pointer;
            font-size: 14px; 
            font-weight: 500; 
            color: var(--text-secondary); 
            border-bottom: 3px solid transparent;
            transition: var(--transition);
            white-space: nowrap;
            position: relative;
        }

        .tab-btn:hover {
            color: var(--primary-color);
            background: rgba(15, 76, 129, 0.05);
        }

        .tab-btn.active {
            color: var(--primary-color);
            border-bottom-color: var(--primary-color);
            background: rgba(15, 76, 129, 0.08);
        }

        .tab-btn:focus {
            outline: 2px solid var(--primary-color);
            outline-offset: -2px;
        }
        .content { 
            padding: 40px; 
            max-width: 1400px; 
            margin: 0 auto; 
            animation: fadeIn 0.4s ease-out;
        }

        .tab-content { 
            display: none; 
            animation: slideIn 0.4s ease-out; 
        }

        @keyframes fadeIn { 
            from { opacity: 0; transform: translateY(20px); } 
            to { opacity: 1; transform: translateY(0); } 
        }

        @keyframes slideIn {
            from { 
                opacity: 0; 
                transform: translateX(20px); 
            }
            to { 
                opacity: 1; 
                transform: translateX(0); 
            }
        }

        .content-header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 32px;
            flex-wrap: wrap;
            gap: 16px;
        }

        .content-header h2 { 
            color: white; 
            font-size: 32px; 
            font-weight: 700;
            text-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .btn {
            padding: 12px 24px; 
            border: none; 
            border-radius: 8px; 
            cursor: pointer;
            font-size: 14px; 
            font-weight: 600; 
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            text-decoration: none;
            position: relative;
            overflow: hidden;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }

        .btn:hover::before {
            left: 100%;
        }

        .btn:focus {
            outline: 2px solid var(--primary-color);
            outline-offset: 2px;
        }

        .btn-primary { 
            background: var(--primary-color); 
            color: white; 
            box-shadow: var(--shadow-light);
        }

        .btn-primary:hover { 
            background: var(--primary-hover); 
            transform: translateY(-2px);
            box-shadow: var(--shadow-medium);
        }

        .btn-secondary {
            background: transparent;
            color: var(--primary-color);
            border: 2px solid var(--primary-color);
        }

        .btn-secondary:hover {
            background: var(--primary-color);
            color: white;
        }

        .btn-icon {
            padding: 8px;
            border-radius: 50%;
            width: 40px;
            height: 40px;
        }

        .btn-sm {
            padding: 8px 16px;
            font-size: 12px;
        }

        .btn-large {
            padding: 16px 32px;
            font-size: 16px;
        }

        /* Toggle Switch Styles */
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 26px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #cbd5e1;
            transition: 0.3s;
            border-radius: 26px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: 0.3s;
            border-radius: 50%;
        }

        .toggle-switch input:checked + .toggle-slider {
            background-color: #10b981;
        }

        .toggle-switch input:checked + .toggle-slider:before {
            transform: translateX(24px);
        }

        .toggle-switch input:disabled + .toggle-slider {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .input {
            width: 100%; 
            padding: 14px 16px; 
            border: 2px solid var(--border-color); 
            border-radius: 8px;
            font-size: 14px; 
            margin-bottom: 16px; 
            transition: var(--transition);
            background: var(--surface-color);
            color: var(--text-primary);
        }

        .input:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(15, 76, 129, 0.1);
        }

        .input::placeholder {
            color: var(--text-secondary);
        }

        .input-group {
            position: relative;
            margin-bottom: 20px;
        }

        .input-label {
            display: block;
            font-weight: 500;
            margin-bottom: 8px;
            color: var(--text-primary);
            font-size: 14px;
        }

        .input-error {
            border-color: #FF6B6B;
        }

        .error-message {
            color: #FF6B6B;
            font-size: 12px;
            margin-top: 4px;
        }

        .card { 
            background: var(--surface-color); 
            padding: 24px; 
            border-radius: var(--border-radius); 
            box-shadow: var(--shadow-light); 
            margin-bottom: 24px;
            border: 1px solid var(--border-color);
            transition: var(--transition);
        }

        .card:hover {
            box-shadow: var(--shadow-medium);
            transform: translateY(-2px);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--border-color);
        }

        .card-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
        }

        /* Client card styling updated for single column */
        .client-card {
            background: var(--surface-color);
            padding: 16px 20px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-xs);
            cursor: pointer;
            transition: var(--transition);
            border: 1px solid var(--border-color);
            position: relative;
            overflow: hidden;
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .client-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: var(--primary-color);
            opacity: 0;
            transition: var(--transition);
        }

        .client-card:hover {
            box-shadow: var(--shadow-sm);
            background: var(--surface-hover);
        }

        .client-card:hover::before {
            opacity: 1;
        }

        .client-card-header {
            flex: 1;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .client-name {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 4px;
        }

        .client-info {
            font-size: 14px;
            color: var(--text-secondary);
            line-height: 1.4;
        }
        .modal { 
            display: none; 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            background: rgba(0, 0, 0, 0.6); 
            z-index: 1000; 
            overflow-y: auto;
            backdrop-filter: blur(4px);
            animation: fadeIn 0.3s ease-out;
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal-content { 
            background: var(--surface-color); 
            margin: 0; 
            padding: 32px; 
            border-radius: var(--border-radius); 
            max-width: 600px; 
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--shadow-heavy);
            border: 1px solid var(--border-color);
            animation: slideUp 0.3s ease-out;
            position: relative;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--border-color);
        }

        .modal-title {
            font-size: 20px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .close { 
            background: none;
            border: none;
            font-size: 24px; 
            cursor: pointer; 
            color: var(--text-secondary);
            padding: 8px;
            border-radius: 50%;
            transition: var(--transition);
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .close:hover {
            color: var(--primary-color);
            background: rgba(15, 76, 129, 0.1);
        }

        .close:focus {
            outline: 2px solid var(--primary-color);
            outline-offset: 2px;
        }

        .notification-badge { 
            background: #FF6B6B; 
            color: white; 
            border-radius: 50%; 
            padding: 4px 8px; 
            font-size: 12px; 
            font-weight: 600;
            margin-left: 8px; 
            min-width: 20px;
            text-align: center;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--surface-color);
            padding: 16px 20px;
            border-radius: 8px;
            box-shadow: var(--shadow-medium);
            border-left: 4px solid var(--primary-color);
            z-index: 1001;
            animation: slideInRight 0.3s ease-out;
            max-width: 400px;
        }

        .notification.success {
            border-left-color: #27ae60;
        }

        .notification.error {
            border-left-color: #e74c3c;
        }

        .notification.warning {
            border-left-color: #f39c12;
        }

        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(100%);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        /* Loading States */
        .loading {
            opacity: 0.6;
            pointer-events: none;
        }

        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid var(--border-color);
            border-radius: 50%;
            border-top-color: var(--primary-color);
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Mobile menu toggle button */
        .mobile-menu-toggle {
            display: none;
            background: transparent;
            border: none;
            font-size: 24px;
            cursor: pointer;
            padding: 8px;
            color: var(--text-primary);
        }

        /* Mobile Responsiveness */
        @media (max-width: 768px) {
            .mobile-menu-toggle {
                display: block;
            }

            .sidebar {
                transform: translateX(-100%);
                box-shadow: none;
            }

            .sidebar.active {
                transform: translateX(0);
                box-shadow: var(--shadow-xl);
                z-index: 150;
            }

            .app-content-wrapper {
                margin-left: 0;
            }

            .header {
                padding: 16px 20px;
            }

            .header h1 {
                font-size: 20px;
            }

            .content {
                padding: 20px;
            }

            .content-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 16px;
            }

            .content-header h2 {
                font-size: 24px;
            }

            .grid {
                gap: 12px;
            }

            .auth-container {
                margin: 20px;
                padding: 32px 24px;
                max-width: none;
            }

            .modal-content {
                margin: 20px;
                padding: 24px;
                max-height: calc(100vh - 40px);
            }

            .btn {
                padding: 14px 20px;
                font-size: 16px;
            }

            .client-card {
                padding: 14px 16px;
                flex-direction: row;
            }

            .notification {
                right: 10px;
                left: 10px;
                max-width: none;
            }
        }

        @media (max-width: 480px) {
            .header {
                padding: 12px 16px;
            }

            .content {
                padding: 16px;
            }

            .auth-container {
                margin: 16px;
                padding: 24px 20px;
            }

            .modal-content {
                margin: 16px;
                padding: 20px;
            }

            .grid {
                gap: 12px;
            }

            .client-card {
                padding: 16px;
            }
        }

        /* Dark mode support */
        [data-theme="dark"] {
            --primary-color: #00D4C4;
            --primary-hover: #00B4A6;
            --secondary-color: #e9ecef;
            --success-color: #4ade80;
            --warning-color: #fbbf24;
            --danger-color: #f87171;
            --info-color: #60a5fa;
            --text-primary: #f8f9fa;
            --text-secondary: #adb5bd;
            --text-muted: #6c757d;
            --background-color: #1a1a2e;
            --surface-color: #16213e;
            --surface-elevated: #0f3460;
            --border-color: #2d3748;
            --shadow: 0 2px 8px rgba(0, 0, 0, 0.5);
            --background-gradient: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
        }

        [data-theme="dark"] body {
            background: var(--background-color);
            color: var(--text-primary);
        }

        [data-theme="dark"] .card {
            background: var(--surface-color);
            color: var(--text-primary);
        }

        [data-theme="dark"] .stat-card {
            background: var(--surface-elevated);
            color: var(--text-primary);
        }

        [data-theme="dark"] .input,
        [data-theme="dark"] .textarea,
        [data-theme="dark"] select {
            background: var(--surface-elevated);
            color: var(--text-primary);
            border-color: var(--border-color);
        }

        [data-theme="dark"] .modal-content {
            background: var(--surface-color);
            color: var(--text-primary);
        }

        [data-theme="dark"] .table th {
            background: var(--surface-elevated);
            color: var(--text-primary);
        }

        [data-theme="dark"] .table td {
            border-color: var(--border-color);
        }

        [data-theme="dark"] .tab-btn {
            color: var(--text-secondary);
        }

        [data-theme="dark"] .tab-btn.active {
            color: var(--primary-color);
            border-bottom-color: var(--primary-color);
        }

        [data-theme="dark"] .header {
            background: var(--surface-color);
            border-bottom-color: var(--border-color);
        }

        @media (prefers-color-scheme: dark) {
            :root:not([data-theme="light"]) {
                --primary-color: #00D4C4;
                --primary-hover: #00B4A6;
                --secondary-color: #e9ecef;
                --success-color: #4ade80;
                --warning-color: #fbbf24;
                --danger-color: #f87171;
                --info-color: #60a5fa;
                --text-primary: #f8f9fa;
                --text-secondary: #adb5bd;
                --text-muted: #6c757d;
                --background-color: #1a1a2e;
                --surface-color: #16213e;
                --surface-elevated: #0f3460;
                --border-color: #2d3748;
                --shadow: 0 2px 8px rgba(0, 0, 0, 0.5);
                --background-gradient: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            }
        }

        /* High contrast mode */
        @media (prefers-contrast: high) {
            :root {
                --border-color: #000000;
                --text-secondary: #000000;
            }

            .btn {
                border: 2px solid var(--text-primary);
            }

            .card {
                border: 2px solid var(--border-color);
            }
        }

        /* Print styles */
        @media print {
            .header,
            .tabs,
            .btn,
            .modal {
                display: none !important;
            }

            .content {
                padding: 0;
            }

            .card {
                box-shadow: none;
                border: 1px solid #ccc;
                break-inside: avoid;
            }
        }
        .client-portal-content { max-width: 800px; margin: 0 auto; padding: 40px 20px; }
        .document-header {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-light) 100%);
            padding: 30px; border-radius: var(--border-radius); margin-bottom: 30px; text-align: center; border: 1px solid var(--border-color); box-shadow: var(--shadow-medium);
        }
        .document-header h1 { color: white; margin-bottom: 10px; }
        .form-section { background: white; padding: 30px; border-radius: var(--border-radius); box-shadow: var(--shadow-light); margin-bottom: 20px; border: 1px solid var(--border-color); }
        .form-field { margin-bottom: 20px; }
        .form-field label { display: block; font-weight: 500; margin-bottom: 8px; color: var(--primary-color); }
        .form-field input, .form-field textarea, .form-field select {
            width: 100%; padding: 12px; border: 2px solid var(--border-color); border-radius: 8px; font-size: 14px; transition: var(--transition);
        }
        .form-field input:focus, .form-field textarea:focus, .form-field select:focus {
            border-color: var(--primary-color); outline: none;
        }
        .form-field textarea { min-height: 100px; resize: vertical; }
        .signature-pad {
            border: 2px dashed var(--primary-color); border-radius: var(--border-radius); padding: 20px; text-align: center; margin: 20px 0; background: var(--background-gradient);
        }
        .signature-input {
            width: 100%; padding: 15px; border: 2px solid var(--primary-color); border-radius: 8px;
            font-family: 'Brush Script MT', cursive; font-size: 24px; text-align: center;
        }
        .submit-section { background: var(--background-gradient); padding: 30px; border-radius: var(--border-radius); text-align: center; margin-top: 30px; border: 1px solid var(--border-color); }
        .search-input {
            flex: 1; padding: 12px; border: 2px solid white; border-radius: 6px; font-size: 14px; background: white; margin-bottom: 20px;
        }
        .doc-nav { display: flex; gap: 10px; margin-bottom: 20px; overflow-x: auto; padding: 10px 0; }
        .doc-nav-item {
            padding: 10px 20px; background: white; border: 2px solid var(--primary-color); border-radius: var(--border-radius);
            cursor: pointer; white-space: nowrap; transition: var(--transition);
        }
        .doc-nav-item.active { background: var(--primary-color); color: white; box-shadow: var(--shadow-medium); }
        .doc-nav-item.completed { background: #10b981; border-color: #10b981; color: white; }
        
        /* New Features Styles */
        .analytics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .stat-card {
            background: white;
            padding: 25px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-light);
            text-align: center;
            transition: var(--transition);
            border: 1px solid var(--border-color);
        }
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-medium);
        }
        .stat-card h3 {
            color: var(--primary-color);
            margin-bottom: 15px;
            font-size: 16px;
            font-weight: 600;
        }
        .stat-number {
            font-size: 32px;
            font-weight: bold;
            color: #2c3e50;
        }
        .charts-container {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
        }
        .chart-card {
            background: white;
            padding: 25px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-light);
            border: 1px solid var(--border-color);
        }
        .chart-card h3 {
            color: var(--primary-color);
            margin-bottom: 20px;
            font-weight: 600;
        }
        .calendar-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .calendar-view-toggle {
            display: flex;
            gap: 5px;
        }
        .calendar-view-toggle .btn-sm {
            padding: 8px 12px;
            font-size: 14px;
            border-radius: 6px;
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            color: #6c757d;
            transition: all 0.3s ease;
        }
        .calendar-view-toggle .btn-sm.active,
        .calendar-view-toggle .btn-sm:hover {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }
        .calendar-container {
            background: white;
            border-radius: var(--border-radius);
            padding: 20px;
            box-shadow: var(--shadow-light);
            margin-bottom: 20px;
            border: 1px solid var(--border-color);
        }
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 1px;
            background: #ddd;
            border-radius: 8px;
            overflow: hidden;
        }
        .calendar-day {
            background: white;
            padding: 15px 10px;
            min-height: 80px;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
            color: #000000;
        }
        .calendar-day:hover {
            background: rgba(15, 76, 129, 0.05);
        }
        .calendar-day.other-month {
            color: #ccc;
        }
        .calendar-day.today {
            background: var(--background-gradient);
            font-weight: bold;
            border: 2px solid var(--primary-color);
        }
        .calendar-day.has-appointment {
            background: rgba(16, 185, 129, 0.1);
            border-left: 4px solid #10b981;
        }
        .appointment-dot {
            width: 8px;
            height: 8px;
            background: var(--primary-color);
            border-radius: 50%;
            margin: 2px auto;
        }
        
        .appointment-widgets {
            position: absolute;
            top: 25px;
            left: 2px;
            right: 2px;
            bottom: 2px;
            display: flex;
            flex-direction: column;
            gap: 2px;
            overflow: hidden;
        }
        
        .appointment-widget {
            background: #ffffff;
            border-left: 3px solid #2196f3;
            border-top: 1px solid #e9ecef;
            border-right: 1px solid #e9ecef;
            border-bottom: 1px solid #e9ecef;
            border-radius: 4px;
            padding: 3px 5px;
            font-size: 10px;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 1px 2px rgba(0,0,0,0.08);
            margin-bottom: 2px;
            overflow: hidden;
            max-height: 28px;
        }

        .appointment-widget.telehealth {
            border-left-color: #9c27b0;
            background: #fafafa;
        }

        .appointment-widget.in-person {
            border-left-color: #2196f3;
        }
        
        .appointment-widget.expanded {
            max-height: 120px;
            padding: 4px 6px;
            z-index: 10;
            position: relative;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        
        .appointment-widget:hover {
            background: #f8f9fa;
            border-color: var(--primary-color);
            transform: scale(1.02);
        }
        
        .widget-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 4px;
        }

        .widget-main-info {
            display: flex;
            flex-direction: column;
            gap: 1px;
            flex: 1;
            min-width: 0;
        }

        .widget-client-name {
            color: #333;
            font-weight: 500;
            font-size: 10px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            line-height: 1.2;
        }

        .widget-modality-indicator {
            display: flex;
            align-items: center;
            flex-shrink: 0;
        }

        .modality-icon {
            font-size: 11px;
            line-height: 1;
            opacity: 0.8;
        }

        .telehealth-icon {
            filter: grayscale(0%);
        }

        .in-person-icon {
            filter: grayscale(0%);
        }
        
        .widget-expanded {
            margin-top: 4px;
            border-top: 1px solid #e9ecef;
            padding-top: 4px;
        }
        
        .expanded-info {
            font-size: 9px;
            color: #000000;
            line-height: 1.2;
        }
        
        .client-name {
            font-weight: bold;
            margin-bottom: 2px;
        }
        
        .appointment-type {
            color: #666;
            margin-bottom: 1px;
        }
        
        .appointment-duration {
            color: #666;
            margin-bottom: 1px;
        }

        .appointment-modality {
            color: #666;
            margin-bottom: 1px;
            font-style: italic;
        }
        
        .appointment-notes {
            color: #888;
            font-style: italic;
            margin-top: 2px;
            max-height: 20px;
            overflow: hidden;
        }
        
        .widget-actions {
            display: flex;
            gap: 2px;
            margin-top: 4px;
        }
        
        .btn-widget-edit, .btn-widget-delete {
            padding: 1px 4px;
            font-size: 8px;
            border: none;
            border-radius: 2px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .btn-widget-edit {
            background: #e3f2fd;
            color: #1976d2;
        }
        
        .btn-widget-edit:hover {
            background: #bbdefb;
        }
        
        .btn-widget-delete {
            background: #ffebee;
            color: #d32f2f;
        }
        
        .btn-widget-delete:hover {
            background: #ffcdd2;
        }
        
        .widget-time {
            color: #666;
            font-weight: 600;
            font-size: 9px;
            line-height: 1.2;
        }
        
        .widget-initials {
            display: flex;
            gap: 2px;
            margin-top: 1px;
        }
        
        .client-initial, .clinician-initial {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 8px;
            font-weight: bold;
            color: #000000;
        }
        
        .client-initial {
            background: #e3f2fd;
            border: 1px solid #2196f3;
        }
        
        .clinician-initial {
            background: #f3e5f5;
            border: 1px solid #9c27b0;
        }
        
        /* Appointment Detail Panel */
        .appointment-detail-panel {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.9);
            width: 90%;
            max-width: 700px;
            max-height: 85vh;
            background: var(--surface-color);
            box-shadow: 0 10px 50px rgba(0, 0, 0, 0.3);
            z-index: 1000;
            transition: all 0.3s ease-in-out;
            overflow-y: auto;
            border-radius: 12px;
            opacity: 0;
            visibility: hidden;
        }

        .appointment-detail-panel.active {
            transform: translate(-50%, -50%) scale(1);
            opacity: 1;
            visibility: visible;
        }

        /* Add overlay backdrop */
        .appointment-detail-panel::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: -1;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
        }

        .appointment-detail-panel.active::before {
            opacity: 1;
        }
        
        .appointment-detail-header {
            background: var(--primary-color);
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-radius: 12px 12px 0 0;
        }
        
        .appointment-detail-header h2 {
            margin: 0;
            font-size: 20px;
            font-weight: 600;
        }
        
        .appointment-detail-close {
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            transition: background 0.2s;
        }
        
        .appointment-detail-close:hover {
            background: rgba(255, 255, 255, 0.2);
        }
        
        .appointment-detail-content {
            padding: 20px;
            background: #FFFFFF;
        }
        
        .detail-section {
            margin-bottom: 24px;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .detail-section:last-child {
            border-bottom: none;
        }
        
        .detail-section h3 {
            margin: 0 0 12px 0;
            font-size: 14px;
            font-weight: 600;
            color: var(--primary-color);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .detail-row {
            display: flex;
            margin-bottom: 12px;
            align-items: flex-start;
        }
        
        .detail-label {
            font-weight: 600;
            color: var(--text-secondary);
            min-width: 100px;
            font-size: 13px;
        }
        
        .detail-value {
            flex: 1;
            color: var(--text-primary);
            font-size: 14px;
        }
        
        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            text-transform: capitalize;
        }
        
        .status-badge.scheduled {
            background: #e3f2fd;
            color: #1976d2;
        }
        
        .status-badge.confirmed {
            background: #e8f5e9;
            color: #388e3c;
        }
        
        .status-badge.completed {
            background: #f3e5f5;
            color: #7b1fa2;
        }
        
        .status-badge.cancelled {
            background: #ffebee;
            color: #d32f2f;
        }
        
        .detail-notes {
            background: #f8f9fa;
            padding: 12px;
            border-radius: 8px;
            border-left: 3px solid var(--primary-color);
            font-size: 14px;
            line-height: 1.6;
            color: var(--text-primary);
            white-space: pre-wrap;
        }
        
        .appointment-detail-actions {
            padding: 20px;
            background: #f8f9fa;
            border-top: 1px solid var(--border-color);
            display: flex;
            gap: 12px;
        }
        
        .appointment-detail-actions button {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .btn-detail-edit {
            background: var(--primary-color);
            color: white;
        }
        
        .btn-detail-edit:hover {
            background: var(--primary-hover);
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0, 168, 107, 0.2);
        }
        
        .btn-detail-delete {
            background: #dc3545;
            color: white;
        }
        
        .btn-detail-delete:hover {
            background: #c82333;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(220, 53, 69, 0.2);
        }
        
        /* Clinical Notes Styling */
        .clinical-notes-container {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .clinical-notes-textarea {
            width: 100%;
            min-height: 150px;
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 14px;
            font-family: inherit;
            line-height: 1.6;
            resize: vertical;
            transition: border-color 0.2s;
        }
        
        .clinical-notes-textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(0, 168, 107, 0.1);
        }
        
        .clinical-notes-actions {
            display: flex;
            gap: 8px;
        }
        
        .btn-ai-note, .btn-save-note {
            flex: 1;
            padding: 10px 16px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .btn-ai-note {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .btn-ai-note:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }
        
        .recording-panel {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #e9ecef;
        }
        
        .recording-status {
            font-weight: 600;
            margin-bottom: 10px;
            color: var(--text-primary);
        }
        
        .recording-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }
        
        .recording-timer {
            font-size: 24px;
            font-weight: 700;
            color: #dc3545;
            text-align: center;
            margin: 15px 0;
            font-family: 'Courier New', monospace;
        }

        /* AI NoteTaker Appointment Integration */
        .btn-floating-record {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 12px 24px;
            background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
            color: white;
            border: none;
            border-radius: 50px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(220, 38, 38, 0.3);
        }

        .btn-floating-record:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(220, 38, 38, 0.4);
            background: linear-gradient(135deg, #b91c1c 0%, #991b1b 100%);
        }

        .btn-floating-record:active {
            transform: translateY(0);
        }

        .btn-floating-record .record-icon {
            font-size: 18px;
            animation: pulse-record 2s infinite;
        }

        @keyframes pulse-record {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }

        .ai-notetaker-appointment-controls {
            display: flex;
            justify-content: center;
            padding: 15px 0;
            border-top: 1px solid var(--border-color);
        }

        .recording-timer.recording {
            animation: pulse 1.5s ease-in-out infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .live-transcript {
            background: white;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #e9ecef;
            margin-top: 15px;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .live-transcript h4 {
            margin: 0 0 10px 0;
            font-size: 14px;
            color: var(--text-secondary);
        }
        
        .transcript-text {
            font-size: 13px;
            line-height: 1.6;
            color: var(--text-primary);
            white-space: pre-wrap;
        }
        
        .recording-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 15px;
        }
        
        .note-format-selector {
            margin-top: 15px;
        }
        
        .note-format-selector label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            font-size: 14px;
        }
        
        .settings-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid var(--border-color);
        }
        
        .settings-tab-btn {
            padding: 12px 24px;
            border: none;
            background: transparent;
            color: var(--text-secondary);
            font-weight: 600;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.2s;
        }
        
        .settings-tab-btn:hover {
            color: var(--primary-color);
        }
        
        .settings-tab-btn.active {
            color: var(--primary-color);
            border-bottom-color: var(--primary-color);
        }
        
        .settings-tab-content {
            margin-top: 20px;
        }
        
        .settings-description {
            color: var(--text-secondary);
            margin-bottom: 20px;
            font-size: 14px;
        }
        
        .settings-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        
        .settings-table th,
        .settings-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }
        
        .settings-table th {
            background: #f8f9fa;
            font-weight: 600;
            color: var(--text-primary);
        }
        
        .settings-table input[type="number"] {
            width: 120px;
            padding: 8px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
        }
        
        .btn-save-note {
            background: var(--primary-color);
            color: white;
        }
        
        .btn-save-note:hover {
            background: var(--primary-hover);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 168, 107, 0.3);
        }
        
        .btn-sign-note {
            flex: 1;
            padding: 10px 16px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%);
            color: white;
        }
        
        .btn-sign-note:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(255, 107, 107, 0.3);
        }
        
        /* Session History Styling */
        .session-item {
            background: white;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            margin-bottom: 12px;
            overflow: hidden;
            transition: box-shadow 0.2s;
        }
        
        .session-item:hover {
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        
        .session-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            padding: 16px;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .session-header:hover {
            background: #f8f9fa;
        }
        
        .session-info {
            flex: 1;
        }
        
        .session-info h4 {
            margin: 0 0 8px 0;
            color: var(--text-primary);
            font-size: 16px;
        }
        
        .session-type {
            color: var(--text-secondary);
            font-size: 14px;
            margin: 4px 0;
        }
        
        .session-summary {
            color: var(--text-secondary);
            font-size: 13px;
            margin: 8px 0 0 0;
            line-height: 1.5;
        }
        
        .session-status {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 8px;
        }
        
        .session-toggle {
            color: var(--primary-color);
            font-size: 18px;
            font-weight: bold;
        }
        
        .session-details {
            padding: 0 16px 16px 16px;
            background: #f8f9fa;
        }
        
        .session-detail-section {
            background: white;
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 12px;
        }
        
        .session-detail-section h5 {
            margin: 0 0 12px 0;
            color: var(--primary-color);
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .clinical-notes-display {
            background: #f8f9fa;
            padding: 12px;
            border-radius: 4px;
            border-left: 3px solid var(--primary-color);
        }
        
        .clinical-notes-display pre {
            white-space: pre-wrap;
            font-family: inherit;
            font-size: 13px;
            line-height: 1.6;
            margin: 0;
            color: var(--text-primary);
        }
        
        .signature-display {
            background: #e8f5e9;
            padding: 12px;
            border-radius: 4px;
            border-left: 3px solid #4caf50;
        }
        
        .signature-row {
            display: flex;
            margin-bottom: 8px;
        }
        
        .signature-row:last-child {
            margin-bottom: 0;
        }
        
        .signature-row .detail-label {
            font-weight: 600;
            color: #2e7d32;
            min-width: 80px;
        }
        
        .signature-row .detail-value {
            color: #1b5e20;
        }
        
        .calendar-header {
            background: #f8f9fa;
            padding: 10px;
            text-align: center;
            font-weight: bold;
            color: #666;
        }
        .day-number {
            font-weight: bold;
            margin-bottom: 5px;
            color: #000000;
        }
        .more-appointments {
            font-size: 12px;
            color: #666;
            text-align: center;
            margin-top: 2px;
        }
        
        /* Week View Styles */
        .week-calendar {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 15px rgba(0, 168, 107, 0.1);
        }
        .week-grid {
            display: grid;
            grid-template-columns: 80px repeat(7, 1fr);
            gap: 1px;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            overflow: hidden;
        }
        .time-column {
            background: #f8f9fa;
        }
        .time-header {
            padding: 15px 10px;
            font-weight: bold;
            text-align: center;
            background: var(--primary-color);
            color: white;
        }
        .time-slot {
            padding: 8px;
            text-align: center;
            font-size: 12px;
            border-bottom: 1px solid #e9ecef;
            min-height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: background 0.2s;
        }
        .time-slot:hover {
            background: #f8f9fa;
        }
        .day-column {
            background: white;
        }
        .day-header {
            padding: 15px 10px;
            text-align: center;
            font-weight: bold;
            background: var(--primary-color);
            color: white;
            border-bottom: 1px solid #e9ecef;
        }
        .time-slot.has-appointment {
            background: rgba(16, 185, 129, 0.1);
            cursor: pointer;
        }
        .appointment-block {
            background: var(--primary-color);
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            text-align: center;
        }
        
        /* Day View Styles */
        .day-view {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 15px rgba(0, 168, 107, 0.1);
        }
        .day-appointments {
            margin-bottom: 20px;
        }
        .day-appointment {
            display: flex;
            align-items: center;
            padding: 15px;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .day-appointment:hover {
            background: #f8f9fa;
            border-color: var(--primary-color);
        }
        .appointment-time {
            font-weight: bold;
            color: var(--primary-color);
            min-width: 80px;
            margin-right: 15px;
        }
        .appointment-details {
            flex: 1;
        }
        .client-name {
            font-weight: bold;
            margin-bottom: 5px;
        }
        .appointment-notes {
            color: #666;
            font-size: 14px;
        }
        .appointment-duration {
            color: #666;
            font-size: 14px;
        }
        .no-appointments {
            text-align: center;
            color: #666;
            padding: 40px;
            font-style: italic;
        }
        .day-actions {
            text-align: center;
            padding-top: 20px;
            border-top: 1px solid #e9ecef;
        }
        
        /* Drag and Drop Styles */
        .calendar-day[draggable="true"] {
            cursor: grab;
        }
        .calendar-day[draggable="true"]:active {
            cursor: grabbing;
        }
        .drag-over {
            background: rgba(15, 76, 129, 0.1) !important;
            border: 2px dashed var(--primary-color) !important;
        }
        
        /* Enhanced Analytics Styles */
        .analytics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .stat-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 15px rgba(0, 168, 107, 0.1);
            border: 1px solid #e9ecef;
        }
        .stat-card h3 {
            color: var(--primary-color);
            margin-bottom: 15px;
            font-size: 16px;
        }
        .stat-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding: 8px 0;
            border-bottom: 1px solid #f8f9fa;
        }
        .stat-label {
            color: #6c757d;
            font-size: 14px;
        }
        .stat-value {
            color: var(--primary-color);
            font-weight: bold;
            font-size: 14px;
        }
        .charts-section {
            margin-top: 30px;
        }
        .chart-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        .chart-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 15px rgba(0, 168, 107, 0.1);
            border: 1px solid #e9ecef;
        }
        .chart-card h3 {
            color: var(--primary-color);
            margin-bottom: 15px;
            font-size: 16px;
        }
        .chart-container {
            min-height: 200px;
            max-height: 300px;
            overflow-y: auto;
        }
        .export-section {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 15px rgba(0, 168, 107, 0.1);
            border: 1px solid #e9ecef;
            margin-top: 20px;
        }
        .export-section h3 {
            color: var(--primary-color);
            margin-bottom: 15px;
        }
        .appointments-list {
            background: white;
            border-radius: var(--border-radius);
            padding: 20px;
            box-shadow: var(--shadow-light);
            border: 1px solid var(--border-color);
        }
        .appointment-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            margin-bottom: 10px;
            transition: var(--transition);
        }
        .appointment-item:hover {
            background: rgba(15, 76, 129, 0.05);
            transform: translateX(5px);
        }
        .appointment-info h4 {
            color: var(--primary-color);
            margin-bottom: 5px;
        }
        .appointment-info p {
            color: #666;
            font-size: 14px;
        }
        .appointment-actions {
            display: flex;
            gap: 10px;
        }
        .btn-small {
            padding: 5px 10px;
            font-size: 12px;
        }
        
        /* Client Chart Styles */
        .client-chart-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 20px;
            padding-bottom: 20px;
            border-bottom: 2px solid #eee;
        }
        .chart-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #eee;
            overflow-x: auto;
        }
        .chart-tab-btn {
            padding: 12px 20px;
            background: transparent;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            color: #666;
            transition: all 0.3s;
            white-space: nowrap;
        }
        .chart-tab-btn:hover {
            color: var(--primary-color);
        }
        .chart-tab-btn.active {
            color: var(--primary-color);
            border-bottom-color: var(--primary-color);
        }
        .chart-tab-content {
            display: none;
        }
        .chart-tab-content.active {
            display: block;
        }
        .btn-success {
            background: #27ae60;
            color: white;
        }
        .btn-warning {
            background: #f39c12;
            color: white;
        }
        .btn-danger {
            background: #FF6B6B;
            color: white;
        }
        .invoices-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
        }
        .invoice-card {
            background: white;
            padding: 20px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-light);
            border: 1px solid var(--border-color);
            transition: var(--transition);
        }
        .invoice-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-medium);
        }
        .invoice-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        .invoice-number {
            font-weight: bold;
            color: var(--primary-color);
        }
        .invoice-status {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
        }
        .invoice-status.pending {
            background: #FFF3CD;
            color: #856404;
        }
        .invoice-status.paid {
            background: #D4EDDA;
            color: #155724;
        }
        .invoice-status.overdue {
            background: #F8D7DA;
            color: #721C24;
        }
        .invoice-amount {
            font-size: 24px;
            font-weight: bold;
            color: #2c3e50;
            margin: 10px 0;
        }
        .invoice-details {
            color: #666;
            font-size: 14px;
            margin-bottom: 15px;
        }
        .invoice-actions {
            display: flex;
            gap: 10px;
        }
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        /* Report Styles */
        .report-section {
            margin-bottom: 30px;
        }

        .report-section h4 {
            color: var(--primary-color);
            margin-bottom: 15px;
            font-size: 18px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .stat-card {
            background: var(--surface-color);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: 20px;
            text-align: center;
            box-shadow: var(--shadow-light);
            transition: var(--transition);
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-medium);
        }

        .stat-card h5 {
            color: var(--text-secondary);
            margin-bottom: 10px;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .stat-number {
            font-size: 28px;
            font-weight: 700;
            color: var(--primary-color);
            display: block;
        }

        .report-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            background: var(--surface-color);
            border-radius: var(--border-radius);
            overflow: hidden;
            box-shadow: var(--shadow-light);
        }

        .report-table th,
        .report-table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }

        .report-table th {
            background: var(--primary-color);
            color: white;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 12px;
            letter-spacing: 0.5px;
        }

        .report-table tr:hover {
            background: rgba(255, 224, 102, 0.05);
        }

        .status-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .status-badge.completed {
            background: #d4edda;
            color: #155724;
        }

        .status-badge.pending {
            background: #fff3cd;
            color: #856404;
        }

        .status-badge.active {
            background: #d1ecf1;
            color: #0c5460;
        }

        .status-badge.cancelled {
            background: #f8d7da;
            color: #721c24;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: var(--border-color);
            border-radius: 4px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-fill {
            height: 100%;
            background: var(--primary-color);
            transition: width 0.3s ease;
        }

        .status-breakdown {
            display: flex;
            gap: 20px;
            margin: 15px 0;
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .status-label {
            font-weight: 500;
            color: var(--text-secondary);
        }

        .status-count {
            font-weight: 600;
            color: var(--primary-color);
            font-size: 18px;
        }

        /* Notification Styles */
        .notification-settings {
            margin-top: 20px;
            padding: 20px;
            background: rgba(255, 224, 102, 0.05);
            border-radius: var(--border-radius);
        }

        .notification-settings h4 {
            color: var(--primary-color);
            margin-bottom: 15px;
        }

        .setting-item {
            margin-bottom: 12px;
        }

        .setting-item label {
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            font-weight: 500;
        }

        .setting-item input[type="checkbox"] {
            width: 18px;
            height: 18px;
            accent-color: var(--primary-color);
        }

        .notification-item {
            background: var(--surface-color);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: 15px;
            margin-bottom: 10px;
            box-shadow: var(--shadow-light);
            transition: var(--transition);
            position: relative;
        }

        .notification-item:hover {
            transform: translateY(-1px);
            box-shadow: var(--shadow-medium);
        }

        .notification-item.unread {
            border-left: 4px solid var(--primary-color);
            background: rgba(255, 224, 102, 0.05);
        }

        .notification-header {
            display: flex;
            justify-content: between;
            align-items: center;
            margin-bottom: 8px;
        }

        .notification-title {
            font-weight: 600;
            color: var(--text-primary);
            margin: 0;
        }

        .notification-time {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .notification-message {
            color: var(--text-secondary);
            margin: 0;
            line-height: 1.4;
        }

        .notification-actions {
            margin-top: 10px;
            display: flex;
            gap: 8px;
        }

        .notification-actions button {
            padding: 4px 8px;
            font-size: 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: var(--transition);
        }

        .notification-actions .mark-read {
            background: var(--primary-color);
            color: white;
        }

        .notification-actions .delete {
            background: #FF6B6B;
            color: white;
        }

        .notification-actions button:hover {
            opacity: 0.8;
        }

        .notification-badge {
            background: #FF6B6B;
            color: white;
            border-radius: 50%;
            padding: 2px 6px;
            font-size: 10px;
            font-weight: 600;
            margin-left: 5px;
        }
        .loading::after {
            content: '';
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #E85D4F;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-left: 10px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .services-container {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            background: #f8f9fa;
        }
        .service-item {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            align-items: center;
        }
        .invoice-total {
            text-align: center;
            padding: 20px;
            background: var(--background-gradient);
            border-radius: var(--border-radius);
            margin: 20px 0;
            border: 1px solid var(--border-color);
        }
        .invoice-total h3 {
            color: var(--primary-color);
            font-size: 28px;
        }
        .invoice-filters {
            margin-bottom: 20px;
        }

        /* ============================================
           SIMPLEPRACTICE-INSPIRED ENHANCED STYLES
           ============================================ */

        /* Enhanced Table Styles */
        table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            overflow: hidden;
            background: var(--surface-color);
            box-shadow: var(--shadow-xs);
        }

        table thead {
            background: linear-gradient(135deg, #F8FAFC 0%, #F1F5F9 100%);
            border-bottom: 2px solid var(--border-color);
        }

        table th {
            padding: 16px 20px;
            text-align: left;
            font-weight: 600;
            font-size: 13px;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 1px solid var(--border-color);
        }

        table td {
            padding: 16px 20px;
            border-bottom: 1px solid var(--border-color);
            color: var(--text-primary);
            font-size: 14px;
            vertical-align: middle;
        }

        table tbody tr {
            transition: var(--transition-fast);
            background: var(--surface-color);
        }

        table tbody tr:hover {
            background: var(--surface-hover);
        }

        table tbody tr:last-child td {
            border-bottom: none;
        }

        /* Enhanced Badge/Pill Styles */
        .badge {
            display: inline-flex;
            align-items: center;
            padding: 4px 12px;
            border-radius: var(--border-radius-full);
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            line-height: 1;
        }

        .badge.badge-primary {
            background: var(--primary-subtle);
            color: var(--primary-color);
        }

        .badge.badge-success {
            background: #D1FAE5;
            color: #065F46;
        }

        .badge.badge-warning {
            background: #FEF3C7;
            color: #92400E;
        }

        .badge.badge-danger {
            background: #FEE2E2;
            color: #991B1B;
        }

        .badge.badge-info {
            background: #DBEAFE;
            color: #1E40AF;
        }

        .badge.badge-secondary {
            background: #F3F4F6;
            color: var(--text-secondary);
        }

        /* Enhanced Alert/Toast Notifications */
        .alert {
            padding: 16px 20px;
            border-radius: var(--border-radius);
            border-left: 4px solid;
            margin-bottom: var(--spacing-md);
            display: flex;
            align-items: flex-start;
            gap: 12px;
            box-shadow: var(--shadow-sm);
            animation: slideInLeft 0.3s ease-out;
        }

        @keyframes slideInLeft {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .alert-icon {
            flex-shrink: 0;
            width: 20px;
            height: 20px;
        }

        .alert-content {
            flex: 1;
        }

        .alert-title {
            font-weight: 600;
            margin-bottom: 4px;
            font-size: 14px;
        }

        .alert-message {
            font-size: 13px;
            line-height: 1.5;
        }

        .alert-success {
            background: #D1FAE5;
            border-left-color: #10B981;
            color: #065F46;
        }

        .alert-warning {
            background: #FEF3C7;
            border-left-color: #F59E0B;
            color: #92400E;
        }

        .alert-error,
        .alert-danger {
            background: #FEE2E2;
            border-left-color: #EF4444;
            color: #991B1B;
        }

        .alert-info {
            background: #DBEAFE;
            border-left-color: #0EA5E9;
            color: #1E40AF;
        }

        /* Loading Skeleton Styles */
        .skeleton {
            background: linear-gradient(
                90deg,
                #F3F4F6 25%,
                #E5E7EB 50%,
                #F3F4F6 75%
            );
            background-size: 200% 100%;
            animation: skeleton-loading 1.5s ease-in-out infinite;
            border-radius: var(--border-radius-sm);
        }

        @keyframes skeleton-loading {
            0% {
                background-position: 200% 0;
            }
            100% {
                background-position: -200% 0;
            }
        }

        .skeleton-text {
            height: 14px;
            margin-bottom: 8px;
        }

        .skeleton-text:last-child {
            width: 70%;
        }

        .skeleton-title {
            height: 24px;
            margin-bottom: 12px;
        }

        .skeleton-card {
            height: 200px;
        }

        .skeleton-avatar {
            width: 40px;
            height: 40px;
            border-radius: var(--border-radius-full);
        }

        /* Enhanced Empty States */
        .empty-state {
            text-align: center;
            padding: 60px 40px;
            max-width: 480px;
            margin: 0 auto;
        }

        .empty-state-icon {
            width: 80px;
            height: 80px;
            margin: 0 auto 24px;
            background: var(--primary-subtle);
            border-radius: var(--border-radius-full);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--primary-color);
            font-size: 32px;
        }

        .empty-state-title {
            font-size: 20px;
            font-weight: 600;
            color: var(--text-primary);
            margin: 0 0 12px 0;
        }

        .empty-state-description {
            font-size: 14px;
            color: var(--text-secondary);
            line-height: 1.6;
            margin: 0 0 24px 0;
        }

        /* Professional Pagination */
        .pagination {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            margin-top: var(--spacing-lg);
        }

        .pagination-btn {
            padding: 8px 12px;
            border: 1px solid var(--border-color);
            background: var(--surface-color);
            border-radius: var(--border-radius);
            font-size: 14px;
            font-weight: 500;
            color: var(--text-primary);
            cursor: pointer;
            transition: var(--transition-fast);
            min-width: 40px;
            text-align: center;
        }

        .pagination-btn:hover:not(:disabled) {
            background: var(--surface-hover);
            border-color: var(--border-color-hover);
        }

        .pagination-btn.active {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        .pagination-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Enhanced Dropdown Menu */
        .dropdown {
            position: relative;
            display: inline-block;
        }

        .dropdown-toggle {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 10px 16px;
            background: var(--surface-color);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            font-size: 14px;
            font-weight: 500;
            color: var(--text-primary);
            cursor: pointer;
            transition: var(--transition-fast);
        }

        .dropdown-toggle:hover {
            background: var(--surface-hover);
            border-color: var(--border-color-hover);
        }

        .dropdown-menu {
            position: absolute;
            top: calc(100% + 8px);
            left: 0;
            background: var(--surface-color);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-lg);
            min-width: 200px;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: var(--transition-fast);
        }

        .dropdown-menu.show {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .dropdown-item {
            padding: 12px 16px;
            font-size: 14px;
            color: var(--text-primary);
            cursor: pointer;
            transition: var(--transition-fast);
            border-bottom: 1px solid var(--border-color);
        }

        .dropdown-item:last-child {
            border-bottom: none;
        }

        .dropdown-item:hover {
            background: var(--surface-hover);
        }

        .dropdown-divider {
            height: 1px;
            background: var(--border-color);
            margin: 4px 0;
        }

        /* Enhanced Icon Button Styles */
        .btn-icon {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
            padding: 0;
            border-radius: var(--border-radius);
            background: transparent;
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
            cursor: pointer;
            transition: var(--transition-fast);
        }

        .btn-icon:hover {
            background: var(--surface-hover);
            border-color: var(--border-color-hover);
            color: var(--text-primary);
        }

        .btn-icon.btn-icon-primary {
            background: var(--primary-subtle);
            border-color: transparent;
            color: var(--primary-color);
        }

        .btn-icon.btn-icon-primary:hover {
            background: var(--primary-color);
            color: white;
        }

        /* Enhanced Data Card */
        .data-card {
            background: var(--surface-color);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: 24px;
            transition: var(--transition);
            position: relative;
            overflow: hidden;
        }

        .data-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--primary-color), var(--accent-color));
            transform: scaleX(0);
            transform-origin: left;
            transition: transform 0.3s ease;
        }

        .data-card:hover::before {
            transform: scaleX(1);
        }

        .data-card:hover {
            box-shadow: var(--shadow-md);
            transform: translateY(-4px);
            border-color: var(--border-color-hover);
        }

        .data-card-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 16px;
        }

        .data-card-title {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin: 0;
        }

        .data-card-value {
            font-size: 32px;
            font-weight: 700;
            color: var(--text-primary);
            margin: 0 0 8px 0;
            line-height: 1;
        }

        .data-card-subtitle {
            font-size: 14px;
            color: var(--text-secondary);
            margin: 0;
        }

        .data-card-trend {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 8px;
            border-radius: var(--border-radius-sm);
            font-size: 12px;
            font-weight: 600;
        }

        .data-card-trend.positive {
            background: #D1FAE5;
            color: #065F46;
        }

        .data-card-trend.negative {
            background: #FEE2E2;
            color: #991B1B;
        }

        /* Enhanced Form Validation */
        .form-control {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid var(--border-color);
            border-radius: var(--border-radius);
            font-size: 14px;
            font-family: inherit;
            color: var(--text-primary);
            background: var(--surface-color);
            transition: var(--transition-fast);
        }

        .form-control:hover {
            border-color: var(--border-color-hover);
        }

        .form-control:focus {
            border-color: var(--border-color-focus);
            box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.1);
            outline: none;
        }

        .form-control.is-valid {
            border-color: var(--success-color);
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 8 8'%3e%3cpath fill='%2310B981' d='M2.3 6.73L.6 4.53c-.4-1.04.46-1.4 1.1-.8l1.1 1.4 3.4-3.8c.6-.63 1.6-.27 1.2.7l-4 4.6c-.43.5-.8.4-1.1.1z'/%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 12px center;
            background-size: 16px;
            padding-right: 40px;
        }

        .form-control.is-invalid {
            border-color: var(--danger-color);
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 12 12' width='12' height='12' fill='none' stroke='%23EF4444'%3e%3ccircle cx='6' cy='6' r='4.5'/%3e%3cpath stroke-linejoin='round' d='M5.8 3.6h.4L6 6.5z'/%3e%3ccircle cx='6' cy='8.2' r='.6' fill='%23EF4444' stroke='none'/%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 12px center;
            background-size: 16px;
            padding-right: 40px;
        }

        .valid-feedback {
            display: none;
            margin-top: 6px;
            font-size: 13px;
            color: var(--success-color);
        }

        .form-control.is-valid ~ .valid-feedback {
            display: block;
        }

        .invalid-feedback {
            display: none;
            margin-top: 6px;
            font-size: 13px;
            color: var(--danger-color);
        }

        .form-control.is-invalid ~ .invalid-feedback {
            display: block;
        }

        /* Enhanced Button Group */
        .btn-group {
            display: inline-flex;
            border-radius: var(--border-radius);
            overflow: hidden;
            box-shadow: var(--shadow-xs);
        }

        .btn-group .btn {
            border-radius: 0;
            border-right: 1px solid rgba(0, 0, 0, 0.1);
        }

        .btn-group .btn:first-child {
            border-top-left-radius: var(--border-radius);
            border-bottom-left-radius: var(--border-radius);
        }

        .btn-group .btn:last-child {
            border-top-right-radius: var(--border-radius);
            border-bottom-right-radius: var(--border-radius);
            border-right: none;
        }

        /* Enhanced Progress Bar */
        .progress {
            height: 8px;
            background: #E5E7EB;
            border-radius: var(--border-radius-full);
            overflow: hidden;
            box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.1);
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--primary-color), var(--primary-light));
            border-radius: var(--border-radius-full);
            transition: width 0.6s ease;
            position: relative;
            overflow: hidden;
        }

        .progress-bar::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(
                90deg,
                transparent,
                rgba(255, 255, 255, 0.3),
                transparent
            );
            animation: progress-shimmer 2s infinite;
        }

        @keyframes progress-shimmer {
            0% {
                transform: translateX(-100%);
            }
            100% {
                transform: translateX(100%);
            }
        }

        /* Enhanced Tooltip */
        .tooltip {
            position: relative;
            display: inline-block;
        }

        .tooltip-text {
            visibility: hidden;
            background-color: var(--text-primary);
            color: white;
            text-align: center;
            padding: 8px 12px;
            border-radius: var(--border-radius);
            font-size: 12px;
            font-weight: 500;
            line-height: 1.4;
            position: absolute;
            z-index: 1000;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            white-space: nowrap;
            opacity: 0;
            transition: opacity 0.3s;
            box-shadow: var(--shadow-lg);
        }

        .tooltip-text::after {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: var(--text-primary) transparent transparent transparent;
        }

        .tooltip:hover .tooltip-text {
            visibility: visible;
            opacity: 1;
        }

        /* Enhanced Breadcrumb */
        .breadcrumb {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px 0;
            font-size: 14px;
        }

        .breadcrumb-item {
            color: var(--text-secondary);
            text-decoration: none;
            transition: var(--transition-fast);
        }

        .breadcrumb-item:hover {
            color: var(--primary-color);
        }

        .breadcrumb-item.active {
            color: var(--text-primary);
            font-weight: 500;
        }

        .breadcrumb-separator {
            color: var(--text-tertiary);
            user-select: none;
        }

        /* Enhanced Divider */
        .divider {
            height: 1px;
            background: var(--border-color);
            margin: var(--spacing-lg) 0;
        }

        .divider-text {
            display: flex;
            align-items: center;
            gap: 16px;
            margin: var(--spacing-lg) 0;
            font-size: 14px;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 600;
        }

        .divider-text::before,
        .divider-text::after {
            content: '';
            flex: 1;
            height: 1px;
            background: var(--border-color);
        }
    </style>

    <!-- Fortune Bright Theme - Professional Healthcare Design -->
    <link href="https://fonts.googleapis.com/css2?family=Karla:wght@400;600;700&family=Open+Sans:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="fortune-bright-theme.css">

    <!-- Subscription Management -->
    <script src="/utils/subscription-plans.js"></script>
    <script src="/utils/feature-gate.js"></script>
</head>
<body>
    <div class="auth-container" id="authContainer">
        <div class="logo-container">
            <!-- SVG Logo Icon -->
            <svg class="logo-icon" viewBox="0 0 100 70" xmlns="http://www.w3.org/2000/svg">
                <circle cx="32" cy="35" r="26" fill="none" stroke="#00B4A6" stroke-width="4"/>
                <circle cx="68" cy="35" r="26" fill="none" stroke="#F4A443" stroke-width="4"/>
            </svg>
            <!-- Logo Text with Tagline -->
            <div class="logo-text-container">
                <div class="logo-wordmark">SESSIONABLY</div>
                <div class="logo-tagline">PRACTICE MANAGEMENT SUITE</div>
            </div>
        </div>

        <div class="auth-tabs">
            <div class="auth-tab active" onclick="switchAuthTab('clinician')" role="tab" aria-selected="true"> Clinician</div>
            <div class="auth-tab" onclick="switchAuthTab('client')" role="tab" aria-selected="false"> Client</div>
        </div>

        <div id="clinicianAuth" class="auth-form active" role="tabpanel">
            <div style="text-align: center; padding: 20px;">
                <h3 style="margin-bottom: 30px; color: var(--text-primary);">Clinician Login</h3>
                
                <div class="input-group" style="margin-bottom: 15px;">
                    <label for="clinicianUsername" class="input-label">Username</label>
                    <input type="text" id="clinicianUsername" placeholder="Enter your username" class="input" autocomplete="username">
                </div>
                
                <div class="input-group" style="margin-bottom: 15px;">
                    <label for="clinicianPassword" class="input-label">Password</label>
                    <input type="password" id="clinicianPassword" placeholder="Enter your password" class="input" autocomplete="current-password">
                </div>
                
                <div style="display: flex; align-items: center; margin-bottom: 20px; font-size: 14px;">
                    <input type="checkbox" id="rememberMe" style="margin-right: 8px; cursor: pointer;">
                    <label for="rememberMe" style="cursor: pointer; color: var(--text-primary);">Remember me for 30 days</label>
                </div>
                
                <button onclick="clinicianLogin()" class="btn btn-primary" style="width: 100%; height: 50px; font-size: 18px; background: #00b4a6; border: none; border-radius: 8px; color: white; cursor: pointer;">
                     Login
                </button>

                <div style="margin-top: 15px; text-align: center;">
                    <a href="#" onclick="showRegisterForm(); return false;" style="color: #00b4a6; text-decoration: none; font-size: 14px;">
                        Don't have an account? Register here
                    </a>
                </div>
            </div>

        </div>

        <div id="clientAuth" class="auth-form" role="tabpanel">
            <div class="input-group">
                <label for="authCode" class="input-label">Authentication Code</label>
                <input type="text" id="authCode" placeholder="Enter your access code" class="input" style="text-transform: uppercase;" aria-describedby="authcode-help" oninput="clearAuthError()">
                <div id="authcode-help" class="error-message" style="display: none;"></div>
            </div>
            
            <button onclick="accessDocument()" class="btn btn-primary" style="width: 100%;">
                <span>Access Document</span>
                <div class="loading-spinner" style="display: none;"></div>
            </button>
            
            <p style="margin-top: 20px; font-size: 12px; color: var(--text-secondary); text-align: center;">
                Enter the code provided by your clinician
            </p>
        </div>
    </div>

    <div class="app-container" id="appContainer">
        <div class="header">
            <div style="display: flex; align-items: center; gap: 16px;">
                <button class="mobile-menu-toggle" onclick="toggleSidebar()" aria-label="Toggle menu">
                    
                </button>
                <h1>
                    <div class="logo-container">
                        <!-- SVG Logo Icon -->
                        <svg class="logo-icon" viewBox="0 0 100 70" xmlns="http://www.w3.org/2000/svg">
                            <circle cx="32" cy="35" r="26" fill="none" stroke="#00B4A6" stroke-width="4"/>
                            <circle cx="68" cy="35" r="26" fill="none" stroke="#F4A443" stroke-width="4"/>
                        </svg>
                        <!-- Logo Text with Tagline -->
                        <div class="logo-text-container">
                            <div class="logo-wordmark">SESSIONABLY</div>
                            <div class="logo-tagline">PRACTICE MANAGEMENT SUITE</div>
                        </div>
                    </div>
                </h1>
            </div>
            <div class="header-actions">
                <!-- Notifications Bell -->
                <button class="notification-bell" onclick="showTab('notifications')" aria-label="Notifications">
                    
                    <span class="notification-badge" id="notifBadgeHeader" style="display: none; position: absolute; top: 4px; right: 4px; background: var(--danger-color); color: white; border-radius: 50%; width: 18px; height: 18px; font-size: 11px; display: flex; align-items: center; justify-content: center;">0</span>
                </button>
                <div id="subscriptionStatus" class="subscription-status" style="display: none;">
                    <span id="trialDaysLeft"></span>
                </div>
                <div class="user-menu" onclick="toggleUserMenu()" tabindex="0" role="button" aria-label="User menu">
                    <div class="user-avatar" id="userAvatar">A</div>
                    <span id="userName">Admin</span>
                    <span style="font-size: 12px; color: var(--text-secondary);"></span>
                    
                    <!-- User Menu Dropdown -->
                    <div class="user-menu-dropdown" id="userMenuDropdown">
                        <div class="user-menu-header">
                            <div class="user-menu-header-name" id="dropdownUserName">Admin User</div>
                            <div class="user-menu-header-email" id="dropdownUserEmail">support@sessionably.com</div>
                </div>
                        <div class="user-menu-item" onclick="openProfileModal()">
                            <svg class="user-menu-item-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                            </svg>
                            <span class="user-menu-item-text">Profile</span>
                            <span class="user-menu-item-arrow"></span>
                        </div>
                        <div class="user-menu-item" onclick="openSettingsModal()">
                            <svg class="user-menu-item-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                            </svg>
                            <span class="user-menu-item-text">Settings</span>
                            <span class="user-menu-item-arrow"></span>
                        </div>
                        <div class="user-menu-item" onclick="openAccountModal()">
                            <svg class="user-menu-item-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"/>
                            </svg>
                            <span class="user-menu-item-text">Account</span>
                            <span class="user-menu-item-arrow"></span>
                        </div>
                        <div class="user-menu-item" onclick="logout()">
                            <svg class="user-menu-item-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/>
                            </svg>
                            <span class="user-menu-item-text">Logout</span>
                        </div>
                    </div>
                </div>
                <button onclick="logout()" class="btn btn-secondary btn-icon" aria-label="Logout" style="display: none;">
                    <span></span>
                </button>
            </div>
        </div>

        <!-- Sidebar Navigation -->
        <div class="sidebar" id="sidebar">
            <div class="sidebar-nav">
                <button class="tab-btn active" onclick="showTab('dashboard')" data-translate="Dashboard">
                    Dashboard
                </button>
                <button class="tab-btn" onclick="showTab('clients')" data-translate="Clients">
                    Clients
                </button>
                <button class="tab-btn" onclick="showTab('appointments')" data-translate="Appointments">
                    Appointments
                </button>
                <!-- Telehealth: Professional+ (Professional or Complete plans) -->
                <button class="tab-btn" id="telehealthNavBtn" onclick="showTab('telehealth')" style="display: none;">
                    Telehealth
                </button>
                <!-- AI NoteTaker: Complete only -->
                <button class="tab-btn" id="aiNoteTakerNavBtn" onclick="showTab('ainotetaker')" style="display: none;">
                    AI NoteTaker
                </button>
                <button class="tab-btn" onclick="showTab('documents')">
                    <span data-translate="Documents">Documents</span>
                    <span class="notification-badge" id="docBadge" style="display: none;">0</span>
                </button>
                <button class="tab-btn" onclick="showTab('invoices')">
                    Billing
                </button>
                <button class="tab-btn" onclick="showTab('settings')" data-translate="Settings">
                    Settings
                </button>
            </div>
        </div>

        <!-- Main Content Wrapper -->
        <div class="app-content-wrapper">
            <div class="content">
            <div id="dashboardContent" class="tab-content" style="display: block;">
                <div class="content-header">
                    <h2>Dashboard</h2>
                    <div>
                        <button onclick="loadDashboard()" class="btn btn-primary">Refresh</button>
                    </div>
                </div>

                <!-- Quick Stats Cards -->
                <div class="analytics-grid" style="margin-bottom: 30px;">
                    <div class="stat-card">
                        <h3 data-translate="Today's Appointments">Today's Appointments</h3>
                        <div class="stat-number" id="todayAppointmentsCount">-</div>
                    </div>
                    <div class="stat-card">
                        <h3 data-translate="Active Clients">Active Clients</h3>
                        <div class="stat-number" id="activeClientsCount">-</div>
                    </div>
                    <div class="stat-card">
                        <h3 data-translate="Unread Messages">Unread Messages</h3>
                        <div class="stat-number" id="unreadMessagesCount">-</div>
                    </div>
                    <div class="stat-card">
                        <h3 data-translate="This Week Revenue">This Week Revenue</h3>
                        <div class="stat-number" id="weeklyRevenue">$-</div>
                    </div>
                </div>

                <!-- Today's Schedule Section -->
                <div class="card" style="padding: 24px; margin-bottom: 20px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3 style="margin: 0;">Today's Schedule</h3>
                        <button onclick="showTab('appointments')" class="btn btn-secondary" style="font-size: 14px; padding: 8px 16px;">View All</button>
                    </div>
                    <div id="todayAppointmentsList">
                        Loading...
                    </div>
                </div>

                <!-- Quick Actions -->
                <div class="card" style="padding: 24px; margin-bottom: 20px;">
                    <h3 style="margin: 0 0 20px 0;">Quick Actions</h3>
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;">
                        <button onclick="openNewClient()" class="btn btn-primary" style="padding: 20px; display: flex; flex-direction: column; align-items: center; gap: 10px; background: white; color: var(--text-color); border: 2px solid var(--border-color); box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                            <span style="font-weight: 600; font-size: 15px;">Add Client</span>
                        </button>
                        <button onclick="openNewAppointment()" class="btn btn-primary" style="padding: 20px; display: flex; flex-direction: column; align-items: center; gap: 10px; background: white; color: var(--text-color); border: 2px solid var(--border-color); box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                            <span style="font-weight: 600; font-size: 15px;">Schedule</span>
                        </button>
                        <button onclick="showTab('ainotetaker')" class="btn btn-primary" style="padding: 20px; display: flex; flex-direction: column; align-items: center; gap: 10px; background: white; color: var(--text-color); border: 2px solid var(--border-color); box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                            <span style="font-weight: 600; font-size: 15px;">New Note</span>
                        </button>
                        <button onclick="openNewInvoice()" class="btn btn-primary" style="padding: 20px; display: flex; flex-direction: column; align-items: center; gap: 10px; background: white; color: var(--text-color); border: 2px solid var(--border-color); box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                            <span style="font-weight: 600; font-size: 15px;">Invoice</span>
                        </button>
                    </div>
                </div>

                <!-- Recent Activity -->
                <div class="card" style="padding: 24px;">
                    <h3 style="margin: 0 0 20px 0;">Recent Activity</h3>
                    <div id="recentActivityList">
                        Loading...
                    </div>
                </div>
            </div>

            <div id="clientsContent" class="tab-content">
                <div class="content-header">
                    <h2>Clients</h2>
                    <button onclick="openNewClient()" class="btn btn-primary">+ New Client</button>
                </div>
                <input type="text" id="clientSearchInput" class="search-input" placeholder="Search clients..." oninput="debouncedFilterClients()">
                <div id="clientsList" class="grid"></div>

                <!-- Enhanced Client Management -->
                <div class="card" style="margin-top: 24px;">
                    <div style="display: flex; gap: 12px; margin-bottom: 20px; flex-wrap: wrap;">
                        <input type="text" id="enhancedClientSearch" placeholder="Search clients (name, email, notes)..."
                               oninput="searchEnhancedClients()"
                               style="flex: 1; min-width: 250px; padding: 10px 14px; border: 1px solid var(--border-color); border-radius: var(--border-radius); font-size: 14px;">
                        <select id="statusFilter" onchange="searchEnhancedClients()"
                                style="padding: 10px 14px; border: 1px solid var(--border-color); border-radius: var(--border-radius); font-size: 14px; background: white;">
                            <option value="">All Status</option>
                            <option value="active">Active</option>
                            <option value="inactive">Inactive</option>
                        </select>
                        <input type="text" id="tagFilter" placeholder="Filter by tag..." onchange="searchEnhancedClients()"
                               style="padding: 10px 14px; border: 1px solid var(--border-color); border-radius: var(--border-radius); font-size: 14px; min-width: 150px;">
                    </div>

                    <div style="overflow-x: auto;">
                        <table id="clientsTable" style="width: 100%; border-collapse: collapse;">
                            <thead>
                                <tr style="background: #F8F9FA; border-bottom: 2px solid var(--border-color);">
                                    <th style="padding: 12px; text-align: left; font-weight: 600; color: var(--text-primary); font-size: 13px;">Name</th>
                                    <th style="padding: 12px; text-align: left; font-weight: 600; color: var(--text-primary); font-size: 13px;">Email</th>
                                    <th style="padding: 12px; text-align: left; font-weight: 600; color: var(--text-primary); font-size: 13px;">Phone</th>
                                    <th style="padding: 12px; text-align: left; font-weight: 600; color: var(--text-primary); font-size: 13px;">Status</th>
                                    <th style="padding: 12px; text-align: left; font-weight: 600; color: var(--text-primary); font-size: 13px;">Tags</th>
                                    <th style="padding: 12px; text-align: left; font-weight: 600; color: var(--text-primary); font-size: 13px;">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="clientsTableBody">
                                <tr>
                                    <td colspan="6" style="padding: 40px; text-align: center; color: var(--text-secondary);">
                                        Loading clients...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- ARCHIVED: Messages Feature Content -->
            <!--
            <div id="messagesContent" class="tab-content">
                <div class="content-header">
                    <h2>Messages</h2>
                    <button onclick="refreshMessages()" class="btn btn-secondary"> Refresh</button>
                </div>
                <div style="display: grid; grid-template-columns: 300px 1fr; gap: 20px; height: calc(100vh - 250px);">
                    <div class="card" style="overflow-y: auto; padding: 0;">
                        <div style="padding: 20px; border-bottom: 1px solid var(--border-color); background: var(--surface-color); position: sticky; top: 0; z-index: 10;">
                            <input type="text" id="conversationSearch" class="input" placeholder="Search conversations..." oninput="filterConversations()" style="width: 100%;">
                        </div>
                        <div id="conversationsList" style="padding: 10px;">
                        </div>
                    </div>

                    <div class="card" style="display: flex; flex-direction: column; padding: 0;">
                        <div id="messageAreaHeader" style="padding: 20px; border-bottom: 1px solid var(--border-color); background: var(--surface-color);">
                            <div id="selectedClientInfo" style="display: none;">
                                <h3 id="selectedClientName" style="margin: 0; color: var(--primary-color);"></h3>
                                <p id="selectedClientEmail" style="margin: 5px 0 0 0; font-size: 14px; color: var(--text-secondary);"></p>
                            </div>
                            <div id="noConversationSelected" style="text-align: center; color: var(--text-secondary);">
                                Select a conversation to view messages
                            </div>
                        </div>

                        <div id="messagesArea" style="flex: 1; overflow-y: auto; padding: 20px; background: #f8f9fa;">
                        </div>

                        <div id="messageComposer" style="padding: 20px; border-top: 1px solid var(--border-color); background: var(--surface-color); display: none;">
                            <div style="display: flex; gap: 10px; align-items: end;">
                                <textarea id="messageInput" class="input" placeholder="Type your message..." rows="3" style="flex: 1; resize: none;" onkeydown="handleMessageKeydown(event)"></textarea>
                                <button onclick="sendProviderMessage()" class="btn btn-primary" style="height: fit-content;">Send</button>
                            </div>
                            <div id="typingIndicator" style="margin-top: 10px; font-size: 13px; color: var(--text-secondary); font-style: italic; display: none;">
                                Client is typing...
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            -->

            <div id="appointmentsContent" class="tab-content">
                <div class="content-header">
                    <h2>Appointments</h2>
                    <button onclick="openNewAppointment()" class="btn btn-primary">+ New Appointment</button>
                </div>
                <div class="calendar-controls">
                    <button onclick="previousMonth()" class="btn"> Previous</button>
                    <h3 id="currentMonth">Current Month</h3>
                    <button onclick="nextMonth()" class="btn">Next </button>
                    <div class="calendar-view-toggle">
                        <button id="monthViewBtn" onclick="setCalendarView('month')" class="btn btn-sm active">Month</button>
                        <button id="weekViewBtn" onclick="setCalendarView('week')" class="btn btn-sm">Week</button>
                        <button id="dayViewBtn" onclick="setCalendarView('day')" class="btn btn-sm">Day</button>
                    </div>
                </div>
                <div id="calendarView" class="calendar-container"></div>
                <div id="appointmentsList" class="appointments-list"></div>
                
                <!-- Appointment Detail Panel -->
                <div id="appointmentDetailPanel" class="appointment-detail-panel">
                    <div class="appointment-detail-header">
                        <h2>Appointment Details</h2>
                        <button class="appointment-detail-close" onclick="closeAppointmentDetail()" aria-label="Close"></button>
                    </div>
                    
                    <div class="appointment-detail-content">
                        <!-- Client Information Section -->
                        <div class="detail-section">
                            <h3>Client Information</h3>
                            <div class="detail-row">
                                <span class="detail-label">Name:</span>
                                <span class="detail-value" id="detailClientName">-</span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">Email:</span>
                                <span class="detail-value" id="detailClientEmail">-</span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">Phone:</span>
                                <span class="detail-value" id="detailClientPhone">-</span>
                            </div>
                        </div>

                        <!-- Payment Information Section -->
                        <div class="detail-section" id="paymentInfoSection" style="display: none;">
                            <h3>Payment Information</h3>
                            <div class="detail-row">
                                <span class="detail-label">Auto-Pay:</span>
                                <span class="detail-value" id="detailAutopay">-</span>
                            </div>
                            <div class="detail-row" id="paymentMethodRow" style="display: none;">
                                <span class="detail-label">Payment Method:</span>
                                <span class="detail-value" id="detailPaymentMethod">-</span>
                            </div>
                            <div style="margin-top: 10px; padding: 10px; background: #f0f9ff; border-radius: 6px; font-size: 13px; color: #1e40af;">
                                <strong>Note:</strong> Full card details are securely stored with Stripe and not accessible to clinicians for security compliance.
                            </div>
                        </div>

                        <!-- Appointment Details Section -->
                        <div class="detail-section">
                            <h3>Appointment Details</h3>
                            <div class="detail-row">
                                <span class="detail-label">Date:</span>
                                <span class="detail-value" id="detailDate">-</span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">Time:</span>
                                <span class="detail-value" id="detailTime">-</span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">Duration:</span>
                                <span class="detail-value" id="detailDuration">-</span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">Type:</span>
                                <span class="detail-value" id="detailType">-</span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">Location:</span>
                                <span class="detail-value" id="detailLocation">-</span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">Modality:</span>
                                <span class="detail-value" id="detailModality">-</span>
                            </div>
                            <div class="detail-row" id="detailTelehealthRow" style="display: none;">
                                <span class="detail-label">Telehealth Link:</span>
                                <span class="detail-value">
                                    <a href="#" id="detailTelehealthLink" target="_blank" style="color: #667eea; font-weight: 600; text-decoration: underline;">Join Video Session</a>
                                </span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">Status:</span>
                                <span class="detail-value">
                                    <span class="status-badge" id="detailStatus">-</span>
                                </span>
                            </div>
                            <!-- TODO: Add Stripe integration fields -->
                            <!-- <div class="detail-row">
                                <span class="detail-label">Service:</span>
                                <span class="detail-value" id="detailService">-</span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">Price:</span>
                                <span class="detail-value" id="detailPrice">-</span>
                            </div> -->
                        </div>
                        
                        <!-- Notes Section -->
                        <div class="detail-section">
                            <h3>Notes</h3>
                            <div class="detail-notes" id="detailNotes">No notes available</div>
                        </div>

                        <!-- Clinical Notes Section -->
                        <div class="detail-section">
                            <h3>Clinical Notes</h3>
                            <div class="clinical-notes-container">
                                <textarea id="detailClinicalNotes" class="clinical-notes-textarea" placeholder="Enter clinical notes here..."></textarea>
                                <div class="clinical-notes-actions">
                                    <button class="btn-save-note" onclick="saveClinicalNote()">
                                         Save Note
                                    </button>
                                    <button class="btn-sign-note" onclick="signClinicalNote()">
                                         Sign & Lock Note
                                    </button>
                                </div>
                                <div style="margin-top: 10px; padding: 10px; background: #fef3c7; border-radius: 6px; font-size: 13px; color: #78350f;">
                                     AI NoteTaker has been moved to the dedicated AI NoteTaker tab. Enable it there to record sessions.
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="appointment-detail-actions">
                        <button class="btn-detail-edit" onclick="editAppointmentFromDetail()">
                             Edit Appointment
                        </button>
                        <!-- Removed Mark Complete button - appointments auto-complete when clinical note is signed -->
                        <button class="btn-detail-delete" onclick="deleteAppointmentFromDetail()">
                             Delete
                        </button>
                    </div>
                </div>
            </div>

            <div id="ainotetakerContent" class="tab-content">
                <div class="content-header">
                    <h2>AI Clinical NoteTaker</h2>
                    <div style="display: flex; gap: 10px;">
                        <button onclick="showNoteTakerRecorder()" class="btn btn-primary">+ New Recording</button>
                        <button onclick="showNoteTakerNotesList()" class="btn btn-secondary">View All Notes</button>
                    </div>
                </div>

                <!-- Subscription Notice -->
                <div id="aiNoteTakerSubscriptionNotice" class="info-banner" style="display: none; margin-bottom: 20px; padding: 15px; background: #fef3c7; border-left: 4px solid #f59e0b; border-radius: 8px;">
                    <h3 style="margin: 0 0 10px 0; color: #92400e;">AI NoteTaker Add-On Required</h3>
                    <p style="margin: 0 0 10px 0; color: #78350f;">The AI NoteTaker is an optional add-on feature for $20/month. Subscribe to enable AI-powered session recording and note generation.</p>
                    <button onclick="showSettingsTab('billing')" class="btn btn-primary">Subscribe Now</button>
                </div>

                <!-- Today's Appointments for AI NoteTaker -->
                <div class="card" style="padding: 24px; margin-bottom: 20px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3>Today's Sessions</h3>
                        <button onclick="refreshAINoteTakerAppointments()" class="btn btn-secondary"> Refresh</button>
                    </div>
                    <div id="aiNoteTakerTodayAppointments">
                        Loading today's appointments...
                    </div>
                </div>

                <!-- Recorder View -->
                <div id="noteTakerRecorderView" style="display: block;">
                    <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                        <!-- Recording Panel -->
                        <div class="card" style="padding: 24px;">
                            <h3 style="margin-bottom: 20px;"> Session Recording</h3>

                            <!-- Timer Display -->
                            <div id="aiTimer" style="font-size: 2.5em; text-align: center; color: var(--primary-color); font-weight: bold; font-family: 'Courier New', monospace; padding: 20px; background: #f7f7f7; border-radius: 10px; margin-bottom: 20px;">
                                00:00:00
                            </div>

                            <!-- Record Button -->
                            <button id="aiRecordBtn" class="btn btn-primary" style="width: 100%; padding: 20px; font-size: 1.1em; border-radius: 50px; margin-bottom: 20px;">
                                <span id="aiRecordIcon"></span>
                                <span id="aiRecordText">Start Recording</span>
                            </button>

                            <!-- Audio Visualizer -->
                            <canvas id="aiVisualizer" style="width: 100%; height: 60px; background: #f7f7f7; border-radius: 8px; margin-bottom: 15px;"></canvas>

                            <!-- Status Message -->
                            <div id="aiStatusMessage" style="display: none;"></div>

                            <!-- Settings Panel -->
                            <div class="card" style="background: #f8fafc; padding: 20px; margin-top: 20px;">
                                <label class="label">Client:</label>
                                <select id="aiClientSelect" class="input" style="margin-bottom: 15px;">
                                    <option value="">Select Client</option>
                                </select>

                                <label class="label">Note Format:</label>
                                <select id="aiNoteFormat" class="input" style="margin-bottom: 15px;">
                                    <option value="soap">SOAP Note</option>
                                    <option value="dap">DAP Note</option>
                                    <option value="progress">Progress Note</option>
                                    <option value="psychotherapy">Psychotherapy Note</option>
                                    <option value="intake">Initial Intake Note</option>
                                    <option value="discharge">Discharge Summary</option>
                                </select>

                                <label class="label">Session Type:</label>
                                <select id="aiSessionType" class="input">
                                    <option value="individual">Individual Therapy</option>
                                    <option value="couples">Couples Therapy</option>
                                    <option value="family">Family Therapy</option>
                                    <option value="group">Group Therapy</option>
                                    <option value="assessment">Assessment</option>
                                </select>
                            </div>
                        </div>

                        <!-- Transcript Panel -->
                        <div class="card" style="padding: 24px;">
                            <h3 style="margin-bottom: 20px;">Session Transcript</h3>

                            <!-- Hidden textarea for AI note generation integration -->
                            <textarea id="session-transcript" style="display: none;"></textarea>

                            <div id="aiTranscript" style="min-height: 300px; max-height: 500px; overflow-y: auto; padding: 20px; background: #f7f7f7; border-radius: 8px; border: 1px solid var(--border-color); white-space: pre-wrap; line-height: 1.6; margin-bottom: 15px; font-size: 0.95em;">
                                Transcript will appear here as you record...
                            </div>

                            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                                <button id="aiClearTranscript" class="btn btn-secondary">Clear</button>
                                <button id="aiEditTranscript" class="btn btn-secondary">Edit</button>
                            </div>
                        </div>
                    </div>

                    <!-- Generated Notes Panel (Full Width) -->
                    <div class="card" style="padding: 24px;">
                        <h3 style="margin-bottom: 20px;">Generated Clinical Note</h3>

                        <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 15px;">
                            <button id="aiGenerateBtn" class="btn btn-primary" data-action="generate-ai-note" disabled>Generate Clinical Notes</button>
                            <button id="aiCopyBtn" class="btn btn-success" disabled>Copy</button>
                            <button id="aiSaveBtn" class="btn btn-primary" disabled> Save to Record</button>
                        </div>

                        <div id="aiNotesOutput" class="ai-note-display" data-note-output style="min-height: 300px; max-height: 600px; overflow-y: auto; padding: 20px; background: #f7f7f7; border-radius: 8px; border: 1px solid var(--border-color); line-height: 1.8;">
                            Generated clinical notes will appear here...
                        </div>

                        <div id="aiSavedNoteInfo" style="display: none; margin-top: 15px; padding: 15px; background: #e8f5e9; border-left: 4px solid var(--success-color); border-radius: 8px;">
                            Note saved successfully! Note ID: <span id="aiSavedNoteId"></span>
                            <button onclick="viewClinicalNote(window.lastSavedNoteId)" class="btn btn-secondary" style="margin-left: 10px; padding: 8px 16px;">View Note</button>
                        </div>
                    </div>
                </div>

                <!-- Notes List View -->
                <div id="noteTakerNotesListView" style="display: none;">
                    <div class="card" style="padding: 24px; margin-bottom: 20px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <h3>All Clinical Notes</h3>
                            <div style="display: flex; gap: 10px;">
                                <select id="notesFilterClient" class="input" style="width: auto;" onchange="filterClinicalNotes()">
                                    <option value="">All Clients</option>
                                </select>
                                <button onclick="refreshClinicalNotesList()" class="btn btn-secondary"> Refresh</button>
                            </div>
                        </div>
                        <div id="clinicalNotesList" class="grid" style="grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 16px;">
                            Loading notes...
                        </div>
                    </div>
                </div>
            </div>

            <div id="documentsContent" class="tab-content">
                <div class="content-header">
                    <h2>Documents</h2>
                    <button onclick="openAssignDoc()" class="btn btn-primary">+ Assign Document</button>
                </div>
                <div id="docsList"></div>
            </div>

            <div id="invoicesContent" class="tab-content">
                <div class="content-header">
                    <h2>Invoices</h2>
                    <button onclick="openNewInvoice()" class="btn btn-primary">+ New Invoice</button>
                </div>
                <div class="invoice-filters">
                    <select id="invoiceStatusFilter" class="input" style="width: auto;" onchange="filterInvoices()">
                        <option value="">All Status</option>
                        <option value="pending">Pending</option>
                        <option value="paid">Paid</option>
                        <option value="overdue">Overdue</option>
                    </select>
                </div>
                <div id="invoicesList" class="invoices-grid"></div>
            </div>

            <div id="analyticsContent" class="tab-content">
                <div class="content-header">
                    <h2>Analytics</h2>
                    <div>
                        <select id="analyticsTimeframeSelect" class="input" style="width: auto; margin-right: 10px;" onchange="loadAnalyticsPage()">
                            <option value="7">Last 7 days</option>
                            <option value="30" selected>Last 30 days</option>
                            <option value="90">Last 90 days</option>
                            <option value="365">Last year</option>
                        </select>
                        <button onclick="loadAnalyticsPage()" class="btn btn-primary">Refresh</button>
                    </div>
                </div>
                <div id="analyticsPageContent">
                    <div class="analytics-grid">
                        <div class="stat-card">
                            <h3>Total Clients</h3>
                            <div class="stat-number" id="analyticsTotalClients">-</div>
                        </div>
                        <div class="stat-card">
                            <h3>Upcoming Appointments</h3>
                            <div class="stat-number" id="analyticsUpcomingAppointments">-</div>
                        </div>
                        <div class="stat-card">
                            <h3>Pending Documents</h3>
                            <div class="stat-number" id="analyticsPendingDocuments">-</div>
                        </div>
                        <div class="stat-card">
                            <h3>Total Revenue</h3>
                            <div class="stat-number" id="analyticsTotalRevenue">$-</div>
                        </div>
                    </div>
                    <div class="charts-container">
                        <div class="chart-card">
                            <h3>Monthly Trends</h3>
                            <div id="analyticsMonthlyChart"></div>
                        </div>
                        <div class="chart-card">
                            <h3>Top Clients</h3>
                            <div id="analyticsTopClientsList"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="settingsContent" class="tab-content">
                <div class="content-header">
                    <h2>Settings</h2>
                </div>
                <div class="settings-tabs">
                    <button class="settings-tab-btn active" onclick="showSettingsTab('billing')"> Billing Settings</button>
                    <button class="settings-tab-btn" onclick="showSettingsTab('autopay')"> Auto-Pay Settings</button>
                    <button class="settings-tab-btn" onclick="showSettingsTab('clinical')"> Clinical Settings</button>
                    <button class="settings-tab-btn" onclick="showSettingsTab('subscription')"> Subscription</button>
                    <button class="settings-tab-btn" onclick="showSettingsTab('profile')"> Profile</button>
                    <button class="settings-tab-btn" onclick="showSettingsTab('practice')"> Practice Info</button>
                    <button class="settings-tab-btn" onclick="showSettingsTab('developer')"> Developer</button>
                </div>
                
                <div id="billingSettingsTab" class="settings-tab-content">
                    <div class="card">
                        <h3>Service Codes & Rates</h3>
                        <p class="settings-description">Set your default rates for CPT codes. These will auto-populate when creating appointments and invoices.</p>
                        
                        <table class="settings-table">
                            <thead>
                                <tr>
                                    <th>CPT Code</th>
                                    <th>Service Name</th>
                                    <th>Default Rate</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="serviceRatesTable">
                                <!-- Populated by JavaScript -->
                            </tbody>
                        </table>
                        
                        <div style="margin-top: 20px;">
                            <button onclick="addCustomService()" class="btn btn-secondary">+ Add Custom Service</button>
                        </div>
                        
                        <div style="margin-top: 30px;">
                            <h3>Tax Settings</h3>
                            <div class="form-group">
                                <label>
                                    <input type="checkbox" id="taxEnabled" onchange="updateTaxSettings()">
                                    Enable tax on invoices
                                </label>
                            </div>
                            <div class="form-group">
                                <label for="taxRate">Tax Rate (%):</label>
                                <input type="number" id="taxRate" class="input" step="0.01" min="0" max="100" value="0" onchange="updateTaxSettings()">
                            </div>
                        </div>
                        
                        <div style="margin-top: 30px;">
                            <h3>Business Information</h3>
                            <div class="form-group">
                                <label for="businessName">Business Name:</label>
                                <input type="text" id="businessName" class="input" placeholder="Your Practice Name">
                            </div>
                            <div class="form-group">
                                <label for="npi">NPI:</label>
                                <input type="text" id="npi" class="input" placeholder="National Provider Identifier">
                            </div>
                            <div class="form-group">
                                <label for="taxId">Tax ID:</label>
                                <input type="text" id="taxId" class="input" placeholder="EIN or SSN">
                            </div>
                        </div>
                        
                        <div style="margin-top: 30px;">
                            <h3>Invoice Terms</h3>
                            <div class="form-group">
                                <label for="invoiceTerms">Default Terms:</label>
                                <select id="invoiceTerms" class="input">
                                    <option value="net30">Net 30</option>
                                    <option value="net15">Net 15</option>
                                    <option value="due_on_receipt">Due on Receipt</option>
                                </select>
                            </div>
                        </div>
                        
                        <div style="margin-top: 30px;">
                            <button onclick="saveBillingSettings()" class="btn btn-primary"> Save Billing Settings</button>
                        </div>
                    </div>
                </div>

                <div id="autopaySettingsTab" class="settings-tab-content" style="display: none;">
                    <div class="card">
                        <h3>Client Auto-Pay Management</h3>
                        <p class="settings-description">Enable or disable automatic payment processing for clients who have saved payment methods on file. Clients must have a valid payment method stored before auto-pay can be enabled.</p>

                        <div style="margin-bottom: 20px; display: flex; gap: 10px; align-items: center;">
                            <input type="text" id="autopaySearchInput" class="input" placeholder="Search clients by name or email..." style="flex: 1;" oninput="filterAutopayClients()">
                            <button onclick="loadAutopaySettings()" class="btn btn-secondary"> Refresh</button>
                            <button onclick="bulkEnableAutopay()" class="btn btn-primary">Enable Selected</button>
                            <button onclick="bulkDisableAutopay()" class="btn btn-secondary">Disable Selected</button>
                        </div>

                        <div style="margin-bottom: 15px; padding: 12px; background: #e8f4f8; border-radius: 8px; border-left: 4px solid #00b4a6;">
                            <strong>Note:</strong> Auto-pay will automatically charge the client's default payment method when an invoice is created. Clients without a saved payment method cannot have auto-pay enabled.
                        </div>

                        <div id="autopayClientsLoading" style="text-align: center; padding: 40px; color: var(--text-secondary);">
                            <div class="loading-spinner"></div>
                            <p>Loading clients...</p>
                        </div>

                        <div id="autopayClientsContainer" style="display: none;">
                            <div style="margin-bottom: 10px; display: flex; gap: 15px; align-items: center; padding: 10px; background: #f8f9fa; border-radius: 6px;">
                                <label style="margin: 0; display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                    <input type="checkbox" id="selectAllAutopay" onchange="toggleSelectAllAutopay()">
                                    <strong>Select All</strong>
                                </label>
                                <span id="selectedAutopayCount" style="color: var(--text-secondary); font-size: 14px;">0 selected</span>
                            </div>

                            <table class="settings-table" style="margin-top: 15px;">
                                <thead>
                                    <tr>
                                        <th style="width: 50px;">Select</th>
                                        <th>Client Name</th>
                                        <th>Email</th>
                                        <th>Payment Method</th>
                                        <th>Auto-Pay Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="autopayClientsTable">
                                    <!-- Populated by JavaScript -->
                                </tbody>
                            </table>

                            <div id="noAutopayClients" style="display: none; text-align: center; padding: 40px; color: var(--text-secondary);">
                                <p>No active clients found.</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="clinicalSettingsTab" class="settings-tab-content" style="display: none;">
                    <div class="card">
                        <h3>Clinical Note Formats</h3>
                        <p class="settings-description">Select which clinical note formats you want available in session notes. These formats will appear as options when creating or generating clinical notes.</p>

                        <div style="margin-top: 20px;">
                            <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 15px;">
                                <label style="display: flex; align-items: start; gap: 10px; padding: 12px; border: 1px solid var(--border-color); border-radius: 8px; cursor: pointer; background: #f8f9fa;">
                                    <input type="checkbox" id="noteFormat_SOAP" value="SOAP" class="note-format-checkbox" onchange="updateNoteFormats()" style="margin-top: 3px; cursor: pointer;">
                                    <div>
                                        <strong style="display: block; margin-bottom: 5px;">SOAP Note</strong>
                                        <span style="font-size: 13px; color: var(--text-secondary);">Subjective, Objective, Assessment, Plan</span>
                                    </div>
                                </label>

                                <label style="display: flex; align-items: start; gap: 10px; padding: 12px; border: 1px solid var(--border-color); border-radius: 8px; cursor: pointer; background: #f8f9fa;">
                                    <input type="checkbox" id="noteFormat_DAP" value="DAP" class="note-format-checkbox" onchange="updateNoteFormats()" style="margin-top: 3px; cursor: pointer;">
                                    <div>
                                        <strong style="display: block; margin-bottom: 5px;">DAP Note</strong>
                                        <span style="font-size: 13px; color: var(--text-secondary);">Data, Assessment, Plan</span>
                                    </div>
                                </label>

                                <label style="display: flex; align-items: start; gap: 10px; padding: 12px; border: 1px solid var(--border-color); border-radius: 8px; cursor: pointer; background: #f8f9fa;">
                                    <input type="checkbox" id="noteFormat_BIRP" value="BIRP" class="note-format-checkbox" onchange="updateNoteFormats()" style="margin-top: 3px; cursor: pointer;">
                                    <div>
                                        <strong style="display: block; margin-bottom: 5px;">BIRP Note</strong>
                                        <span style="font-size: 13px; color: var(--text-secondary);">Behavior, Intervention, Response, Plan</span>
                                    </div>
                                </label>

                                <label style="display: flex; align-items: start; gap: 10px; padding: 12px; border: 1px solid var(--border-color); border-radius: 8px; cursor: pointer; background: #f8f9fa;">
                                    <input type="checkbox" id="noteFormat_GIRP" value="GIRP" class="note-format-checkbox" onchange="updateNoteFormats()" style="margin-top: 3px; cursor: pointer;">
                                    <div>
                                        <strong style="display: block; margin-bottom: 5px;">GIRP Note</strong>
                                        <span style="font-size: 13px; color: var(--text-secondary);">Goal, Intervention, Response, Plan</span>
                                    </div>
                                </label>

                                <label style="display: flex; align-items: start; gap: 10px; padding: 12px; border: 1px solid var(--border-color); border-radius: 8px; cursor: pointer; background: #f8f9fa;">
                                    <input type="checkbox" id="noteFormat_Psychotherapy" value="Psychotherapy" class="note-format-checkbox" onchange="updateNoteFormats()" style="margin-top: 3px; cursor: pointer;">
                                    <div>
                                        <strong style="display: block; margin-bottom: 5px;">Psychotherapy Note</strong>
                                        <span style="font-size: 13px; color: var(--text-secondary);">HIPAA-protected process notes</span>
                                    </div>
                                </label>

                                <label style="display: flex; align-items: start; gap: 10px; padding: 12px; border: 1px solid var(--border-color); border-radius: 8px; cursor: pointer; background: #f8f9fa;">
                                    <input type="checkbox" id="noteFormat_Narrative" value="Narrative" class="note-format-checkbox" onchange="updateNoteFormats()" style="margin-top: 3px; cursor: pointer;">
                                    <div>
                                        <strong style="display: block; margin-bottom: 5px;">Narrative Note</strong>
                                        <span style="font-size: 13px; color: var(--text-secondary);">Free-form clinical narrative</span>
                                    </div>
                                </label>

                                <label style="display: flex; align-items: start; gap: 10px; padding: 12px; border: 1px solid var(--border-color); border-radius: 8px; cursor: pointer; background: #f8f9fa;">
                                    <input type="checkbox" id="noteFormat_PIRP" value="PIRP" class="note-format-checkbox" onchange="updateNoteFormats()" style="margin-top: 3px; cursor: pointer;">
                                    <div>
                                        <strong style="display: block; margin-bottom: 5px;">PIRP Note</strong>
                                        <span style="font-size: 13px; color: var(--text-secondary);">Problem, Intervention, Response, Plan</span>
                                    </div>
                                </label>

                                <label style="display: flex; align-items: start; gap: 10px; padding: 12px; border: 1px solid var(--border-color); border-radius: 8px; cursor: pointer; background: #f8f9fa;">
                                    <input type="checkbox" id="noteFormat_PAIP" value="PAIP" class="note-format-checkbox" onchange="updateNoteFormats()" style="margin-top: 3px; cursor: pointer;">
                                    <div>
                                        <strong style="display: block; margin-bottom: 5px;">PAIP Note</strong>
                                        <span style="font-size: 13px; color: var(--text-secondary);">Problem, Assessment, Intervention, Plan</span>
                                    </div>
                                </label>
                            </div>
                        </div>

                        <div style="margin-top: 30px;">
                            <button onclick="saveClinicalSettings()" class="btn btn-primary"> Save Clinical Settings</button>
                        </div>
                    </div>

                    <div class="card" style="margin-top: 30px;">
                        <h3>Treatment Plan Review Periods</h3>
                        <p class="settings-description">Configure default review periods for treatment plans. Treatment plans will prompt for review when the review date approaches.</p>

                        <div class="form-group">
                            <label for="defaultReviewPeriod">Default Review Period:</label>
                            <select id="defaultReviewPeriod" class="input" onchange="updateTreatmentPlanSettings()">
                                <option value="30">30 Days</option>
                                <option value="60">60 Days</option>
                                <option value="90" selected>90 Days</option>
                                <option value="120">120 Days</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                                <input type="checkbox" id="enableReviewAlerts" onchange="updateTreatmentPlanSettings()" style="width: auto; cursor: pointer;">
                                <span>Enable review period alerts (notification when review is due)</span>
                            </label>
                        </div>

                        <div class="form-group">
                            <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                                <input type="checkbox" id="allowUnlockForReview" onchange="updateTreatmentPlanSettings()" style="width: auto; cursor: pointer;">
                                <span>Allow unlocking treatment plans for review (requires authorization)</span>
                            </label>
                        </div>

                        <div style="margin-top: 20px;">
                            <button onclick="saveClinicalSettings()" class="btn btn-primary"> Save Clinical Settings</button>
                        </div>
                    </div>

                    <div class="card" style="margin-top: 30px;">
                        <h3>CPT Code Selection</h3>
                        <p class="settings-description">Select which CPT codes you frequently use. These will appear in dropdowns for clinical notes, claims, and appointments.</p>

                        <div style="margin-top: 20px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                <h4 style="margin: 0;">Available Mental Health & Psychiatric CPT Codes</h4>
                                <div>
                                    <button onclick="selectAllCPTCodes()" class="btn btn-small">Select All</button>
                                    <button onclick="deselectAllCPTCodes()" class="btn btn-small" style="margin-left: 5px;">Deselect All</button>
                                </div>
                            </div>

                            <div style="max-height: 500px; overflow-y: auto; border: 1px solid var(--border-color); border-radius: 8px; padding: 15px; background: #f8f9fa;">
                                <div id="cptCodesList" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 10px;">
                                    <!-- CPT codes will be populated by JavaScript -->
                                </div>
                            </div>
                        </div>

                        <div style="margin-top: 20px;">
                            <button onclick="saveClinicalSettings()" class="btn btn-primary"> Save Clinical Settings</button>
                        </div>
                    </div>
                </div>

                <div id="subscriptionSettingsTab" class="settings-tab-content" style="display: none;">
                    <!-- Current Plan Card -->
                    <div class="card">
                        <h3>Current Subscription Plan</h3>
                        <div id="currentPlanCard" style="padding: 20px; background: var(--primary-subtle); border-radius: 12px; margin: 15px 0;">
                            <!-- Dynamically loaded current plan info -->
                        </div>
                    </div>

                    <!-- Professional Plan Addon Selection (shown only for Professional users) -->
                    <div id="professionalAddonSection" class="card" style="margin-top: 30px; display: none;">
                        <h3>Professional Plan Add-on</h3>
                        <p class="settings-description">Choose ONE premium feature included with your Professional plan:</p>

                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px;">
                            <!-- AI Notes Addon Card -->
                            <div id="aiNotesAddonCard" class="addon-selection-card" onclick="selectProfessionalAddon('ai_notes')"
                                 style="border: 2px solid var(--border-color); border-radius: 12px; padding: 20px; cursor: pointer; transition: all 0.2s;">
                                <h4 style="margin: 0 0 10px 0;"> AI NoteTaker</h4>
                                <p style="color: var(--text-secondary); font-size: 14px; margin: 0 0 15px 0;">
                                    AI-powered clinical note generation with real-time transcription
                                </p>
                                <ul style="margin: 0 0 15px 20px; color: var(--text-secondary); font-size: 13px;">
                                    <li>Real-time transcription</li>
                                    <li>Multiple note formats</li>
                                    <li>Automated documentation</li>
                                </ul>
                                <div id="aiNotesAddonStatus"></div>
                            </div>

                            <!-- Telehealth Addon Card -->
                            <div id="telehealthAddonCard" class="addon-selection-card" onclick="selectProfessionalAddon('telehealth')"
                                 style="border: 2px solid var(--border-color); border-radius: 12px; padding: 20px; cursor: pointer; transition: all 0.2s;">
                                <h4 style="margin: 0 0 10px 0;"> Telehealth</h4>
                                <p style="color: var(--text-secondary); font-size: 14px; margin: 0 0 15px 0;">
                                    Integrated video sessions directly in the platform
                                </p>
                                <ul style="margin: 0 0 15px 20px; color: var(--text-secondary); font-size: 13px;">
                                    <li>Secure video calls</li>
                                    <li>HIPAA-compliant</li>
                                    <li>Seamless scheduling</li>
                                </ul>
                                <div id="telehealthAddonStatus"></div>
                            </div>
                        </div>

                        <p style="color: var(--text-secondary); font-size: 13px; margin-top: 15px;">
                            * You can change your addon once per billing cycle. To get both features, upgrade to Complete Suite.
                        </p>
                    </div>

                    <!-- Upgrade Options Card -->
                    <div class="card" style="margin-top: 30px;">
                        <h3>Subscription Plans</h3>
                        <p class="settings-description">Compare plans and upgrade anytime:</p>

                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-top: 20px;">
                            <!-- Essential Plan -->
                            <div class="plan-card" style="border: 2px solid var(--border-color); border-radius: 12px; padding: 20px;">
                                <h4 style="margin: 0 0 10px 0;">Essential</h4>
                                <div style="font-size: 32px; font-weight: 700; color: var(--primary-color); margin: 10px 0;">$40</div>
                                <div style="color: var(--text-secondary); font-size: 14px; margin-bottom: 15px;">/month</div>
                                <ul style="margin: 0 0 20px 20px; color: var(--text-secondary); font-size: 13px; list-style: none;">
                                    <li style="margin: 8px 0;"> Client management</li>
                                    <li style="margin: 8px 0;"> Scheduling</li>
                                    <li style="margin: 8px 0;"> Billing & invoicing</li>
                                    <li style="margin: 8px 0;"> Manual notes</li>
                                    <li style="margin: 8px 0;"> 50GB storage</li>
                                    <li style="margin: 8px 0; opacity: 0.5;"> AI Notes</li>
                                    <li style="margin: 8px 0; opacity: 0.5;"> Telehealth</li>
                                </ul>
                                <button id="essentialPlanBtn" class="btn btn-secondary" onclick="changePlan('essential')" style="width: 100%;">
                                    Current Plan
                                </button>
                            </div>

                            <!-- Professional Plan -->
                            <div class="plan-card" style="border: 2px solid var(--primary-color); border-radius: 12px; padding: 20px; position: relative;">
                                <div style="position: absolute; top: -12px; left: 50%; transform: translateX(-50%); background: var(--success-color); color: white; padding: 4px 12px; border-radius: 20px; font-size: 11px; font-weight: 700;">
                                    MOST POPULAR
                                </div>
                                <h4 style="margin: 0 0 10px 0;">Professional</h4>
                                <div style="font-size: 32px; font-weight: 700; color: var(--primary-color); margin: 10px 0;">$60</div>
                                <div style="color: var(--text-secondary); font-size: 14px; margin-bottom: 15px;">/month</div>
                                <ul style="margin: 0 0 20px 20px; color: var(--text-secondary); font-size: 13px; list-style: none;">
                                    <li style="margin: 8px 0;"> Everything in Essential</li>
                                    <li style="margin: 8px 0;"> Choose ONE addon:</li>
                                    <li style="margin: 8px 0; margin-left: 20px;"> AI Notes OR</li>
                                    <li style="margin: 8px 0; margin-left: 20px;"> Telehealth</li>
                                    <li style="margin: 8px 0;"> 100GB storage</li>
                                    <li style="margin: 8px 0;"> Priority support</li>
                                </ul>
                                <button id="professionalPlanBtn" class="btn btn-primary" onclick="changePlan('professional')" style="width: 100%;">
                                    Upgrade to Professional
                                </button>
                            </div>

                            <!-- Complete Suite Plan -->
                            <div class="plan-card" style="border: 2px solid var(--border-color); border-radius: 12px; padding: 20px;">
                                <h4 style="margin: 0 0 10px 0;">Complete Suite</h4>
                                <div style="font-size: 32px; font-weight: 700; color: var(--primary-color); margin: 10px 0;">$80</div>
                                <div style="color: var(--text-secondary); font-size: 14px; margin-bottom: 15px;">/month</div>
                                <ul style="margin: 0 0 20px 20px; color: var(--text-secondary); font-size: 13px; list-style: none;">
                                    <li style="margin: 8px 0;"> Everything in Essential</li>
                                    <li style="margin: 8px 0;"> AI Notes (unlimited)</li>
                                    <li style="margin: 8px 0;"> Telehealth (unlimited)</li>
                                    <li style="margin: 8px 0;"> Multi-clinician (5 users)</li>
                                    <li style="margin: 8px 0;"> 250GB storage</li>
                                    <li style="margin: 8px 0;"> Premium support</li>
                                </ul>
                                <button id="completePlanBtn" class="btn btn-primary" onclick="changePlan('complete')" style="width: 100%;">
                                    Upgrade to Complete
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Billing History (keep existing) -->
                    <div class="card" style="margin-top: 30px;">
                        <div id="billingHistory" class="billing-history">
                            <h4>Billing History</h4>
                            <div id="billingHistoryList" class="billing-history-list">
                                <!-- Billing history will be loaded here -->
                            </div>
                        </div>
                    </div>
                </div>
                
                <div id="profileSettingsTab" class="settings-tab-content" style="display: none;">
                    <div class="card">
                        <h3>Profile Settings</h3>
                        <div class="form-group">
                            <label for="clinicianName">Name:</label>
                            <input type="text" id="clinicianName" class="input" value="${currentUser?.name || ''}">
                        </div>
                        <div class="form-group">
                            <label for="clinicianEmail">Email:</label>
                            <input type="email" id="clinicianEmail" class="input" value="${currentUser?.email || ''}">
                        </div>
                        <div class="form-group">
                            <label for="clinicianPhone">Phone:</label>
                            <input type="tel" id="clinicianPhone" class="input" value="${currentUser?.phone || ''}">
                        </div>
                        <button onclick="saveProfileSettings()" class="btn btn-primary"> Save Profile</button>
                    </div>
                </div>
                
                <div id="practiceSettingsTab" class="settings-tab-content" style="display: none;">
                    <div class="card">
                        <h3>Practice Information</h3>
                        <div class="form-group">
                            <label for="practiceName">Practice Name:</label>
                            <input type="text" id="practiceName" class="input">
                        </div>
                        <div class="form-group">
                            <label for="practiceAddress">Address:</label>
                            <textarea id="practiceAddress" class="input" rows="3"></textarea>
                        </div>
                        <div class="form-group">
                            <label for="practicePhone">Phone:</label>
                            <input type="tel" id="practicePhone" class="input">
                        </div>
                        <button onclick="savePracticeSettings()" class="btn btn-primary"> Save Practice Info</button>
                    </div>

                    <!-- Client Data Import Section -->
                    <div class="card" style="margin-top: 20px;">
                        <h3>Import Client Data</h3>
                        <p class="settings-description">Import client information from other EHR platforms using CSV or PDF files.</p>

                        <div style="margin-top: 20px;">
                            <div class="form-group">
                                <label for="importFileType">Select Import Format:</label>
                                <select id="importFileType" class="input" onchange="updateImportInstructions()">
                                    <option value="">Choose format...</option>
                                    <option value="csv">CSV (Comma-Separated Values)</option>
                                    <option value="pdf">PDF (Extract from Forms)</option>
                                </select>
                            </div>

                            <div id="csvImportSection" style="display: none; margin-top: 20px;">
                                <h4 style="font-size: 16px; margin-bottom: 10px;">CSV Import Instructions</h4>
                                <div style="background: #f8f9fa; padding: 15px; border-radius: 6px; margin-bottom: 15px;">
                                    <p style="font-size: 14px; margin-bottom: 10px;">Required CSV columns:</p>
                                    <code style="display: block; padding: 10px; background: white; border-radius: 4px; font-size: 12px;">
                                        name, email, phone, date_of_birth, address, insurance_info, notes
                                    </code>
                                </div>
                                <input type="file" id="csvImportFile" accept=".csv" class="input" style="padding: 8px;">
                                <button onclick="importCSV()" class="btn btn-primary" style="margin-top: 10px;"> Import CSV</button>
                            </div>

                            <div id="pdfImportSection" style="display: none; margin-top: 20px;">
                                <h4 style="font-size: 16px; margin-bottom: 10px;">PDF Import Instructions</h4>
                                <div style="background: #f8f9fa; padding: 15px; border-radius: 6px; margin-bottom: 15px;">
                                    <p style="font-size: 14px; margin-bottom: 10px;">Upload completed client intake forms or demographic sheets in PDF format. The system will extract:</p>
                                    <ul style="font-size: 13px; margin-left: 20px; color: var(--text-secondary);">
                                        <li>Client name and contact information</li>
                                        <li>Date of birth and demographics</li>
                                        <li>Insurance details</li>
                                        <li>Medical history notes</li>
                                    </ul>
                                </div>
                                <input type="file" id="pdfImportFile" accept=".pdf" multiple class="input" style="padding: 8px;">
                                <button onclick="importPDF()" class="btn btn-primary" style="margin-top: 10px;"> Import PDF(s)</button>
                            </div>

                            <div id="importStatus" style="display: none; margin-top: 15px; padding: 12px; border-radius: 6px;">
                                <!-- Import status messages will appear here -->
                            </div>
                        </div>
                    </div>
                </div>

                <div id="developerSettingsTab" class="settings-tab-content" style="display: none;">
                    <div class="card">
                        <h3>Developer & Testing Settings</h3>
                        <p class="settings-description">Enable testing features for development and demonstration purposes.</p>

                        <div style="margin-top: 20px;">
                            <h4>Test Client</h4>
                            <p style="color: var(--text-secondary); font-size: 14px; margin-bottom: 15px;">
                                Enable a pre-configured test client with sample data for testing features without affecting real client records.
                            </p>
                            <div class="form-group">
                                <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                                    <input type="checkbox" id="testClientEnabled" onchange="toggleTestClient()" style="width: auto; cursor: pointer;">
                                    <span>Enable Test Client</span>
                                </label>
                            </div>
                            <div id="testClientInfo" style="display: none; margin-top: 15px; padding: 15px; background: #f0f9ff; border: 1px solid #0ea5e9; border-radius: 8px;">
                                <p style="font-size: 14px; color: #0369a1; margin: 0;">
                                    <strong> Test Client Active</strong><br>
                                    Name: Test Client (Demo)<br>
                                    Email: testclient@example.com<br>
                                    Phone: (555) 123-4567<br>
                                    DOB: 1990-01-15
                                </p>
                            </div>
                        </div>

                        <div style="margin-top: 30px;">
                            <button onclick="saveDeveloperSettings()" class="btn btn-primary"> Save Developer Settings</button>
                        </div>
                    </div>
                </div>
            </div>

            <div id="auditContent" class="tab-content">
                <div class="content-header">
                    <h2>Audit Log</h2>
                </div>
                <div id="auditList"></div>
            </div>

            <!-- ARCHIVED: Reports Feature Content -->
            <!--
            <div id="reportsContent" class="tab-content">
                <div class="content-header">
                    <h2>Reports & Analytics</h2>
                    <div>
                        <select id="reportType" class="input" style="width: auto; margin-right: 10px;" onchange="generateReport()">
                            <option value="client-summary">Client Summary</option>
                            <option value="appointment-trends">Appointment Trends</option>
                            <option value="revenue-report">Revenue Report</option>
                            <option value="payment-history">Payment History</option>
                            <option value="document-completion">Document Completion</option>
                        </select>
                        <button class="btn" onclick="exportReport()"> Export PDF</button>
                    </div>
                </div>
                <div id="reportContent">
                    <div class="card">
                        <h3>Report Generator</h3>
                        <p>Select a report type above to generate detailed analytics and insights for your practice.</p>
                        <div class="report-preview" style="display: none;">
                            <div class="report-header">
                                <h4 id="reportTitle"></h4>
                                <p id="reportDate"></p>
                            </div>
                            <div id="reportData"></div>
                        </div>
                    </div>
                </div>
            </div>
            -->

            <!-- ARCHIVED: Insurance Feature Content -->
            <!--
            <div id="insuranceContent" class="tab-content">
                <div class="content-header">
                    <h2>Insurance Management</h2>
                    <div>
                        <button class="btn btn-primary" onclick="openVerifyBenefits()"> Verify Benefits</button>
                        <button class="btn btn-primary" onclick="openSubmitClaim()"> Submit Claim</button>
                    </div>
                </div>
                (Content omitted for brevity - see archive/v1-features/insurance/)
            </div>
            -->

            <div id="notificationsContent" class="tab-content">
                <div class="content-header">
                    <h2>Notifications Center</h2>
                    <div>
                        <button class="btn" onclick="markAllAsRead()"> Mark All Read</button>
                        <button class="btn" onclick="clearAllNotifications()"> Clear All</button>
                    </div>
                </div>
                <div id="notificationsList">
                    <div class="card">
                        <h3>Real-time Notifications</h3>
                        <p>Stay updated with important events in your practice.</p>
                        <div class="notification-settings">
                            <h4>Notification Settings</h4>
                            <div class="setting-item">
                                <label>
                                    <input type="checkbox" id="emailNotifications" checked>
                                    Email notifications for new appointments
                                </label>
                            </div>
                            <div class="setting-item">
                                <label>
                                    <input type="checkbox" id="docNotifications" checked>
                                    Notifications for completed documents
                                </label>
                            </div>
                            <div class="setting-item">
                                <label>
                                    <input type="checkbox" id="paymentNotifications" checked>
                                    Payment reminders and updates
                                </label>
                            </div>
                            <div class="setting-item">
                                <label>
                                    <input type="checkbox" id="systemNotifications" checked>
                                    System updates and maintenance alerts
                                </label>
                            </div>
                        </div>
                    </div>
                    <div id="notificationsContainer">
                        <!-- Notifications will be loaded here -->
                    </div>
                </div>
            </div>
            </div> <!-- End app-content-wrapper -->
        </div> <!-- End content -->
    </div> <!-- End app-container -->

    <div class="client-portal" id="clientPortal">
        <div class="header">
            <h1>Sessionably</h1>
            <button onclick="clientLogout()" class="btn">Exit</button>
        </div>
        <div class="client-portal-content" id="clientPortalContent"></div>
    </div>

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-content">
            <div class="loading-spinner-large"></div>
            <p class="loading-text">Loading Sessionably...</p>
        </div>
    </div>

    <!-- Modals -->
    <!-- First Time Setup Modal -->
    <div id="firstTimeSetupModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 500px;">
            <h2 style="text-align: center; color: var(--primary-color);">Welcome to Sessionably</h2>
            <p style="text-align: center; color: var(--text-secondary); margin: 20px 0;">Let's set up your first administrator account</p>
            
            <div class="form-group">
                <label for="setupFullName">Full Name *</label>
                <input type="text" id="setupFullName" placeholder="Your Full Name" class="input" required>
            </div>
            
            <div class="form-group">
                <label for="setupEmail">Email *</label>
                <input type="email" id="setupEmail" placeholder="your@email.com" class="input" required>
            </div>
            
            <div class="form-group">
                <label for="setupUsername">Username *</label>
                <input type="text" id="setupUsername" placeholder="Choose a username" class="input" required>
            </div>
            
            <div class="form-group">
                <label for="setupPassword">Password *</label>
                <input type="password" id="setupPassword" placeholder="Create a secure password" class="input" required>
                <small style="color: var(--text-secondary); font-size: 12px;">Minimum 8 characters recommended</small>
            </div>
            
            <div class="form-group">
                <label for="setupConfirmPassword">Confirm Password *</label>
                <input type="password" id="setupConfirmPassword" placeholder="Confirm your password" class="input" required>
            </div>
            
            <button onclick="completeFirstTimeSetup()" class="btn btn-primary" style="width: 100%; margin-top: 20px;">
                Complete Setup
            </button>
            
            <p style="text-align: center; font-size: 12px; color: var(--text-secondary); margin-top: 15px;">
                This will create your administrator account and initialize the system.
            </p>
        </div>
    </div>

    <div id="newClientModal" class="modal">
        <div class="modal-content" style="max-width: 800px; max-height: 90vh; overflow-y: auto;">
            <span class="close" onclick="closeModal('newClientModal')">&times;</span>
            <h2>New Client</h2>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-top: 20px;">
                <!-- Personal Information -->
                <div style="grid-column: 1 / -1;">
                    <h3 style="color: var(--primary-color); font-size: 16px; margin-bottom: 12px; border-bottom: 2px solid var(--primary-subtle); padding-bottom: 8px;">Personal Information</h3>
                </div>

                <div>
                    <label for="clientName" style="display: block; margin-bottom: 4px; font-weight: 500; color: var(--text-primary);">Full Name *</label>
                    <input type="text" id="clientName" placeholder="Full Name" class="input" required>
                </div>

                <div>
                    <label for="clientDOB" style="display: block; margin-bottom: 4px; font-weight: 500; color: var(--text-primary);">Date of Birth</label>
                    <input type="date" id="clientDOB" class="input">
                </div>

                <!-- Contact Information -->
                <div style="grid-column: 1 / -1; margin-top: 12px;">
                    <h3 style="color: var(--primary-color); font-size: 16px; margin-bottom: 12px; border-bottom: 2px solid var(--primary-subtle); padding-bottom: 8px;">Contact Information</h3>
                </div>

                <div>
                    <label for="clientEmail" style="display: block; margin-bottom: 4px; font-weight: 500; color: var(--text-primary);">Email</label>
                    <input type="email" id="clientEmail" placeholder="email@example.com" class="input">
                </div>

                <div>
                    <label for="clientPhone" style="display: block; margin-bottom: 4px; font-weight: 500; color: var(--text-primary);">Phone</label>
                    <input type="tel" id="clientPhone" placeholder="(555) 123-4567" class="input">
                </div>

                <div style="grid-column: 1 / -1;">
                    <label for="clientAddress" style="display: block; margin-bottom: 4px; font-weight: 500; color: var(--text-primary);">Address</label>
                    <input type="text" id="clientAddress" placeholder="Street Address" class="input">
                </div>

                <div>
                    <label for="clientCity" style="display: block; margin-bottom: 4px; font-weight: 500; color: var(--text-primary);">City</label>
                    <input type="text" id="clientCity" placeholder="City" class="input">
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                    <div>
                        <label for="clientState" style="display: block; margin-bottom: 4px; font-weight: 500; color: var(--text-primary);">State</label>
                        <input type="text" id="clientState" placeholder="State" class="input" maxlength="2">
                    </div>
                    <div>
                        <label for="clientZip" style="display: block; margin-bottom: 4px; font-weight: 500; color: var(--text-primary);">ZIP Code</label>
                        <input type="text" id="clientZip" placeholder="ZIP" class="input">
                    </div>
                </div>

                <!-- Emergency Contact -->
                <div style="grid-column: 1 / -1; margin-top: 12px;">
                    <h3 style="color: var(--primary-color); font-size: 16px; margin-bottom: 12px; border-bottom: 2px solid var(--primary-subtle); padding-bottom: 8px;">Emergency Contact</h3>
                </div>

                <div>
                    <label for="clientEmergencyContact" style="display: block; margin-bottom: 4px; font-weight: 500; color: var(--text-primary);">Emergency Contact Name</label>
                    <input type="text" id="clientEmergencyContact" placeholder="Emergency Contact" class="input">
                </div>

                <div>
                    <label for="clientEmergencyPhone" style="display: block; margin-bottom: 4px; font-weight: 500; color: var(--text-primary);">Emergency Phone</label>
                    <input type="tel" id="clientEmergencyPhone" placeholder="(555) 123-4567" class="input">
                </div>

                <!-- Additional Information -->
                <div style="grid-column: 1 / -1; margin-top: 12px;">
                    <h3 style="color: var(--primary-color); font-size: 16px; margin-bottom: 12px; border-bottom: 2px solid var(--primary-subtle); padding-bottom: 8px;">Additional Information</h3>
                </div>

                <div>
                    <label for="clientStatus" style="display: block; margin-bottom: 4px; font-weight: 500; color: var(--text-primary);">Status</label>
                    <select id="clientStatus" class="input">
                        <option value="active">Active</option>
                        <option value="inactive">Inactive</option>
                        <option value="pending">Pending</option>
                    </select>
                </div>

                <div style="grid-column: 1 / -1;">
                    <label for="clientNotes" style="display: block; margin-bottom: 4px; font-weight: 500; color: var(--text-primary);">Notes</label>
                    <textarea id="clientNotes" placeholder="Clinical notes, preferences, etc." class="input" rows="3"></textarea>
                </div>

                <div style="grid-column: 1 / -1; margin: 15px 0;">
                    <label style="display: flex; align-items: center; cursor: pointer;">
                        <input type="checkbox" id="clientSuperbill" style="margin-right: 8px;">
                        <span>Send monthly superbill to this client</span>
                    </label>
                </div>
            </div>

            <div style="display: flex; gap: 12px; margin-top: 24px;">
                <button onclick="saveClient()" class="btn btn-primary" style="flex: 1;">Save Client</button>
                <button onclick="closeModal('newClientModal')" class="btn btn-secondary">Cancel</button>
            </div>
        </div>
    </div>

    <div id="editClientModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('editClientModal')">&times;</span>
            <h2>Edit Client</h2>
            <input type="hidden" id="editClientId">
            <input type="text" id="editClientName" placeholder="Full Name" class="input">
            <input type="email" id="editClientEmail" placeholder="Email" class="input">
            <input type="tel" id="editClientPhone" placeholder="Phone" class="input">
            <input type="date" id="editClientDOB" class="input">
            <textarea id="editClientNotes" placeholder="Notes" class="input"></textarea>
            <div style="margin: 15px 0;">
                <label style="display: flex; align-items: center; cursor: pointer;">
                    <input type="checkbox" id="editClientSuperbill" style="margin-right: 8px;">
                    <span>Send monthly superbill to this client</span>
                </label>
            </div>
            <button onclick="updateClient()" class="btn btn-primary">Update Client</button>
        </div>
    </div>

    <div id="assignDocModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('assignDocModal')">&times;</span>
            <h2>Assign Documents</h2>
            
            <!-- Assignment Mode Toggle -->
            <div style="margin-bottom: 20px;">
                <label style="display: flex; align-items: center; gap: 10px;">
                    <input type="radio" name="assignMode" value="single" checked onchange="toggleAssignMode()">
                    Single Client
                </label>
                <label style="display: flex; align-items: center; gap: 10px;">
                    <input type="radio" name="assignMode" value="bulk" onchange="toggleAssignMode()">
                    Bulk Assignment
                </label>
            </div>
            
            <!-- Single Client Assignment -->
            <div id="singleClientSection">
            <select id="assignClient" class="input"><option value="">Select Client</option></select>
            </div>
            
            <!-- Bulk Client Assignment -->
            <div id="bulkClientSection" style="display: none;">
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 10px; font-weight: 500;">Select Clients (check multiple):</label>
                    <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                        <button onclick="selectAllClients()" class="btn btn-sm">Select All Clients</button>
                        <button onclick="deselectAllClients()" class="btn btn-sm">Clear All</button>
                    </div>
                    <div id="clientCheckboxContainer" style="max-height: 200px; overflow-y: auto; border: 1px solid #ddd; padding: 15px; border-radius: 6px; background: #f8f9fa;"></div>
                </div>
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 10px; font-weight: 500;">Expiration Days:</label>
                    <input type="number" id="expirationDays" value="30" min="1" max="365" class="input" style="width: 100px;">
                </div>
            </div>
            
            <!-- Document Selection -->
            <div style="margin: 20px 0;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <p style="font-weight: 500;">Select Documents (check multiple):</p>
                    <div>
                        <button onclick="selectAllDocs()" class="btn" style="font-size: 12px; padding: 5px 10px; margin-right: 5px;">Select All</button>
                        <button onclick="deselectAllDocs()" class="btn" style="font-size: 12px; padding: 5px 10px;">Clear All</button>
                    </div>
                </div>
                <div id="templateCheckboxContainer" style="max-height: 400px; overflow-y: auto; border: 1px solid #ddd; padding: 15px; border-radius: 6px; background: #f8f9fa;"></div>
                <p id="selectedCount" style="margin-top: 10px; font-size: 14px; color: #E85D4F; font-weight: 500;"></p>
            </div>
            
            <div style="display: flex; gap: 10px;">
            <button onclick="saveAssignDoc()" class="btn btn-primary">Assign Documents</button>
                <button onclick="openBulkAssignModal()" class="btn btn-secondary" id="bulkAssignBtn" style="display: none;">Bulk Assign</button>
            </div>
        </div>
    </div>

    <div id="successModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('successModal')">&times;</span>
            <h2>Documents Assigned!</h2>
            <div style="background: #FFE5E0; padding: 20px; border-radius: 8px; margin: 20px 0;">
                <h3 style="color: #E85D4F;">Authentication Code:</h3>
                <div id="generatedCode" style="font-family: monospace; font-size: 24px; font-weight: bold; text-align: center; padding: 15px; background: white; border-radius: 6px; margin: 10px 0;"></div>
                <p style="font-size: 14px; color: #666; margin-top: 15px;">Share this code with your client.</p>
                <div id="assignedDocsList" style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #F4A261;"></div>
            </div>
            <button onclick="closeModal('successModal')" class="btn btn-primary">Done</button>
        </div>
    </div>

    <!-- New Appointment Modal -->
    <div id="newAppointmentModal" class="modal">
        <div class="modal-content" style="max-width: 700px; max-height: 90vh; overflow-y: auto;">
            <span class="close" onclick="closeModal('newAppointmentModal')">&times;</span>
            <h2>New Appointment</h2>

            <div style="display: grid; gap: 16px; margin-top: 20px;">
                <!-- Client Selection -->
                <div style="grid-column: 1 / -1;">
                    <h3 style="color: var(--primary-color); font-size: 16px; margin-bottom: 12px; border-bottom: 2px solid var(--primary-subtle); padding-bottom: 8px;">Client & Session Type</h3>
                </div>

                <div>
                    <label for="appointmentClient" style="display: block; margin-bottom: 4px; font-weight: 500; color: var(--text-primary);">Client *</label>
                    <select id="appointmentClient" class="input" required>
                        <option value="">Select Client</option>
                    </select>
                </div>

                <div>
                    <label for="appointmentModality" style="display: block; margin-bottom: 4px; font-weight: 500; color: var(--text-primary);">Modality *</label>
                    <select id="appointmentModality" class="input" required>
                        <option value="in-person">In-Person</option>
                        <option value="telehealth">Telehealth (Video)</option>
                    </select>
                </div>

                <!-- Date & Time -->
                <div style="grid-column: 1 / -1; margin-top: 12px;">
                    <h3 style="color: var(--primary-color); font-size: 16px; margin-bottom: 12px; border-bottom: 2px solid var(--primary-subtle); padding-bottom: 8px;">Date & Time</h3>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 16px;">
                    <div>
                        <label for="appointmentDate" style="display: block; margin-bottom: 4px; font-weight: 500; color: var(--text-primary);">Date *</label>
                        <input type="date" id="appointmentDate" class="input" required>
                    </div>

                    <div>
                        <label for="appointmentTime" style="display: block; margin-bottom: 4px; font-weight: 500; color: var(--text-primary);">Time *</label>
                        <input type="time" id="appointmentTime" class="input" required>
                    </div>

                    <div>
                        <label for="appointmentDuration" style="display: block; margin-bottom: 4px; font-weight: 500; color: var(--text-primary);">Duration (min)</label>
                        <select id="appointmentDuration" class="input">
                            <option value="15">15 minutes</option>
                            <option value="30">30 minutes</option>
                            <option value="45">45 minutes</option>
                            <option value="60" selected>60 minutes</option>
                            <option value="90">90 minutes</option>
                            <option value="120">120 minutes</option>
                        </select>
                    </div>
                </div>

                <!-- Session Information -->
                <div style="grid-column: 1 / -1; margin-top: 12px;">
                    <h3 style="color: var(--primary-color); font-size: 16px; margin-bottom: 12px; border-bottom: 2px solid var(--primary-subtle); padding-bottom: 8px;">Session Information</h3>
                </div>

                <div>
                    <label for="appointmentType" style="display: block; margin-bottom: 4px; font-weight: 500; color: var(--text-primary);">Session Type</label>
                    <select id="appointmentType" class="input">
                        <option value="">Select Type</option>
                        <option value="90791">Psychiatric Diagnostic Evaluation (90791)</option>
                        <option value="90834">Psychotherapy 45 min (90834)</option>
                        <option value="90837">Psychotherapy 60 min (90837)</option>
                        <option value="90847">Family Psychotherapy (90847)</option>
                        <option value="90853">Group Psychotherapy (90853)</option>
                    </select>
                </div>

                <div>
                    <label for="appointmentStatus" style="display: block; margin-bottom: 4px; font-weight: 500; color: var(--text-primary);">Status</label>
                    <select id="appointmentStatus" class="input">
                        <option value="scheduled">Scheduled</option>
                        <option value="confirmed">Confirmed</option>
                        <option value="completed">Completed</option>
                        <option value="cancelled">Cancelled</option>
                        <option value="no-show">No Show</option>
                    </select>
                </div>

                <div style="grid-column: 1 / -1;">
                    <label for="appointmentTitle" style="display: block; margin-bottom: 4px; font-weight: 500; color: var(--text-primary);">Title</label>
                    <input type="text" id="appointmentTitle" placeholder="e.g., Initial Consultation, Follow-up Session" class="input" value="Session">
                </div>

                <div style="grid-column: 1 / -1;">
                    <label for="appointmentNotes" style="display: block; margin-bottom: 4px; font-weight: 500; color: var(--text-primary);">Notes</label>
                    <textarea id="appointmentNotes" placeholder="Session notes, preparation reminders, etc." class="input" rows="3"></textarea>
                </div>
            </div>

            <div style="display: flex; gap: 12px; margin-top: 24px;">
                <button onclick="saveAppointment()" class="btn btn-primary" style="flex: 1;">Save Appointment</button>
                <button onclick="closeModal('newAppointmentModal')" class="btn btn-secondary">Cancel</button>
            </div>
        </div>
    </div>

    <!-- New Invoice Modal -->
    <div id="newInvoiceModal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <span class="close" onclick="closeModal('newInvoiceModal')">&times;</span>
            <h2>New Invoice</h2>
            <select id="invoiceClient" class="input">
                <option value="">Select Client</option>
            </select>
            <input type="date" id="invoiceDueDate" class="input">
            <textarea id="invoiceNotes" placeholder="Additional Notes" class="input"></textarea>
            
            <h3>Services</h3>
            <div id="servicesList" class="services-container">
                <div class="service-item">
                    <input type="text" placeholder="Service Description" class="input service-desc">
                    <select class="input service-cpt">
                        <option value="">CPT Code</option>
                        <option value="90791">90791 - Psychiatric Diagnostic Evaluation</option>
                        <option value="90834">90834 - Psychotherapy 45 min</option>
                        <option value="90837">90837 - Psychotherapy 60 min</option>
                        <option value="90847">90847 - Family Psychotherapy</option>
                        <option value="90853">90853 - Group Psychotherapy</option>
                    </select>
                    <input type="number" placeholder="Amount" class="input service-amount" step="0.01">
                    <button onclick="removeService(this)" class="btn btn-danger btn-small">Remove</button>
                </div>
            </div>
            <button onclick="addService()" class="btn">+ Add Service</button>
            
            <div class="invoice-total">
                <h3>Total: $<span id="invoiceTotal">0.00</span></h3>
            </div>
            
            <div style="margin: 20px 0;">
                <label style="display: flex; align-items: center; gap: 10px; font-weight: 500;">
                    <input type="checkbox" id="emailInvoiceOption" style="transform: scale(1.2);">
                     Email invoice to client
                </label>
                <p style="color: #666; font-size: 14px; margin: 5px 0 0 0;">
                    Send a professional invoice email to the client's email address
                </p>
            </div>
            
            <button onclick="saveInvoice()" class="btn btn-primary">Create Invoice</button>
        </div>
    </div>

    <!-- Client Chart Modal -->
    <div id="clientChartModal" class="modal">
        <div class="modal-content" style="max-width: 1200px; max-height: 90vh; overflow-y: auto;">
            <span class="close" onclick="closeModal('clientChartModal')">&times;</span>
            <div class="client-chart-header">
                <div>
                    <h2 id="chartClientName">Client Chart</h2>
                    <p id="chartClientInfo" style="color: #666; font-size: 14px;"></p>
                </div>
                <div style="display: flex; gap: 10px;">
                    <button onclick="scheduleFromChart()" class="btn btn-primary btn-small"> Schedule</button>
                    <button onclick="assignDocFromChart()" class="btn btn-primary btn-small"> Assign Doc</button>
                    <button onclick="createInvoiceFromChart()" class="btn btn-primary btn-small"> Invoice</button>
                    <button onclick="openEditClientFromChart()" class="btn btn-small"> Edit</button>
                </div>
            </div>
            
            <div class="chart-tabs">
                <button class="chart-tab-btn active" onclick="showChartTab('overview')">Overview</button>
                <button class="chart-tab-btn" onclick="showChartTab('appointments')">Appointments</button>
                <button class="chart-tab-btn" onclick="showChartTab('documents')">Documents</button>
                <button class="chart-tab-btn" onclick="showChartTab('invoices')">Invoices</button>
                <button class="chart-tab-btn" onclick="showChartTab('billing')">Billing</button>
                <button class="chart-tab-btn" onclick="showChartTab('notes')">Notes</button>
                <button class="chart-tab-btn" onclick="showChartTab('treatmentplans')">Treatment Plans</button>
            </div>
            
            <div id="chartOverviewTab" class="chart-tab-content active">
                <div class="analytics-grid" style="margin-top: 20px;">
                    <div class="stat-card">
                        <h3>Total Appointments</h3>
                        <div class="stat-number" id="chartTotalAppts">0</div>
                    </div>
                    <div class="stat-card">
                        <h3>Completed Sessions</h3>
                        <div class="stat-number" id="chartCompletedAppts">0</div>
                    </div>
                    <div class="stat-card">
                        <h3>Pending Documents</h3>
                        <div class="stat-number" id="chartPendingDocs">0</div>
                    </div>
                    <div class="stat-card">
                        <h3>Total Billed</h3>
                        <div class="stat-number" id="chartTotalBilled">$0</div>
                    </div>
                </div>
                <div id="chartOverviewContent"></div>
            </div>
            
            <div id="chartAppointmentsTab" class="chart-tab-content">
                <div id="clientAppointmentsList" class="appointments-list" style="margin-top: 20px;"></div>
            </div>
            
            <div id="chartDocumentsTab" class="chart-tab-content">
                <div id="chartDocumentsContent" style="margin-top: 20px;"></div>
            </div>
            
            <div id="chartInvoicesTab" class="chart-tab-content">
                <div style="margin-bottom: 15px; display: flex; gap: 10px; align-items: center;">
                    <button onclick="generateSuperbill()" class="btn btn-secondary"> Generate Monthly Superbill</button>
                    <span style="color: #6c757d; font-size: 14px;">Generate a superbill for insurance reimbursement</span>
                </div>
                <div id="chartInvoicesContent" style="margin-top: 20px;"></div>
            </div>
            
            <div id="chartBillingTab" class="chart-tab-content">
                <div id="chartBillingContent" style="margin-top: 20px;"></div>
            </div>
            
            <div id="chartNotesTab" class="chart-tab-content">
                <div id="chartNotesContent" style="margin-top: 20px;"></div>
            </div>

            <div id="chartTreatmentPlansTab" class="chart-tab-content">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 20px; margin-bottom: 20px;">
                    <h3>Treatment Plans</h3>
                    <button onclick="openNewTreatmentPlan()" class="btn btn-primary">+ New Treatment Plan</button>
                </div>
                <div id="chartTreatmentPlansContent"></div>
            </div>
        </div>
    </div>

    <!-- Clinical Note View/Edit Modal -->
    <div id="clinicalNoteModal" class="modal">
        <div class="modal-content" style="max-width: 900px;">
            <span class="close" onclick="closeModal('clinicalNoteModal')">&times;</span>
            <h2>Clinical Note</h2>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px; padding: 15px; background: #f8fafc; border-radius: 8px;">
                <div>
                    <strong>Client:</strong> <span id="viewNoteClient">-</span>
                </div>
                <div>
                    <strong>Session Date:</strong> <span id="viewNoteDate">-</span>
                </div>
                <div>
                    <strong>Format:</strong> <span id="viewNoteFormat">-</span>
                </div>
                <div>
                    <strong>Session Type:</strong> <span id="viewNoteType">-</span>
                </div>
                <div>
                    <strong>Created By:</strong> <span id="viewNoteCreatedBy">-</span>
                </div>
                <div id="viewNoteSignedInfo" style="display: none;">
                    <strong> Signed By:</strong> <span id="viewNoteSignedBy">-</span>
                </div>
            </div>

            <!-- Transcript Section -->
            <div style="margin-bottom: 20px;">
                <h3 style="margin-bottom: 10px;">Transcript</h3>
                <div id="viewNoteTranscript" style="max-height: 200px; overflow-y: auto; padding: 15px; background: #f7f7f7; border-radius: 8px; border: 1px solid var(--border-color); white-space: pre-wrap; line-height: 1.6;">
                    No transcript
                </div>
            </div>

            <!-- Clinical Note Section -->
            <div style="margin-bottom: 20px;">
                <h3 style="margin-bottom: 10px;">Clinical Note</h3>
                <div id="viewNoteClinicalNote" style="max-height: 400px; overflow-y: auto; padding: 20px; background: #ffffff; border-radius: 8px; border: 1px solid var(--border-color); line-height: 1.8;">
                    Loading...
                </div>
            </div>

            <!-- Actions -->
            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                <button id="editNoteBtn" onclick="enableNoteEditing()" class="btn btn-secondary"> Edit Note</button>
                <button id="signNoteBtn" onclick="openSignatureModal()" class="btn btn-primary"> Sign Note</button>
                <button id="saveNoteEditBtn" onclick="saveNoteEdit()" class="btn btn-primary" style="display: none;"> Save Changes</button>
                <button id="cancelNoteEditBtn" onclick="cancelNoteEdit()" class="btn btn-secondary" style="display: none;">Cancel</button>
                <button onclick="copyNoteText()" class="btn btn-secondary">Copy</button>
                <button onclick="downloadNoteText()" class="btn btn-secondary"> Download</button>
                <button id="deleteNoteBtn" onclick="deleteClinicalNote()" class="btn" style="background: #e74c3c; color: white;"> Delete</button>
            </div>
        </div>
    </div>

    <!-- Digital Signature Modal -->
    <div id="signatureModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <span class="close" onclick="closeModal('signatureModal')">&times;</span>
            <h2>Sign Clinical Note</h2>

            <p style="margin-bottom: 20px; color: var(--text-secondary);">
                By signing this note, you certify that it is accurate and complete. Signed notes cannot be edited or deleted.
            </p>

            <div style="margin-bottom: 20px;">
                <label class="label">Signature Method:</label>
                <select id="signatureMethod" class="input" onchange="toggleSignatureInput()">
                    <option value="typed">Typed Signature</option>
                    <option value="drawn">Draw Signature</option>
                </select>
            </div>

            <!-- Typed Signature -->
            <div id="typedSignatureSection" style="margin-bottom: 20px;">
                <label class="label">Type Your Full Name:</label>
                <input type="text" id="typedSignature" class="input" placeholder="Dr. Jane Smith">
                <div id="typedSignaturePreview" style="margin-top: 10px; padding: 15px; background: #f7f7f7; border-radius: 8px; font-family: 'Kalam', cursive; font-size: 24px; text-align: center; min-height: 60px; border: 1px dashed var(--border-color);">
                    Signature will appear here...
                </div>
            </div>

            <!-- Drawn Signature -->
            <div id="drawnSignatureSection" style="display: none; margin-bottom: 20px;">
                <label class="label">Draw Your Signature:</label>
                <canvas id="signatureCanvas" style="width: 100%; height: 150px; border: 2px solid var(--border-color); border-radius: 8px; background: white; cursor: crosshair;"></canvas>
                <div style="margin-top: 10px;">
                    <button onclick="clearSignature()" class="btn btn-secondary">Clear</button>
                </div>
            </div>

            <div style="margin-bottom: 20px;">
                <label style="display: flex; align-items: center; cursor: pointer;">
                    <input type="checkbox" id="signatureConfirm" style="margin-right: 8px;">
                    <span>I confirm that this clinical note is accurate and complete</span>
                </label>
            </div>

            <div style="display: flex; gap: 10px;">
                <button onclick="confirmSignNote()" class="btn btn-primary"> Sign & Lock Note</button>
                <button onclick="closeModal('signatureModal')" class="btn btn-secondary">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Treatment Plan Modal (Create/Edit) -->
    <div id="treatmentPlanModal" class="modal">
        <div class="modal-content" style="max-width: 1000px; max-height: 90vh; overflow-y: auto;">
            <span class="close" onclick="closeModal('treatmentPlanModal')">&times;</span>
            <h2 id="treatmentPlanModalTitle">New Treatment Plan</h2>

            <input type="hidden" id="treatmentPlanId">
            <input type="hidden" id="treatmentPlanClientId">

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                <div>
                    <label class="label">Plan Date:</label>
                    <input type="date" id="treatmentPlanDate" class="input">
                </div>
                <div>
                    <label class="label">Review Date:</label>
                    <input type="date" id="treatmentPlanReviewDate" class="input">
                </div>
            </div>

            <div style="margin-bottom: 20px;">
                <label class="label">Diagnoses (DSM-5/ICD-10): *</label>
                <textarea id="treatmentPlanDiagnoses" class="input" rows="3" placeholder="e.g., F41.1 - Generalized Anxiety Disorder&#10;F33.1 - Major Depressive Disorder, Recurrent, Moderate" required></textarea>
                <small style="color: #666;">Enter all relevant diagnoses with codes</small>
            </div>

            <div style="margin-bottom: 20px;">
                <label class="label">Presenting Problems: *</label>
                <textarea id="treatmentPlanProblems" class="input" rows="4" placeholder="Describe the client's presenting problems and symptoms..." required></textarea>
            </div>

            <div style="margin-bottom: 20px;">
                <label class="label">Treatment Goals: *</label>
                <textarea id="treatmentPlanGoals" class="input" rows="5" placeholder="1. Client will reduce anxiety symptoms by 50% within 3 months&#10;2. Client will develop 3 healthy coping strategies&#10;3. Client will improve sleep quality to 7+ hours nightly" required></textarea>
                <small style="color: #666;">List specific, measurable treatment goals</small>
            </div>

            <div style="margin-bottom: 20px;">
                <label class="label">Objective Data / Clinical Observations:</label>
                <textarea id="treatmentPlanObjectiveData" class="input" rows="4" placeholder="Include assessment results, baseline measurements, clinical observations...&#10;e.g., PHQ-9 score: 18 (moderately severe depression)&#10;GAD-7 score: 15 (moderate anxiety)"></textarea>
            </div>

            <div style="margin-bottom: 20px;">
                <label class="label">Treatment Frequency: *</label>
                <input type="text" id="treatmentPlanFrequency" class="input" placeholder="e.g., Weekly individual therapy (60 min)" required>
                <small style="color: #666;">Specify session frequency, duration, and modality</small>
            </div>

            <div style="margin-bottom: 20px;">
                <label class="label">Status:</label>
                <select id="treatmentPlanStatus" class="input">
                    <option value="active">Active</option>
                    <option value="completed">Completed</option>
                    <option value="discontinued">Discontinued</option>
                </select>
            </div>

            <div id="treatmentPlanSignedInfo" style="display: none; margin-bottom: 20px; padding: 15px; background: #e8f5e9; border-left: 4px solid #4caf50; border-radius: 8px;">
                <strong>Signed By:</strong> <span id="treatmentPlanSignedBy">-</span><br>
                <strong>Signed At:</strong> <span id="treatmentPlanSignedAt">-</span>
            </div>

            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                <button id="saveTreatmentPlanBtn" onclick="saveTreatmentPlan()" class="btn btn-primary">Save Treatment Plan</button>
                <button id="signTreatmentPlanBtn" onclick="signTreatmentPlan()" class="btn btn-success" style="display: none;">Sign & Lock Plan</button>
                <button onclick="closeModal('treatmentPlanModal')" class="btn btn-secondary">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Treatment Plan View Modal (Read-only for signed plans) -->
    <div id="viewTreatmentPlanModal" class="modal">
        <div class="modal-content" style="max-width: 1000px; max-height: 90vh; overflow-y: auto;">
            <span class="close" onclick="closeModal('viewTreatmentPlanModal')">&times;</span>
            <h2>Treatment Plan</h2>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px; padding: 15px; background: #f8fafc; border-radius: 8px;">
                <div>
                    <strong>Client:</strong> <span id="viewPlanClient">-</span>
                </div>
                <div>
                    <strong>Plan Date:</strong> <span id="viewPlanDate">-</span>
                </div>
                <div>
                    <strong>Review Date:</strong> <span id="viewPlanReviewDate">-</span>
                </div>
                <div>
                    <strong>Status:</strong> <span id="viewPlanStatus">-</span>
                </div>
                <div>
                    <strong>Created By:</strong> <span id="viewPlanCreatedBy">-</span>
                </div>
                <div id="viewPlanSignedInfo" style="display: none;">
                    <strong> Signed By:</strong> <span id="viewPlanSignedBy">-</span><br>
                    <strong>Signed At:</strong> <span id="viewPlanSignedAt">-</span>
                </div>
            </div>

            <div style="margin-bottom: 20px;">
                <h3 style="margin-bottom: 10px; color: var(--primary-color);">Diagnoses</h3>
                <div id="viewPlanDiagnoses" style="padding: 15px; background: #ffffff; border-radius: 8px; border: 1px solid var(--border-color); white-space: pre-wrap;"></div>
            </div>

            <div style="margin-bottom: 20px;">
                <h3 style="margin-bottom: 10px; color: var(--primary-color);">Presenting Problems</h3>
                <div id="viewPlanProblems" style="padding: 15px; background: #ffffff; border-radius: 8px; border: 1px solid var(--border-color); white-space: pre-wrap;"></div>
            </div>

            <div style="margin-bottom: 20px;">
                <h3 style="margin-bottom: 10px; color: var(--primary-color);">Treatment Goals</h3>
                <div id="viewPlanGoals" style="padding: 15px; background: #ffffff; border-radius: 8px; border: 1px solid var(--border-color); white-space: pre-wrap;"></div>
            </div>

            <div style="margin-bottom: 20px;">
                <h3 style="margin-bottom: 10px; color: var(--primary-color);">Objective Data</h3>
                <div id="viewPlanObjectiveData" style="padding: 15px; background: #ffffff; border-radius: 8px; border: 1px solid var(--border-color); white-space: pre-wrap;"></div>
            </div>

            <div style="margin-bottom: 20px;">
                <h3 style="margin-bottom: 10px; color: var(--primary-color);">Treatment Frequency</h3>
                <div id="viewPlanFrequency" style="padding: 15px; background: #ffffff; border-radius: 8px; border: 1px solid var(--border-color);"></div>
            </div>

            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                <button id="editTreatmentPlanBtn" onclick="editTreatmentPlan()" class="btn btn-secondary">Edit</button>
                <button id="signViewPlanBtn" onclick="signViewedTreatmentPlan()" class="btn btn-primary">Sign & Lock</button>
                <button id="unlockTreatmentPlanBtn" onclick="unlockTreatmentPlan()" class="btn" style="background: #f39c12; color: white; display: none;">Unlock for Review</button>
                <button onclick="downloadTreatmentPlan()" class="btn btn-secondary">Download PDF</button>
                <button id="deleteTreatmentPlanBtn" onclick="deleteTreatmentPlan()" class="btn" style="background: #e74c3c; color: white;">Delete</button>
                <button onclick="closeModal('viewTreatmentPlanModal')" class="btn btn-secondary">Close</button>
            </div>
        </div>
    </div>

    <!-- Treatment Plan Signature Modal -->
    <div id="treatmentPlanSignatureModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <span class="close" onclick="closeModal('treatmentPlanSignatureModal')">&times;</span>
            <h2>Sign Treatment Plan</h2>

            <p style="margin-bottom: 20px; color: var(--text-secondary);">
                By signing this treatment plan, you certify that it is accurate and complete. Signed treatment plans cannot be edited or deleted.
            </p>

            <div style="margin-bottom: 20px;">
                <label class="label">Signature Method:</label>
                <select id="planSignatureMethod" class="input" onchange="togglePlanSignatureInput()">
                    <option value="typed">Typed Signature</option>
                    <option value="drawn">Draw Signature</option>
                </select>
            </div>

            <!-- Typed Signature -->
            <div id="planTypedSignatureSection" style="margin-bottom: 20px;">
                <label class="label">Type Your Full Name:</label>
                <input type="text" id="planTypedSignature" class="input" placeholder="Dr. Jane Smith">
                <div id="planTypedSignaturePreview" style="margin-top: 10px; padding: 15px; background: #f7f7f7; border-radius: 8px; font-family: 'Kalam', cursive; font-size: 24px; text-align: center; min-height: 60px; border: 1px dashed var(--border-color);">
                    Signature will appear here...
                </div>
            </div>

            <!-- Drawn Signature -->
            <div id="planDrawnSignatureSection" style="display: none; margin-bottom: 20px;">
                <label class="label">Draw Your Signature:</label>
                <canvas id="planSignatureCanvas" style="width: 100%; height: 150px; border: 2px solid var(--border-color); border-radius: 8px; background: white; cursor: crosshair;"></canvas>
                <div style="margin-top: 10px;">
                    <button onclick="clearPlanSignature()" class="btn btn-secondary">Clear</button>
                </div>
            </div>

            <div style="margin-bottom: 20px;">
                <label style="display: flex; align-items: center; cursor: pointer;">
                    <input type="checkbox" id="planSignatureConfirm" style="margin-right: 8px;">
                    <span>I confirm that this treatment plan is accurate and complete</span>
                </label>
            </div>

            <div style="display: flex; gap: 10px;">
                <button onclick="confirmSignTreatmentPlan()" class="btn btn-primary"> Sign & Lock Plan</button>
                <button onclick="closeModal('treatmentPlanSignatureModal')" class="btn btn-secondary">Cancel</button>
            </div>
        </div>
    </div>

<script>
// ========================================
// FEATURE FLAGS - Toggle add-on features
// ========================================
const FEATURE_FLAGS = {
    AI_NOTETAKER_ENABLED: true  // Set to false to disable AI NoteTaker feature
};

// Client-side localStorage implementation - no API calls needed
let authToken = null;
let currentUser = null;
let clients = [];
let assignedDocs = [];
let currentDocuments = [];
let currentDocIndex = 0;
let documentTemplates = {};
let templateNames = {};
let currentChartClient = null;

// Stripe Configuration
// Initialize Stripe when available
let stripe = null;
function initializeStripe() {
    if (typeof Stripe !== 'undefined') {
        stripe = Stripe('pk_test_51SJ5QBKfOEPgyMAooTwIKAxHZK2cCaPuJSXWlLE2LHCRYFJMOYEVA2UF7TbJi6RScA3vaFv5QIWkfgVzrwmuA5s200PbzGr863');
        console.log(' Stripe initialized');
    } else {
        console.log('[WARN] Stripe not loaded yet, will retry...');
        setTimeout(initializeStripe, 100);
    }
}
let clientCalendarDate = new Date();
let clientAppointments = [];
let clientInvoices = [];
let clientDocs = [];
let appointments = [];
let invoices = [];
let currentAppointmentId = null; // For AI NoteTaker session tracking

// Session management
function setSession(rememberMe = false) {
    const sessionData = {
        token: authToken,
        user: currentUser,
        loginTime: new Date().toISOString(),
        expiresAt: rememberMe ? Date.now() + (30 * 24 * 60 * 60 * 1000) : Date.now() + (30 * 60 * 1000) // 30 days or 30 minutes
    };
    
    if (rememberMe) {
        localStorage.setItem('session_data', JSON.stringify(sessionData));
    } else {
        sessionStorage.setItem('session_data', JSON.stringify(sessionData));
    }
}

function checkSession() {
    let sessionData = null;
    
    // Check localStorage first (remember me)
    const localSession = localStorage.getItem('session_data');
    if (localSession) {
        sessionData = JSON.parse(localSession);
    }
    
    // Check sessionStorage (temporary session)
    if (!sessionData) {
        const sessionSession = sessionStorage.getItem('session_data');
        if (sessionSession) {
            sessionData = JSON.parse(sessionSession);
        }
    }
    
    if (sessionData && sessionData.expiresAt > Date.now()) {
        authToken = sessionData.token;
        currentUser = sessionData.user;
        return true;
    } else {
        // Clear expired session
        localStorage.removeItem('session_data');
        sessionStorage.removeItem('session_data');
        return false;
    }
}

function clearSession() {
    localStorage.removeItem('session_data');
    sessionStorage.removeItem('session_data');
    authToken = null;
    currentUser = null;
}

// localStorage management functions
function getStorageKey(key) {
    return `sessionably_${key}`;
}

function saveToStorage(key, data) {
    try {
        localStorage.setItem(getStorageKey(key), JSON.stringify(data));
    } catch (error) {
        console.error('Failed to save to localStorage:', error);
    }
}

function loadFromStorage(key, defaultValue = null) {
    try {
        const data = localStorage.getItem(getStorageKey(key));
        return data ? JSON.parse(data) : defaultValue;
    } catch (error) {
        console.error('Failed to load from localStorage:', error);
        return defaultValue;
    }
}

function logLocalAudit(action, details = {}) {
    const auditLogs = loadFromStorage('audit_logs', []);
    const logEntry = {
        id: Date.now() + Math.random(),
        timestamp: new Date().toISOString(),
        action,
        details,
        user_name: currentUser?.name || 'System'
    };
    auditLogs.unshift(logEntry);
    // Keep only last 1000 audit logs
    if (auditLogs.length > 1000) {
        auditLogs.splice(1000);
    }
    saveToStorage('audit_logs', auditLogs);
}

// Initialize demo data if localStorage is empty
function initializeDemoData() {
    // Check if this is the first time setup
    const hasClinicians = localStorage.getItem(getStorageKey('clinicians'));
    // Check for signup flow
    const urlParams = new URLSearchParams(window.location.search);
    const isSignup = urlParams.get('signup') === 'true';
    const newUserData = localStorage.getItem('sessionably_new_user');
    
    if (isSignup && newUserData) {
        console.log('[NEW] Signup flow detected');
        // Handle new user signup
        handleNewUserSignup(JSON.parse(newUserData));
        return;
    }
    
    // ALWAYS ensure test admin exists for testing
    const existingClinicians = loadFromStorage('clinicians', []);
    const testAdminExists = existingClinicians.some(c => c.username === 'Joe');

    if (!testAdminExists) {
        const defaultAdmin = {
            id: 'admin-' + Date.now(),
            username: 'Joe',
            password: 'Mo',
            fullName: 'Joe',
            email: 'admin@sessionably.com',
            role: 'admin',
            createdAt: new Date().toISOString(),
            isActive: true,
            mustChangePassword: false
        };

        existingClinicians.push(defaultAdmin);
        saveToStorage('clinicians', existingClinicians);
        console.log(' Joe admin user created for testing');
        console.log('Admin details:', defaultAdmin);
    }

    const isFirstTime = !hasClinicians && !localStorage.getItem(getStorageKey('clients'));

    if (isFirstTime) {
        console.log('[NEW] First time setup detected');
        // Show setup modal for first admin user (additional to JHolub)
        showFirstTimeSetup();
        return;
    }
    
    console.log('All clinicians:', loadFromStorage('clinicians', []));
    
    // Always check if templates exist, initialize them if they don't
    const hasTemplates = localStorage.getItem(getStorageKey('templates'));
    if (!hasTemplates) {
        console.log('[DOC] Initializing document templates');
        // Initialize templates only
        const demoTemplates = {
            '1': { id: 1, name: 'Consent Form', content: 'Default consent form content...' },
            '2': { id: 2, name: 'Medical History', content: 'Default medical history form...' },
            '3': { 
                id: 3, 
                name: 'ACE Questionnaire', 
                content: `<div style="font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; line-height: 1.6;">
                    <h2 style="text-align: center; color: #2c3e50; margin-bottom: 30px;">Adverse Childhood Experience (ACE) Questionnaire</h2>
                    
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                        <p><strong>Instructions:</strong> While you were growing up, during your first 18 years of life, please answer the following questions. Mark "Yes" or "No" for each question.</p>
                    </div>
                    
                    <form id="aceForm" style="margin-bottom: 30px;">
                        <div style="margin-bottom: 20px; padding: 15px; border: 1px solid #e9ecef; border-radius: 8px;">
                            <p><strong>1.</strong> Did a parent or other adult in the household often swear at you, insult you, put you down, or humiliate you? Did they act in a way that made you afraid that you might be physically hurt?</p>
                            <label><input type="radio" name="q1" value="1"> Yes (1)</label>
                            <label style="margin-left: 20px;"><input type="radio" name="q1" value="0"> No (0)</label>
                        </div>
                        
                        <div style="margin-bottom: 20px; padding: 15px; border: 1px solid #e9ecef; border-radius: 8px;">
                            <p><strong>2.</strong> Did a parent or other adult in the household often push, grab, slap, or throw something at you? Did they ever hit you so hard that you had marks or were injured?</p>
                            <label><input type="radio" name="q2" value="1"> Yes (1)</label>
                            <label style="margin-left: 20px;"><input type="radio" name="q2" value="0"> No (0)</label>
                        </div>
                        
                        <div style="margin-bottom: 20px; padding: 15px; border: 1px solid #e9ecef; border-radius: 8px;">
                            <p><strong>3.</strong> Did an adult or person at least 5 years older than you ever touch or fondle you or have you touch their body in a sexual way? Did they try to or actually have oral, anal, or vaginal sex with you?</p>
                            <label><input type="radio" name="q3" value="1"> Yes (1)</label>
                            <label style="margin-left: 20px;"><input type="radio" name="q3" value="0"> No (0)</label>
                        </div>
                        
                        <div style="margin-bottom: 20px; padding: 15px; border: 1px solid #e9ecef; border-radius: 8px;">
                            <p><strong>4.</strong> Did you often feel that no one in your family loved you or thought you were important or special? Did you often feel as your family didn't look out for each other, feel close to each other, or support each other?</p>
                            <label><input type="radio" name="q4" value="1"> Yes (1)</label>
                            <label style="margin-left: 20px;"><input type="radio" name="q4" value="0"> No (0)</label>
                        </div>
                        
                        <div style="margin-bottom: 20px; padding: 15px; border: 1px solid #e9ecef; border-radius: 8px;">
                            <p><strong>5.</strong> Did you often feel that you didn't have enough to eat, had to wear dirty clothes, and had no one to protect you? Did you often feel that your parents were too drunk or high to take care of you or take you to the doctor if you needed it?</p>
                            <label><input type="radio" name="q5" value="1"> Yes (1)</label>
                            <label style="margin-left: 20px;"><input type="radio" name="q5" value="0"> No (0)</label>
                        </div>
                        
                        <div style="margin-bottom: 20px; padding: 15px; border: 1px solid #e9ecef; border-radius: 8px;">
                            <p><strong>6.</strong> Were your parents ever separated or divorced?</p>
                            <label><input type="radio" name="q6" value="1"> Yes (1)</label>
                            <label style="margin-left: 20px;"><input type="radio" name="q6" value="0"> No (0)</label>
                        </div>
                        
                        <div style="margin-bottom: 20px; padding: 15px; border: 1px solid #e9ecef; border-radius: 8px;">
                            <p><strong>7.</strong> Was your mother or stepmother often pushed, grabbed, slapped, or had something thrown at her? Was she sometimes or often kicked, bitten, hit with a fist, or hit with something hard? Or ever repeatedly hit over at least a few minutes or threatened with a gun or knife?</p>
                            <label><input type="radio" name="q7" value="1"> Yes (1)</label>
                            <label style="margin-left: 20px;"><input type="radio" name="q7" value="0"> No (0)</label>
                        </div>
                        
                        <div style="margin-bottom: 20px; padding: 15px; border: 1px solid #e9ecef; border-radius: 8px;">
                            <p><strong>8.</strong> Did you live with anyone who was a problem drinker or alcoholic or who used street drugs?</p>
                            <label><input type="radio" name="q8" value="1"> Yes (1)</label>
                            <label style="margin-left: 20px;"><input type="radio" name="q8" value="0"> No (0)</label>
                        </div>
                        
                        <div style="margin-bottom: 20px; padding: 15px; border: 1px solid #e9ecef; border-radius: 8px;">
                            <p><strong>9.</strong> Was a household member depressed or mentally ill or did a household member attempt suicide?</p>
                            <label><input type="radio" name="q9" value="1"> Yes (1)</label>
                            <label style="margin-left: 20px;"><input type="radio" name="q9" value="0"> No (0)</label>
                        </div>
                        
                        <div style="margin-bottom: 20px; padding: 15px; border: 1px solid #e9ecef; border-radius: 8px;">
                            <p><strong>10.</strong> Did a household member go to prison?</p>
                            <label><input type="radio" name="q10" value="1"> Yes (1)</label>
                            <label style="margin-left: 20px;"><input type="radio" name="q10" value="0"> No (0)</label>
                        </div>
                        
                        <div style="background: #fff3cd; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                            <p><strong>ACE Score Calculation:</strong></p>
                            <p>Now add up your "Yes" answers and enter the total below:</p>
                            <label><strong>Total ACE Score:</strong> <input type="number" id="aceScore" min="0" max="10" style="width: 60px; padding: 5px; border: 1px solid #ccc; border-radius: 4px;"></label>
                        </div>
                    </form>
                    
                    <div style="background: #e8f5e8; padding: 15px; border-radius: 8px; margin-bottom: 30px;">
                        <p><strong>Source:</strong> CDC-Kaiser Permanente ACE Study, 1998.</p>
                    </div>
                    
                    <div style="border-top: 2px solid #e9ecef; padding-top: 30px; margin-top: 30px;">
                        <h3 style="color: #2c3e50; margin-bottom: 20px;">Digital Signatures</h3>
                        
                        <div style="display: flex; gap: 40px; margin-bottom: 30px;">
                            <div style="flex: 1;">
                                <h4 style="color: #1976d2; margin-bottom: 15px;">Client Signature</h4>
                                <div style="border: 2px dashed #1976d2; border-radius: 8px; padding: 20px; text-align: center; min-height: 100px; background: #f8f9fa;">
                                    <div id="clientSignature" style="min-height: 60px; display: flex; align-items: center; justify-content: center; color: #666;">
                                        <span>Client Signature Required</span>
                                    </div>
                                    <div style="margin-top: 10px; font-size: 12px; color: #666;">
                                        <div>Client Name: <input type="text" id="clientName" style="border: none; border-bottom: 1px solid #ccc; background: transparent; width: 200px;"></div>
                                        <div style="margin-top: 5px;">Date: <span id="clientDate"></span></div>
                                    </div>
                                </div>
                            </div>
                            
                            <div style="flex: 1;">
                                <h4 style="color: #9c27b0; margin-bottom: 15px;">Clinician Signature</h4>
                                <div style="border: 2px dashed #9c27b0; border-radius: 8px; padding: 20px; text-align: center; min-height: 100px; background: #f8f9fa;">
                                    <div id="clinicianSignature" style="min-height: 60px; display: flex; align-items: center; justify-content: center; color: #666;">
                                        <span>Clinician Signature Required</span>
                                    </div>
                                    <div style="margin-top: 10px; font-size: 12px; color: #666;">
                                        <div>Clinician Name: <input type="text" id="clinicianName" style="border: none; border-bottom: 1px solid #ccc; background: transparent; width: 200px;"></div>
                                        <div style="margin-top: 5px;">Date: <span id="clinicianDate"></span></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div style="text-align: center; margin-top: 30px;">
                        <button onclick="submitACEDocument()" style="background: #00a86b; color: white; border: none; padding: 12px 30px; border-radius: 6px; font-size: 16px; cursor: pointer;">
                            Submit Completed Form
                        </button>
                    </div>
                </div>` 
            },
            '4': { 
                id: 4, 
                name: 'AUDIT Questionnaire', 
                content: `<div style="font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; line-height: 1.6;">
                    <h2 style="text-align: center; color: #2c3e50; margin-bottom: 30px;">Alcohol Use Disorders Identification Test (AUDIT): Self-Report Version</h2>
                    
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                        <p><strong>Instructions:</strong> Because alcohol use can affect your health and can interfere with certain medications and treatments, it is important that we ask some questions about your use of alcohol. Your answers will remain confidential so please be honest. Check the option that best describes your answer to each question.</p>
                    </div>
                    
                    <form id="auditForm" style="margin-bottom: 30px;">
                        <div style="margin-bottom: 20px; padding: 15px; border: 1px solid #e9ecef; border-radius: 8px;">
                            <p><strong>1.</strong> How often do you have a drink containing alcohol?</p>
                            <label><input type="radio" name="q1" value="0"> (0) Never</label><br>
                            <label><input type="radio" name="q1" value="1"> (1) Monthly or less</label><br>
                            <label><input type="radio" name="q1" value="2"> (2) 2 to 4 times a month</label><br>
                            <label><input type="radio" name="q1" value="3"> (3) 2 to 3 times a week</label><br>
                            <label><input type="radio" name="q1" value="4"> (4) 4 or more times a week</label>
                        </div>
                        
                        <div style="margin-bottom: 20px; padding: 15px; border: 1px solid #e9ecef; border-radius: 8px;">
                            <p><strong>2.</strong> How many drinks containing alcohol do you have on a typical day when you are drinking?</p>
                            <label><input type="radio" name="q2" value="0"> (0) 1 or 2</label><br>
                            <label><input type="radio" name="q2" value="1"> (1) 3 or 4</label><br>
                            <label><input type="radio" name="q2" value="2"> (2) 5 or 6</label><br>
                            <label><input type="radio" name="q2" value="3"> (3) 7, 8, or 9</label><br>
                            <label><input type="radio" name="q2" value="4"> (4) 10 or more</label>
                        </div>
                        
                        <div style="margin-bottom: 20px; padding: 15px; border: 1px solid #e9ecef; border-radius: 8px;">
                            <p><strong>3.</strong> How often do you have six or more drinks on one occasion?</p>
                            <label><input type="radio" name="q3" value="0"> (0) Never</label><br>
                            <label><input type="radio" name="q3" value="1"> (1) Less than monthly</label><br>
                            <label><input type="radio" name="q3" value="2"> (2) Monthly</label><br>
                            <label><input type="radio" name="q3" value="3"> (3) Weekly</label><br>
                            <label><input type="radio" name="q3" value="4"> (4) Daily or almost daily</label>
                        </div>
                        
                        <div style="margin-bottom: 20px; padding: 15px; border: 1px solid #e9ecef; border-radius: 8px;">
                            <p><strong>4.</strong> How often during the last year have you found that you were not able to stop drinking once you had started?</p>
                            <label><input type="radio" name="q4" value="0"> (0) Never</label><br>
                            <label><input type="radio" name="q4" value="1"> (1) Less than monthly</label><br>
                            <label><input type="radio" name="q4" value="2"> (2) Monthly</label><br>
                            <label><input type="radio" name="q4" value="3"> (3) Weekly</label><br>
                            <label><input type="radio" name="q4" value="4"> (4) Daily or almost daily</label>
                        </div>
                        
                        <div style="margin-bottom: 20px; padding: 15px; border: 1px solid #e9ecef; border-radius: 8px;">
                            <p><strong>5.</strong> How often during the last year have you failed to do what was normally expected from you because of drinking?</p>
                            <label><input type="radio" name="q5" value="0"> (0) Never</label><br>
                            <label><input type="radio" name="q5" value="1"> (1) Less than monthly</label><br>
                            <label><input type="radio" name="q5" value="2"> (2) Monthly</label><br>
                            <label><input type="radio" name="q5" value="3"> (3) Weekly</label><br>
                            <label><input type="radio" name="q5" value="4"> (4) Daily or almost daily</label>
                        </div>
                        
                        <div style="margin-bottom: 20px; padding: 15px; border: 1px solid #e9ecef; border-radius: 8px;">
                            <p><strong>6.</strong> How often during the last year have you needed a first drink in the morning to get yourself going after a heavy drinking session?</p>
                            <label><input type="radio" name="q6" value="0"> (0) Never</label><br>
                            <label><input type="radio" name="q6" value="1"> (1) Less than monthly</label><br>
                            <label><input type="radio" name="q6" value="2"> (2) Monthly</label><br>
                            <label><input type="radio" name="q6" value="3"> (3) Weekly</label><br>
                            <label><input type="radio" name="q6" value="4"> (4) Daily or almost daily</label>
                        </div>
                        
                        <div style="margin-bottom: 20px; padding: 15px; border: 1px solid #e9ecef; border-radius: 8px;">
                            <p><strong>7.</strong> How often during the last year have you had a feeling of guilt or remorse after drinking?</p>
                            <label><input type="radio" name="q7" value="0"> (0) Never</label><br>
                            <label><input type="radio" name="q7" value="1"> (1) Less than monthly</label><br>
                            <label><input type="radio" name="q7" value="2"> (2) Monthly</label><br>
                            <label><input type="radio" name="q7" value="3"> (3) Weekly</label><br>
                            <label><input type="radio" name="q7" value="4"> (4) Daily or almost daily</label>
                        </div>
                        
                        <div style="margin-bottom: 20px; padding: 15px; border: 1px solid #e9ecef; border-radius: 8px;">
                            <p><strong>8.</strong> How often during the last year have you been unable to remember what happened the night before because you had been drinking?</p>
                            <label><input type="radio" name="q8" value="0"> (0) Never</label><br>
                            <label><input type="radio" name="q8" value="1"> (1) Less than monthly</label><br>
                            <label><input type="radio" name="q8" value="2"> (2) Monthly</label><br>
                            <label><input type="radio" name="q8" value="3"> (3) Weekly</label><br>
                            <label><input type="radio" name="q8" value="4"> (4) Daily or almost daily</label>
                        </div>
                        
                        <div style="margin-bottom: 20px; padding: 15px; border: 1px solid #e9ecef; border-radius: 8px;">
                            <p><strong>9.</strong> Have you or someone else been injured as a result of your drinking?</p>
                            <label><input type="radio" name="q9" value="0"> (0) No</label><br>
                            <label><input type="radio" name="q9" value="2"> (2) Yes, but not in the last year</label><br>
                            <label><input type="radio" name="q9" value="4"> (4) Yes, during the last year</label>
                        </div>
                        
                        <div style="margin-bottom: 20px; padding: 15px; border: 1px solid #e9ecef; border-radius: 8px;">
                            <p><strong>10.</strong> Has a relative, friend, doctor, or another health worker been concerned about your drinking or suggested you cut down?</p>
                            <label><input type="radio" name="q10" value="0"> (0) No</label><br>
                            <label><input type="radio" name="q10" value="2"> (2) Yes, but not in the last year</label><br>
                            <label><input type="radio" name="q10" value="4"> (4) Yes, during the last year</label>
                        </div>
                        
                        <div style="background: #fff3cd; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                            <p><strong>AUDIT Score Calculation:</strong></p>
                            <p>Now add up the total for your answers using the number in parentheses next to each answer you selected. Record your total score here:</p>
                            <label><strong>Total AUDIT Score:</strong> <input type="number" id="auditScore" min="0" max="40" style="width: 60px; padding: 5px; border: 1px solid #ccc; border-radius: 4px;"></label>
                        </div>
                    </form>
                    
                    <div style="background: #e8f5e8; padding: 15px; border-radius: 8px; margin-bottom: 30px;">
                        <p><strong>Source:</strong> Babor TF; de la Fuente JR; Saunders J; Grant M. AUDIT: The Alcohol Use Disorders Identification Test. Guidelines for use in primary health care. WHO/MNH/DAT 89.4, World Health Organization, Geneva, 1989.</p>
                    </div>
                    
                    <div style="border-top: 2px solid #e9ecef; padding-top: 30px; margin-top: 30px;">
                        <h3 style="color: #2c3e50; margin-bottom: 20px;">Digital Signatures</h3>
                        
                        <div style="display: flex; gap: 40px; margin-bottom: 30px;">
                            <div style="flex: 1;">
                                <h4 style="color: #1976d2; margin-bottom: 15px;">Client Signature</h4>
                                <div style="border: 2px dashed #1976d2; border-radius: 8px; padding: 20px; text-align: center; min-height: 100px; background: #f8f9fa;">
                                    <div id="clientSignature" style="min-height: 60px; display: flex; align-items: center; justify-content: center; color: #666;">
                                        <span>Client Signature Required</span>
                                    </div>
                                    <div style="margin-top: 10px; font-size: 12px; color: #666;">
                                        <div>Client Name: <input type="text" id="clientName" style="border: none; border-bottom: 1px solid #ccc; background: transparent; width: 200px;"></div>
                                        <div style="margin-top: 5px;">Date: <span id="clientDate"></span></div>
                                    </div>
                                </div>
                            </div>
                            
                            <div style="flex: 1;">
                                <h4 style="color: #9c27b0; margin-bottom: 15px;">Clinician Signature</h4>
                                <div style="border: 2px dashed #9c27b0; border-radius: 8px; padding: 20px; text-align: center; min-height: 100px; background: #f8f9fa;">
                                    <div id="clinicianSignature" style="min-height: 60px; display: flex; align-items: center; justify-content: center; color: #666;">
                                        <span>Clinician Signature Required</span>
                                    </div>
                                    <div style="margin-top: 10px; font-size: 12px; color: #666;">
                                        <div>Clinician Name: <input type="text" id="clinicianName" style="border: none; border-bottom: 1px solid #ccc; background: transparent; width: 200px;"></div>
                                        <div style="margin-top: 5px;">Date: <span id="clinicianDate"></span></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div style="text-align: center; margin-top: 30px;">
                        <button onclick="submitAUDITDocument()" style="background: #00a86b; color: white; border: none; padding: 12px 30px; border-radius: 6px; font-size: 16px; cursor: pointer;">
                            Submit Completed Form
                        </button>
                    </div>
                </div>` 
            },
            '5': { 
                id: 5, 
                name: 'Authorization for Disclosure of Information', 
                content: `<div style="font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; line-height: 1.6;">
                    <h2 style="text-align: center; color: #2c3e50; margin-bottom: 30px;">Authorization for Disclosure of Information</h2>
                    
                    <form id="disclosureForm" style="margin-bottom: 30px;">
                        <div style="margin-bottom: 20px; padding: 15px; border: 1px solid #e9ecef; border-radius: 8px;">
                            <label><strong>I hereby authorize and direct (enter name of clinician):</strong></label><br>
                            <input type="text" name="clinicianName" style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ccc; border-radius: 4px;" required>
                        </div>
                        
                        <div style="margin-bottom: 20px; padding: 15px; border: 1px solid #e9ecef; border-radius: 8px;">
                            <label><strong>To:</strong></label><br>
                            <input type="text" name="authorizedTo" style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ccc; border-radius: 4px;" required>
                        </div>
                        
                        <div style="margin-bottom: 20px; padding: 15px; border: 1px solid #e9ecef; border-radius: 8px;">
                            <p><strong>DISCLOSE the following information:</strong></p>
                            <textarea name="discloseInfo" rows="4" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;" placeholder="Specify information to be disclosed..."></textarea>
                        </div>
                        
                        <div style="margin-bottom: 20px; padding: 15px; border: 1px solid #e9ecef; border-radius: 8px;">
                            <p><strong>EXCHANGE the following information:</strong></p>
                            <textarea name="exchangeInfo" rows="4" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;" placeholder="Specify information to be exchanged..."></textarea>
                        </div>
                        
                        <div style="margin-bottom: 20px; padding: 15px; border: 1px solid #e9ecef; border-radius: 8px;">
                            <label><strong>To / With:</strong></label><br>
                            <input type="text" name="recipient" style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ccc; border-radius: 4px;" required>
                        </div>
                        
                        <div style="margin-bottom: 20px; padding: 15px; border: 1px solid #e9ecef; border-radius: 8px;">
                            <label><strong>For the following purpose(s):</strong></label><br>
                            <textarea name="purpose" rows="3" style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ccc; border-radius: 4px;" required></textarea>
                        </div>
                        
                        <div style="margin-bottom: 20px; padding: 15px; border: 1px solid #e9ecef; border-radius: 8px;">
                            <label><strong>This authorization expires on:</strong></label><br>
                            <input type="date" name="expirationDate" style="padding: 8px; margin-top: 5px; border: 1px solid #ccc; border-radius: 4px;" required>
                            <p style="font-size: 12px; color: #666; margin-top: 5px;">This authorization expires on the date selected or in 90 days, whichever date is sooner.</p>
                        </div>
                        
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                            <p><strong>By signing this authorization form:</strong> I understand that my records contain information regarding my mental health. I give specific permission for this information to be released. I understand that my records are protected under State and Federal law and cannot be disclosed without my written consent unless otherwise provided for by law.</p>
                        </div>
                    </form>
                    
                    <div style="border-top: 2px solid #e9ecef; padding-top: 30px; margin-top: 30px;">
                        <h3 style="color: #2c3e50; margin-bottom: 20px;">Digital Signatures</h3>
                        
                        <div style="display: flex; gap: 40px; margin-bottom: 30px;">
                            <div style="flex: 1;">
                                <h4 style="color: #1976d2; margin-bottom: 15px;">Client Signature</h4>
                                <div style="border: 2px dashed #1976d2; border-radius: 8px; padding: 20px; text-align: center; min-height: 100px; background: #f8f9fa;">
                                    <div id="clientSignature" style="min-height: 60px; display: flex; align-items: center; justify-content: center; color: #666;">
                                        <span>Client Signature Required</span>
                                    </div>
                                    <div style="margin-top: 10px; font-size: 12px; color: #666;">
                                        <div>Client Name: <input type="text" id="clientName" style="border: none; border-bottom: 1px solid #ccc; background: transparent; width: 200px;"></div>
                                        <div style="margin-top: 5px;">Date: <span id="clientDate"></span></div>
                                    </div>
                                </div>
                            </div>
                            
                            <div style="flex: 1;">
                                <h4 style="color: #9c27b0; margin-bottom: 15px;">Clinician Signature</h4>
                                <div style="border: 2px dashed #9c27b0; border-radius: 8px; padding: 20px; text-align: center; min-height: 100px; background: #f8f9fa;">
                                    <div id="clinicianSignature" style="min-height: 60px; display: flex; align-items: center; justify-content: center; color: #666;">
                                        <span>Clinician Signature Required</span>
                                    </div>
                                    <div style="margin-top: 10px; font-size: 12px; color: #666;">
                                        <div>Clinician Name: <input type="text" id="clinicianName" style="border: none; border-bottom: 1px solid #ccc; background: transparent; width: 200px;"></div>
                                        <div style="margin-top: 5px;">Date: <span id="clinicianDate"></span></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div style="text-align: center; margin-top: 30px;">
                        <button onclick="submitDisclosureDocument()" style="background: #00a86b; color: white; border: none; padding: 12px 30px; border-radius: 6px; font-size: 16px; cursor: pointer;">
                            Submit Authorization
                        </button>
                    </div>
                </div>` 
            },
            '6': { 
                id: 6, 
                name: 'Biopsychosocial Assessment', 
                content: `<div style="font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; line-height: 1.6;">
                    <h2 style="text-align: center; color: #2c3e50; margin-bottom: 30px;">Biopsychosocial Assessment</h2>
                    
                    <form id="biopsychosocialForm" style="margin-bottom: 30px;">
                        <div style="margin-bottom: 20px; padding: 15px; border: 1px solid #e9ecef; border-radius: 8px;">
                            <label><strong>1. Presenting Problem:</strong></label><br>
                            <textarea name="presentingProblem" rows="4" style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ccc; border-radius: 4px;"></textarea>
                        </div>
                        
                        <div style="margin-bottom: 20px; padding: 15px; border: 1px solid #e9ecef; border-radius: 8px;">
                            <label><strong>2. Signs and Symptoms (DSM-V-TR based) resulting in impairment(s):</strong></label><br>
                            <textarea name="signsSymptoms" rows="4" style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ccc; border-radius: 4px;" placeholder="Include current examples for treatment planning, e.g., social, occupational, affective, cognitive, physical"></textarea>
                        </div>
                        
                        <div style="margin-bottom: 20px; padding: 15px; border: 1px solid #e9ecef; border-radius: 8px;">
                            <label><strong>3. History of Presenting Problem:</strong></label><br>
                            <textarea name="historyProblem" rows="4" style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ccc; border-radius: 4px;" placeholder="Events, precipitating factors, or incidents leading to need for services"></textarea>
                        </div>
                        
                        <div style="margin-bottom: 20px; padding: 15px; border: 1px solid #e9ecef; border-radius: 8px;">
                            <label><strong>Frequency/duration/severity/cycling of symptoms:</strong></label><br>
                            <textarea name="frequencyDuration" rows="3" style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ccc; border-radius: 4px;"></textarea>
                        </div>
                        
                        <div style="margin-bottom: 20px; padding: 15px; border: 1px solid #e9ecef; border-radius: 8px;">
                            <label><strong>Was there a clear time when symptoms worsened?</strong></label><br>
                            <textarea name="symptomsWorsened" rows="3" style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ccc; border-radius: 4px;"></textarea>
                        </div>
                        
                        <div style="margin-bottom: 20px; padding: 15px; border: 1px solid #e9ecef; border-radius: 8px;">
                            <label><strong>4. Current Family and Significant Relationships:</strong></label><br>
                            <p><strong>Strengths/support:</strong></p>
                            <textarea name="familyStrengths" rows="2" style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ccc; border-radius: 4px;"></textarea>
                            
                            <p style="margin-top: 15px;"><strong>Stressors/problems:</strong></p>
                            <textarea name="familyStressors" rows="2" style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ccc; border-radius: 4px;"></textarea>
                            
                            <p style="margin-top: 15px;"><strong>Recent changes:</strong></p>
                            <textarea name="familyChanges" rows="2" style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ccc; border-radius: 4px;"></textarea>
                            
                            <p style="margin-top: 15px;"><strong>Changes desired:</strong></p>
                            <textarea name="familyDesiredChanges" rows="2" style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ccc; border-radius: 4px;"></textarea>
                            
                            <p style="margin-top: 15px;"><strong>Comment on family circumstances:</strong></p>
                            <textarea name="familyCircumstances" rows="2" style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ccc; border-radius: 4px;"></textarea>
                        </div>
                        
                        <div style="margin-bottom: 20px; padding: 15px; border: 1px solid #e9ecef; border-radius: 8px;">
                            <label><strong>5. Childhood/Adolescent History:</strong></label><br>
                            <textarea name="childhoodHistory" rows="4" style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ccc; border-radius: 4px;" placeholder="Developmental milestones, past behavioral concerns, environment, abuse, school, social, mental health"></textarea>
                        </div>
                        
                        <div style="margin-bottom: 20px; padding: 15px; border: 1px solid #e9ecef; border-radius: 8px;">
                            <label><strong>6. Social Relationships:</strong></label><br>
                            <p><strong>Strengths/support:</strong></p>
                            <textarea name="socialStrengths" rows="2" style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ccc; border-radius: 4px;"></textarea>
                            
                            <p style="margin-top: 15px;"><strong>Stressors/problems:</strong></p>
                            <textarea name="socialStressors" rows="2" style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ccc; border-radius: 4px;"></textarea>
                            
                            <p style="margin-top: 15px;"><strong>Recent changes:</strong></p>
                            <textarea name="socialChanges" rows="2" style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ccc; border-radius: 4px;"></textarea>
                            
                            <p style="margin-top: 15px;"><strong>Changes desired:</strong></p>
                            <textarea name="socialDesiredChanges" rows="2" style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ccc; border-radius: 4px;"></textarea>
                        </div>
                        
                        <div style="margin-bottom: 20px; padding: 15px; border: 1px solid #e9ecef; border-radius: 8px;">
                            <label><strong>7. Cultural/Ethnic:</strong></label><br>
                            <p><strong>Strengths/support:</strong></p>
                            <textarea name="culturalStrengths" rows="2" style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ccc; border-radius: 4px;"></textarea>
                            
                            <p style="margin-top: 15px;"><strong>Stressors/problems:</strong></p>
                            <textarea name="culturalStressors" rows="2" style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ccc; border-radius: 4px;"></textarea>
                            
                            <p style="margin-top: 15px;"><strong>Beliefs/practices to incorporate into therapy:</strong></p>
                            <textarea name="culturalBeliefs" rows="2" style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ccc; border-radius: 4px;"></textarea>
                        </div>
                        
                        <div style="margin-bottom: 20px; padding: 15px; border: 1px solid #e9ecef; border-radius: 8px;">
                            <label><strong>8. Spiritual/Religious:</strong></label><br>
                            <p><strong>Strengths/support:</strong></p>
                            <textarea name="spiritualStrengths" rows="2" style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ccc; border-radius: 4px;"></textarea>
                            
                            <p style="margin-top: 15px;"><strong>Stressors/problems:</strong></p>
                            <textarea name="spiritualStressors" rows="2" style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ccc; border-radius: 4px;"></textarea>
                            
                            <p style="margin-top: 15px;"><strong>Beliefs/practices to incorporate into therapy:</strong></p>
                            <textarea name="spiritualBeliefs" rows="2" style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ccc; border-radius: 4px;"></textarea>
                            
                            <p style="margin-top: 15px;"><strong>Recent changes:</strong></p>
                            <textarea name="spiritualChanges" rows="2" style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ccc; border-radius: 4px;"></textarea>
                            
                            <p style="margin-top: 15px;"><strong>Changes desired:</strong></p>
                            <textarea name="spiritualDesiredChanges" rows="2" style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ccc; border-radius: 4px;"></textarea>
                        </div>
                        
                        <div style="margin-bottom: 20px; padding: 15px; border: 1px solid #e9ecef; border-radius: 8px;">
                            <label><strong>9. Legal:</strong></label><br>
                            <p><strong>History:</strong></p>
                            <textarea name="legalHistory" rows="2" style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ccc; border-radius: 4px;"></textarea>
                            
                            <p style="margin-top: 15px;"><strong>Status/impact/stressors:</strong></p>
                            <textarea name="legalStatus" rows="2" style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ccc; border-radius: 4px;"></textarea>
                        </div>
                        
                        <div style="margin-bottom: 20px; padding: 15px; border: 1px solid #e9ecef; border-radius: 8px;">
                            <label><strong>10. Education:</strong></label><br>
                            <p><strong>Strengths:</strong></p>
                            <textarea name="educationStrengths" rows="2" style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ccc; border-radius: 4px;"></textarea>
                            
                            <p style="margin-top: 15px;"><strong>Weaknesses:</strong></p>
                            <textarea name="educationWeaknesses" rows="2" style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ccc; border-radius: 4px;"></textarea>
                        </div>
                        
                        <div style="margin-bottom: 20px; padding: 15px; border: 1px solid #e9ecef; border-radius: 8px;">
                            <label><strong>11. Employment/Vocational:</strong></label><br>
                            <p><strong>Strengths/support:</strong></p>
                            <textarea name="employmentStrengths" rows="2" style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ccc; border-radius: 4px;"></textarea>
                            
                            <p style="margin-top: 15px;"><strong>Stressors/problems:</strong></p>
                            <textarea name="employmentStressors" rows="2" style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ccc; border-radius: 4px;"></textarea>
                        </div>
                        
                        <div style="margin-bottom: 20px; padding: 15px; border: 1px solid #e9ecef; border-radius: 8px;">
                            <label><strong>12. Military:</strong></label><br>
                            <p><strong>Current impact:</strong></p>
                            <textarea name="militaryImpact" rows="3" style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ccc; border-radius: 4px;"></textarea>
                        </div>
                        
                        <div style="margin-bottom: 20px; padding: 15px; border: 1px solid #e9ecef; border-radius: 8px;">
                            <label><strong>13. Leisure/Recreational:</strong></label><br>
                            <p><strong>Strengths/support:</strong></p>
                            <textarea name="leisureStrengths" rows="2" style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ccc; border-radius: 4px;"></textarea>
                            
                            <p style="margin-top: 15px;"><strong>Recent changes:</strong></p>
                            <textarea name="leisureChanges" rows="2" style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ccc; border-radius: 4px;"></textarea>
                            
                            <p style="margin-top: 15px;"><strong>Changes desired:</strong></p>
                            <textarea name="leisureDesiredChanges" rows="2" style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ccc; border-radius: 4px;"></textarea>
                        </div>
                        
                        <div style="margin-bottom: 20px; padding: 15px; border: 1px solid #e9ecef; border-radius: 8px;">
                            <label><strong>14. Physical Health:</strong></label><br>
                            <p><strong>Summary of health:</strong></p>
                            <textarea name="healthSummary" rows="2" style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ccc; border-radius: 4px;"></textarea>
                            
                            <p style="margin-top: 15px;"><strong>Physical factors affecting mental condition:</strong></p>
                            <textarea name="physicalFactors" rows="2" style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ccc; border-radius: 4px;"></textarea>
                        </div>
                        
                        <div style="margin-bottom: 20px; padding: 15px; border: 1px solid #e9ecef; border-radius: 8px;">
                            <label><strong>15. Chemical Use History:</strong></label><br>
                            <p><strong>Summary of use:</strong></p>
                            <textarea name="chemicalSummary" rows="2" style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ccc; border-radius: 4px;"></textarea>
                            
                            <p style="margin-top: 15px;"><strong>Patient's perception of problem:</strong></p>
                            <textarea name="chemicalPerception" rows="2" style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ccc; border-radius: 4px;"></textarea>
                        </div>
                        
                        <div style="margin-bottom: 20px; padding: 15px; border: 1px solid #e9ecef; border-radius: 8px;">
                            <label><strong>16. Counseling/Prior Treatment History:</strong></label><br>
                            <p><strong>Summary of prior treatment:</strong></p>
                            <textarea name="treatmentSummary" rows="2" style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ccc; border-radius: 4px;"></textarea>
                            
                            <p style="margin-top: 15px;"><strong>Benefits of previous treatment:</strong></p>
                            <textarea name="treatmentBenefits" rows="2" style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ccc; border-radius: 4px;"></textarea>
                            
                            <p style="margin-top: 15px;"><strong>Setbacks of previous treatment:</strong></p>
                            <textarea name="treatmentSetbacks" rows="2" style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ccc; border-radius: 4px;"></textarea>
                        </div>
                        
                        <div style="margin-bottom: 20px; padding: 15px; border: 1px solid #e9ecef; border-radius: 8px;">
                            <label><strong>Family mental health history:</strong></label><br>
                            <textarea name="familyMentalHealth" rows="3" style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ccc; border-radius: 4px;"></textarea>
                        </div>
                    </form>
                    
                    <div style="border-top: 2px solid #e9ecef; padding-top: 30px; margin-top: 30px;">
                        <h3 style="color: #2c3e50; margin-bottom: 20px;">Digital Signatures</h3>
                        
                        <div style="display: flex; gap: 40px; margin-bottom: 30px;">
                            <div style="flex: 1;">
                                <h4 style="color: #1976d2; margin-bottom: 15px;">Client Signature</h4>
                                <div style="border: 2px dashed #1976d2; border-radius: 8px; padding: 20px; text-align: center; min-height: 100px; background: #f8f9fa;">
                                    <div id="clientSignature" style="min-height: 60px; display: flex; align-items: center; justify-content: center; color: #666;">
                                        <span>Client Signature Required</span>
                                    </div>
                                    <div style="margin-top: 10px; font-size: 12px; color: #666;">
                                        <div>Client Name: <input type="text" id="clientName" style="border: none; border-bottom: 1px solid #ccc; background: transparent; width: 200px;"></div>
                                        <div style="margin-top: 5px;">Date: <span id="clientDate"></span></div>
                                    </div>
                                </div>
                            </div>
                            
                            <div style="flex: 1;">
                                <h4 style="color: #9c27b0; margin-bottom: 15px;">Clinician Signature</h4>
                                <div style="border: 2px dashed #9c27b0; border-radius: 8px; padding: 20px; text-align: center; min-height: 100px; background: #f8f9fa;">
                                    <div id="clinicianSignature" style="min-height: 60px; display: flex; align-items: center; justify-content: center; color: #666;">
                                        <span>Clinician Signature Required</span>
                                    </div>
                                    <div style="margin-top: 10px; font-size: 12px; color: #666;">
                                        <div>Clinician Name: <input type="text" id="clinicianName" style="border: none; border-bottom: 1px solid #ccc; background: transparent; width: 200px;"></div>
                                        <div style="margin-top: 5px;">Date: <span id="clinicianDate"></span></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div style="text-align: center; margin-top: 30px;">
                        <button onclick="submitBiopsychosocialDocument()" style="background: #00a86b; color: white; border: none; padding: 12px 30px; border-radius: 6px; font-size: 16px; cursor: pointer;">
                            Submit Assessment
                        </button>
                    </div>
                </div>` 
            },
            '7': { 
                id: 7, 
                name: 'Consent for Use of AI Tools in Therapy', 
                content: `<div style="font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; line-height: 1.6;">
                    <h2 style="text-align: center; color: #2c3e50; margin-bottom: 30px;">Consent for Use of Artificial Intelligence (AI) Tools in Therapy Services</h2>
                    
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                        <h3 style="color: #2c3e50; margin-bottom: 15px;">Introduction</h3>
                        <p>At [Therapist Name/Practice Name], we are [I am] committed to providing you with the best possible treatment. To help us [me] manage our [my] practice efficiently and enhance our [my] services, we [I] use technology, including certain artificial intelligence (AI) tools. This document explains how we [I] use these tools and asks for your consent to use them as part of your treatment. Your privacy, confidentiality, and the quality of your treatment remain our highest priorities.</p>
                    </div>
                    
                    <div style="background: #e8f5e8; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                        <h3 style="color: #2c3e50; margin-bottom: 15px;">How We [I] Use AI Tools</h3>
                        <p>AI tools are used strictly for administrative and supplementary support tasks under the direct supervision of your therapist. These tools do not provide therapy, make independent clinical decisions, or interact with you directly.</p>
                        <p><strong>The specific purposes for which we [I] may use AI now and in the future include:</strong></p>
                        <ul>
                            <li>Assisting your therapist in drafting and organizing session notes;</li>
                            <li>Managing appointment scheduling and/or sending reminders;</li>
                            <li>Processing billing and insurance claims;</li>
                            <li>Analyzing data to identify therapy trends and track progress, which is always reviewed by your therapist;</li>
                            <li>Analyzing business information and generating reports or trends to help me manage my business; or</li>
                            <li>Helping to identify and organize external resources or referrals for your use.</li>
                        </ul>
                    </div>
                    
                    <div style="background: #fff3cd; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                        <h3 style="color: #2c3e50; margin-bottom: 15px;">How We [I] DO NOT Use AI Tools</h3>
                        <p><strong>To be clear, we [I] do not use AI to:</strong></p>
                        <ul>
                            <li>Make independent therapeutic decisions or diagnoses;</li>
                            <li>Communicate with you directly to provide therapeutic advice;</li>
                            <li>Generate treatment recommendations without the direct review, approval, and input of your licensed therapist; or</li>
                            <li>Detect or interpret your emotions or mental state.</li>
                        </ul>
                    </div>
                    
                    <form id="aiConsentForm" style="margin-bottom: 30px;">
                        <div style="margin-bottom: 20px; padding: 15px; border: 1px solid #e9ecef; border-radius: 8px;">
                            <h3 style="color: #2c3e50; margin-bottom: 15px;">Consent for Session Transcription (If Applicable)</h3>
                            <p>To help create accurate and detailed session notes, your therapist uses [I use] an AI tool called Note Taker that transcribes our sessions and then prepares a draft progress note. Note Taker is a feature in the Electronic Health Record and practice management platform that I use from Sessionably.</p>
                            <p><strong>Please check one of the following:</strong></p>
                            
                            <label style="display: block; margin: 10px 0;">
                                <input type="radio" name="transcriptionConsent" value="yes">
                                I consent to the use of an AI transcription tool to record and transcribe my therapy sessions for the purpose of assisting my therapist with note-taking.
                            </label>
                            
                            <label style="display: block; margin: 10px 0;">
                                <input type="radio" name="transcriptionConsent" value="no">
                                I do not consent to the use of an AI transcription tool to record or transcribe my therapy sessions. I understand this will not affect the quality of my care.
                            </label>
                        </div>
                        
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                            <h3 style="color: #2c3e50; margin-bottom: 15px;">Your Rights and Confidentiality</h3>
                            <p><strong>Confidentiality:</strong> All information, including any data processed by an AI tool, is treated as part of your confidential health record and is protected by the same privacy and security standards as all other aspects of your care, including HIPAA.</p>
                            <ul>
                                <li>Sessionably and its Note Taker tool are HIPAA-compliant and HITRUST certified.</li>
                                <li>All audio-recordings of therapy sessions through Note Taker are immediately deleted as soon as a transcript is created, generally within minutes of a session ending.</li>
                                <li>Transcripts that are created through Note Taker are only retained for the shorter of 7 days or when the progress note is signed and locked by your therapist. After that, they are permanently deleted.</li>
                                <li>During the time that transcripts are available in Note Taker, they always remain confidential and secure, and are only available for your therapist's use to verify the accuracy of the progress note. They are not used for any other purpose.</li>
                            </ul>
                            <p><strong>Right to Revoke Consent:</strong> Your consent is voluntary. You have the right to withdraw this consent at any time by notifying your therapist in writing. Revoking your consent will not affect your ability to receive therapy services.</p>
                        </div>
                        
                        <div style="background: #e8f5e8; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                            <h3 style="color: #2c3e50; margin-bottom: 15px;">Client Acknowledgment and Consent</h3>
                            <p>By signing below, I confirm that:</p>
                            <ol>
                                <li>I have read and understood this form.</li>
                                <li>I have had the opportunity to ask questions about the use of AI tools in my treatment.</li>
                                <li>I voluntarily agree to the use of AI tools for the purposes described above.</li>
                            </ol>
                        </div>
                    </form>
                    
                    <div style="border-top: 2px solid #e9ecef; padding-top: 30px; margin-top: 30px;">
                        <h3 style="color: #2c3e50; margin-bottom: 20px;">Digital Signatures</h3>
                        
                        <div style="display: flex; gap: 40px; margin-bottom: 30px;">
                            <div style="flex: 1;">
                                <h4 style="color: #1976d2; margin-bottom: 15px;">Client Signature</h4>
                                <div style="border: 2px dashed #1976d2; border-radius: 8px; padding: 20px; text-align: center; min-height: 100px; background: #f8f9fa;">
                                    <div id="clientSignature" style="min-height: 60px; display: flex; align-items: center; justify-content: center; color: #666;">
                                        <span>Client Signature Required</span>
                                    </div>
                                    <div style="margin-top: 10px; font-size: 12px; color: #666;">
                                        <div>Client Name: <input type="text" id="clientName" style="border: none; border-bottom: 1px solid #ccc; background: transparent; width: 200px;"></div>
                                        <div style="margin-top: 5px;">Date: <span id="clientDate"></span></div>
                                    </div>
                                </div>
                            </div>
                            
                            <div style="flex: 1;">
                                <h4 style="color: #9c27b0; margin-bottom: 15px;">Clinician Signature</h4>
                                <div style="border: 2px dashed #9c27b0; border-radius: 8px; padding: 20px; text-align: center; min-height: 100px; background: #f8f9fa;">
                                    <div id="clinicianSignature" style="min-height: 60px; display: flex; align-items: center; justify-content: center; color: #666;">
                                        <span>Clinician Signature Required</span>
                                    </div>
                                    <div style="margin-top: 10px; font-size: 12px; color: #666;">
                                        <div>Clinician Name: <input type="text" id="clinicianName" style="border: none; border-bottom: 1px solid #ccc; background: transparent; width: 200px;"></div>
                                        <div style="margin-top: 5px;">Date: <span id="clinicianDate"></span></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div style="text-align: center; margin-top: 30px;">
                        <button onclick="submitAIConsentDocument()" style="background: #00a86b; color: white; border: none; padding: 12px 30px; border-radius: 6px; font-size: 16px; cursor: pointer;">
                            Submit Consent Form
                        </button>
                    </div>
                </div>` 
            },
            '8': { 
                id: 8, 
                name: 'Couple Therapy Policy: Limited Secrets Policy', 
                content: `<div style="font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; line-height: 1.6;">
                    <h2 style="text-align: center; color: #2c3e50; margin-bottom: 30px;">Couple Therapy Policy: Limited Secrets Policy</h2>
                    
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 30px;">
                        <h3 style="color: #2c3e50; margin-bottom: 15px;">Couple Therapy Policy</h3>
                        <p>If you are here to work on a relationship problem, it's important for you to understand what I believe about relationships and marriage. First of all, I do not have preconceived notions about whether you should stay together or part ways. I believe it is important to explore such questions openly, honestly, and thoroughly. Once your goals are established, I will work diligently to support you in achieving them, whatever they may be.</p>
                        
                        <p style="margin-top: 15px;">Second, you are entrusting me to use my professional judgment as it relates to individual confidences. By signing this form, you are acknowledging that anything you communicate to me individually by phone, email, or any other means may be important to bring up and work on in a couple therapy session, and I reserve the right (but not the obligation) to do so.</p>
                    </div>
                    
                    <div style="background: #fff3cd; padding: 15px; border-radius: 8px; margin-bottom: 30px;">
                        <h3 style="color: #2c3e50; margin-bottom: 15px;">Important Understanding</h3>
                        <p>This policy helps ensure that both partners can work together effectively in therapy. It promotes transparency and honesty, which are essential for successful couple therapy outcomes.</p>
                    </div>
                    
                    <form id="couplePolicyForm" style="margin-bottom: 30px;">
                        <div style="margin-bottom: 20px; padding: 15px; border: 1px solid #e9ecef; border-radius: 8px;">
                            <label style="display: block; margin-bottom: 10px;">
                                <input type="checkbox" name="acknowledgePolicy" required>
                                I acknowledge that I have read and understand this Couple Therapy Policy regarding limited secrets.
                            </label>
                            
                            <label style="display: block; margin-bottom: 10px;">
                                <input type="checkbox" name="consentToSharing" required>
                                I consent to sharing information provided here and understand that individual communications may be discussed in couple sessions when clinically appropriate.
                            </label>
                        </div>
                    </form>
                    
                    <div style="border-top: 2px solid #e9ecef; padding-top: 30px; margin-top: 30px;">
                        <h3 style="color: #2c3e50; margin-bottom: 20px;">Digital Signatures</h3>
                        
                        <div style="display: flex; gap: 40px; margin-bottom: 30px;">
                            <div style="flex: 1;">
                                <h4 style="color: #1976d2; margin-bottom: 15px;">Client Signature</h4>
                                <div style="border: 2px dashed #1976d2; border-radius: 8px; padding: 20px; text-align: center; min-height: 100px; background: #f8f9fa;">
                                    <div id="clientSignature" style="min-height: 60px; display: flex; align-items: center; justify-content: center; color: #666;">
                                        <span>Client Signature Required</span>
                                    </div>
                                    <div style="margin-top: 10px; font-size: 12px; color: #666;">
                                        <div>Client Name: <input type="text" id="clientName" style="border: none; border-bottom: 1px solid #ccc; background: transparent; width: 200px;"></div>
                                        <div style="margin-top: 5px;">Date: <span id="clientDate"></span></div>
                                    </div>
                                </div>
                            </div>
                            
                            <div style="flex: 1;">
                                <h4 style="color: #9c27b0; margin-bottom: 15px;">Clinician Signature</h4>
                                <div style="border: 2px dashed #9c27b0; border-radius: 8px; padding: 20px; text-align: center; min-height: 100px; background: #f8f9fa;">
                                    <div id="clinicianSignature" style="min-height: 60px; display: flex; align-items: center; justify-content: center; color: #666;">
                                        <span>Clinician Signature Required</span>
                                    </div>
                                    <div style="margin-top: 10px; font-size: 12px; color: #666;">
                                        <div>Clinician Name: <input type="text" id="clinicianName" style="border: none; border-bottom: 1px solid #ccc; background: transparent; width: 200px;"></div>
                                        <div style="margin-top: 5px;">Date: <span id="clinicianDate"></span></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div style="text-align: center; margin-top: 30px;">
                        <button onclick="submitCouplePolicyDocument()" style="background: #00a86b; color: white; border: none; padding: 12px 30px; border-radius: 6px; font-size: 16px; cursor: pointer;">
                            Submit Policy Agreement
                        </button>
                    </div>
                </div>` 
            },
            '9': { 
                id: 9, 
                name: 'Couples Counseling Initial Intake Form', 
                content: `<div style="font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; line-height: 1.6;">
                    <h2 style="text-align: center; color: #2c3e50; margin-bottom: 30px;">Couples Counseling Initial Intake Form</h2>
                    
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                        <p><strong>Instructions:</strong> Prior to your first appointment, please answer all questions below. Do not spend too much time on any question.</p>
                    </div>
                    
                    <form id="couplesIntakeForm" style="margin-bottom: 30px;">
                        <div style="margin-bottom: 20px; padding: 15px; border: 1px solid #e9ecef; border-radius: 8px;">
                            <label><strong>Name of partner:</strong></label><br>
                            <input type="text" name="partnerName" style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ccc; border-radius: 4px;" required>
                        </div>
                        
                        <div style="margin-bottom: 20px; padding: 15px; border: 1px solid #e9ecef; border-radius: 8px;">
                            <label><strong>Relationship status (check all that apply):</strong></label><br>
                            <label><input type="checkbox" name="status" value="married"> Married</label><br>
                            <label><input type="checkbox" name="status" value="separated"> Separated</label><br>
                            <label><input type="checkbox" name="status" value="divorced"> Divorced</label><br>
                            <label><input type="checkbox" name="status" value="dating"> Dating</label><br>
                            <label><input type="checkbox" name="status" value="cohabitating"> Cohabitating/living together</label><br>
                            <label><input type="checkbox" name="status" value="living-apart"> Living apart</label>
                        </div>
                        
                        <div style="margin-bottom: 20px; padding: 15px; border: 1px solid #e9ecef; border-radius: 8px;">
                            <label><strong>Length of time in current relationship:</strong></label><br>
                            <input type="text" name="relationshipLength" style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ccc; border-radius: 4px;" required>
                        </div>
                        
                        <div style="margin-bottom: 20px; padding: 15px; border: 1px solid #e9ecef; border-radius: 8px;">
                            <label><strong>As you think about the primary reason that brings you here, how does it occur?</strong></label><br>
                            <select name="occurrence" style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ccc; border-radius: 4px;" required>
                                <option value="">Select frequency</option>
                                <option value="no-occurrence">No occurrence</option>
                                <option value="rarely">Occurs rarely</option>
                                <option value="sometimes">Occurs sometimes</option>
                                <option value="frequently">Occurs frequently</option>
                                <option value="nearly-always">Occurs nearly always</option>
                            </select>
                        </div>
                        
                        <div style="margin-bottom: 20px; padding: 15px; border: 1px solid #e9ecef; border-radius: 8px;">
                            <label><strong>As you think about the primary reason that brings you here, how would you rate your overall concern about it?</strong></label><br>
                            <select name="concern" style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ccc; border-radius: 4px;" required>
                                <option value="">Select concern level</option>
                                <option value="no-concern">No concern</option>
                                <option value="little-concern">Little concern</option>
                                <option value="moderate-concern">Moderate concern</option>
                                <option value="serious-concern">Serious concern</option>
                                <option value="very-serious">Very serious concern</option>
                            </select>
                        </div>
                        
                        <div style="margin-bottom: 20px; padding: 15px; border: 1px solid #e9ecef; border-radius: 8px;">
                            <label><strong>What do you hope to accomplish through counseling?</strong></label><br>
                            <textarea name="goals" rows="4" style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ccc; border-radius: 4px;" required></textarea>
                        </div>
                        
                        <div style="margin-bottom: 20px; padding: 15px; border: 1px solid #e9ecef; border-radius: 8px;">
                            <label><strong>What have you already done to deal with the difficulties?</strong></label><br>
                            <textarea name="attemptedSolutions" rows="4" style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ccc; border-radius: 4px;" required></textarea>
                        </div>
                        
                        <div style="margin-bottom: 20px; padding: 15px; border: 1px solid #e9ecef; border-radius: 8px;">
                            <label><strong>What are your biggest strengths as a couple?</strong></label><br>
                            <textarea name="strengths" rows="3" style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ccc; border-radius: 4px;" required></textarea>
                        </div>
                        
                        <div style="margin-bottom: 20px; padding: 15px; border: 1px solid #e9ecef; border-radius: 8px;">
                            <label><strong>Please rate your current level of relationship happiness (1-10):</strong></label><br>
                            <select name="happiness" style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ccc; border-radius: 4px;" required>
                                <option value="">Select rating</option>
                                <option value="1">1 - Extremely unhappy</option>
                                <option value="2">2</option>
                                <option value="3">3</option>
                                <option value="4">4</option>
                                <option value="5">5</option>
                                <option value="6">6</option>
                                <option value="7">7</option>
                                <option value="8">8</option>
                                <option value="9">9</option>
                                <option value="10">10 - Extremely happy</option>
                            </select>
                        </div>
                        
                        <div style="margin-bottom: 20px; padding: 15px; border: 1px solid #e9ecef; border-radius: 8px;">
                            <label><strong>Have you received prior couples counseling related to any of the above problems?</strong></label><br>
                            <label><input type="radio" name="priorCounseling" value="yes"> Yes</label>
                            <label style="margin-left: 20px;"><input type="radio" name="priorCounseling" value="no"> No</label>
                        </div>
                        
                        <div style="margin-bottom: 20px; padding: 15px; border: 1px solid #e9ecef; border-radius: 8px;">
                            <label><strong>Please make at least one suggestion as to something you could personally do to improve the relationship regardless of what your partner does:</strong></label><br>
                            <textarea name="personalImprovement" rows="3" style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ccc; border-radius: 4px;" required></textarea>
                        </div>
                        
                        <div style="margin-bottom: 20px; padding: 15px; border: 1px solid #e9ecef; border-radius: 8px;">
                            <label><strong>If you have received prior couples counseling, when did this occur?</strong></label><br>
                            <input type="text" name="priorCounselingWhen" style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ccc; border-radius: 4px;" placeholder="If not applicable, type N/A">
                        </div>
                        
                        <div style="margin-bottom: 20px; padding: 15px; border: 1px solid #e9ecef; border-radius: 8px;">
                            <label><strong>If you have received prior couples counseling, where did this occur?</strong></label><br>
                            <input type="text" name="priorCounselingWhere" style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ccc; border-radius: 4px;" placeholder="If not applicable, type N/A">
                        </div>
                        
                        <div style="margin-bottom: 20px; padding: 15px; border: 1px solid #e9ecef; border-radius: 8px;">
                            <label><strong>If you have received prior couples counseling, who counseled you?</strong></label><br>
                            <input type="text" name="priorCounselingWho" style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ccc; border-radius: 4px;" placeholder="If not applicable, type N/A">
                        </div>
                        
                        <div style="margin-bottom: 20px; padding: 15px; border: 1px solid #e9ecef; border-radius: 8px;">
                            <label><strong>If you have received prior couples counseling, what was the length of treatment?</strong></label><br>
                            <input type="text" name="priorCounselingLength" style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ccc; border-radius: 4px;" placeholder="If not applicable, type N/A">
                        </div>
                        
                        <div style="margin-bottom: 20px; padding: 15px; border: 1px solid #e9ecef; border-radius: 8px;">
                            <label><strong>If you have received prior couples counseling, what were the problems that were treated?</strong></label><br>
                            <textarea name="priorCounselingProblems" rows="3" style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ccc; border-radius: 4px;" placeholder="If not applicable, type N/A"></textarea>
                        </div>
                        
                        <div style="margin-bottom: 20px; padding: 15px; border: 1px solid #e9ecef; border-radius: 8px;">
                            <label><strong>Have either you or your partner been in individual counseling before?</strong></label><br>
                            <label><input type="radio" name="individualCounseling" value="yes"> Yes</label>
                            <label style="margin-left: 20px;"><input type="radio" name="individualCounseling" value="no"> No</label>
                        </div>
                        
                        <div style="margin-bottom: 20px; padding: 15px; border: 1px solid #e9ecef; border-radius: 8px;">
                            <label><strong>Do either you or your partner drink alcohol to intoxication or take drugs to intoxication?</strong></label><br>
                            <label><input type="radio" name="substanceUse" value="yes"> Yes</label>
                            <label style="margin-left: 20px;"><input type="radio" name="substanceUse" value="no"> No</label>
                        </div>
                        
                        <div style="margin-bottom: 20px; padding: 15px; border: 1px solid #e9ecef; border-radius: 8px;">
                            <label><strong>If you have received prior couples counseling, what was the outcome?</strong></label><br>
                            <select name="priorCounselingOutcome" style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ccc; border-radius: 4px;">
                                <option value="">Select outcome</option>
                                <option value="much-worse">Much worse</option>
                                <option value="somewhat-worse">Somewhat worse</option>
                                <option value="same">Stayed the same</option>
                                <option value="somewhat-successful">Somewhat successful</option>
                                <option value="very-successful">Very successful</option>
                                <option value="n/a">N/A</option>
                            </select>
                        </div>
                        
                        <div style="margin-bottom: 20px; padding: 15px; border: 1px solid #e9ecef; border-radius: 8px;">
                            <label><strong>If married, has either of you threatened to separate or divorce as a result of the current relationship problems?</strong></label><br>
                            <select name="separationThreat" style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ccc; border-radius: 4px;">
                                <option value="">Select option</option>
                                <option value="yes">Yes</option>
                                <option value="no">No</option>
                                <option value="n/a">N/A (Not married)</option>
                            </select>
                        </div>
                        
                        <div style="margin-bottom: 20px; padding: 15px; border: 1px solid #e9ecef; border-radius: 8px;">
                            <label><strong>Have either you or your partner struck, physically restrained, used violence against, or injured the other person?</strong></label><br>
                            <label><input type="radio" name="violence" value="yes"> Yes</label>
                            <label style="margin-left: 20px;"><input type="radio" name="violence" value="no"> No</label>
                        </div>
                        
                        <div style="margin-bottom: 20px; padding: 15px; border: 1px solid #e9ecef; border-radius: 8px;">
                            <label><strong>Do you perceive that either you or your partner has withdrawn from the relationship?</strong></label><br>
                            <label><input type="radio" name="withdrawal" value="yes"> Yes</label>
                            <label style="margin-left: 20px;"><input type="radio" name="withdrawal" value="no"> No</label>
                        </div>
                        
                        <div style="margin-bottom: 20px; padding: 15px; border: 1px solid #e9ecef; border-radius: 8px;">
                            <label><strong>If married, have either you or your partner consulted with a lawyer about divorce?</strong></label><br>
                            <select name="lawyerConsultation" style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ccc; border-radius: 4px;">
                                <option value="">Select option</option>
                                <option value="yes">Yes</option>
                                <option value="no">No</option>
                                <option value="n/a">N/A (Not married)</option>
                            </select>
                        </div>
                        
                        <div style="margin-bottom: 20px; padding: 15px; border: 1px solid #e9ecef; border-radius: 8px;">
                            <label><strong>How frequently have you had sexual relations during the last month?</strong></label><br>
                            <input type="text" name="sexualFrequency" style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ccc; border-radius: 4px;">
                        </div>
                        
                        <div style="margin-bottom: 20px; padding: 15px; border: 1px solid #e9ecef; border-radius: 8px;">
                            <label><strong>How satisfied are you with the frequency of your sexual relations? (1-10)</strong></label><br>
                            <select name="sexualSatisfaction" style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ccc; border-radius: 4px;">
                                <option value="">Select rating</option>
                                <option value="1">1 - Extremely unsatisfied</option>
                                <option value="2">2</option>
                                <option value="3">3</option>
                                <option value="4">4</option>
                                <option value="5">5</option>
                                <option value="6">6</option>
                                <option value="7">7</option>
                                <option value="8">8</option>
                                <option value="9">9</option>
                                <option value="10">10 - Extremely satisfied</option>
                            </select>
                        </div>
                        
                        <div style="margin-bottom: 20px; padding: 15px; border: 1px solid #e9ecef; border-radius: 8px;">
                            <label><strong>How enjoyable is your sexual relationship? (1-10)</strong></label><br>
                            <select name="sexualEnjoyment" style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ccc; border-radius: 4px;">
                                <option value="">Select rating</option>
                                <option value="1">1 - Extremely unpleasant</option>
                                <option value="2">2</option>
                                <option value="3">3</option>
                                <option value="4">4</option>
                                <option value="5">5</option>
                                <option value="6">6</option>
                                <option value="7">7</option>
                                <option value="8">8</option>
                                <option value="9">9</option>
                                <option value="10">10 - Extremely pleasant</option>
                            </select>
                        </div>
                        
                        <div style="margin-bottom: 20px; padding: 15px; border: 1px solid #e9ecef; border-radius: 8px;">
                            <label><strong>What is your current level of stress (overall)? (1-10)</strong></label><br>
                            <select name="overallStress" style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ccc; border-radius: 4px;" required>
                                <option value="">Select rating</option>
                                <option value="1">1 - No stress</option>
                                <option value="2">2</option>
                                <option value="3">3</option>
                                <option value="4">4</option>
                                <option value="5">5</option>
                                <option value="6">6</option>
                                <option value="7">7</option>
                                <option value="8">8</option>
                                <option value="9">9</option>
                                <option value="10">10 - High stress</option>
                            </select>
                        </div>
                        
                        <div style="margin-bottom: 20px; padding: 15px; border: 1px solid #e9ecef; border-radius: 8px;">
                            <label><strong>What is your current level of stress (in the relationship)? (1-10)</strong></label><br>
                            <select name="relationshipStress" style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ccc; border-radius: 4px;" required>
                                <option value="">Select rating</option>
                                <option value="1">1 - No stress</option>
                                <option value="2">2</option>
                                <option value="3">3</option>
                                <option value="4">4</option>
                                <option value="5">5</option>
                                <option value="6">6</option>
                                <option value="7">7</option>
                                <option value="8">8</option>
                                <option value="9">9</option>
                                <option value="10">10 - High stress</option>
                            </select>
                        </div>
                        
                        <div style="margin-bottom: 20px; padding: 15px; border: 1px solid #e9ecef; border-radius: 8px;">
                            <label><strong>List your top three concerns that you have in your relationship with your partner (1 being the most problematic):</strong></label><br>
                            <textarea name="topConcerns" rows="4" style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ccc; border-radius: 4px;" required></textarea>
                        </div>
                        
                        <div style="background: #fff3cd; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                            <p><strong>Thank you for completing this.</strong> Please note that you will be asked to talk about your answers in appointments, but your partner will not be shown this form.</p>
                        </div>
                    </form>
                    
                    <div style="border-top: 2px solid #e9ecef; padding-top: 30px; margin-top: 30px;">
                        <h3 style="color: #2c3e50; margin-bottom: 20px;">Digital Signatures</h3>
                        
                        <div style="display: flex; gap: 40px; margin-bottom: 30px;">
                            <div style="flex: 1;">
                                <h4 style="color: #1976d2; margin-bottom: 15px;">Client Signature</h4>
                                <div style="border: 2px dashed #1976d2; border-radius: 8px; padding: 20px; text-align: center; min-height: 100px; background: #f8f9fa;">
                                    <div id="clientSignature" style="min-height: 60px; display: flex; align-items: center; justify-content: center; color: #666;">
                                        <span>Client Signature Required</span>
                                    </div>
                                    <div style="margin-top: 10px; font-size: 12px; color: #666;">
                                        <div>Client Name: <input type="text" id="clientName" style="border: none; border-bottom: 1px solid #ccc; background: transparent; width: 200px;"></div>
                                        <div style="margin-top: 5px;">Date: <span id="clientDate"></span></div>
                                    </div>
                                </div>
                            </div>
                            
                            <div style="flex: 1;">
                                <h4 style="color: #9c27b0; margin-bottom: 15px;">Clinician Signature</h4>
                                <div style="border: 2px dashed #9c27b0; border-radius: 8px; padding: 20px; text-align: center; min-height: 100px; background: #f8f9fa;">
                                    <div id="clinicianSignature" style="min-height: 60px; display: flex; align-items: center; justify-content: center; color: #666;">
                                        <span>Clinician Signature Required</span>
                                    </div>
                                    <div style="margin-top: 10px; font-size: 12px; color: #666;">
                                        <div>Clinician Name: <input type="text" id="clinicianName" style="border: none; border-bottom: 1px solid #ccc; background: transparent; width: 200px;"></div>
                                        <div style="margin-top: 5px;">Date: <span id="clinicianDate"></span></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div style="text-align: center; margin-top: 30px;">
                        <button onclick="submitCouplesIntakeDocument()" style="background: #00a86b; color: white; border: none; padding: 12px 30px; border-radius: 6px; font-size: 16px; cursor: pointer;">
                            Submit Intake Form
                        </button>
                    </div>
                </div>` 
            }
        };
        
        saveToStorage('templates', demoTemplates);
        console.log(' Templates initialized');
    }
    
    const hasData = localStorage.getItem(getStorageKey('clients'));
    if (!hasData) {
        
        // Initialize with demo data
        const demoClients = [
            { id: 1, name: 'John Doe', email: 'john@example.com', phone: '555-0123', status: 'active', created_at: new Date().toISOString() },
            { id: 2, name: 'Jane Smith', email: 'jane@example.com', phone: '555-0124', status: 'active', created_at: new Date().toISOString() }
        ];
        const demoAppointments = [
            { id: 1, client_id: 1, client_name: 'John Doe', appointment_date: new Date().toISOString().split('T')[0], appointment_time: '09:00', duration: 60, type: 'Initial Consultation', notes: 'Initial consultation', status: 'scheduled', created_at: new Date().toISOString() },
            { id: 2, client_id: 2, client_name: 'Jane Smith', appointment_date: new Date(Date.now() + 86400000).toISOString().split('T')[0], appointment_time: '14:00', duration: 45, type: 'Follow-up', notes: 'Follow-up appointment', status: 'scheduled', created_at: new Date().toISOString() }
        ];
        
        const demoAssignedDocs = [
            { id: 1, client_id: 1, client_name: 'John Doe', template_id: 'ace-questionnaire', template_name: 'ACE Questionnaire', auth_code: 'ABC-123456', status: 'pending', assigned_at: new Date().toISOString(), created_at: new Date().toISOString(), expiration_date: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toISOString() },
            { id: 2, client_id: 2, client_name: 'Jane Smith', template_id: 'informed-consent', template_name: 'Informed Consent for Psychotherapy', auth_code: 'XYZ-789012', status: 'pending', assigned_at: new Date().toISOString(), created_at: new Date().toISOString(), expiration_date: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toISOString() }
        ];
        
        saveToStorage('clients', demoClients);
        saveToStorage('appointments', demoAppointments);
        saveToStorage('assigned_docs', demoAssignedDocs);
        saveToStorage('invoices', []);
        
        logLocalAudit('system_init', { message: 'Demo data initialized' });
    }
}

async function loadTemplates() {
    try {
        const templates = loadFromStorage('templates', {});
        documentTemplates = templates;
        Object.keys(templates).forEach(id => {
            templateNames[id] = templates[id].name;
        });
        
        console.log(' Loaded', Object.keys(documentTemplates).length, 'templates');
        
        // If no templates loaded, initialize them
        if (Object.keys(documentTemplates).length === 0) {
            console.log('[WARN] No templates found in storage, initializing...');
            initializeDemoData();
            // Reload after initialization
            const newTemplates = loadFromStorage('templates', {});
            documentTemplates = newTemplates;
            Object.keys(newTemplates).forEach(id => {
                templateNames[id] = newTemplates[id].name;
            });
            console.log(' Templates initialized and loaded:', Object.keys(documentTemplates).length);
        }
    } catch (error) {
        console.error('Error loading templates:', error);
        alert('Failed to load templates');
    }
}

// localStorage-based API replacement functions
async function apiCall(endpoint, options = {}) {
    // DISABLED - No API calls allowed
    console.log('apiCall disabled - endpoint:', endpoint);
    throw new Error('API calls disabled - use localStorage functions directly');
}


function switchAuthTab(tab) {
    document.querySelectorAll('.auth-tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.auth-form').forEach(f => f.classList.remove('active'));
    event.target.classList.add('active');
    document.getElementById(tab + 'Auth').classList.add('active');
}

function quickTestLogin() {
    // Auto-fill demo credentials
    document.getElementById('clinicianUsername').value = 'Joe';
    document.getElementById('clinicianPassword').value = 'Mo';
    document.getElementById('rememberMe').checked = false;

    // Trigger login
    clinicianLogin();
}

async function clinicianLogin() {
    const username = document.getElementById('clinicianUsername').value.trim();
    const password = document.getElementById('clinicianPassword').value;
    const rememberMe = document.getElementById('rememberMe').checked;
    
    if (!username || !password) {
        showNotification('Please enter both username and password', 'error');
        return;
    }
    
    try {
        // Load all clinicians from storage
        const clinicians = loadFromStorage('clinicians', []);
        console.log('Loaded clinicians from storage:', clinicians);
        console.log('Looking for username:', username);
        console.log('Looking for password:', password);
        
        // Debug: Log each clinician's details
        clinicians.forEach((c, index) => {
            console.log(`Clinician ${index}:`, {
                id: c.id,
                username: c.username,
                password: c.password,
                fullName: c.fullName
            });
        });
        
        // Find matching clinician
        const clinician = clinicians.find(c => 
            c.username === username && c.password === password
        );
        console.log('Found clinician:', clinician);
        
        if (clinician) {
            // Login successful
            authToken = 'token-' + Date.now() + '-' + clinician.id;
            currentUser = {
                id: clinician.id,
                name: clinician.fullName,
                email: clinician.email,
                username: clinician.username,
                role: 'admin',
                createdAt: clinician.createdAt
            };
            
            // Set session with remember me option
            setSession(rememberMe);
            
            logAudit('login', { 
                username: username,
                user_id: clinician.id,
                method: 'password',
                rememberMe: rememberMe
            });
            
            showNotification('Login successful!', 'success');
            showApp();
            
        } else {
            showNotification('Invalid username or password', 'error');
        }
        
    } catch (error) {
        console.error('Login error:', error);
        showNotification('Login failed: ' + error.message, 'error');
    }
}

function showRegisterForm() {
    document.getElementById('clinicianAuth').style.display = 'none';
    document.getElementById('registerForm').style.display = 'block';
}

function showLoginForm() {
    document.getElementById('registerForm').style.display = 'none';
    document.getElementById('clinicianAuth').style.display = 'block';
}

function registerClinician() {
    const username = document.getElementById('regUsername').value.trim();
    const password = document.getElementById('regPassword').value;
    const confirmPassword = document.getElementById('regConfirmPassword').value;
    const fullName = document.getElementById('regFullName').value.trim();
    const email = document.getElementById('regEmail').value.trim();
    
    // Validation
    if (!username || !password || !confirmPassword || !fullName || !email) {
        showNotification('Please fill in all fields', 'error');
        return;
    }
    
    if (password !== confirmPassword) {
        showNotification('Passwords do not match', 'error');
        return;
    }
    
    if (password.length < 8) {
        showNotification('Password must be at least 8 characters', 'error');
        return;
    }
    
    if (!email.includes('@')) {
        showNotification('Please enter a valid email address', 'error');
        return;
    }
    
    try {
        // Load existing clinicians
        const clinicians = loadFromStorage('clinicians', []);
        
        // Check if username already exists
        if (clinicians.find(c => c.username === username)) {
            showNotification('Username already exists', 'error');
            return;
        }
        
        // Check if email already exists
        if (clinicians.find(c => c.email === email)) {
            showNotification('Email already registered', 'error');
            return;
        }
        
        // Create new clinician
        const newClinician = {
            id: 'clinician-' + Date.now(),
            username: username,
            password: password, // In production, this should be hashed
            fullName: fullName,
            email: email,
            role: 'admin',
            createdAt: new Date().toISOString(),
            isActive: true
        };
        
        // Add to clinicians array
        clinicians.push(newClinician);
        console.log('Saving clinicians:', clinicians);
        
        saveToStorage('clinicians', clinicians);
        
        // Verify save
        const verifyClinicians = loadFromStorage('clinicians', []);
        console.log('Verified clinicians after save:', verifyClinicians);
        
        // Log registration
        logAudit('clinician_registered', {
            username: username,
            email: email,
            user_id: newClinician.id
        });
        
        showNotification('Registration successful! Please login.', 'success');
        
        // Switch back to login form
        setTimeout(() => {
            showLoginForm();
            // Pre-fill username
            document.getElementById('loginUsername').value = username;
        }, 1500);
        
    } catch (error) {
        console.error('Registration error:', error);
        showNotification('Registration failed: ' + error.message, 'error');
    }
}


async function accessDocument() {
    console.log('[START] accessDocument() called');
    const codeInput = document.getElementById('authCode');
    const code = codeInput.value.toUpperCase().trim();

    console.log('[NOTE] Auth code entered:', code);

    if (!code) {
        showAuthError('Please enter an access code');
        return;
    }

    // Validate code format (ABCD-12345678 - 4 chars, dash, 8 chars)
    if (!/^[A-Z0-9]{4}-[A-Z0-9]{8}$/.test(code)) {
        showAuthError('Invalid code format. Please use the format provided by your clinician');
        return;
    }

    try {
        console.log('[PKG] Templates loaded:', Object.keys(documentTemplates).length);
        if (Object.keys(documentTemplates).length === 0) {
            console.log('[WARN] No templates, loading now...');
            await loadTemplates();
            console.log(' Templates loaded:', Object.keys(documentTemplates).length);
        }

        // Use localStorage instead of API call
        const allDocs = loadFromStorage('assigned_docs', []);
        // Check both auth_code and access_code for compatibility
        const docs = allDocs.filter(d => d.auth_code === code || d.access_code === code);

        console.log('[SEARCH] Auth code search:', { code, totalDocs: allDocs.length, matchingDocs: docs.length, allDocs, matchedDocs: docs });
        
        if (docs.length === 0) {
            showAuthError('This access code was not found. Please check your code and try again.');
            return;
        }
        
        // Check for expired codes
        const now = new Date();
        const validDocs = docs.filter(doc => {
            if (doc.status === 'completed') {
                console.log('[DOC] Document already completed:', doc.template_name);
                return false;
            }
            if (doc.expiration_date) {
                const expDate = new Date(doc.expiration_date);
                if (expDate < now) {
                    console.log('[TIME] Expired document:', doc.template_name, 'expired on:', expDate.toLocaleDateString());
                    return false;
                }
            }
            return true;
        });
        
        if (validDocs.length === 0) {
            const completedCount = docs.filter(d => d.status === 'completed').length;
            const expiredCount = docs.filter(d => {
                if (d.expiration_date) {
                    const expDate = new Date(d.expiration_date);
                    return expDate < now;
                }
                return false;
            }).length;
            
            if (completedCount > 0) {
                showAuthError('All documents for this code have been completed.');
            } else if (expiredCount > 0) {
                showAuthError('This access code has expired. Please contact your clinician for a new code.');
            } else {
                showAuthError('No valid documents found for this code.');
            }
            return;
        }
        
        // Clear any previous errors
        clearAuthError();

        console.log(' Valid documents found:', validDocs.length);
        console.log('[LIST] Valid docs details:', validDocs);

        currentDocuments = validDocs;
        currentDocIndex = 0;

        console.log('[NOTE] Logging audit...');
        await logAudit('client_access', { code, docCount: validDocs.length }, 'Client');

        console.log('[INFO] About to call showClientPortal()');
        showClientPortal();
        console.log(' showClientPortal() returned');

        // Clear the auth code input
        codeInput.value = '';

    } catch (error) {
        console.error(' Access document error:', error);
        console.error(' Error stack:', error.stack);
        showAuthError('Error accessing documents: ' + error.message);
    }
}

function showAuthError(message) {
    const errorElement = document.getElementById('authcode-help');
    if (errorElement) {
        errorElement.textContent = message;
        errorElement.style.display = 'block';
        errorElement.style.color = '#dc3545';
    } else {
        alert(message);
    }
}

function clearAuthError() {
    const errorElement = document.getElementById('authcode-help');
    if (errorElement) {
        errorElement.style.display = 'none';
        errorElement.textContent = '';
    }
}

// Loading State Functions
function showLoadingState() {
    const overlay = document.getElementById('loadingOverlay');
    if (overlay) {
        overlay.classList.add('active');
    }
}

function hideLoadingState() {
    const overlay = document.getElementById('loadingOverlay');
    if (overlay) {
        overlay.classList.remove('active');
    }
}

// Debouncing utility function
function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}

// Create debounced versions of search functions
const debouncedFilterClients = debounce(filterClients, 300);
// Filter appointments function
function filterAppointments() {
    // This function can be used to filter appointments if needed
    // For now, just reload the appointments list
    renderAppointmentsList();
}

const debouncedFilterAppointments = debounce(filterAppointments, 300);

// Filter invoices function
function filterInvoices() {
    // This function can be used to filter invoices if needed
    // For now, just reload the invoices list
    loadInvoices();
}

const debouncedFilterInvoices = debounce(filterInvoices, 300);

// Performance optimization: Cache DOM elements
const domCache = {
    clientsList: null,
    appointmentsList: null,
    invoicesList: null,
    calendarView: null
};

// Optimized DOM element getter with caching
function getCachedElement(id) {
    if (!domCache[id]) {
        domCache[id] = document.getElementById(id);
    }
    return domCache[id];
}

// Performance optimization: Memoization for expensive calculations
const memoCache = new Map();

function memoize(func, keyGenerator) {
    return function(...args) {
        const key = keyGenerator ? keyGenerator(...args) : JSON.stringify(args);
        
        if (memoCache.has(key)) {
            return memoCache.get(key);
        }
        
        const result = func.apply(this, args);
        memoCache.set(key, result);
        
        // Limit cache size to prevent memory leaks
        if (memoCache.size > 100) {
            const firstKey = memoCache.keys().next().value;
            memoCache.delete(firstKey);
        }
        
        return result;
    };
}

function logout() {
    // Log the logout before clearing
    logAudit('logout', { 
        method: 'session',
        username: currentUser?.username || 'unknown'
    });
    
    // Clear session
    clearSession();
    
    // Remove old auth data
    localStorage.removeItem('auth_token');
    localStorage.removeItem('current_user');
    
    // Show login screen
    document.getElementById('authContainer').style.display = 'block';
    document.getElementById('appContainer').style.display = 'none';
    document.getElementById('clientPortal').style.display = 'none';

    // Clear form fields (use correct IDs)
    const usernameField = document.getElementById('clinicianUsername');
    const passwordField = document.getElementById('clinicianPassword');
    if (usernameField) usernameField.value = '';
    if (passwordField) passwordField.value = '';

    alert(' Logged out successfully!');
}

function clientLogout() {
    // Clear client portal data
    currentDocuments = [];
    currentDocIndex = 0;
    
    // Clear the auth code input
    document.getElementById('authCode').value = '';
    
    // Return to login screen
    document.getElementById('clientPortal').style.display = 'none';
    document.getElementById('authContainer').style.display = 'block';
    document.getElementById('appContainer').style.display = 'none';
    
    console.log(' Client logged out');
}

async function showApp() {
    document.getElementById('authContainer').style.display = 'none';
    document.getElementById('appContainer').style.display = 'block';
    document.getElementById('userName').textContent = currentUser.name;
    await loadData();
    updateSubscriptionStatus();
}

// Update subscription status display
function updateSubscriptionStatus() {
    const statusElement = document.getElementById('subscriptionStatus');
    const daysLeftElement = document.getElementById('trialDaysLeft');
    
    if (!statusElement || !daysLeftElement || !currentUser) return;
    
    // Check if user is on trial
    if (currentUser.subscriptionStatus === 'trial' && currentUser.trialEndDate) {
        const trialEndDate = new Date(currentUser.trialEndDate);
        const now = new Date();
        const daysLeft = Math.ceil((trialEndDate - now) / (1000 * 60 * 60 * 24));
        
        if (daysLeft > 0) {
            statusElement.style.display = 'block';
            daysLeftElement.textContent = `${daysLeft} days left in trial`;
            
            // Change styling based on days left
            if (daysLeft <= 3) {
                statusElement.className = 'subscription-status trial-ending';
            } else if (daysLeft <= 7) {
                statusElement.className = 'subscription-status';
            } else {
                statusElement.className = 'subscription-status';
            }
        } else {
            // Trial expired
            statusElement.style.display = 'block';
            statusElement.className = 'subscription-status trial-ending';
            daysLeftElement.textContent = 'Trial expired - Subscribe now';
        }
    } else if (currentUser.subscriptionStatus === 'active') {
        statusElement.style.display = 'block';
        statusElement.className = 'subscription-status active';
        daysLeftElement.textContent = 'Active subscription';
    } else {
        statusElement.style.display = 'none';
    }
}

// Update navigation based on subscription plan
function updateNavigationForSubscription() {
    const subscription = window.SubscriptionHelpers?.getCurrentSubscription() || {
        planId: 'essential',
        status: 'active',
        selectedAddon: null
    };

    const telehealthBtn = document.getElementById('telehealthNavBtn');
    const aiNoteTakerBtn = document.getElementById('aiNoteTakerNavBtn');

    // Telehealth: Professional or Complete (Professional+)
    if (telehealthBtn) {
        telehealthBtn.style.display =
            (subscription.planId === 'professional' ||
             subscription.planId === 'complete')
            ? 'block' : 'none';
    }

    // AI NoteTaker: Complete only
    if (aiNoteTakerBtn) {
        aiNoteTakerBtn.style.display =
            subscription.planId === 'complete'
            ? 'block' : 'none';
    }
}

function showClientPortal() {
    console.log('[CLINIC] showClientPortal() called');
    console.log('[STATS] currentDocuments:', currentDocuments);
    console.log(' currentDocIndex:', currentDocIndex);

    const authContainer = document.getElementById('authContainer');
    const clientPortal = document.getElementById('clientPortal');

    console.log('[SEARCH] Elements found:', {
        authContainer: !!authContainer,
        clientPortal: !!clientPortal
    });

    if (!authContainer) {
        console.error(' authContainer element not found!');
    }
    if (!clientPortal) {
        console.error(' clientPortal element not found!');
    }

    authContainer.style.display = 'none';
    clientPortal.style.display = 'block';

    console.log(' Portal visibility changed. Calling renderClientDocuments()...');
    renderClientDocuments();
    console.log(' renderClientDocuments() completed');
}

function renderClientDocuments() {
    console.log('[DOC] renderClientDocuments() called');

    const container = document.getElementById('clientPortalContent');
    console.log('[INFO] Container element:', !!container);

    if (!container) {
        console.error(' clientPortalContent container not found!');
        return;
    }

    if (currentDocuments.length === 0) {
        console.warn(' No current documents to render');
        container.innerHTML = '<div>No documents found</div>';
        return;
    }

    const doc = currentDocuments[currentDocIndex];
    const template = documentTemplates[doc.template_id];

    // Debug logging
    console.log('[SEARCH] Rendering document:', {
        docId: doc.id,
        templateId: doc.template_id,
        templateExists: !!template,
        availableTemplates: Object.keys(documentTemplates),
        currentDoc: doc
    });

    // Check if template exists
    if (!template) {
        console.error(' Template not found:', doc.template_id);
        container.innerHTML = `
            <div style="padding: 40px; text-align: center;">
                <h2 style="color: #dc3545; margin-bottom: 20px;"> Document Template Not Found</h2>
                <p style="margin-bottom: 10px;">Template ID: <code>${doc.template_id}</code></p>
                <p style="margin-bottom: 20px; color: #666;">This document template is no longer available.</p>
                <p style="font-size: 14px; color: #888;">Available templates: ${Object.keys(documentTemplates).join(', ') || 'None'}</p>
                <button onclick="clientLogout()" class="btn btn-primary" style="margin-top: 20px;">Exit</button>
            </div>
        `;
        return;
    }

    // Check if template has fields
    if (!template.fields || template.fields.length === 0) {
        console.warn(' Template has no fields:', template);
        container.innerHTML = `
            <div style="padding: 40px; text-align: center;">
                <h2 style="color: #ffc107; margin-bottom: 20px;"> Empty Document Template</h2>
                <p style="margin-bottom: 10px;">Template: <strong>${template.name}</strong></p>
                <p style="margin-bottom: 20px; color: #666;">This document has no fields to complete.</p>
                <button onclick="clientLogout()" class="btn btn-primary" style="margin-top: 20px;">Exit</button>
            </div>
        `;
        return;
    }

    let navHTML = '';
    if (currentDocuments.length > 1) {
        navHTML = '<div class="doc-nav">';
        currentDocuments.forEach((doc, i) => {
            const templateName = templateNames[doc.template_id] || doc.template_name || 'Unknown Document';
            navHTML += `<div class="doc-nav-item ${i === currentDocIndex ? 'active' : ''} ${doc.status === 'completed' ? 'completed' : ''}" onclick="switchDocument(${i})">
                ${i + 1}. ${templateName}
            </div>`;
        });
        navHTML += '</div>';
    }

    let html = navHTML + `
        <div class="document-header">
            <h1>${template.name}</h1>
            <p style="color: white; opacity: 0.95;">Client: ${doc.client_name}</p>
            ${currentDocuments.length > 1 ? `<p style="font-size: 14px; margin-top: 5px; color: white; opacity: 0.9;">Document ${currentDocIndex + 1} of ${currentDocuments.length}</p>` : ''}
        </div>
        <div class="form-section">
            <h2 style="margin-bottom: 20px;">Please complete:</h2>
            <form id="clientDocumentForm">
    `;

    template.fields.forEach(field => {
        html += `<div class="form-field"><label>${field.label}</label>`;
        if (field.type === 'checkbox') {
            html += `<input type="checkbox" id="${field.id}" style="width: auto;">`;
        } else if (field.type === 'select') {
            html += `<select id="${field.id}">`;
            field.options.forEach(opt => html += `<option>${opt}</option>`);
            html += `</select>`;
        } else if (field.type === 'textarea') {
            html += `<textarea id="${field.id}"></textarea>`;
        } else {
            html += `<input type="${field.type}" id="${field.id}">`;
        }
        html += `</div>`;
    });

    html += `</form></div>
        <div class="form-section">
            <h3 style="margin-bottom: 20px;">Signature</h3>
            <div class="signature-pad">
                <p style="margin-bottom: 10px;">Type your full name:</p>
                <input type="text" id="clientSignature" class="signature-input" placeholder="Your Full Name">
            </div>
        </div>
        <div class="submit-section">
            <button onclick="submitClientDocument()" class="btn btn-primary" style="font-size: 16px; padding: 15px 40px;">Submit Document</button>
        </div>
    `;

    container.innerHTML = html;
    console.log(' Document rendered successfully');
}

function switchDocument(index) {
    currentDocIndex = index;
    renderClientDocuments();
}

// Enhanced Document Workflow Functions
function addDocumentVersion(docId, changes) {
    const doc = assignedDocs.find(d => d.id === docId);
    if (doc) {
        if (!doc.versions) doc.versions = [];
        doc.versions.push({
            id: Date.now(),
            timestamp: new Date().toISOString(),
            changes,
            user: currentUser?.name || 'System'
        });
        saveToStorage('assigned_docs', assignedDocs);
        logLocalAudit('document_version_added', { docId, versionId: doc.versions[doc.versions.length - 1].id });
    }
}

function bulkAssignDocuments(clientIds, templateIds, expirationDays = 30) {
    const expirationDate = new Date();
    expirationDate.setDate(expirationDate.getDate() + expirationDays);
    
    const bulkDocs = [];
    clientIds.forEach(clientId => {
        templateIds.forEach(templateId => {
            const client = clients.find(c => c.id === clientId);
            const template = documentTemplates[templateId];
            if (client && template) {
                const newDoc = {
                    id: Date.now() + Math.random(),
                    client_id: clientId,
                    client_name: client.name,
                    template_id: templateId,
                    template_name: template.name,
                    auth_code: generateAuthCode(),
                    status: 'pending',
                    created_at: new Date().toISOString(),
                    expiration_date: expirationDate.toISOString(),
                    versions: []
                };
                bulkDocs.push(newDoc);
            }
        });
    });
    
    assignedDocs.push(...bulkDocs);
    saveToStorage('assigned_docs', assignedDocs);
    logLocalAudit('bulk_document_assign', { 
        clientCount: clientIds.length, 
        templateCount: templateIds.length, 
        totalDocs: bulkDocs.length 
    });
    
    return bulkDocs;
}

function checkDocumentExpirations() {
    const today = new Date();
    const expiredDocs = assignedDocs.filter(doc => {
        if (doc.expiration_date) {
            return new Date(doc.expiration_date) < today && doc.status === 'pending';
        }
        return false;
    });
    
    if (expiredDocs.length > 0) {
        showNotification(`${expiredDocs.length} documents have expired`, 'warning');
        logLocalAudit('document_expiration_check', { expiredCount: expiredDocs.length });
    }
    
    return expiredDocs;
}

function exportDocumentToPDF(docId) {
    const doc = assignedDocs.find(d => d.id === docId);
    if (!doc) return;
    
    const template = documentTemplates[doc.template_id];
    if (!template) return;
    
    // Create a new window for PDF generation
    const printWindow = window.open('', '_blank');
    const printContent = `
        <!DOCTYPE html>
        <html>
        <head>
            <title>${template.name} - ${doc.client_name}</title>
            <style>
                body { font-family: Arial, sans-serif; margin: 20px; }
                .header { text-align: center; margin-bottom: 30px; border-bottom: 2px solid #00a86b; padding-bottom: 20px; }
                .field { margin-bottom: 15px; }
                .label { font-weight: bold; margin-bottom: 5px; }
                .value { margin-left: 20px; }
                .signature { margin-top: 30px; border-top: 1px solid #ccc; padding-top: 20px; }
                @media print { body { margin: 0; } }
            </style>
        </head>
        <body>
            <div class="header">
                <h1>${template.name}</h1>
                <p><strong>Client:</strong> ${doc.client_name}</p>
                <p><strong>Date:</strong> ${new Date(doc.created_at).toLocaleDateString()}</p>
                <p><strong>Status:</strong> ${doc.status}</p>
            </div>
            
            <div class="content">
                ${template.fields.map(field => `
                    <div class="field">
                        <div class="label">${field.label}:</div>
                        <div class="value">${doc.form_data?.[field.id] || '[Not completed]'}</div>
                    </div>
                `).join('')}
            </div>
            
            ${doc.status === 'completed' ? `
                <div class="signature">
                    <p><strong>Digital Signature:</strong> ${doc.signature || '[No signature]'}</p>
                    <p><strong>Completed:</strong> ${new Date(doc.completed_at).toLocaleString()}</p>
                </div>
            ` : ''}
        </body>
        </html>
    `;
    
    printWindow.document.write(printContent);
    printWindow.document.close();
    printWindow.print();
    
    logLocalAudit('document_pdf_export', { docId, clientName: doc.client_name });
}

function customizeDocumentTemplate(templateId, customizations) {
    const template = documentTemplates[templateId];
    if (template) {
        // Apply customizations (fields, styling, etc.)
        if (customizations.fields) {
            template.customFields = customizations.fields;
        }
        if (customizations.branding) {
            template.branding = customizations.branding;
        }
        
        saveToStorage('templates', documentTemplates);
        logLocalAudit('template_customized', { templateId, templateName: template.name });
        return template;
    }
}

function getDocumentAnalytics() {
    const totalDocs = assignedDocs.length;
    const completedDocs = assignedDocs.filter(doc => doc.status === 'completed').length;
    const pendingDocs = assignedDocs.filter(doc => doc.status === 'pending').length;
    const expiredDocs = checkDocumentExpirations().length;
    
    const completionRate = totalDocs > 0 ? (completedDocs / totalDocs * 100).toFixed(1) : 0;
    const avgCompletionTime = calculateAverageCompletionTime();
    
    return {
        totalDocs,
        completedDocs,
        pendingDocs,
        expiredDocs,
        completionRate: `${completionRate}%`,
        avgCompletionTime,
        templateStats: getTemplateStatistics()
    };
}

function calculateAverageCompletionTime() {
    const completedDocs = assignedDocs.filter(doc => doc.status === 'completed' && doc.completed_at && doc.created_at);
    if (completedDocs.length === 0) return 'N/A';
    
    const totalTime = completedDocs.reduce((sum, doc) => {
        const created = new Date(doc.created_at);
        const completed = new Date(doc.completed_at);
        return sum + (completed - created);
    }, 0);
    
    const avgMs = totalTime / completedDocs.length;
    const avgDays = Math.round(avgMs / (1000 * 60 * 60 * 24));
    return `${avgDays} days`;
}

function getTemplateStatistics() {
    const stats = {};
    assignedDocs.forEach(doc => {
        const templateName = doc.template_name || 'Unknown';
        if (!stats[templateName]) {
            stats[templateName] = { total: 0, completed: 0 };
        }
        stats[templateName].total++;
        if (doc.status === 'completed') {
            stats[templateName].completed++;
        }
    });
    
    return stats;
}

async function submitClientDocument() {
    const signature = document.getElementById('clientSignature').value.trim();
    if (!signature) return alert('Please sign');
    
    // Enhanced signature verification
    if (signature.length < 2) {
        return alert('Please enter your full name for the signature');
    }
    
    const responses = {};
    const template = documentTemplates[currentDocuments[currentDocIndex].template_id];
    const doc = currentDocuments[currentDocIndex];
    
    template.fields.forEach(field => {
        const el = document.getElementById(field.id);
        if (el) responses[field.id] = el.type === 'checkbox' ? el.checked : el.value;
    });
    
    try {
        const completedAt = new Date().toISOString();
        
        // Update document with completion data
        doc.status = 'completed';
        doc.responses = responses;
        doc.form_data = responses; // For backward compatibility
        doc.signature = signature;
        doc.completed_at = completedAt;
        doc.signature_timestamp = completedAt; // HIPAA-compliant timestamp
        
        // Add version history
        addDocumentVersion(doc.id, {
            action: 'completed',
            form_data: responses,
            signature: signature,
            timestamp: completedAt
        });
        
        // Save to localStorage
        const docIndex = assignedDocs.findIndex(d => d.id === doc.id);
        if (docIndex !== -1) {
            assignedDocs[docIndex] = doc;
            saveToStorage('assigned_docs', assignedDocs);
        }
        
        logLocalAudit('document_completed', { 
            docId: doc.id, 
            clientName: doc.client_name, 
            templateName: doc.template_name,
            signature: signature,
            completionTime: completedAt
        });
        
        const remaining = currentDocuments.filter(d => d.status === 'pending');
        
        if (remaining.length > 0) {
            alert(` Submitted! ${remaining.length} more to complete.`);
            currentDocIndex = currentDocuments.findIndex(d => d.status === 'pending');
            renderClientDocuments();
        } else {
            alert(' All documents submitted successfully!');
            clientLogout();
        }
    } catch (error) {
        alert('Error: ' + error.message);
    }
}

async function loadData() {
    try {
        await loadTemplates();
        // Data is already loaded from localStorage in DOMContentLoaded
        renderClients();
        updateDocBadge();
        loadDashboard(); // Load dashboard stats on app load
    } catch (error) {
        console.error('Load error:', error);
    }
}

function updateDocBadge() {
    const needsReview = assignedDocs.filter(d => d.status === 'completed' && !d.clinician_signature).length;
    const badge = document.getElementById('docBadge');
    badge.style.display = needsReview > 0 ? 'inline-block' : 'none';
    badge.textContent = needsReview;
}

// Toggle sidebar for mobile
function toggleSidebar() {
    const sidebar = document.getElementById('sidebar');
    sidebar.classList.toggle('active');
}

// Close sidebar on mobile when clicking outside
document.addEventListener('click', function(e) {
    const sidebar = document.getElementById('sidebar');
    const toggle = document.querySelector('.mobile-menu-toggle');
    if (window.innerWidth <= 768 && sidebar && sidebar.classList.contains('active')) {
        if (!sidebar.contains(e.target) && !toggle.contains(e.target)) {
            sidebar.classList.remove('active');
        }
    }
});

function showTab(tab) {
    document.querySelectorAll('.tab-content').forEach(el => el.style.display = 'none');
    document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
    document.getElementById(tab + 'Content').style.display = 'block';
    event.target.classList.add('active');

    // Close sidebar on mobile after selecting tab
    if (window.innerWidth <= 768) {
        const sidebar = document.getElementById('sidebar');
        if (sidebar) sidebar.classList.remove('active');
    }

    if (tab === 'dashboard') loadDashboard();
    else if (tab === 'clients') renderClients();
    else if (tab === 'appointments') renderCalendar();
    else if (tab === 'documents') renderDocs();
    else if (tab === 'audit') renderAudit();
    else if (tab === 'ainotetaker') {
        checkAINoteTakerSubscription();
        loadTodayAppointments();
    }
    else if (tab === 'settings') {
        showSettingsTab('billing');
        loadBillingSettings();
    }
}

// AI NoteTaker: Open from appointment context
function openAINoteTakerFromAppointment(appointmentId, clientId, clientName) {
    // Check subscription-based feature access
    const access = window.featureGate.checkFeature('aiClinicalNotes');
    if (!access.allowed) {
        window.featureGate.showUpgradePrompt('aiClinicalNotes');
        return;
    }

    if (!FEATURE_FLAGS.AI_NOTETAKER_ENABLED) {
        showNotification('AI NoteTaker feature is not enabled', 'error');
        return;
    }

    // Store appointment context
    currentAppointmentId = appointmentId;

    // Switch to AI NoteTaker tab
    showTab('ainotetaker');

    // Pre-populate client selection
    setTimeout(() => {
        const clientSelect = document.getElementById('aiClientSelect');
        if (clientSelect) {
            clientSelect.value = clientId;
        }

        // Auto-start recording if desired
        showNotification(`Ready to record session for ${clientName}`, 'success');

        // Optionally auto-click record button after a brief delay
        // setTimeout(() => {
        //     const recordBtn = document.getElementById('aiRecordBtn');
        //     if (recordBtn && !recordBtn.disabled) {
        //         recordBtn.click();
        //     }
        // }, 1000);
    }, 300);
}

function showSettingsTab(tab) {
    document.querySelectorAll('.settings-tab-content').forEach(el => el.style.display = 'none');
    document.querySelectorAll('.settings-tab-btn').forEach(btn => btn.classList.remove('active'));
    document.getElementById(tab + 'SettingsTab').style.display = 'block';
    event.target.classList.add('active');

    // Load subscription data when switching to subscription tab
    if (tab === 'subscription') {
        loadSubscriptionSettings();
    }

    // Load clinical settings when switching to clinical tab
    if (tab === 'clinical') {
        loadClinicalSettings();
    }

    // Load developer settings when switching to developer tab
    if (tab === 'developer') {
        loadDeveloperSettings();
    }

    // Load autopay settings when switching to autopay tab
    if (tab === 'autopay') {
        loadAutopaySettings();
    }
}

// Insurance Tab Functions
function showInsuranceTab(tab) {
    document.querySelectorAll('.insurance-tab-content').forEach(el => el.style.display = 'none');
    document.querySelectorAll('.settings-tab-btn').forEach(btn => btn.classList.remove('active'));
    document.getElementById('insurance' + tab.charAt(0).toUpperCase() + tab.slice(1) + 'Tab').style.display = 'block';
    event.target.classList.add('active');

    // Load data when switching tabs
    if (tab === 'claims') {
        loadClaims();
    } else if (tab === 'verification') {
        loadVerifications();
    } else if (tab === 'settings') {
        loadInsuranceSettings();
    }
}

// Load insurance claims
async function loadClaims() {
    try {
        const response = await fetch('/api/insurance-claims', {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json',
            }
        });

        if (!response.ok) {
            throw new Error('Failed to load claims');
        }

        const claims = await response.json();
        displayClaims(claims);
        updateClaimsStats(claims);
    } catch (error) {
        console.error('Error loading claims:', error);
        showNotification('Failed to load claims', 'error');
    }
}

// Display claims in the list
function displayClaims(claims) {
    const claimsList = document.getElementById('claimsList');

    if (!claims || claims.length === 0) {
        claimsList.innerHTML = `
            <div style="text-align: center; padding: 40px; color: #6B7280;">
                <p>No claims found. Submit your first claim to get started.</p>
            </div>
        `;
        return;
    }

    const claimsHtml = claims.map(claim => `
        <div class="card" style="margin-bottom: 16px;">
            <div style="display: flex; justify-content: space-between; align-items: start;">
                <div style="flex: 1;">
                    <h4 style="margin: 0 0 8px 0;">Claim #${claim.claim_number || claim.id}</h4>
                    <p style="margin: 0; color: #6B7280;">
                        Patient: ${claim.patient_name || 'N/A'}<br>
                        Service Date: ${claim.service_date ? new Date(claim.service_date).toLocaleDateString() : 'N/A'}<br>
                        CPT Code: ${claim.cpt_code || 'N/A'}<br>
                        Amount: $${parseFloat(claim.amount || 0).toFixed(2)}
                    </p>
                </div>
                <div style="text-align: right;">
                    <span class="status-badge status-${claim.status}">${claim.status}</span>
                    <div style="margin-top: 10px;">
                        <button class="btn btn-small" onclick="viewClaimDetails('${claim.id}')">View</button>
                        ${claim.status === 'denied' ? `<button class="btn btn-small" onclick="resubmitClaim('${claim.id}')">Resubmit</button>` : ''}
                    </div>
                </div>
            </div>
            ${claim.denial_reason ? `
                <div style="margin-top: 12px; padding: 12px; background: #FEE2E2; border-radius: 6px; color: #991B1B;">
                    <strong>Denial Reason:</strong> ${claim.denial_reason}
                </div>
            ` : ''}
        </div>
    `).join('');

    claimsList.innerHTML = claimsHtml;
}

// Update claims statistics
function updateClaimsStats(claims) {
    const pending = claims.filter(c => c.status === 'pending' || c.status === 'submitted').length;
    const approved = claims.filter(c => c.status === 'approved').length;
    const denied = claims.filter(c => c.status === 'denied').length;
    const totalClaimed = claims.reduce((sum, c) => sum + parseFloat(c.amount || 0), 0);

    document.getElementById('pendingClaimsCount').textContent = pending;
    document.getElementById('approvedClaimsCount').textContent = approved;
    document.getElementById('deniedClaimsCount').textContent = denied;
    document.getElementById('totalClaimedAmount').textContent = '$' + totalClaimed.toFixed(2);
}

// Filter claims by status
function filterClaims() {
    const status = document.getElementById('claimStatusFilter').value;
    loadClaims(status);
}

// Open verify benefits modal
function openVerifyBenefits() {
    // Create and show modal
    const modal = document.createElement('div');
    modal.className = 'modal';
    modal.id = 'verifyBenefitsModal';
    modal.innerHTML = `
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h2>Verify Insurance Benefits</h2>
                <span class="close" onclick="closeModal('verifyBenefitsModal')">&times;</span>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="verifyPatientId">Select Patient:</label>
                    <select id="verifyPatientId" class="input" required>
                        <option value="">Select a patient...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="verifyInsuranceId">Insurance Member ID:</label>
                    <input type="text" id="verifyInsuranceId" class="input" required>
                </div>
                <div class="form-group">
                    <label for="verifyPayerId">Payer/Insurance Company:</label>
                    <input type="text" id="verifyPayerId" class="input" placeholder="e.g., Anthem, BCBS, Aetna" required>
                </div>
                <div class="form-group">
                    <label for="verifyServiceType">Service Type:</label>
                    <select id="verifyServiceType" class="input">
                        <option value="30">Health Benefit Plan Coverage (30)</option>
                        <option value="98">Professional (Physician) Visit - Office (98)</option>
                        <option value="MH">Mental Health (MH)</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn" onclick="closeModal('verifyBenefitsModal')">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="submitVerifyBenefits()">Verify Benefits</button>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
    modal.style.display = 'block';

    // Load patients into dropdown
    loadPatientsForVerification();
}

// Load patients into verification dropdown
async function loadPatientsForVerification() {
    try {
        const response = await fetch('/api/clients');
        const clients = await response.json();

        const select = document.getElementById('verifyPatientId');
        clients.forEach(client => {
            const option = document.createElement('option');
            option.value = client.id;
            option.textContent = `${client.first_name} ${client.last_name}`;
            select.appendChild(option);
        });
    } catch (error) {
        console.error('Error loading patients:', error);
    }
}

// Submit benefits verification
async function submitVerifyBenefits() {
    const patientId = document.getElementById('verifyPatientId').value;
    const memberId = document.getElementById('verifyInsuranceId').value;
    const payerId = document.getElementById('verifyPayerId').value;
    const serviceType = document.getElementById('verifyServiceType').value;

    if (!patientId || !memberId || !payerId) {
        showNotification('Please fill in all required fields', 'error');
        return;
    }

    try {
        const response = await fetch('/api/insurance-verification', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                patient_id: patientId,
                member_id: memberId,
                payer_id: payerId,
                service_type: serviceType
            })
        });

        if (!response.ok) {
            throw new Error('Verification failed');
        }

        const result = await response.json();
        closeModal('verifyBenefitsModal');
        showNotification('Benefits verified successfully', 'success');
        showVerificationResults(result);
    } catch (error) {
        console.error('Error verifying benefits:', error);
        showNotification('Failed to verify benefits. Please check your Availity credentials.', 'error');
    }
}

// Show verification results
function showVerificationResults(result) {
    const modal = document.createElement('div');
    modal.className = 'modal';
    modal.id = 'verificationResultsModal';
    modal.innerHTML = `
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <h2>Verification Results</h2>
                <span class="close" onclick="closeModal('verificationResultsModal')">&times;</span>
            </div>
            <div class="modal-body">
                <div class="card" style="background: #D1FAE5; border-left: 4px solid #10B981;">
                    <h4 style="margin: 0 0 10px 0;">Coverage Active</h4>
                    <p style="margin: 0;"><strong>Patient:</strong> ${result.patient_name || 'N/A'}</p>
                    <p style="margin: 0;"><strong>Member ID:</strong> ${result.member_id || 'N/A'}</p>
                    <p style="margin: 0;"><strong>Payer:</strong> ${result.payer_name || 'N/A'}</p>
                </div>
                <div style="margin-top: 20px;">
                    <h4>Coverage Details:</h4>
                    <table class="settings-table">
                        <tr>
                            <td><strong>Deductible:</strong></td>
                            <td>${result.deductible || 'N/A'}</td>
                        </tr>
                        <tr>
                            <td><strong>Deductible Met:</strong></td>
                            <td>${result.deductible_met || 'N/A'}</td>
                        </tr>
                        <tr>
                            <td><strong>Co-pay:</strong></td>
                            <td>${result.copay || 'N/A'}</td>
                        </tr>
                        <tr>
                            <td><strong>Co-insurance:</strong></td>
                            <td>${result.coinsurance || 'N/A'}</td>
                        </tr>
                        <tr>
                            <td><strong>Out-of-Pocket Max:</strong></td>
                            <td>${result.out_of_pocket_max || 'N/A'}</td>
                        </tr>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" onclick="closeModal('verificationResultsModal')">Close</button>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
    modal.style.display = 'block';
}

// Open submit claim modal
function openSubmitClaim() {
    const modal = document.createElement('div');
    modal.className = 'modal';
    modal.id = 'submitClaimModal';
    modal.innerHTML = `
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <h2>Submit Insurance Claim</h2>
                <span class="close" onclick="closeModal('submitClaimModal')">&times;</span>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="claimPatientId">Patient:</label>
                    <select id="claimPatientId" class="input" required>
                        <option value="">Select a patient...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="claimMemberId">Insurance Member ID:</label>
                    <input type="text" id="claimMemberId" class="input" required>
                </div>
                <div class="form-group">
                    <label for="claimPayerId">Payer/Insurance Company:</label>
                    <input type="text" id="claimPayerId" class="input" placeholder="e.g., Anthem, BCBS" required>
                </div>
                <div class="form-group">
                    <label for="claimServiceDate">Service Date:</label>
                    <input type="date" id="claimServiceDate" class="input" required>
                </div>
                <div class="form-group">
                    <label for="claimCptCode">CPT Code:</label>
                    <select id="claimCptCode" class="input" required>
                        <option value="">Select CPT code...</option>
                        <option value="90791">90791 - Psychiatric Diagnostic Evaluation</option>
                        <option value="90834">90834 - Psychotherapy 45 min</option>
                        <option value="90837">90837 - Psychotherapy 60 min</option>
                        <option value="90847">90847 - Family Psychotherapy</option>
                        <option value="90853">90853 - Group Psychotherapy</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="claimDiagnosisCode">Diagnosis Code (ICD-10):</label>
                    <input type="text" id="claimDiagnosisCode" class="input" placeholder="e.g., F41.1" required>
                </div>
                <div class="form-group">
                    <label for="claimAmount">Charge Amount:</label>
                    <input type="number" id="claimAmount" class="input" step="0.01" min="0" required>
                </div>
                <div class="form-group">
                    <label for="claimPlaceOfService">Place of Service:</label>
                    <select id="claimPlaceOfService" class="input">
                        <option value="11">11 - Office</option>
                        <option value="02">02 - Telehealth</option>
                        <option value="12">12 - Home</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn" onclick="closeModal('submitClaimModal')">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="submitInsuranceClaim()">Submit Claim</button>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
    modal.style.display = 'block';

    // Load patients
    loadPatientsForClaim();
}

// Load patients for claim submission
async function loadPatientsForClaim() {
    try {
        const response = await fetch('/api/clients');
        const clients = await response.json();

        const select = document.getElementById('claimPatientId');
        clients.forEach(client => {
            const option = document.createElement('option');
            option.value = client.id;
            option.textContent = `${client.first_name} ${client.last_name}`;
            select.appendChild(option);
        });
    } catch (error) {
        console.error('Error loading patients:', error);
    }
}

// Submit insurance claim
async function submitInsuranceClaim() {
    const patientId = document.getElementById('claimPatientId').value;
    const memberId = document.getElementById('claimMemberId').value;
    const payerId = document.getElementById('claimPayerId').value;
    const serviceDate = document.getElementById('claimServiceDate').value;
    const cptCode = document.getElementById('claimCptCode').value;
    const diagnosisCode = document.getElementById('claimDiagnosisCode').value;
    const amount = document.getElementById('claimAmount').value;
    const placeOfService = document.getElementById('claimPlaceOfService').value;

    if (!patientId || !memberId || !payerId || !serviceDate || !cptCode || !diagnosisCode || !amount) {
        showNotification('Please fill in all required fields', 'error');
        return;
    }

    try {
        const response = await fetch('/api/insurance-claims', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                patient_id: patientId,
                member_id: memberId,
                payer_id: payerId,
                service_date: serviceDate,
                cpt_code: cptCode,
                diagnosis_code: diagnosisCode,
                amount: amount,
                place_of_service: placeOfService
            })
        });

        if (!response.ok) {
            throw new Error('Failed to submit claim');
        }

        const result = await response.json();
        closeModal('submitClaimModal');
        showNotification('Claim submitted successfully', 'success');
        loadClaims();
    } catch (error) {
        console.error('Error submitting claim:', error);
        showNotification('Failed to submit claim. Please check your configuration.', 'error');
    }
}

// Load verifications
async function loadVerifications() {
    try {
        const response = await fetch('/api/insurance-verification');
        if (!response.ok) throw new Error('Failed to load verifications');

        const verifications = await response.json();
        displayVerifications(verifications);
    } catch (error) {
        console.error('Error loading verifications:', error);
        showNotification('Failed to load verifications', 'error');
    }
}

// Display verifications
function displayVerifications(verifications) {
    const list = document.getElementById('verificationsList');

    if (!verifications || verifications.length === 0) {
        list.innerHTML = `
            <div style="text-align: center; padding: 40px; color: #6B7280;">
                <p>No benefit verifications found.</p>
            </div>
        `;
        return;
    }

    const html = verifications.map(v => `
        <div class="card" style="margin-bottom: 16px;">
            <div style="display: flex; justify-content: space-between;">
                <div>
                    <h4 style="margin: 0 0 8px 0;">${v.patient_name}</h4>
                    <p style="margin: 0; color: #6B7280;">
                        Date: ${new Date(v.created_at).toLocaleDateString()}<br>
                        Payer: ${v.payer_name || 'N/A'}<br>
                        Member ID: ${v.member_id}
                    </p>
                </div>
                <div>
                    <span class="status-badge status-${v.status}">${v.status}</span>
                </div>
            </div>
        </div>
    `).join('');

    list.innerHTML = html;
}

// View claim details
function viewClaimDetails(claimId) {
    // Implement claim details view
    showNotification('Viewing claim details for: ' + claimId, 'info');
}

// Resubmit denied claim
async function resubmitClaim(claimId) {
    if (!confirm('Are you sure you want to resubmit this claim?')) return;

    try {
        const response = await fetch(`/api/insurance-claims/${claimId}/resubmit`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        });

        if (!response.ok) throw new Error('Failed to resubmit claim');

        showNotification('Claim resubmitted successfully', 'success');
        loadClaims();
    } catch (error) {
        console.error('Error resubmitting claim:', error);
        showNotification('Failed to resubmit claim', 'error');
    }
}

// Load insurance settings
function loadInsuranceSettings() {
    const settings = loadFromStorage('insuranceSettings', {
        availityClientId: '',
        availityClientSecret: '',
        availityTestMode: true,
        defaultPlaceOfService: '11',
        defaultBillingProvider: '',
        defaultTaxonomy: ''
    });

    document.getElementById('availityClientId').value = settings.availityClientId || '';
    document.getElementById('availityClientSecret').value = settings.availityClientSecret || '';
    document.getElementById('availityTestMode').checked = settings.availityTestMode !== false;
    document.getElementById('defaultPlaceOfService').value = settings.defaultPlaceOfService || '11';
    document.getElementById('defaultBillingProvider').value = settings.defaultBillingProvider || '';
    document.getElementById('defaultTaxonomy').value = settings.defaultTaxonomy || '';
}

// Save insurance settings
function saveInsuranceSettings() {
    const settings = {
        availityClientId: document.getElementById('availityClientId').value,
        availityClientSecret: document.getElementById('availityClientSecret').value,
        availityTestMode: document.getElementById('availityTestMode').checked,
        defaultPlaceOfService: document.getElementById('defaultPlaceOfService').value,
        defaultBillingProvider: document.getElementById('defaultBillingProvider').value,
        defaultTaxonomy: document.getElementById('defaultTaxonomy').value
    };

    saveToStorage('insuranceSettings', settings);
    showNotification('Insurance settings saved successfully', 'success');
}

// Save default claim settings
function saveDefaultClaimSettings() {
    const settings = {
        defaultPlaceOfService: document.getElementById('defaultPlaceOfService').value,
        defaultBillingProvider: document.getElementById('defaultBillingProvider').value,
        defaultTaxonomy: document.getElementById('defaultTaxonomy').value
    };

    const currentSettings = loadFromStorage('insuranceSettings', {});
    saveToStorage('insuranceSettings', { ...currentSettings, ...settings });
    showNotification('Default claim settings saved', 'success');
}

// Test Availity connection
async function testAvailityConnection() {
    try {
        const response = await fetch('/api/insurance-verification/test-connection', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        });

        if (!response.ok) throw new Error('Connection test failed');

        const result = await response.json();
        showNotification('Availity connection successful!', 'success');
    } catch (error) {
        console.error('Error testing connection:', error);
        showNotification('Availity connection failed. Please check your credentials.', 'error');
    }
}

// Billing Settings Functions
function loadBillingSettings() {
    const settings = loadFromStorage('clinicianBillingSettings', {
        serviceFees: {
            '90791': 200.00,
            '90834': 150.00,
            '90837': 180.00,
            '90847': 200.00,
            '90853': 75.00
        },
        customServices: [],
        taxSettings: { enabled: false, rate: 0 },
        businessInfo: { name: '', npi: '', taxId: '' },
        invoiceTerms: 'net30'
    });
    
    // Populate service rates table
    const table = document.getElementById('serviceRatesTable');
    if (!table) return;
    
    const serviceNames = {
        '90791': 'Psychiatric Diagnostic Evaluation',
        '90834': 'Psychotherapy 45 min',
        '90837': 'Psychotherapy 60 min',
        '90847': 'Family Psychotherapy',
        '90853': 'Group Psychotherapy'
    };
    
    let html = '';
    for (const [code, rate] of Object.entries(settings.serviceFees)) {
        html += `
            <tr>
                <td><strong>${code}</strong></td>
                <td>${serviceNames[code] || 'Custom Service'}</td>
                <td>
                    <input type="number" id="rate_${code}" value="${rate}" step="0.01" min="0" class="input" style="width: 120px;">
                </td>
                <td>
                    <button onclick="resetRate('${code}')" class="btn btn-small">Reset</button>
                </td>
            </tr>
        `;
    }
    
    // Add custom services
    settings.customServices.forEach(service => {
        html += `
            <tr>
                <td><strong>${service.code}</strong></td>
                <td>${service.name}</td>
                <td>
                    <input type="number" id="rate_${service.code}" value="${service.rate}" step="0.01" min="0" class="input" style="width: 120px;">
                </td>
                <td>
                    <button onclick="deleteCustomService('${service.code}')" class="btn btn-danger btn-small">Delete</button>
                </td>
            </tr>
        `;
    });
    
    table.innerHTML = html;
    
    // Populate other settings
    document.getElementById('taxEnabled').checked = settings.taxSettings.enabled;
    document.getElementById('taxRate').value = settings.taxSettings.rate;
    document.getElementById('businessName').value = settings.businessInfo.name || '';
    document.getElementById('npi').value = settings.businessInfo.npi || '';
    document.getElementById('taxId').value = settings.businessInfo.taxId || '';
    document.getElementById('invoiceTerms').value = settings.invoiceTerms;
}

function saveBillingSettings() {
    const settings = {
        serviceFees: {},
        customServices: loadFromStorage('clinicianBillingSettings', {}).customServices || [],
        taxSettings: {
            enabled: document.getElementById('taxEnabled').checked,
            rate: parseFloat(document.getElementById('taxRate').value) || 0
        },
        businessInfo: {
            name: document.getElementById('businessName').value,
            npi: document.getElementById('npi').value,
            taxId: document.getElementById('taxId').value
        },
        invoiceTerms: document.getElementById('invoiceTerms').value
    };
    
    // Get all rate inputs
    document.querySelectorAll('[id^="rate_"]').forEach(input => {
        const code = input.id.replace('rate_', '');
        settings.serviceFees[code] = parseFloat(input.value) || 0;
    });
    
    saveToStorage('clinicianBillingSettings', settings);
    showNotification('Billing settings saved successfully!', 'success');
}

// Clinical Settings Functions
function loadClinicalSettings() {
    const settings = loadFromStorage('clinicalSettings', {
        enabledNoteFormats: ['SOAP', 'DAP', 'BIRP', 'Narrative'], // Default enabled formats
        treatmentPlanReview: {
            defaultPeriod: 90,
            enableAlerts: true,
            allowUnlockForReview: true
        },
        selectedCPTCodes: [
            '90791', '90792', '90832', '90834', '90837',
            '90839', '90840', '90846', '90847', '90853'
        ] // Default commonly used codes
    });

    // Load note format checkboxes
    const noteFormats = ['SOAP', 'DAP', 'BIRP', 'GIRP', 'Psychotherapy', 'Narrative', 'PIRP', 'PAIP'];
    noteFormats.forEach(format => {
        const checkbox = document.getElementById(`noteFormat_${format}`);
        if (checkbox) {
            checkbox.checked = settings.enabledNoteFormats.includes(format);
        }
    });

    // Load treatment plan settings
    const defaultPeriod = document.getElementById('defaultReviewPeriod');
    if (defaultPeriod) {
        defaultPeriod.value = settings.treatmentPlanReview.defaultPeriod || 90;
    }

    const enableAlerts = document.getElementById('enableReviewAlerts');
    if (enableAlerts) {
        enableAlerts.checked = settings.treatmentPlanReview.enableAlerts !== false;
    }

    const allowUnlock = document.getElementById('allowUnlockForReview');
    if (allowUnlock) {
        allowUnlock.checked = settings.treatmentPlanReview.allowUnlockForReview !== false;
    }

    // Load CPT codes list
    renderCPTCodesList(settings.selectedCPTCodes);
}

function saveClinicalSettings() {
    const settings = {
        enabledNoteFormats: [],
        treatmentPlanReview: {
            defaultPeriod: parseInt(document.getElementById('defaultReviewPeriod')?.value || 90),
            enableAlerts: document.getElementById('enableReviewAlerts')?.checked || false,
            allowUnlockForReview: document.getElementById('allowUnlockForReview')?.checked || false
        },
        selectedCPTCodes: []
    };

    // Get enabled note formats
    document.querySelectorAll('.note-format-checkbox:checked').forEach(checkbox => {
        settings.enabledNoteFormats.push(checkbox.value);
    });

    // Get selected CPT codes
    document.querySelectorAll('.cpt-code-checkbox:checked').forEach(checkbox => {
        settings.selectedCPTCodes.push(checkbox.value);
    });

    saveToStorage('clinicalSettings', settings);
    showNotification('Clinical settings saved successfully!', 'success');
}

function updateNoteFormats() {
    // Auto-save on change (optional)
    // saveClinicalSettings();
}

function updateTreatmentPlanSettings() {
    // Auto-save on change (optional)
    // saveClinicalSettings();
}

// Comprehensive Mental Health & Psychiatric CPT Codes
const MENTAL_HEALTH_CPT_CODES = [
    // Diagnostic Evaluations
    { code: '90791', description: 'Psychiatric diagnostic evaluation without medical services' },
    { code: '90792', description: 'Psychiatric diagnostic evaluation with medical services' },

    // Psychotherapy - Individual
    { code: '90832', description: 'Psychotherapy, 30 minutes with patient' },
    { code: '90834', description: 'Psychotherapy, 45 minutes with patient' },
    { code: '90837', description: 'Psychotherapy, 60 minutes with patient' },

    // Psychotherapy with E/M
    { code: '90833', description: 'Psychotherapy, 30 minutes when performed with E/M service (add-on)' },
    { code: '90836', description: 'Psychotherapy, 45 minutes when performed with E/M service (add-on)' },
    { code: '90838', description: 'Psychotherapy, 60 minutes when performed with E/M service (add-on)' },

    // Crisis Psychotherapy
    { code: '90839', description: 'Psychotherapy for crisis; first 60 minutes' },
    { code: '90840', description: 'Psychotherapy for crisis; each additional 30 minutes (add-on)' },

    // Family/Couples Psychotherapy
    { code: '90846', description: 'Family psychotherapy (without the patient present)' },
    { code: '90847', description: 'Family psychotherapy (with the patient present)' },
    { code: '90849', description: 'Multiple-family group psychotherapy' },

    // Group Psychotherapy
    { code: '90853', description: 'Group psychotherapy (not family)' },

    // Interactive Complexity (Add-on)
    { code: '90785', description: 'Interactive complexity (add-on code for psychotherapy)' },

    // Pharmacologic Management
    { code: '90863', description: 'Pharmacologic management, including prescription management' },

    // Medication-Assisted Treatment
    { code: '99408', description: 'Alcohol/substance abuse screening and brief intervention, 15-30 min' },
    { code: '99409', description: 'Alcohol/substance abuse screening and brief intervention, >30 min' },

    // Psychological/Neuropsychological Testing
    { code: '96130', description: 'Psychological testing evaluation services, first hour' },
    { code: '96131', description: 'Psychological testing evaluation services, each additional hour' },
    { code: '96136', description: 'Psychological or neuropsychological test administration, first 30 min' },
    { code: '96137', description: 'Psychological or neuropsychological test administration, each additional 30 min' },
    { code: '96138', description: 'Psychological/neuropsychological test administration by computer, first 30 min' },
    { code: '96139', description: 'Psychological/neuropsychological test administration by computer, each additional 30 min' },
    { code: '96146', description: 'Psychological/neuropsychological test administration scoring and interpretation' },

    // Health and Behavior Assessment
    { code: '96156', description: 'Health behavior assessment, initial' },
    { code: '96158', description: 'Health behavior assessment, reassessment' },
    { code: '96164', description: 'Health behavior intervention, individual, first 30 min' },
    { code: '96165', description: 'Health behavior intervention, individual, each additional 15 min' },
    { code: '96167', description: 'Health behavior intervention, family (with patient present), first 30 min' },
    { code: '96168', description: 'Health behavior intervention, family (with patient present), each additional 15 min' },
    { code: '96170', description: 'Health behavior intervention, family (without patient), first 30 min' },
    { code: '96171', description: 'Health behavior intervention, family (without patient), each additional 15 min' },

    // Adaptive Behavior Services
    { code: '97151', description: 'Behavior identification assessment by physician/QHP, first hour' },
    { code: '97152', description: 'Behavior identification assessment by physician/QHP, each additional 15 min' },
    { code: '97153', description: 'Adaptive behavior treatment by protocol, first 15 min' },
    { code: '97154', description: 'Adaptive behavior treatment by protocol, each additional 15 min' },
    { code: '97155', description: 'Adaptive behavior treatment with protocol modification, first 15 min' },
    { code: '97156', description: 'Adaptive behavior treatment with protocol modification, each additional 15 min' },
    { code: '97157', description: 'Multiple-family adaptive behavior treatment guidance, first 15 min' },
    { code: '97158', description: 'Group adaptive behavior treatment by protocol, first 15 min' },

    // Electroconvulsive Therapy
    { code: '90870', description: 'Electroconvulsive therapy (includes anesthesia)' },

    // Transcranial Magnetic Stimulation
    { code: '90867', description: 'Therapeutic repetitive transcranial magnetic stimulation (TMS) treatment planning' },
    { code: '90868', description: 'TMS treatment delivery and management, first treatment' },
    { code: '90869', description: 'TMS treatment delivery and management, subsequent treatment' },

    // Psychiatric Collaborative Care
    { code: '99492', description: 'Initial psychiatric collaborative care, first 70 minutes' },
    { code: '99493', description: 'Subsequent psychiatric collaborative care, first 60 minutes' },
    { code: '99494', description: 'Initial or subsequent psychiatric collaborative care, each additional 30 min' },

    // General Behavioral Health Integration
    { code: '99484', description: 'Behavioral health integration care, first 20 minutes' },

    // Telehealth/Telemedicine
    { code: '98970', description: 'Qualified nonphysician health care professional online digital E/M, 5-10 min' },
    { code: '98971', description: 'Qualified nonphysician health care professional online digital E/M, 11-20 min' },
    { code: '98972', description: 'Qualified nonphysician health care professional online digital E/M, 21+ min' },

    // Smoking/Tobacco Cessation
    { code: '99406', description: 'Smoking and tobacco use cessation counseling, intermediate (>3 min, <=10 min)' },
    { code: '99407', description: 'Smoking and tobacco use cessation counseling, intensive (>10 min)' },

    // Prolonged Services (Add-on)
    { code: '99354', description: 'Prolonged evaluation and management service, first hour (add-on)' },
    { code: '99355', description: 'Prolonged evaluation and management service, each additional 30 min (add-on)' },
    { code: '99415', description: 'Prolonged clinical staff service during outpatient E/M, first hour' },
    { code: '99416', description: 'Prolonged clinical staff service during outpatient E/M, each additional 30 min' },

    // Peer Support Services
    { code: 'H0038', description: 'Peer specialist services, per 15 minutes' },
    { code: 'H0023', description: 'Behavioral health outreach service, per 15 minutes' },

    // Case Management
    { code: 'H0006', description: 'Behavioral health case management, per 15 minutes' },

    // Assertive Community Treatment (ACT)
    { code: 'H0040', description: 'Assertive community treatment, per 15 minutes' },

    // Intensive Outpatient Program (IOP)
    { code: 'S9480', description: 'Intensive outpatient psychiatric services, per diem' },

    // Partial Hospitalization
    { code: 'S0201', description: 'Partial hospitalization services, per diem' }
];

function renderCPTCodesList(selectedCodes = []) {
    const container = document.getElementById('cptCodesList');
    if (!container) return;

    let html = '';
    MENTAL_HEALTH_CPT_CODES.forEach(cpt => {
        const isChecked = selectedCodes.includes(cpt.code) ? 'checked' : '';
        html += `
            <label style="display: flex; align-items: start; gap: 8px; padding: 8px; border: 1px solid #e5e7eb; border-radius: 6px; cursor: pointer; background: white;">
                <input type="checkbox" value="${cpt.code}" class="cpt-code-checkbox" ${isChecked} style="margin-top: 3px; cursor: pointer;">
                <div style="flex: 1;">
                    <strong style="color: var(--primary-color);">${cpt.code}</strong>
                    <span style="font-size: 13px; color: var(--text-secondary); display: block; margin-top: 2px;">${cpt.description}</span>
                </div>
            </label>
        `;
    });

    container.innerHTML = html;
}

function selectAllCPTCodes() {
    document.querySelectorAll('.cpt-code-checkbox').forEach(checkbox => {
        checkbox.checked = true;
    });
    showNotification('All CPT codes selected', 'success');
}

function deselectAllCPTCodes() {
    document.querySelectorAll('.cpt-code-checkbox').forEach(checkbox => {
        checkbox.checked = false;
    });
    showNotification('All CPT codes deselected', 'success');
}

// Subscription Management Functions
function loadSubscriptionSettings() {
    const subscriptionInfo = loadFromStorage('subscription_info', {
        status: 'trial',
        plan: 'professional',  // essential, professional, or complete
        tier: 'Professional',  // Display name
        price: 60,             // $40 for essential, $60 for professional, $80 for complete
        trialStartDate: new Date().toISOString(),
        trialEndDate: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toISOString(),
        nextBillingDate: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toISOString(),
        createdAt: new Date().toISOString()
    });

    const billingHistory = loadFromStorage('billing_history', []);

    renderSubscriptionStatus(subscriptionInfo);
    renderSubscriptionActions(subscriptionInfo);
    renderBillingHistory(billingHistory);
    updateAINoteTakerSubscriptionUI();
}

// AI NoteTaker Subscription Functions
function updateAINoteTakerSubscriptionUI() {
    const subscriptionStatus = loadFromStorage('aiNoteTakerSubscription', { active: false, planId: null });
    const badge = document.getElementById('aiNoteTakerBadge');
    const subscribeBtn = document.getElementById('subscribeAINoteTakerBtn');
    const unsubscribeBtn = document.getElementById('unsubscribeAINoteTakerBtn');

    if (subscriptionStatus.active) {
        badge.textContent = 'Active';
        badge.className = 'status-badge status-completed';
        badge.style.fontSize = '12px';
        subscribeBtn.style.display = 'none';
        unsubscribeBtn.style.display = 'inline-block';
    } else {
        badge.textContent = 'Not Active';
        badge.className = 'status-badge status-scheduled';
        badge.style.fontSize = '12px';
        subscribeBtn.style.display = 'inline-block';
        unsubscribeBtn.style.display = 'none';
    }
}

async function subscribeToAINoteTaker() {
    // In a real implementation, this would call Stripe API to create subscription
    // For now, we'll simulate the subscription

    const confirmed = confirm('Subscribe to AI NoteTaker for $20/month?\n\nThis add-on includes:\n- Real-time session transcription\n- AI-generated clinical notes\n- Multiple note format support\n- 7-day automatic transcript retention\n- HIPAA-compliant secure storage');

    if (!confirmed) return;

    try {
        // Simulate subscription creation
        const subscription = {
            active: true,
            planId: 'ai_notetaker_monthly_20',
            subscribedAt: new Date().toISOString(),
            nextBillingDate: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toISOString(),
            price: 20
        };

        saveToStorage('aiNoteTakerSubscription', subscription);

        // Log the subscription
        logAuditEvent('ai_notetaker_subscribed', 'Subscribed to AI NoteTaker add-on ($20/month)');

        // Add to billing history
        const billingHistory = loadFromStorage('billing_history', []);
        billingHistory.unshift({
            date: new Date().toISOString(),
            description: 'AI NoteTaker Add-On - Monthly Subscription',
            amount: 20.00,
            status: 'paid'
        });
        saveToStorage('billing_history', billingHistory);

        // Update UI
        updateAINoteTakerSubscriptionUI();
        renderBillingHistory(billingHistory);

        showToast('Successfully subscribed to AI NoteTaker! Visit the AI NoteTaker tab to get started.');
    } catch (error) {
        console.error('Subscription error:', error);
        showToast('Failed to subscribe. Please try again.', 'error');
    }
}

async function unsubscribeFromAINoteTaker() {
    const confirmed = confirm('Cancel AI NoteTaker subscription?\n\nYou will lose access to:\n- Session recording\n- AI-generated notes\n- Transcript features\n\nAny existing recordings and transcripts will be retained according to the retention policy.');

    if (!confirmed) return;

    try {
        // Remove subscription
        const subscription = {
            active: false,
            planId: null,
            cancelledAt: new Date().toISOString()
        };

        saveToStorage('aiNoteTakerSubscription', subscription);

        // Log the cancellation
        logAuditEvent('ai_notetaker_cancelled', 'Cancelled AI NoteTaker add-on subscription');

        // Update UI
        updateAINoteTakerSubscriptionUI();

        showToast('AI NoteTaker subscription cancelled. You will retain access until the end of your current billing period.');
    } catch (error) {
        console.error('Cancellation error:', error);
        showToast('Failed to cancel subscription. Please try again.', 'error');
    }
}

function renderSubscriptionStatus(subscriptionInfo) {
    const statusCard = document.getElementById('subscriptionStatusCard');
    const now = new Date();
    const trialEndDate = new Date(subscriptionInfo.trialEndDate);
    const daysLeft = Math.ceil((trialEndDate - now) / (1000 * 60 * 60 * 24));
    
    let statusClass = 'subscription-status-card';
    let statusText = '';
    let statusIcon = '';
    
    if (subscriptionInfo.status === 'trial') {
        if (daysLeft > 0) {
            statusClass += ' trial';
            statusIcon = '';
            statusText = `Free Trial - ${daysLeft} days remaining`;
        } else {
            statusClass += ' expired';
            statusIcon = '';
            statusText = 'Trial Expired - Subscribe to continue';
        }
    } else if (subscriptionInfo.status === 'active') {
        statusClass += ' active';
        statusIcon = '';
        statusText = 'Active Subscription';
    } else {
        statusClass += ' expired';
        statusIcon = '';
        statusText = 'Subscription Inactive';
    }
    
    statusCard.className = statusClass;

    // Get plan display name
    const planDisplay = subscriptionInfo.tier || (subscriptionInfo.plan === 'essential' ? 'Essential EHR' :
                                                   subscriptionInfo.plan === 'complete' ? 'Complete Suite' : 'Professional');

    statusCard.innerHTML = `
        <div style="display: flex; align-items: center; margin-bottom: 15px;">
            <span style="font-size: 24px; margin-right: 10px;">${statusIcon}</span>
            <h4 style="margin: 0; color: var(--text-primary);">${statusText}</h4>
        </div>
        <div class="subscription-info">
            <div class="subscription-info-item">
                <div class="subscription-info-label">Plan</div>
                <div class="subscription-info-value">${planDisplay}</div>
            </div>
            <div class="subscription-info-item">
                <div class="subscription-info-label">Price</div>
                <div class="subscription-info-value">$${subscriptionInfo.price}/month</div>
            </div>
            <div class="subscription-info-item">
                <div class="subscription-info-label">Status</div>
                <div class="subscription-info-value">${subscriptionInfo.status}</div>
            </div>
            <div class="subscription-info-item">
                <div class="subscription-info-label">${subscriptionInfo.status === 'trial' ? 'Trial Ends' : 'Next Billing'}</div>
                <div class="subscription-info-value">${new Date(subscriptionInfo.trialEndDate || subscriptionInfo.nextBillingDate).toLocaleDateString()}</div>
            </div>
        </div>
    `;
}

function renderSubscriptionActions(subscriptionInfo) {
    const actionsContainer = document.getElementById('subscriptionActions');
    let actionsHTML = '';

    // Get the price for the current plan
    const price = subscriptionInfo.price || 50;

    if (subscriptionInfo.status === 'trial') {
        const trialEndDate = new Date(subscriptionInfo.trialEndDate);
        const daysLeft = Math.ceil((trialEndDate - new Date()) / (1000 * 60 * 60 * 24));

        if (daysLeft > 0) {
            actionsHTML = `
                <button onclick="startSubscription()" class="btn btn-primary">Subscribe Now ($${price}/month)</button>
                <p style="margin-top: 15px; font-size: 14px; color: var(--text-secondary);">
                    Want to change your plan? <a href="/" style="color: var(--primary-color);">View all pricing tiers</a>
                </p>
            `;
        } else {
            actionsHTML = `
                <button onclick="startSubscription()" class="btn btn-primary">Subscribe Now ($${price}/month)</button>
                <button onclick="contactSupport()" class="btn btn-secondary">Contact Support</button>
            `;
        }
    } else if (subscriptionInfo.status === 'active') {
        actionsHTML = `
            <button onclick="manageSubscription()" class="btn btn-secondary">Manage Subscription</button>
            <button onclick="downloadInvoice()" class="btn btn-secondary">Download Invoice</button>
            <button onclick="cancelSubscription()" class="btn btn-danger">Cancel Subscription</button>
        `;
    } else {
        actionsHTML = `
            <button onclick="reactivateSubscription()" class="btn btn-primary">Reactivate Subscription</button>
            <button onclick="contactSupport()" class="btn btn-secondary">Contact Support</button>
        `;
    }

    actionsContainer.innerHTML = actionsHTML;
}

function renderBillingHistory(billingHistory) {
    const historyContainer = document.getElementById('billingHistoryList');
    
    if (billingHistory.length === 0) {
        historyContainer.innerHTML = '<p style="text-align: center; color: var(--text-secondary); padding: 20px;">No billing history yet</p>';
        return;
    }
    
    const historyHTML = billingHistory.map(entry => `
        <div class="billing-history-item">
            <div>
                <div class="billing-history-date">${new Date(entry.date).toLocaleDateString()}</div>
                <div style="font-size: 12px; color: var(--text-secondary);">${entry.description}</div>
            </div>
            <div style="display: flex; align-items: center; gap: 10px;">
                <div class="billing-history-amount">$${entry.amount}</div>
                <div class="billing-history-status ${entry.status}">${entry.status}</div>
            </div>
        </div>
    `).join('');
    
    historyContainer.innerHTML = historyHTML;
}

// NEW: Three-Tier Subscription Management Functions
function loadSubscriptionSettings() {
    // Get subscription from helper (uses localStorage)
    const subscription = window.SubscriptionHelpers?.getCurrentSubscription() || {
        planId: 'essential',
        status: 'active',
        selectedAddon: null
    };
    const plan = window.SUBSCRIPTION_PLANS?.[subscription.planId] || window.SUBSCRIPTION_PLANS?.essential;

    // Render current plan card
    renderCurrentPlanCard(subscription, plan);

    // Show/hide professional addon section
    if (subscription.planId === 'professional') {
        document.getElementById('professionalAddonSection').style.display = 'block';
        renderProfessionalAddonSelection(subscription);
    } else {
        document.getElementById('professionalAddonSection').style.display = 'none';
    }

    // Update plan buttons
    updatePlanButtons(subscription.planId);

    // Load existing billing history
    const billingHistory = loadFromStorage('billing_history', []);
    renderBillingHistory(billingHistory);
}

function renderCurrentPlanCard(subscription, plan) {
    const card = document.getElementById('currentPlanCard');
    const statusBadge = subscription.status === 'active' ?
        '<span style="background: var(--success-color); color: white; padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 600;">ACTIVE</span>' :
        '<span style="background: var(--warning-color); color: white; padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 600;">INACTIVE</span>';

    let addonInfo = '';
    if (subscription.planId === 'professional' && subscription.selectedAddon) {
        const addon = window.ADDONS?.[subscription.selectedAddon];
        addonInfo = `
            <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid var(--border-color);">
                <div style="font-size: 14px; color: var(--text-secondary); margin-bottom: 5px;">Selected Add-on:</div>
                <div style="font-size: 16px; font-weight: 600; color: var(--primary-color);">${addon?.icon || ''} ${addon?.name || subscription.selectedAddon}</div>
            </div>
        `;
    } else if (subscription.planId === 'professional' && !subscription.selectedAddon) {
        addonInfo = `
            <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid var(--border-color);">
                <div style="color: var(--warning-color); font-weight: 600;"> Please select an add-on below</div>
            </div>
        `;
    }

    card.innerHTML = `
        <div style="display: flex; justify-content: space-between; align-items: start;">
            <div>
                <h2 style="margin: 0 0 5px 0; font-size: 28px; color: var(--primary-color);">${plan.name}</h2>
                <div style="font-size: 14px; color: var(--text-secondary); margin-bottom: 10px;">${plan.description}</div>
                <div style="font-size: 32px; font-weight: 700; color: var(--text-primary);">$${plan.price}<span style="font-size: 16px; font-weight: 400; color: var(--text-secondary);">/month</span></div>
            </div>
            <div>
                ${statusBadge}
            </div>
        </div>
        ${addonInfo}
    `;
}

function renderProfessionalAddonSelection(subscription) {
    const aiNotesCard = document.getElementById('aiNotesAddonCard');
    const telehealthCard = document.getElementById('telehealthAddonCard');
    const aiNotesStatus = document.getElementById('aiNotesAddonStatus');
    const telehealthStatus = document.getElementById('telehealthAddonStatus');

    // Reset styles
    aiNotesCard.style.border = '2px solid var(--border-color)';
    telehealthCard.style.border = '2px solid var(--border-color)';
    aiNotesCard.style.background = 'white';
    telehealthCard.style.background = 'white';

    // Highlight selected addon
    if (subscription.selectedAddon === 'ai_notes') {
        aiNotesCard.style.border = '2px solid var(--primary-color)';
        aiNotesCard.style.background = 'var(--primary-subtle)';
        aiNotesStatus.innerHTML = '<span style="color: var(--success-color); font-weight: 600;"> Selected</span>';
        telehealthStatus.innerHTML = '<button class="btn btn-secondary" onclick="selectProfessionalAddon(\'telehealth\')" style="font-size: 13px; padding: 8px 16px;">Switch to this</button>';
    } else if (subscription.selectedAddon === 'telehealth') {
        telehealthCard.style.border = '2px solid var(--primary-color)';
        telehealthCard.style.background = 'var(--primary-subtle)';
        telehealthStatus.innerHTML = '<span style="color: var(--success-color); font-weight: 600;"> Selected</span>';
        aiNotesStatus.innerHTML = '<button class="btn btn-secondary" onclick="selectProfessionalAddon(\'ai_notes\')" style="font-size: 13px; padding: 8px 16px;">Switch to this</button>';
    } else {
        aiNotesStatus.innerHTML = '<button class="btn btn-primary" onclick="selectProfessionalAddon(\'ai_notes\')" style="font-size: 13px; padding: 8px 16px;">Select</button>';
        telehealthStatus.innerHTML = '<button class="btn btn-primary" onclick="selectProfessionalAddon(\'telehealth\')" style="font-size: 13px; padding: 8px 16px;">Select</button>';
    }
}

function updatePlanButtons(currentPlanId) {
    const essentialBtn = document.getElementById('essentialPlanBtn');
    const professionalBtn = document.getElementById('professionalPlanBtn');
    const completeBtn = document.getElementById('completePlanBtn');

    // Reset all buttons
    essentialBtn.className = 'btn btn-secondary';
    professionalBtn.className = 'btn btn-primary';
    completeBtn.className = 'btn btn-primary';
    essentialBtn.textContent = 'Downgrade';
    professionalBtn.textContent = 'Upgrade to Professional';
    completeBtn.textContent = 'Upgrade to Complete';
    essentialBtn.style.width = '100%';
    professionalBtn.style.width = '100%';
    completeBtn.style.width = '100%';

    // Highlight current plan
    if (currentPlanId === 'essential') {
        essentialBtn.className = 'btn btn-secondary';
        essentialBtn.textContent = 'Current Plan';
        essentialBtn.disabled = true;
        professionalBtn.textContent = 'Upgrade';
        completeBtn.textContent = 'Upgrade';
    } else if (currentPlanId === 'professional') {
        essentialBtn.textContent = 'Downgrade';
        professionalBtn.className = 'btn btn-secondary';
        professionalBtn.textContent = 'Current Plan';
        professionalBtn.disabled = true;
        completeBtn.textContent = 'Upgrade';
    } else if (currentPlanId === 'complete') {
        essentialBtn.textContent = 'Downgrade';
        professionalBtn.textContent = 'Downgrade';
        completeBtn.className = 'btn btn-secondary';
        completeBtn.textContent = 'Current Plan';
        completeBtn.disabled = true;
    }
}

function selectProfessionalAddon(addonId) {
    if (window.featureGate) {
        window.featureGate.selectAddon(addonId);
    } else {
        // Fallback if feature gate not loaded
        window.SubscriptionHelpers.updateSubscription({
            selectedAddon: addonId,
            addonSelectedDate: new Date().toISOString()
        });
        showNotification('Addon selected successfully!', 'success');
        loadSubscriptionSettings();
    }
}

function changePlan(planId) {
    const plan = window.SUBSCRIPTION_PLANS?.[planId];
    if (!plan) {
        showNotification('Invalid plan selected', 'error');
        return;
    }

    if (window.featureGate) {
        window.featureGate.upgradePlan(planId);
    } else {
        // Fallback if feature gate not loaded
        const confirmed = confirm(`Change to ${plan.name} for $${plan.price}/month?`);
        if (!confirmed) return;

        window.SubscriptionHelpers.updateSubscription({
            planId: planId,
            status: 'active',
            upgradeDate: new Date().toISOString()
        });
        showNotification(`Successfully changed to ${plan.name}!`, 'success');
        loadSubscriptionSettings();
    }
}

// Subscription Actions
async function startSubscription() {
    try {
        showLoadingState('Setting up subscription...');
        
        // Create Stripe subscription
        const response = await fetch('/api/create-subscription', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                email: currentUser.email,
                name: currentUser.name,
                userId: currentUser.id,
                priceId: 'price_1SJ5QBKfOEPgyMAo8K8vQ2Xx' // $60/month
            })
        });

        const data = await response.json();

        if (!data.success) {
            throw new Error(data.error || 'Failed to create subscription');
        }

        // Confirm payment with Stripe
        if (!stripe) {
            throw new Error('Stripe not initialized. Please refresh the page and try again.');
        }
        const { error } = await stripe.confirmCardPayment(data.clientSecret);

        if (error) {
            throw new Error(error.message);
        }

        // Update local subscription info
        const subscriptionInfo = loadFromStorage('subscription_info', {});
        subscriptionInfo.status = 'active';
        subscriptionInfo.stripeSubscriptionId = data.subscriptionId;
        subscriptionInfo.stripeCustomerId = data.customerId;
        subscriptionInfo.nextBillingDate = new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toISOString();
        subscriptionInfo.subscribedAt = new Date().toISOString();
        
        saveToStorage('subscription_info', subscriptionInfo);
        
        // Add to billing history
        const billingHistory = loadFromStorage('billing_history', []);
        billingHistory.unshift({
            id: Date.now(),
            date: new Date().toISOString(),
            description: 'Monthly subscription - Sessionably',
            amount: 50,
            status: 'paid',
            stripeSubscriptionId: data.subscriptionId
        });
        saveToStorage('billing_history', billingHistory);
        
        // Update current user
        if (currentUser) {
            currentUser.subscriptionStatus = 'active';
            saveToStorage('current_user', currentUser);
        }
        
        showNotification('Subscription activated! Welcome to Sessionably Pro!', 'success');
        loadSubscriptionSettings();
        updateSubscriptionStatus();
        
    } catch (error) {
        console.error('Subscription error:', error);
        showNotification('Error setting up subscription. Please try again.', 'error');
    } finally {
        hideLoadingState();
    }
}

function extendTrial() {
    const subscriptionInfo = loadFromStorage('subscription_info', {});
    const currentEndDate = new Date(subscriptionInfo.trialEndDate);
    const newEndDate = new Date(currentEndDate.getTime() + 7 * 24 * 60 * 60 * 1000);
    
    subscriptionInfo.trialEndDate = newEndDate.toISOString();
    saveToStorage('subscription_info', subscriptionInfo);
    
    if (currentUser) {
        currentUser.trialEndDate = newEndDate.toISOString();
        saveToStorage('current_user', currentUser);
    }
    
    showNotification('Trial extended by 7 days!', 'success');
    loadSubscriptionSettings();
    updateSubscriptionStatus();
}

async function manageSubscription() {
    try {
        showLoadingState('Opening billing portal...');
        
        const subscriptionInfo = loadFromStorage('subscription_info', {});
        
        if (!subscriptionInfo.stripeCustomerId) {
            throw new Error('No Stripe customer ID found');
        }

        const response = await fetch('/api/manage-subscription', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                action: 'get_customer_portal',
                customerId: subscriptionInfo.stripeCustomerId
            })
        });

        const data = await response.json();

        if (!data.success) {
            throw new Error(data.error || 'Failed to open billing portal');
        }

        // Redirect to Stripe customer portal
        window.open(data.portalUrl, '_blank');
        
    } catch (error) {
        console.error('Billing portal error:', error);
        showNotification('Error opening billing portal. Please try again.', 'error');
    } finally {
        hideLoadingState();
    }
}

function downloadInvoice() {
    showNotification('Invoice download coming soon!', 'info');
}

async function cancelSubscription() {
    if (confirm('Are you sure you want to cancel your subscription? You will lose access to Sessionably at the end of your current billing period.')) {
        try {
            showLoadingState('Cancelling subscription...');
            
            const subscriptionInfo = loadFromStorage('subscription_info', {});
            
            if (!subscriptionInfo.stripeSubscriptionId) {
                throw new Error('No Stripe subscription ID found');
            }

            const response = await fetch('/api/manage-subscription', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    action: 'cancel',
                    subscriptionId: subscriptionInfo.stripeSubscriptionId
                })
            });

            const data = await response.json();

            if (!data.success) {
                throw new Error(data.error || 'Failed to cancel subscription');
            }

            // Update local subscription info
            subscriptionInfo.status = 'cancelled';
            subscriptionInfo.cancelledAt = new Date().toISOString();
            saveToStorage('subscription_info', subscriptionInfo);
            
            showNotification('Subscription cancelled. You will retain access until the end of your billing period.', 'info');
            loadSubscriptionSettings();
            
        } catch (error) {
            console.error('Cancel subscription error:', error);
            showNotification('Error cancelling subscription. Please try again.', 'error');
        } finally {
            hideLoadingState();
        }
    }
}

async function reactivateSubscription() {
    if (confirm('Reactivate your subscription for $60/month?')) {
        try {
            showLoadingState('Reactivating subscription...');
            
            const subscriptionInfo = loadFromStorage('subscription_info', {});
            
            if (!subscriptionInfo.stripeSubscriptionId) {
                throw new Error('No Stripe subscription ID found');
            }

            const response = await fetch('/api/manage-subscription', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    action: 'reactivate',
                    subscriptionId: subscriptionInfo.stripeSubscriptionId
                })
            });

            const data = await response.json();

            if (!data.success) {
                throw new Error(data.error || 'Failed to reactivate subscription');
            }

            // Update local subscription info
            subscriptionInfo.status = 'active';
            subscriptionInfo.reactivatedAt = new Date().toISOString();
            saveToStorage('subscription_info', subscriptionInfo);
            
            showNotification('Subscription reactivated! Welcome back to Sessionably Pro!', 'success');
            loadSubscriptionSettings();
            
        } catch (error) {
            console.error('Reactivate subscription error:', error);
            showNotification('Error reactivating subscription. Please try again.', 'error');
        } finally {
            hideLoadingState();
        }
    }
}

function contactSupport() {
    window.open('mailto:support@sessionably.com?subject=Sessionably Support Request', '_blank');
}

function resetRate(code) {
    const defaults = {
        '90791': 200.00,
        '90834': 150.00,
        '90837': 180.00,
        '90847': 200.00,
        '90853': 75.00
    };
    
    const input = document.getElementById('rate_' + code);
    if (input) {
        input.value = defaults[code] || 0;
    }
}

function addCustomService() {
    const code = prompt('Enter service code:');
    if (!code) return;
    
    const name = prompt('Enter service name:');
    if (!name) return;
    
    const rate = parseFloat(prompt('Enter default rate:'));
    if (isNaN(rate)) return;
    
    const settings = loadFromStorage('clinicianBillingSettings', { customServices: [] });
    settings.customServices.push({ code, name, rate });
    saveToStorage('clinicianBillingSettings', settings);
    
    loadBillingSettings();
    showNotification('Custom service added!', 'success');
}

function deleteCustomService(code) {
    if (!confirm('Delete this custom service?')) return;
    
    const settings = loadFromStorage('clinicianBillingSettings', { customServices: [] });
    settings.customServices = settings.customServices.filter(s => s.code !== code);
    saveToStorage('clinicianBillingSettings', settings);
    
    loadBillingSettings();
    showNotification('Custom service deleted!', 'success');
}

function updateTaxSettings() {
    // Auto-save when changed
    const settings = loadFromStorage('clinicianBillingSettings', {});
    settings.taxSettings = {
        enabled: document.getElementById('taxEnabled').checked,
        rate: parseFloat(document.getElementById('taxRate').value) || 0
    };
    saveToStorage('clinicianBillingSettings', settings);
}

function getServiceRate(cptCode) {
    const settings = loadFromStorage('clinicianBillingSettings', {
        serviceFees: {
            '90791': 200.00,
            '90834': 150.00,
            '90837': 180.00,
            '90847': 200.00,
            '90853': 75.00
        }
    });
    
    return settings.serviceFees[cptCode] || 150.00;
}

function saveProfileSettings() {
    const name = document.getElementById('clinicianName').value;
    const email = document.getElementById('clinicianEmail').value;
    const phone = document.getElementById('clinicianPhone').value;
    
    if (currentUser) {
        currentUser.name = name;
        currentUser.email = email;
        currentUser.phone = phone;
        saveToStorage('current_user', currentUser);
        showNotification('Profile saved!', 'success');
    }
}

function savePracticeSettings() {
    const practice = {
        name: document.getElementById('practiceName').value,
        address: document.getElementById('practiceAddress').value,
        phone: document.getElementById('practicePhone').value
    };

    saveToStorage('practice_info', practice);
    showNotification('Practice info saved!', 'success');
}

// Client Data Import Functions
function updateImportInstructions() {
    const importType = document.getElementById('importFileType').value;
    const csvSection = document.getElementById('csvImportSection');
    const pdfSection = document.getElementById('pdfImportSection');

    csvSection.style.display = importType === 'csv' ? 'block' : 'none';
    pdfSection.style.display = importType === 'pdf' ? 'block' : 'none';
}

async function importCSV() {
    const fileInput = document.getElementById('csvImportFile');
    const file = fileInput.files[0];

    if (!file) {
        showNotification('Please select a CSV file', 'error');
        return;
    }

    const reader = new FileReader();
    reader.onload = async function(e) {
        try {
            const text = e.target.result;
            const lines = text.split('\n');
            const headers = lines[0].split(',').map(h => h.trim());

            let imported = 0;
            for (let i = 1; i < lines.length; i++) {
                if (!lines[i].trim()) continue;

                const values = lines[i].split(',').map(v => v.trim());
                const client = {};

                headers.forEach((header, index) => {
                    client[header] = values[index] || '';
                });

                // Add required fields
                client.id = Date.now() + i;
                client.status = 'active';
                client.created_at = new Date().toISOString();

                // Save client
                const clients = loadFromStorage('clients', []);
                clients.push(client);
                saveToStorage('clients', clients);
                imported++;
            }

            showNotification(`Successfully imported ${imported} clients!`, 'success');
            renderClients();
            fileInput.value = '';
        } catch (error) {
            console.error('CSV Import Error:', error);
            showNotification('Error importing CSV file', 'error');
        }
    };
    reader.readAsText(file);
}

async function importPDF() {
    const fileInput = document.getElementById('pdfImportFile');
    const files = fileInput.files;

    if (files.length === 0) {
        showNotification('Please select at least one PDF file', 'error');
        return;
    }

    const statusDiv = document.getElementById('importStatus');
    statusDiv.style.display = 'block';
    statusDiv.style.background = '#f0f9ff';
    statusDiv.style.color = '#0369a1';
    statusDiv.innerHTML = `<p>Processing ${files.length} PDF file(s)... This feature extracts data from PDFs. For best results, ensure PDFs are text-based forms.</p>`;

    // Note: Full PDF parsing would require a library like pdf.js
    // For now, we'll show a message that this is a premium feature
    setTimeout(() => {
        statusDiv.innerHTML = `
            <p><strong>PDF Import Feature</strong></p>
            <p>PDF text extraction requires additional processing. Please contact support to enable automated PDF import, or manually enter client data from the PDF forms.</p>
            <p>Tip: You can convert PDF data to CSV format using tools like Adobe Acrobat or online converters, then use the CSV import feature.</p>
        `;
        fileInput.value = '';
    }, 1500);
}

// Developer Settings Functions
function loadDeveloperSettings() {
    const settings = loadFromStorage('developerSettings', {
        testClientEnabled: false
    });

    const checkbox = document.getElementById('testClientEnabled');
    const infoBox = document.getElementById('testClientInfo');

    checkbox.checked = settings.testClientEnabled;
    infoBox.style.display = settings.testClientEnabled ? 'block' : 'none';
}

function toggleTestClient() {
    const checkbox = document.getElementById('testClientEnabled');
    const infoBox = document.getElementById('testClientInfo');

    infoBox.style.display = checkbox.checked ? 'block' : 'none';
}

function saveDeveloperSettings() {
    const settings = {
        testClientEnabled: document.getElementById('testClientEnabled').checked
    };

    saveToStorage('developerSettings', settings);
    showNotification('Developer settings saved!', 'success');

    // Reload clients to show/hide test client
    loadClients();
}

// =====================================================
// AUTO-PAY SETTINGS FUNCTIONS
// =====================================================

let autopayClientsData = [];

async function loadAutopaySettings() {
    const loadingEl = document.getElementById('autopayClientsLoading');
    const containerEl = document.getElementById('autopayClientsContainer');
    const noClientsEl = document.getElementById('noAutopayClients');

    loadingEl.style.display = 'block';
    containerEl.style.display = 'none';
    noClientsEl.style.display = 'none';

    try {
        const response = await fetch('/api/client-autopay-settings', {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json'
            }
        });

        if (!response.ok) {
            throw new Error('Failed to load autopay settings');
        }

        const result = await response.json();
        autopayClientsData = result.data || [];

        loadingEl.style.display = 'none';

        if (autopayClientsData.length === 0) {
            noClientsEl.style.display = 'block';
            return;
        }

        containerEl.style.display = 'block';
        renderAutopayClientsTable();

    } catch (error) {
        console.error('Error loading autopay settings:', error);
        loadingEl.innerHTML = `
            <p style="color: var(--error-color);">Error loading autopay settings: ${error.message}</p>
            <button onclick="loadAutopaySettings()" class="btn btn-secondary" style="margin-top: 10px;">Retry</button>
        `;
    }
}

function renderAutopayClientsTable() {
    const tableBody = document.getElementById('autopayClientsTable');
    const searchInput = document.getElementById('autopaySearchInput');
    const searchTerm = searchInput ? searchInput.value.toLowerCase() : '';

    let filteredClients = autopayClientsData;
    if (searchTerm) {
        filteredClients = autopayClientsData.filter(client =>
            (client.name && client.name.toLowerCase().includes(searchTerm)) ||
            (client.email && client.email.toLowerCase().includes(searchTerm))
        );
    }

    if (filteredClients.length === 0) {
        tableBody.innerHTML = `
            <tr>
                <td colspan="6" style="text-align: center; padding: 30px; color: var(--text-secondary);">
                    ${searchTerm ? 'No clients match your search.' : 'No active clients found.'}
                </td>
            </tr>
        `;
        return;
    }

    tableBody.innerHTML = filteredClients.map(client => {
        const hasPaymentMethod = !!client.payment_method_id;
        const paymentMethodDisplay = hasPaymentMethod
            ? `${client.brand || 'Card'}  ${client.last4} (Exp: ${client.expiry_month}/${client.expiry_year})`
            : '<span style="color: var(--error-color);">No payment method</span>';

        const autopayStatus = client.autopay_enabled
            ? '<span style="color: var(--success-color); font-weight: 500;"> Enabled</span>'
            : '<span style="color: var(--text-secondary);"> Disabled</span>';

        const canEnableAutopay = hasPaymentMethod;

        return `
            <tr>
                <td style="text-align: center;">
                    <input type="checkbox" class="autopay-client-checkbox" data-client-id="${client.id}" ${!canEnableAutopay ? 'disabled' : ''} onchange="updateSelectedAutopayCount()">
                </td>
                <td><strong>${escapeHtml(client.name || 'N/A')}</strong></td>
                <td>${escapeHtml(client.email || 'N/A')}</td>
                <td>${paymentMethodDisplay}</td>
                <td>${autopayStatus}</td>
                <td>
                    <button
                        onclick="toggleClientAutopay(${client.id}, ${!client.autopay_enabled})"
                        class="btn btn-${client.autopay_enabled ? 'secondary' : 'primary'}"
                        style="padding: 5px 12px; font-size: 13px;"
                        ${!canEnableAutopay && !client.autopay_enabled ? 'disabled title="No payment method on file"' : ''}
                    >
                        ${client.autopay_enabled ? 'Disable' : 'Enable'}
                    </button>
                </td>
            </tr>
        `;
    }).join('');
}

function filterAutopayClients() {
    renderAutopayClientsTable();
}

function toggleSelectAllAutopay() {
    const selectAllCheckbox = document.getElementById('selectAllAutopay');
    const checkboxes = document.querySelectorAll('.autopay-client-checkbox:not([disabled])');

    checkboxes.forEach(checkbox => {
        checkbox.checked = selectAllCheckbox.checked;
    });

    updateSelectedAutopayCount();
}

function updateSelectedAutopayCount() {
    const checkboxes = document.querySelectorAll('.autopay-client-checkbox:checked');
    const countEl = document.getElementById('selectedAutopayCount');
    if (countEl) {
        countEl.textContent = `${checkboxes.length} selected`;
    }
}

async function toggleClientAutopay(clientId, enable) {
    try {
        const response = await fetch('/api/client-autopay-settings', {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                client_id: clientId,
                autopay_enabled: enable
            })
        });

        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.error || 'Failed to update autopay setting');
        }

        showNotification(`Auto-pay ${enable ? 'enabled' : 'disabled'} successfully`, 'success');

        // Update local data
        const client = autopayClientsData.find(c => c.id === clientId);
        if (client) {
            client.autopay_enabled = enable;
        }

        renderAutopayClientsTable();

    } catch (error) {
        console.error('Error toggling autopay:', error);
        showNotification(`Error: ${error.message}`, 'error');
    }
}

async function bulkEnableAutopay() {
    const checkboxes = document.querySelectorAll('.autopay-client-checkbox:checked');
    if (checkboxes.length === 0) {
        showNotification('Please select at least one client', 'error');
        return;
    }

    if (!confirm(`Enable auto-pay for ${checkboxes.length} client(s)?`)) {
        return;
    }

    const clientIds = Array.from(checkboxes).map(cb => parseInt(cb.dataset.clientId));

    try {
        const response = await fetch('/api/client-autopay-settings', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                client_ids: clientIds,
                autopay_enabled: true
            })
        });

        if (!response.ok) {
            throw new Error('Failed to enable autopay');
        }

        const result = await response.json();

        if (result.data.failed.length > 0) {
            const failedNames = result.data.failed.map(f => `Client ${f.client_id}: ${f.reason}`).join('\n');
            showNotification(`Auto-pay enabled for ${result.data.success.length} client(s).\n\nFailed for ${result.data.failed.length}:\n${failedNames}`, 'warning');
        } else {
            showNotification(`Auto-pay enabled for ${result.data.success.length} client(s)`, 'success');
        }

        // Reload data
        await loadAutopaySettings();

    } catch (error) {
        console.error('Error enabling bulk autopay:', error);
        showNotification(`Error: ${error.message}`, 'error');
    }
}

async function bulkDisableAutopay() {
    const checkboxes = document.querySelectorAll('.autopay-client-checkbox:checked');
    if (checkboxes.length === 0) {
        showNotification('Please select at least one client', 'error');
        return;
    }

    if (!confirm(`Disable auto-pay for ${checkboxes.length} client(s)?`)) {
        return;
    }

    const clientIds = Array.from(checkboxes).map(cb => parseInt(cb.dataset.clientId));

    try {
        const response = await fetch('/api/client-autopay-settings', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                client_ids: clientIds,
                autopay_enabled: false
            })
        });

        if (!response.ok) {
            throw new Error('Failed to disable autopay');
        }

        const result = await response.json();
        showNotification(`Auto-pay disabled for ${result.data.success.length} client(s)`, 'success');

        // Reload data
        await loadAutopaySettings();

    } catch (error) {
        console.error('Error disabling bulk autopay:', error);
        showNotification(`Error: ${error.message}`, 'error');
    }
}

function getTestClient() {
    return {
        id: 'test-client-001',
        name: 'Test Client (Demo)',
        email: 'testclient@example.com',
        phone: '(555) 123-4567',
        dob: '1990-01-15',
        notes: 'This is a test client for demonstration and testing purposes. Not a real client.',
        created_at: new Date().toISOString(),
        is_test_client: true
    };
}

function isTestClientEnabled() {
    const settings = loadFromStorage('developerSettings', {
        testClientEnabled: false
    });
    return settings.testClientEnabled;
}

// First Time Setup Functions
function showFirstTimeSetup() {
    // Hide the auth container
    document.getElementById('authContainer').style.display = 'none';
    // Modal is already visible via inline style
}

function completeFirstTimeSetup() {
    const fullName = document.getElementById('setupFullName').value.trim();
    const email = document.getElementById('setupEmail').value.trim();
    const username = document.getElementById('setupUsername').value.trim();
    const password = document.getElementById('setupPassword').value;
    const confirmPassword = document.getElementById('setupConfirmPassword').value;
    
    // Validation
    if (!fullName || !email || !username || !password || !confirmPassword) {
        showNotification('Please fill in all fields', 'error');
        return;
    }
    
    if (password !== confirmPassword) {
        showNotification('Passwords do not match', 'error');
        return;
    }
    
    if (password.length < 8) {
        showNotification('Password must be at least 8 characters', 'error');
        return;
    }
    
    // Create admin user
    const adminUser = {
        id: 'admin-' + Date.now(),
        username: username,
        password: password,
        fullName: fullName,
        email: email,
        role: 'admin',
        createdAt: new Date().toISOString(),
        isActive: true,
        mustChangePassword: false
    };
    
    // Save to localStorage
    saveToStorage('clinicians', [adminUser]);
    
    // Initialize empty data structures
    saveToStorage('clients', []);
    saveToStorage('appointments', []);
    saveToStorage('invoices', []);
    saveToStorage('assigned_docs', []);
    saveToStorage('audit_logs', []);
    
    // Hide setup modal
    document.getElementById('firstTimeSetupModal').style.display = 'none';
    
    // Show success and auto-login
    showNotification('Setup complete! Logging you in...', 'success');
    
    setTimeout(() => {
        // Auto-login
        authToken = 'token-' + Date.now() + '-' + adminUser.id;
        currentUser = {
            id: adminUser.id,
            name: adminUser.fullName,
            email: adminUser.email,
            username: adminUser.username,
            role: 'admin',
            createdAt: adminUser.createdAt
        };
        
        setSession(true); // Remember me
        showApp();
        
        logAudit('system_setup_completed', {
            username: username,
            email: email,
            user_id: adminUser.id
        });
    }, 1000);
}

// Handle new user signup from landing page
async function handleNewUserSignup(userData) {
    console.log('[NEW] Processing new user signup:', userData);
    
    // Create admin user from signup data
    const adminUser = {
        id: 'admin-' + Date.now(),
        username: userData.username,
        password: userData.password,
        fullName: `${userData.firstName} ${userData.lastName}`,
        email: userData.email,
        phone: userData.phone,
        practiceName: userData.practiceName,
        licenseNumber: userData.licenseNumber,
        role: 'admin',
        createdAt: userData.createdAt,
        isActive: true,
        mustChangePassword: false,
        subscriptionStatus: userData.subscriptionStatus,
        trialStartDate: userData.trialStartDate,
        trialEndDate: userData.trialEndDate
    };
    
    // Save to localStorage
    saveToStorage('clinicians', [adminUser]);
    
    // Initialize empty data structures
    saveToStorage('clients', []);
    saveToStorage('appointments', []);
    saveToStorage('invoices', []);
    saveToStorage('assigned_docs', []);
    saveToStorage('audit_logs', []);
    
    // Initialize practice info
    const practiceInfo = {
        name: userData.practiceName,
        email: userData.email,
        phone: userData.phone,
        address: '',
        city: '',
        state: '',
        zip: '',
        license: userData.licenseNumber,
        npi: '',
        taxId: '',
        createdAt: new Date().toISOString()
    };
    saveToStorage('practice_info', practiceInfo);
    
    // Initialize subscription info
    const subscriptionInfo = {
        status: 'trial',
        plan: 'monthly',
        price: 50,
        trialStartDate: userData.trialStartDate,
        trialEndDate: userData.trialEndDate,
        nextBillingDate: userData.trialEndDate,
        createdAt: new Date().toISOString()
    };
    saveToStorage('subscription_info', subscriptionInfo);
    
    // Hide setup modal if visible
    const setupModal = document.getElementById('firstTimeSetupModal');
    if (setupModal) {
        setupModal.style.display = 'none';
    }
    
    // Show welcome message
    showNotification(`Welcome to Sessionably, ${userData.firstName}! Your 7-day free trial has started.`, 'success');
    
    setTimeout(async () => {
        // Auto-login
        authToken = 'token-' + Date.now() + '-' + adminUser.id;
        currentUser = {
            id: adminUser.id,
            name: adminUser.fullName,
            email: adminUser.email,
            username: adminUser.username,
            role: 'admin',
            createdAt: adminUser.createdAt,
            subscriptionStatus: adminUser.subscriptionStatus,
            trialEndDate: adminUser.trialEndDate
        };
        
        setSession(true); // Remember me
        showApp();
        
        // Show trial info
        showTrialWelcome();
        
        logAudit('user_signup_completed', {
            username: userData.username,
            email: userData.email,
            fullName: adminUser.fullName,
            practiceName: userData.practiceName,
            trialEndDate: userData.trialEndDate
        });
        
        // Clean up signup data
        localStorage.removeItem('sessionably_new_user');
        
        // Send welcome email
        await sendWelcomeEmail(userData);
        
        // Clean URL
        window.history.replaceState({}, document.title, window.location.pathname);
    }, 2000);
}

// Show trial welcome modal
function showTrialWelcome() {
    const trialEndDate = new Date(currentUser.trialEndDate);
    const daysLeft = Math.ceil((trialEndDate - new Date()) / (1000 * 60 * 60 * 24));
    
    const modal = document.createElement('div');
    modal.className = 'modal';
    modal.style.display = 'block';
    modal.innerHTML = `
        <div class="modal-content" style="max-width: 500px;">
            <h2 style="text-align: center; color: var(--primary-color);"> Welcome to Sessionably!</h2>
            <div style="text-align: center; margin: 20px 0;">
                <p style="font-size: 1.1rem; color: var(--text-secondary); margin-bottom: 15px;">
                    Your 7-day free trial has started!
                </p>
                <div style="background: var(--primary-color); color: white; padding: 15px; border-radius: 8px; margin: 15px 0;">
                    <strong>${daysLeft} days remaining</strong><br>
                    <small>Trial ends: ${trialEndDate.toLocaleDateString()}</small>
                </div>
                <p style="font-size: 0.9rem; color: var(--text-secondary);">
                    After your trial, you'll be charged $60/month per clinician. You can cancel anytime.
                </p>
            </div>
            <div style="text-align: center; margin-top: 20px;">
                <button onclick="this.closest('.modal').remove()" class="btn btn-primary">
                    Get Started
                </button>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
    
    // Auto-close after 10 seconds
    setTimeout(() => {
        if (modal.parentNode) {
            modal.remove();
        }
    }, 10000);
}

// Email and Onboarding Functions
async function sendWelcomeEmail(userData) {
    try {
        // Send via AWS SES
        const response = await fetch('/api/send-email', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                emailType: 'welcome',
                emailData: {
                    email: userData.email,
                    firstName: userData.firstName,
                    lastName: userData.lastName,
                    practiceName: userData.practiceName
                }
            })
        });

        const result = await response.json();
        
        if (result.success) {
            console.log(' Welcome email sent successfully to:', userData.email);
            showNotification('Welcome email sent!', 'success');
        } else {
            console.error('Failed to send welcome email:', result.error);
            showNotification('Failed to send welcome email', 'error');
        }
    } catch (error) {
        console.error('Error sending welcome email:', error);
        showNotification('Error sending welcome email', 'error');
    }
    
    // Schedule follow-up emails
    scheduleOnboardingEmails(userData);
}

function generateWelcomeEmailTemplate(userData) {
    const trialEndDate = new Date(userData.trialEndDate);
    const daysLeft = Math.ceil((trialEndDate - new Date()) / (1000 * 60 * 60 * 24));
    
    const html = `
        <!DOCTYPE html>
        <html>
        <head>
            <meta charset="utf-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>Welcome to Sessionably</title>
            <style>
                body { font-family: Arial, sans-serif; line-height: 1.6; color: #333; max-width: 600px; margin: 0 auto; padding: 20px; }
                .header { background: linear-gradient(135deg, #4361EE, #5B7BFF); color: white; padding: 30px; text-align: center; border-radius: 8px 8px 0 0; }
                .content { background: white; padding: 30px; border: 1px solid #e2e8f0; }
                .footer { background: #f8fafc; padding: 20px; text-align: center; border-radius: 0 0 8px 8px; font-size: 14px; color: #64748b; }
                .button { display: inline-block; background: #4361EE; color: white; padding: 12px 24px; text-decoration: none; border-radius: 6px; margin: 10px 0; }
                .trial-box { background: #fef3c7; border: 1px solid #f59e0b; padding: 20px; border-radius: 8px; margin: 20px 0; }
                .feature-list { list-style: none; padding: 0; }
                .feature-list li { padding: 8px 0; border-bottom: 1px solid #f1f5f9; }
                .feature-list li:before { content: " "; color: #10b981; font-weight: bold; }
            </style>
        </head>
        <body>
            <div class="header">
                <h1>Welcome to Sessionably!</h1>
                <p>Your HIPAA-compliant practice management solution</p>
            </div>
            
            <div class="content">
                <h2>Hi ${userData.firstName},</h2>
                
                <p>Welcome to Sessionably! We're excited to help you streamline your mental health practice with our AI-powered documentation and secure client management tools.</p>
                
                <div class="trial-box">
                    <h3>Your Free Trial is Active</h3>
                    <p><strong>${daysLeft} days remaining</strong> in your free trial</p>
                    <p>Trial ends: ${trialEndDate.toLocaleDateString()}</p>
                    <p>After your trial, you'll be charged $60/month per clinician. You can cancel anytime.</p>
                </div>
                
                <h3>Getting Started</h3>
                <p>Here's what you can do right now:</p>
                <ul class="feature-list">
                    <li>Add your first client and create appointments</li>
                    <li>Generate AI-powered clinical notes from session transcripts</li>
                    <li>Set up your billing rates and create invoices</li>
                    <li>Upload and manage client documents securely</li>
                    <li>Record sessions with automatic transcription</li>
                </ul>
                
                <div style="text-align: center; margin: 30px 0;">
                    <a href="https://sessionably.com/app.html" class="button">Access Your Dashboard</a>
                </div>
                
                <h3>Resources & Support</h3>
                <ul>
                    <li><strong>Getting Started Guide:</strong> <a href="https://sessionably.com/guide">sessionably.com/guide</a></li>
                    <li><strong>Video Tutorials:</strong> <a href="https://sessionably.com/tutorials">sessionably.com/tutorials</a></li>
                    <li><strong>Support:</strong> <a href="mailto:support@sessionably.com">support@sessionably.com</a></li>
                </ul>
                
                <h3>HIPAA Compliance</h3>
                <p>Sessionably is fully HIPAA-compliant with:</p>
                <ul>
                    <li>End-to-end encryption for all data</li>
                    <li>Business Associate Agreements with all vendors</li>
                    <li>Complete audit trails for all activities</li>
                    <li>Secure cloud storage with automatic backups</li>
                </ul>
                
                <p>If you have any questions, don't hesitate to reach out to our support team.</p>
                
                <p>Best regards,<br>
                The Sessionably Team</p>
            </div>
            
            <div class="footer">
                <p>Sessionably - Built by clinicians, for clinicians</p>
                <p>This email was sent to ${userData.email} because you signed up for Sessionably.</p>
                <p><a href="https://sessionably.com/unsubscribe">Unsubscribe</a> | <a href="https://sessionably.com/privacy.html">Privacy Policy</a></p>
            </div>
        </body>
        </html>
    `;
    
    const text = `
Welcome to Sessionably!

Hi ${userData.firstName},

Welcome to Sessionably! We're excited to help you streamline your mental health practice.

Your Free Trial is Active:
- ${daysLeft} days remaining
- Trial ends: ${trialEndDate.toLocaleDateString()}
- After your trial: $60/month per clinician

Getting Started:
1. Add your first client and create appointments
2. Generate AI-powered clinical notes from session transcripts
3. Set up your billing rates and create invoices
4. Upload and manage client documents securely
5. Record sessions with automatic transcription

Access your dashboard: https://sessionably.com/app.html

Resources & Support:
- Getting Started Guide: https://sessionably.com/guide
- Video Tutorials: https://sessionably.com/tutorials
- Support: support@sessionably.com

HIPAA Compliance:
Sessionably is fully HIPAA-compliant with end-to-end encryption, BAAs with all vendors, complete audit trails, and secure cloud storage.

Best regards,
The Sessionably Team

---
Sessionably - Built by clinicians, for clinicians
This email was sent to ${userData.email} because you signed up for Sessionably.
Unsubscribe: https://sessionably.com/unsubscribe
Privacy Policy: https://sessionably.com/privacy
    `;
    
    return { html, text };
}

function scheduleOnboardingEmails(userData) {
    const emailQueue = loadFromStorage('email_queue', []);
    const trialEndDate = new Date(userData.trialEndDate);
    
    // Day 3: Getting Started Tips
    const day3Date = new Date(Date.now() + 3 * 24 * 60 * 60 * 1000);
    emailQueue.push({
        id: Date.now() + 1,
        type: 'onboarding_day3',
        to: userData.email,
        subject: 'Sessionably: 3 Tips to Get the Most from Your Trial',
        html: generateOnboardingEmailTemplate(userData, 'day3'),
        text: generateOnboardingEmailText(userData, 'day3'),
        status: 'scheduled',
        scheduledFor: day3Date.toISOString(),
        createdAt: new Date().toISOString()
    });
    
    // Day 7: Feature Spotlight
    const day7Date = new Date(Date.now() + 7 * 24 * 60 * 60 * 1000);
    emailQueue.push({
        id: Date.now() + 2,
        type: 'onboarding_day7',
        to: userData.email,
        subject: 'Sessionably: AI-Powered Notes & Session Recording',
        html: generateOnboardingEmailTemplate(userData, 'day7'),
        text: generateOnboardingEmailText(userData, 'day7'),
        status: 'scheduled',
        scheduledFor: day7Date.toISOString(),
        createdAt: new Date().toISOString()
    });
    
    // Day 10: Trial Reminder
    const day10Date = new Date(Date.now() + 10 * 24 * 60 * 60 * 1000);
    emailQueue.push({
        id: Date.now() + 3,
        type: 'trial_reminder_day10',
        to: userData.email,
        subject: 'Sessionably: 4 Days Left in Your Free Trial',
        html: generateTrialReminderTemplate(userData, 4),
        text: generateTrialReminderText(userData, 4),
        status: 'scheduled',
        scheduledFor: day10Date.toISOString(),
        createdAt: new Date().toISOString()
    });
    
    // Day 12: Final Reminder
    const day12Date = new Date(Date.now() + 12 * 24 * 60 * 60 * 1000);
    emailQueue.push({
        id: Date.now() + 4,
        type: 'trial_reminder_day12',
        to: userData.email,
        subject: 'Sessionably: 2 Days Left - Subscribe to Continue',
        html: generateTrialReminderTemplate(userData, 2),
        text: generateTrialReminderText(userData, 2),
        status: 'scheduled',
        scheduledFor: day12Date.toISOString(),
        createdAt: new Date().toISOString()
    });
    
    // Day 14: Trial Expired
    const day14Date = new Date(trialEndDate);
    emailQueue.push({
        id: Date.now() + 5,
        type: 'trial_expired',
        to: userData.email,
        subject: 'Sessionably: Your Free Trial Has Ended',
        html: generateTrialExpiredTemplate(userData),
        text: generateTrialExpiredText(userData),
        status: 'scheduled',
        scheduledFor: day14Date.toISOString(),
        createdAt: new Date().toISOString()
    });
    
    saveToStorage('email_queue', emailQueue);
    console.log(' Onboarding emails scheduled for:', userData.email);
}

function generateOnboardingEmailTemplate(userData, day) {
    const templates = {
        day3: {
            title: '3 Tips to Get the Most from Your Trial',
            content: `
                <h3>Tip 1: Set Up Your First Client</h3>
                <p>Add a client and create your first appointment to see how easy it is to manage your practice.</p>
                
                <h3>Tip 2: Try AI-Powered Notes</h3>
                <p>Use the session recording feature to automatically generate clinical notes. It saves hours of documentation time!</p>
                
                <h3>Tip 3: Configure Your Billing</h3>
                <p>Set up your CPT codes and rates in Settings > Billing Settings. This will auto-populate when creating invoices.</p>
            `
        },
        day7: {
            title: 'AI-Powered Notes & Session Recording',
            content: `
                <h3>Session Recording</h3>
                <p>Record entire sessions with automatic transcription. Perfect for generating comprehensive clinical notes.</p>
                
                <h3>AI Note Generation</h3>
                <p>Choose from DAP, SOAP, BIRP, or Narrative formats. The AI creates detailed notes from your session transcripts.</p>
                
                <h3>Digital Signatures</h3>
                <p>All notes are automatically signed and timestamped for compliance and legal protection.</p>
            `
        }
    };
    
    const template = templates[day];
    
    return `
        <!DOCTYPE html>
        <html>
        <head>
            <meta charset="utf-8">
            <title>Sessionably Onboarding</title>
            <style>
                body { font-family: Arial, sans-serif; line-height: 1.6; color: #333; max-width: 600px; margin: 0 auto; padding: 20px; }
                .header { background: #4361EE; color: white; padding: 20px; text-align: center; border-radius: 8px 8px 0 0; }
                .content { background: white; padding: 30px; border: 1px solid #e2e8f0; }
                .button { display: inline-block; background: #4361EE; color: white; padding: 12px 24px; text-decoration: none; border-radius: 6px; margin: 10px 0; }
            </style>
        </head>
        <body>
            <div class="header">
                <h1>${template.title}</h1>
            </div>
            <div class="content">
                <h2>Hi ${userData.firstName},</h2>
                <p>Here are some tips to help you get the most out of your Sessionably trial:</p>
                ${template.content}
                <div style="text-align: center; margin: 30px 0;">
                    <a href="https://sessionably.com/app.html" class="button">Continue to Dashboard</a>
                </div>
                <p>Questions? Reply to this email or contact us at support@sessionably.com</p>
            </div>
        </body>
        </html>
    `;
}

function generateOnboardingEmailText(userData, day) {
    const templates = {
        day3: `
Hi ${userData.firstName},

Here are 3 tips to get the most from your Sessionably trial:

Tip 1: Set Up Your First Client
Add a client and create your first appointment to see how easy it is to manage your practice.

Tip 2: Try AI-Powered Notes
Use the session recording feature to automatically generate clinical notes. It saves hours of documentation time!

Tip 3: Configure Your Billing
Set up your CPT codes and rates in Settings > Billing Settings. This will auto-populate when creating invoices.

Continue to your dashboard: https://sessionably.com/app.html

Questions? Reply to this email or contact us at support@sessionably.com
        `,
        day7: `
Hi ${userData.firstName},

Here's how to use Sessionably's powerful AI features:

Session Recording
Record entire sessions with automatic transcription. Perfect for generating comprehensive clinical notes.

AI Note Generation
Choose from DAP, SOAP, BIRP, or Narrative formats. The AI creates detailed notes from your session transcripts.

Digital Signatures
All notes are automatically signed and timestamped for compliance and legal protection.

Continue to your dashboard: https://sessionably.com/app.html

Questions? Reply to this email or contact us at support@sessionably.com
        `
    };
    
    return templates[day];
}

function generateTrialReminderTemplate(userData, daysLeft) {
    return `
        <!DOCTYPE html>
        <html>
        <head>
            <meta charset="utf-8">
            <title>Trial Reminder</title>
            <style>
                body { font-family: Arial, sans-serif; line-height: 1.6; color: #333; max-width: 600px; margin: 0 auto; padding: 20px; }
                .header { background: #f59e0b; color: white; padding: 20px; text-align: center; border-radius: 8px 8px 0 0; }
                .content { background: white; padding: 30px; border: 1px solid #e2e8f0; }
                .button { display: inline-block; background: #4361EE; color: white; padding: 12px 24px; text-decoration: none; border-radius: 6px; margin: 10px 0; }
                .urgent { background: #fee2e2; border: 1px solid #ef4444; padding: 20px; border-radius: 8px; margin: 20px 0; }
            </style>
        </head>
        <body>
            <div class="header">
                <h1>${daysLeft} Days Left in Your Trial</h1>
            </div>
            <div class="content">
                <h2>Hi ${userData.firstName},</h2>
                <div class="urgent">
                    <h3>Your free trial ends in ${daysLeft} days!</h3>
                    <p>Don't lose access to your client data and practice management tools.</p>
                </div>
                <p>Subscribe now to continue using Sessionably with unlimited clients, AI-powered notes, and secure document storage.</p>
                <div style="text-align: center; margin: 30px 0;">
                    <a href="https://sessionably.com/app.html" class="button">Subscribe Now - $60/month</a>
                </div>
                <p>Questions? Contact us at support@sessionably.com</p>
            </div>
        </body>
        </html>
    `;
}

function generateTrialReminderText(userData, daysLeft) {
    return `
Hi ${userData.firstName},

Your free trial ends in ${daysLeft} days!

Don't lose access to your client data and practice management tools.

Subscribe now to continue using Sessionably with unlimited clients, AI-powered notes, and secure document storage.

Subscribe now: https://sessionably.com/app.html

Questions? Contact us at support@sessionably.com
    `;
}

function generateTrialExpiredTemplate(userData) {
    return `
        <!DOCTYPE html>
        <html>
        <head>
            <meta charset="utf-8">
            <title>Trial Expired</title>
            <style>
                body { font-family: Arial, sans-serif; line-height: 1.6; color: #333; max-width: 600px; margin: 0 auto; padding: 20px; }
                .header { background: #ef4444; color: white; padding: 20px; text-align: center; border-radius: 8px 8px 0 0; }
                .content { background: white; padding: 30px; border: 1px solid #e2e8f0; }
                .button { display: inline-block; background: #4361EE; color: white; padding: 12px 24px; text-decoration: none; border-radius: 6px; margin: 10px 0; }
                .expired { background: #fee2e2; border: 1px solid #ef4444; padding: 20px; border-radius: 8px; margin: 20px 0; }
            </style>
        </head>
        <body>
            <div class="header">
                <h1>Your Trial Has Ended</h1>
            </div>
            <div class="content">
                <h2>Hi ${userData.firstName},</h2>
                <div class="expired">
                    <h3>Your free trial has ended</h3>
                    <p>Your data is safe, but you'll need to subscribe to continue using Sessionably.</p>
                </div>
                <p>Subscribe now to regain access to all your client data and practice management tools.</p>
                <div style="text-align: center; margin: 30px 0;">
                    <a href="https://sessionably.com/app.html" class="button">Subscribe Now - $60/month</a>
                </div>
                <p>Need help? Contact us at support@sessionably.com</p>
            </div>
        </body>
        </html>
    `;
}

function generateTrialExpiredText(userData) {
    return `
Hi ${userData.firstName},

Your free trial has ended.

Your data is safe, but you'll need to subscribe to continue using Sessionably.

Subscribe now to regain access to all your client data and practice management tools.

Subscribe now: https://sessionably.com/app.html

Need help? Contact us at support@sessionably.com
    `;
}

// Invoice Email Functions
async function sendInvoiceEmail(invoice) {
    try {
        console.log(' Starting invoice email process for invoice:', invoice.id);
        
        const client = clients.find(c => c.id == invoice.client_id);
        if (!client || !client.email) {
            console.log(' Client email not found:', { client: client?.name, email: client?.email });
            showNotification('Client email not found - invoice not emailed', 'warning');
            return;
        }

        console.log(' Sending email to:', client.email);
        const emailTemplate = generateInvoiceEmailTemplate(invoice, client);

        // Get practice info for email subject
        const practiceInfo = invoice.practice_info || loadFromStorage('practice_info') || { name: 'Your Practice' };

        const response = await fetch('/api/send-email', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                emailType: 'general',
                emailData: {
                    to: client.email,
                    subject: `Invoice #${invoice.invoice_number} from ${practiceInfo.name}`,
                    htmlContent: emailTemplate.html,
                    textContent: emailTemplate.text
                }
            })
        });

        console.log(' Email API response status:', response.status);

        if (response.ok) {
            const result = await response.json();
            console.log(' Email sent successfully:', result);
            showNotification(` Invoice emailed to ${client.name}`, 'success');
            await logAudit('email_invoice', { 
                invoice_id: invoice.id, 
                client_id: invoice.client_id, 
                email: client.email 
            });
        } else {
            const errorText = await response.text();
            console.error(' Email API error:', response.status, errorText);
            throw new Error(`Failed to send email: ${response.status} ${errorText}`);
        }
    } catch (error) {
        console.error(' Error sending invoice email:', error);
        showNotification('Error sending invoice email', 'error');
        throw error; // Re-throw so saveInvoice can handle it
    }
}

function generateInvoiceEmailTemplate(invoice, client) {
    const dueDate = new Date(invoice.due_date).toLocaleDateString();
    const createdDate = new Date(invoice.created_at).toLocaleDateString();

    // Get practice info
    const practiceInfo = invoice.practice_info || loadFromStorage('practice_info') || {
        name: 'Your Practice Name',
        address: 'Practice Address',
        phone: 'Practice Phone'
    };

    const servicesHtml = invoice.services.map(service => `
        <tr>
            <td style="padding: 10px; border-bottom: 1px solid #e2e8f0; font-weight: 600; color: #0066cc;">${service.cpt_code || 'N/A'}</td>
            <td style="padding: 10px; border-bottom: 1px solid #e2e8f0;">${service.description}</td>
            <td style="padding: 10px; border-bottom: 1px solid #e2e8f0; text-align: right;">$${service.amount.toFixed(2)}</td>
        </tr>
    `).join('');

    const html = `
        <!DOCTYPE html>
        <html>
        <head>
            <meta charset="utf-8">
            <title>Invoice #${invoice.invoice_number}</title>
            <style>
                body { font-family: Arial, sans-serif; line-height: 1.6; color: #333; max-width: 600px; margin: 0 auto; padding: 20px; }
                .header { background: #0F4C81; color: white; padding: 30px; text-align: center; border-bottom: 3px solid #1B5F9A; }
                .content { background: white; padding: 30px; border: 1px solid #D6DCE4; }
                .invoice-table { width: 100%; border-collapse: collapse; margin: 20px 0; }
                .invoice-table th { background: #F5F7FA; padding: 10px; text-align: left; border-bottom: 2px solid #D6DCE4; }
                .total { background: linear-gradient(135deg, #0F4C81 0%, #1B5F9A 100%); color: white; padding: 15px; text-align: right; font-weight: bold; font-size: 18px; }
                .footer { background: #f8f9fa; padding: 15px; text-align: center; border-top: 1px solid #D6DCE4; color: #6c757d; font-size: 12px; }
            </style>
        </head>
        <body>
            <div class="header">
                <h1 style="margin: 0 0 10px 0;">${practiceInfo.name}</h1>
                <p style="margin: 0; color: #666;">${practiceInfo.address || ''}</p>
                <p style="margin: 0; color: #666;">${practiceInfo.phone || ''}</p>
            </div>
            <div class="content">
                <h2 style="margin: 0 0 20px 0;">Invoice #${invoice.invoice_number}</h2>
                <h3>Dear ${client.name},</h3>
                <p>Thank you for your visit. Please find your invoice details below:</p>

                <div style="margin: 20px 0;">
                    <p><strong>Invoice Number:</strong> ${invoice.invoice_number}</p>
                    <p><strong>Date Issued:</strong> ${createdDate}</p>
                    <p><strong>Due Date:</strong> ${dueDate}</p>
                </div>

                <table class="invoice-table">
                    <thead>
                        <tr>
                            <th>CPT Code</th>
                            <th>Service Description</th>
                            <th style="text-align: right;">Amount</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${servicesHtml}
                    </tbody>
                </table>

                <div class="total">
                    Total Amount: $${invoice.total_amount.toFixed(2)}
                </div>

                ${invoice.notes ? `<div style="margin: 20px 0;"><strong>Notes:</strong><br>${invoice.notes}</div>` : ''}

                <div style="margin: 30px 0; padding: 20px; background: #f8f9fa; border-radius: 8px;">
                    <h3>Payment Information</h3>
                    <p>Please contact our office to arrange payment or if you have any questions about this invoice.</p>
                    ${practiceInfo.phone ? `<p><strong>Phone:</strong> ${practiceInfo.phone}</p>` : ''}
                    <p>Thank you for your business!</p>
                </div>
            </div>
            <div class="footer">
                <p style="margin: 0;">Provided by Sessionably</p>
            </div>
        </body>
        </html>
    `;

    const text = `
Invoice #${invoice.invoice_number}
${practiceInfo.name}
${practiceInfo.address || ''}
${practiceInfo.phone || ''}

Dear ${client.name},

Thank you for your visit. Please find your invoice details below:

Invoice Details:
- Invoice Number: ${invoice.invoice_number}
- Date Issued: ${createdDate}
- Due Date: ${dueDate}

Services:
${invoice.services.map(service => `- CPT ${service.cpt_code || 'N/A'}: ${service.description} - $${service.amount.toFixed(2)}`).join('\n')}

Total Amount: $${invoice.total_amount.toFixed(2)}

${invoice.notes ? `Notes: ${invoice.notes}\n` : ''}
Payment Information:
Please contact our office to arrange payment or if you have any questions about this invoice.
${practiceInfo.phone ? `Phone: ${practiceInfo.phone}` : ''}

Thank you for your business!

---
Provided by Sessionably

Sessionably - Professional Healthcare Management
This is an automated invoice. Please contact our office with any questions.
    `;

    return { html, text };
}

// SMS Appointment Reminder Functions
async function scheduleAppointmentSMSReminder(appointment) {
    // 1. Check appointment object exists
    if (!appointment) {
        console.error('No appointment provided to SMS scheduler');
        return;
    }

    // 2. Use flexible parser to handle all date formats (including ISO)
    const appointmentDateTime = parseAppointmentDate(appointment);

    // 3. Validate date was parsed successfully
    if (!appointmentDateTime) {
        console.error('Invalid appointment date -', appointment);
        return; // Exit early - don't try to schedule
    }

    // 4. Now safe to format the date for SMS
    const formattedDate = appointmentDateTime.toLocaleDateString('en-US', {
        weekday: 'long',
        month: 'long',
        day: 'numeric'
    });
    const formattedTime = appointmentDateTime.toLocaleTimeString('en-US', {
        hour: 'numeric',
        minute: '2-digit',
        hour12: true
    });

    console.log(' SMS scheduled for:', formattedDate, formattedTime);
    // ... rest of SMS scheduling logic ...

    try {
        console.log(' Scheduling SMS reminder for appointment:', appointment.id);

        // Handle both camelCase (from database) and snake_case field names
        const clientId = appointment.clientId || appointment.client_id;
        const client = clients.find(c => c.id == clientId);
        if (!client || !client.phone) {
            console.log(' Client phone not found - SMS reminder not scheduled:', {
                client: client?.name,
                phone: client?.phone
            });
            return;
        }

        console.log(' Client found for SMS:', { name: client.name, phone: client.phone });

        // Format phone number for SMS (ensure it starts with +)
        let phoneNumber = client.phone.trim();
        console.log(' Original phone number:', phoneNumber);

        if (!phoneNumber.startsWith('+')) {
            // Assume US number if no country code
            phoneNumber = phoneNumber.replace(/\D/g, ''); // Remove non-digits
            if (phoneNumber.length === 10) {
                phoneNumber = '+1' + phoneNumber;
            } else if (phoneNumber.length === 11 && phoneNumber.startsWith('1')) {
                phoneNumber = '+' + phoneNumber;
            }
        }

        console.log(' Formatted phone number:', phoneNumber);

        const reminderDateTime = new Date(appointmentDateTime.getTime() - (24 * 60 * 60 * 1000)); // 24 hours before

        console.log(' Appointment datetime:', appointmentDateTime.toLocaleString());
        console.log(' Reminder scheduled for:', reminderDateTime.toLocaleString());

        // Remove PHI - no client name, just appointment details
        const message = `Reminder: You have an appointment scheduled for ${formattedDate} at ${formattedTime}. Please arrive 10 minutes early. Reply STOP to opt out.`;
        
        console.log(' SMS message:', message);

        // Add to SMS queue for scheduled sending
        const smsQueue = loadFromStorage('sms_queue', []);
        const smsReminder = {
            id: Date.now(),
            appointment_id: appointment.id,
            client_id: clientId,
            phone: phoneNumber,
            message: message,
            scheduled_for: reminderDateTime.toISOString(),
            status: 'scheduled',
            created_at: new Date().toISOString()
        };
        
        smsQueue.push(smsReminder);
        saveToStorage('sms_queue', smsQueue);
        
        console.log(' SMS reminder added to queue:', smsReminder);
        console.log(' Total SMS queue length:', smsQueue.length);
        
        showNotification(`[SMS] SMS reminder scheduled for 24 hours before appointment`, 'success');
        await logAudit('schedule_sms_reminder', { 
            appointment_id: appointment.id, 
            client_id: appointment.client_id,
            phone: phoneNumber,
            scheduled_for: reminderDateTime.toISOString()
        });
        
        console.log(` SMS reminder scheduled for ${reminderDateTime.toLocaleString()}`);
        
    } catch (error) {
        console.error('Error scheduling SMS appointment reminder:', error);
        showNotification('Error scheduling SMS reminder', 'error');
    }
}

// Function to process scheduled SMS reminders (can be called periodically)
async function processScheduledSMSReminders() {
    try {
        const smsQueue = loadFromStorage('sms_queue', []);
        const now = new Date();
        const remindersToSend = smsQueue.filter(reminder => 
            new Date(reminder.scheduled_for) <= now && reminder.status === 'scheduled'
        );
        
        console.log(' Processing SMS reminders - Queue length:', smsQueue.length, 'Due now:', remindersToSend.length);

        for (const reminder of remindersToSend) {
            try {
                const response = await fetch('/api/send-sms', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        smsType: 'general',
                        smsData: {
                            to: reminder.phone,
                            message: reminder.message,
                            from: 'Sessionably'
                        }
                    })
                });

                if (response.ok) {
                    // Mark as sent
                    reminder.status = 'sent';
                    reminder.sent_at = new Date().toISOString();
                    
                    await logAudit('sms_reminder_sent', { 
                        appointment_id: reminder.appointment_id, 
                        client_id: reminder.client_id,
                        phone: reminder.phone
                    });
                    
                    console.log(`SMS reminder sent for appointment ${reminder.appointment_id}`);
                } else {
                    reminder.status = 'failed';
                    reminder.failed_at = new Date().toISOString();
                }
            } catch (error) {
                console.error('Error sending scheduled SMS:', error);
                reminder.status = 'failed';
                reminder.failed_at = new Date().toISOString();
            }
        }

        // Update the queue
        saveToStorage('sms_queue', smsQueue);
        
        // Clean up old sent/failed reminders (older than 7 days)
        const sevenDaysAgo = new Date(now.getTime() - (7 * 24 * 60 * 60 * 1000));
        const cleanedQueue = smsQueue.filter(reminder => {
            if (reminder.status === 'sent' || reminder.status === 'failed') {
                return new Date(reminder.sent_at || reminder.failed_at) > sevenDaysAgo;
            }
            return true; // Keep scheduled reminders
        });
        
        if (cleanedQueue.length !== smsQueue.length) {
            saveToStorage('sms_queue', cleanedQueue);
        }
        
    } catch (error) {
        console.error('Error processing scheduled SMS reminders:', error);
    }
}

// Load clients from database API
async function loadClients() {
    try {
        const response = await fetch('/api/clients');
        const result = await response.json();

        if (!response.ok) {
            throw new Error(result.error || 'Failed to load clients');
        }

        clients = result.data || [];
    } catch (error) {
        console.error('Error loading clients:', error);
        showNotification('Error loading clients: ' + error.message, 'error');
        clients = [];
    }
}

// Load appointments from database API
async function loadAppointments() {
    try {
        const response = await fetch('/api/appointments');
        const result = await response.json();

        if (!response.ok) {
            throw new Error(result.error || 'Failed to load appointments');
        }

        appointments = result.data || [];

        // Render calendar after loading appointments
        if (document.getElementById('calendarView')) {
            renderCalendar();
        }
    } catch (error) {
        console.error('Error loading appointments:', error);
        // Don't show notification for appointments - might not be critical
        appointments = [];
    }
}

function renderClients() {
    const container = document.getElementById('clientsList');

    // Prepare clients list with test client if enabled
    let clientsToRender = [...clients];
    if (isTestClientEnabled()) {
        const testClient = getTestClient();
        clientsToRender = [testClient, ...clients];
    }

    if (clientsToRender.length === 0) {
        container.innerHTML = `
            <div style="text-align: center; padding: 60px 20px; color: var(--text-secondary);">
                <div style="font-size: 48px; margin-bottom: 16px;"></div>
                <h3 style="color: var(--text-primary); margin-bottom: 8px;">No Clients Yet</h3>
                <p>Click "+ New Client" to add your first client</p>
            </div>
        `;
        return;
    }

    // Status badge helper
    const getStatusBadge = (status) => {
        const badges = {
            'active': { color: '#10B981', bg: '#E0F7F5', label: 'Active' },
            'inactive': { color: '#888888', bg: '#F3F4F6', label: 'Inactive' },
            'pending': { color: '#F59E0B', bg: '#FEF3C7', label: 'Pending' }
        };
        const badge = badges[status] || badges.active;
        return `<span style="background: ${badge.bg}; color: ${badge.color}; padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 600;">${badge.label}</span>`;
    };

    container.innerHTML = clientsToRender.map(c => {
        const isTest = c.is_test_client === true;
        const testBadge = isTest ? '<span style="background: #0ea5e9; color: white; padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 600; margin-left: 8px;">TEST</span>' : '';
        const statusBadge = getStatusBadge(c.status || 'active');
        const dob = c.date_of_birth || c.dob;

        return `
            <div class="client-card" onclick="openClientChart('${c.id}')" style="cursor: pointer; transition: all 0.2s; border: 1px solid var(--border-color);">
                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
                    <h3 style="color: var(--primary-color); margin: 0; font-size: 18px; font-weight: 600;">${c.name}${testBadge}</h3>
                    ${statusBadge}
                </div>
                <div style="display: grid; gap: 8px; color: var(--text-secondary); font-size: 14px;">
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <svg style="width: 16px; height: 16px; flex-shrink: 0;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
                        </svg>
                        <span>${c.email || 'No email'}</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <svg style="width: 16px; height: 16px; flex-shrink: 0;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"/>
                        </svg>
                        <span>${c.phone || 'No phone'}</span>
                    </div>
                    ${dob ? `
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <svg style="width: 16px; height: 16px; flex-shrink: 0;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                            </svg>
                            <span>${new Date(dob).toLocaleDateString()}</span>
                        </div>
                    ` : ''}
                </div>
            </div>
        `;
    }).join('');
}

function filterClients() {
    const term = document.getElementById('clientSearchInput').value.toLowerCase();

    // Prepare clients list with test client if enabled
    let clientsToFilter = [...clients];
    if (isTestClientEnabled()) {
        const testClient = getTestClient();
        clientsToFilter = [testClient, ...clients];
    }

    const filtered = clientsToFilter.filter(c =>
        c.name.toLowerCase().includes(term) ||
        (c.email && c.email.toLowerCase().includes(term)) ||
        (c.phone && c.phone.includes(term))
    );

    const container = document.getElementById('clientsList');
    container.innerHTML = filtered.map(c => {
        const isTest = c.is_test_client === true;
        const badge = isTest ? '<span style="background: #0ea5e9; color: white; padding: 2px 8px; border-radius: 4px; font-size: 11px; margin-left: 8px;">TEST</span>' : '';
        return `
            <div class="client-card" onclick="openClientChart('${c.id}')">
                <h3>${c.name}${badge}</h3>
                <p> ${c.email || 'N/A'}</p>
                <p> ${c.phone || 'N/A'}</p>
                <p> ${c.dob ? new Date(c.dob).toLocaleDateString() : 'N/A'}</p>
            </div>
        `;
    }).join('');
}

// Enhanced Client Management Functions
async function searchEnhancedClients() {
    const searchTerm = document.getElementById('enhancedClientSearch').value;
    const status = document.getElementById('statusFilter').value;
    const tag = document.getElementById('tagFilter').value;

    try {
        const params = new URLSearchParams();
        if (searchTerm) params.append('q', searchTerm);
        if (status) params.append('status', status);
        if (tag) params.append('tag', tag);

        const response = await fetch(`/api/clients-enhanced?${params.toString()}`);
        const result = await response.json();

        if (!response.ok) {
            throw new Error(result.error || 'Failed to search clients');
        }

        renderEnhancedClientsTable(result.data || []);
    } catch (error) {
        console.error('Error searching enhanced clients:', error);
        const tbody = document.getElementById('clientsTableBody');
        tbody.innerHTML = `
            <tr>
                <td colspan="6" style="padding: 40px; text-align: center; color: var(--danger-color);">
                    Error loading clients: ${error.message}
                </td>
            </tr>
        `;
    }
}

function renderEnhancedClientsTable(clientsData) {
    const tbody = document.getElementById('clientsTableBody');

    if (clientsData.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="6" style="padding: 40px; text-align: center; color: var(--text-secondary);">
                    No clients found
                </td>
            </tr>
        `;
        return;
    }

    tbody.innerHTML = clientsData.map(client => {
        const statusColors = {
            'active': { bg: '#D0F7F5', color: '#00B4A6' },
            'inactive': { bg: '#F3F4F6', color: '#888888' }
        };
        const statusStyle = statusColors[client.status] || statusColors.active;

        const tagsHtml = (client.tags && client.tags.length > 0)
            ? client.tags.map(tag => `
                <span style="background: #F5A623; color: white; padding: 4px 8px; border-radius: 4px; font-size: 11px; margin-right: 4px; display: inline-block;">
                    ${tag}
                </span>
            `).join('')
            : '<span style="color: var(--text-tertiary); font-size: 12px;">No tags</span>';

        return `
            <tr style="border-bottom: 1px solid var(--border-color); transition: background 0.2s;"
                onmouseover="this.style.background='#F8F9FA'"
                onmouseout="this.style.background='white'">
                <td style="padding: 12px; font-weight: 500; color: var(--text-primary);">${client.name}</td>
                <td style="padding: 12px; color: var(--text-secondary);">${client.email || '-'}</td>
                <td style="padding: 12px; color: var(--text-secondary);">${client.phone || '-'}</td>
                <td style="padding: 12px;">
                    <span style="background: ${statusStyle.bg}; color: ${statusStyle.color}; padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 600;">
                        ${client.status || 'active'}
                    </span>
                </td>
                <td style="padding: 12px;">${tagsHtml}</td>
                <td style="padding: 12px;">
                    <button onclick="viewEnhancedClient(${client.id})"
                            style="background: var(--primary-color); color: white; border: none; padding: 6px 12px; border-radius: var(--border-radius-sm); cursor: pointer; font-size: 13px; transition: all 0.2s;"
                            onmouseover="this.style.background='var(--primary-hover)'"
                            onmouseout="this.style.background='var(--primary-color)'">
                        View
                    </button>
                </td>
            </tr>
        `;
    }).join('');
}

function viewEnhancedClient(clientId) {
    // Navigate to client chart or open client detail modal
    if (typeof openClientChart === 'function') {
        openClientChart(clientId);
    } else {
        console.log('View client:', clientId);
    }
}

// Load enhanced clients when clients tab is opened
if (typeof window.addEventListener !== 'undefined') {
    const originalShowTab = window.showTab;
    window.showTab = function(tabName) {
        if (originalShowTab) originalShowTab(tabName);
        if (tabName === 'clients') {
            searchEnhancedClients();
        }
    };
}

function openNewClient() {
    document.getElementById('newClientModal').style.display = 'block';
}

async function saveClient() {
    const clientData = {
        name: document.getElementById('clientName').value,
        email: document.getElementById('clientEmail').value,
        phone: document.getElementById('clientPhone').value,
        date_of_birth: document.getElementById('clientDOB').value,
        address: document.getElementById('clientAddress').value,
        city: document.getElementById('clientCity').value,
        state: document.getElementById('clientState').value,
        zip_code: document.getElementById('clientZip').value,
        emergency_contact: document.getElementById('clientEmergencyContact').value,
        emergency_phone: document.getElementById('clientEmergencyPhone').value,
        notes: document.getElementById('clientNotes').value,
        status: document.getElementById('clientStatus').value,
        superbill_monthly: document.getElementById('clientSuperbill').checked
    };

    if (!clientData.name) {
        showNotification('Client name is required', 'error');
        return;
    }

    try {
        const response = await fetch('/api/clients', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(clientData)
        });

        const result = await response.json();

        if (!response.ok) {
            throw new Error(result.error || 'Failed to save client');
        }

        await logAudit('create_client', { id: result.data.id, name: result.data.name });
        showNotification('Client saved successfully!', 'success');
        closeModal('newClientModal');

        // Clear form
        ['clientName','clientEmail','clientPhone','clientDOB','clientAddress','clientCity','clientState','clientZip','clientEmergencyContact','clientEmergencyPhone','clientNotes'].forEach(id => {
            document.getElementById(id).value = '';
        });
        document.getElementById('clientStatus').value = 'active';
        document.getElementById('clientSuperbill').checked = false;

        // Reload clients
        await loadClients();
        renderClients();
    } catch (error) {
        console.error('Error saving client:', error);
        showNotification('Error: ' + error.message, 'error');
    }
}

function openEditClient(id) {
    const c = clients.find(c => c.id === id);
    if (!c) return;
    document.getElementById('editClientId').value = c.id;
    document.getElementById('editClientName').value = c.name;
    document.getElementById('editClientEmail').value = c.email || '';
    document.getElementById('editClientPhone').value = c.phone || '';
    document.getElementById('editClientDOB').value = c.dob || '';
    document.getElementById('editClientNotes').value = c.notes || '';
    document.getElementById('editClientSuperbill').checked = c.superbill_monthly || false;
    document.getElementById('editClientModal').style.display = 'block';
}

async function updateClient() {
    const id = document.getElementById('editClientId').value;
    const client = {
        id: parseInt(id),
        name: document.getElementById('editClientName').value,
        email: document.getElementById('editClientEmail').value,
        phone: document.getElementById('editClientPhone').value,
        dob: document.getElementById('editClientDOB').value,
        notes: document.getElementById('editClientNotes').value,
        superbill_monthly: document.getElementById('editClientSuperbill').checked
    };
    
    try {
        // Update in localStorage
        const index = clients.findIndex(c => c.id === client.id);
        if (index !== -1) {
            // Preserve existing fields
            clients[index] = { ...clients[index], ...client };
            saveToStorage('clients', clients);
        }
        
        
        await logAudit('update_client', { id, name: client.name });
        closeModal('editClientModal');
        renderClients();
        alert(' Updated!');
    } catch (error) {
        alert('Error: ' + error.message);
    }
}

// Client Chart Functions
async function openClientChart(clientId) {
    let client = clients.find(c => c.id == clientId);

    // Check if this is the test client
    if (!client && clientId === 'test-client-001' && isTestClientEnabled()) {
        client = getTestClient();
    }

    if (!client) return;

    currentChartClient = client;
    clientCalendarDate = new Date();

    // Set header info
    const badge = client.is_test_client ? ' <span style="background: #0ea5e9; color: white; padding: 2px 8px; border-radius: 4px; font-size: 11px;">TEST</span>' : '';
    document.getElementById('chartClientName').innerHTML = client.name + badge;
    document.getElementById('chartClientInfo').textContent =
        `${client.email || 'N/A'} | ${client.phone || 'N/A'} | ${client.dob ? new Date(client.dob).toLocaleDateString() : 'N/A'}`;

    // Load client data
    await loadClientChartData();

    // Show overview tab by default
    showChartTab('overview');

    // Open modal
    document.getElementById('clientChartModal').style.display = 'block';
}

function showChartTab(tabName) {
    // Hide all tabs
    document.querySelectorAll('.chart-tab-content').forEach(tab => {
        tab.classList.remove('active');
    });
    document.querySelectorAll('.chart-tab-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    
    // Show selected tab
    document.getElementById(`chart${tabName.charAt(0).toUpperCase() + tabName.slice(1)}Tab`).classList.add('active');
    
    // Find and activate the correct tab button
    const tabButton = document.querySelector(`.chart-tab-btn[onclick*="'${tabName}'"]`);
    if (tabButton) tabButton.classList.add('active');
    
    // Load tab-specific data
    if (tabName === 'appointments') {
        renderClientAppointmentsList();
    } else if (tabName === 'documents') {
        renderClientDocuments();
    } else if (tabName === 'invoices') {
        renderClientInvoices();
    } else if (tabName === 'billing') {
        renderClientBilling();
    } else if (tabName === 'notes') {
        renderClientNotes();
    } else if (tabName === 'treatmentplans') {
        renderClientTreatmentPlans();
    }
}

async function loadClientChartData() {
    if (!currentChartClient) return;
    
    // Filter client's appointments
    clientAppointments = appointments.filter(apt => apt.client_id === currentChartClient.id);
    
    // Filter client's documents
    clientDocs = assignedDocs.filter(doc => doc.client_id === currentChartClient.id);
    
    // Filter client's invoices
    clientInvoices = invoices.filter(inv => inv.client_id === currentChartClient.id);
    
    // Update overview stats
    const completedAppts = clientAppointments.filter(apt => apt.status === 'completed').length;
    const pendingDocs = clientDocs.filter(doc => doc.status === 'pending').length;
    const totalBilled = clientInvoices.reduce((sum, inv) => sum + parseFloat(inv.total_amount || 0), 0);
    
    document.getElementById('chartTotalAppts').textContent = clientAppointments.length;
    document.getElementById('chartCompletedAppts').textContent = completedAppts;
    document.getElementById('chartPendingDocs').textContent = pendingDocs;
    document.getElementById('chartTotalBilled').textContent = '$' + totalBilled.toFixed(2);
    
    // Render overview content
    renderClientOverview();
}

// Refresh client chart data when modal is open
function refreshClientChartData() {
    if (currentChartClient && document.getElementById('clientChartModal').style.display === 'block') {
        loadClientChartData();
        // Re-render the currently active tab
        const activeTab = document.querySelector('.chart-tab-btn.active');
        if (activeTab) {
            const tabName = activeTab.textContent.toLowerCase().replace(/[^a-z]/g, '');
            if (tabName === 'invoices') {
                renderClientInvoices();
            } else if (tabName === 'appointments') {
                renderClientAppointmentsList();
            } else if (tabName === 'documents') {
                renderClientDocuments();
            }
        }
    }
}

function renderClientOverview() {
    const container = document.getElementById('chartOverviewContent');
    
    // Show recent activity
    let html = '<div class="card"><h3>Recent Activity</h3>';
    
    // Get recent appointments
    const recentAppts = clientAppointments
        .sort((a, b) => new Date(b.appointment_date) - new Date(a.appointment_date))
        .slice(0, 5);
    
    if (recentAppts.length > 0) {
        html += '<h4 style="margin-top: 20px; color: #E85D4F;">Recent Appointments</h4>';
        recentAppts.forEach(apt => {
            html += `<div style="padding: 10px; border-bottom: 1px solid #eee;">
                ${new Date(apt.appointment_date).toLocaleDateString()} at ${apt.appointment_time} - ${apt.type}
                <span style="float: right; color: #27ae60;">${apt.status}</span>
            </div>`;
        });
    }
    
    // Get recent documents
    const recentDocs = clientDocs
        .sort((a, b) => new Date(b.assigned_at) - new Date(a.assigned_at))
        .slice(0, 5);
    
    if (recentDocs.length > 0) {
        html += '<h4 style="margin-top: 20px; color: #E85D4F;">Recent Documents</h4>';
        recentDocs.forEach(doc => {
            const statusColor = doc.status === 'completed' ? '#27ae60' : '#e67e22';
            html += `<div style="padding: 10px; border-bottom: 1px solid #eee;">
                ${doc.template_name}
                <span style="float: right; color: ${statusColor};">${doc.status}</span>
            </div>`;
        });
    }
    
    html += '</div>';
    container.innerHTML = html;
}

function renderClientAppointmentsList() {
    const container = document.getElementById('clientAppointmentsList');
    
    if (clientAppointments.length === 0) {
        container.innerHTML = '<p>No appointments scheduled.</p>';
        return;
    }
    
    const sortedAppointments = clientAppointments.sort((a, b) => {
        const dateA = new Date(`${a.appointment_date} ${a.appointment_time}`);
        const dateB = new Date(`${b.appointment_date} ${b.appointment_time}`);
        return dateB - dateA;
    });
    
    container.innerHTML = '<h3>Session History</h3>' + sortedAppointments.map(apt => {
        const statusClass = apt.status === 'completed' ? 'success' : apt.status === 'cancelled' ? 'danger' : 'warning';
        const hasClinicalNotes = apt.clinical_notes && apt.clinical_notes.trim().length > 0;
        const hasSignature = apt.clinical_signature && apt.clinical_signature_timestamp;
        
        // Create session summary (first 150 characters)
        let sessionSummary = 'No clinical notes recorded';
        if (hasClinicalNotes) {
            const lines = apt.clinical_notes.split('\n');
            sessionSummary = lines.slice(0, 3).join(' ').substring(0, 150);
            if (apt.clinical_notes.length > 150) sessionSummary += '...';
        }
        
        return `<div class="session-item" data-session-id="${apt.id}">
                    <div class="session-header" onclick="toggleSessionDetails(${apt.id})">
                        <div class="session-info">
                        <h4>${new Date(apt.appointment_date).toLocaleDateString()} at ${apt.appointment_time}</h4>
                            <p class="session-type">${apt.type}  ${apt.duration} min</p>
                            <p class="session-summary">${sessionSummary}</p>
                    </div>
                        <div class="session-status">
                        <span class="btn btn-${statusClass} btn-small">${apt.status}</span>
                            <span class="session-toggle"></span>
                        </div>
                    </div>
                    <div class="session-details" id="session-details-${apt.id}" style="display: none;">
                        <div class="session-detail-section">
                            <h5>Session Details</h5>
                            <div class="detail-row">
                                <span class="detail-label">Date:</span>
                                <span class="detail-value">${new Date(apt.appointment_date).toLocaleDateString()}</span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">Time:</span>
                                <span class="detail-value">${apt.appointment_time}</span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">Duration:</span>
                                <span class="detail-value">${apt.duration} minutes</span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">Type:</span>
                                <span class="detail-value">${apt.type}</span>
                            </div>
                            ${apt.notes ? `
                            <div class="detail-row">
                                <span class="detail-label">Notes:</span>
                                <span class="detail-value">${apt.notes}</span>
                            </div>
                            ` : ''}
                        </div>
                        ${hasClinicalNotes ? `
                        <div class="session-detail-section">
                            <h5>Clinical Notes</h5>
                            <div class="clinical-notes-display">
                                <pre>${apt.clinical_notes}</pre>
                            </div>
                        </div>
                        ` : `<div class="session-detail-section">
                            <h5>Clinical Notes</h5>
                            <p style="color: #999; font-style: italic;">No clinical notes recorded for this session</p>
                        </div>`}
                        ${FEATURE_FLAGS.AI_NOTETAKER_ENABLED ? `
                        <div class="ai-notetaker-appointment-controls" style="margin-top: 15px;">
                            <button onclick="openAINoteTakerFromAppointment(${apt.id}, ${apt.client_id}, '${apt.client_name ? apt.client_name.replace(/'/g, "\\'") : 'Unknown'}')" class="btn-floating-record" title="Record session with AI NoteTaker">
                                <span class="record-icon"></span> Record Session
                            </button>
                        </div>
                        ` : ''}
                        ${hasSignature ? `
                        <div class="session-detail-section">
                            <h5>Digital Signature</h5>
                            <div class="signature-display">
                                <div class="signature-row">
                                    <span class="detail-label">Clinician:</span>
                                    <span class="detail-value">${apt.clinical_signature}</span>
                                </div>
                                <div class="signature-row">
                                    <span class="detail-label">Signed:</span>
                                    <span class="detail-value">${new Date(apt.clinical_signature_timestamp).toLocaleString()}</span>
                                </div>
                            </div>
                        </div>
                        ` : `
                        <div class="session-detail-section">
                            <h5>Digital Signature</h5>
                            <p style="color: #d32f2f; font-style: italic;"> Not signed</p>
                        </div>
                        `}
                    </div>
                </div>`;
    }).join('');
}

function toggleSessionDetails(sessionId) {
    const detailsDiv = document.getElementById(`session-details-${sessionId}`);
    const sessionItem = document.querySelector(`[data-session-id="${sessionId}"]`);
    const toggle = sessionItem.querySelector('.session-toggle');
    
    if (detailsDiv.style.display === 'none') {
        detailsDiv.style.display = 'block';
        toggle.textContent = '';
    } else {
        detailsDiv.style.display = 'none';
        toggle.textContent = '';
    }
}

function renderClientDocuments() {
    const container = document.getElementById('chartDocumentsContent');
    
    if (clientDocs.length === 0) {
        container.innerHTML = '<div class="card"><p>No documents assigned to this client.</p></div>';
        return;
    }
    
    const pending = clientDocs.filter(d => d.status === 'pending');
    const completed = clientDocs.filter(d => d.status === 'completed');
    
    let html = '';
    
    if (pending.length > 0) {
        html += '<div class="card"><h3 style="color: #e67e22;"> Pending Documents</h3>';
        pending.forEach(d => {
            html += `<div style="padding: 15px; border-bottom: 1px solid #eee;">
                <h4>${d.template_name}</h4>
                <p>Assigned: ${new Date(d.assigned_at).toLocaleDateString()}</p>
                <p>Auth Code: <code>${d.auth_code}</code></p>
            </div>`;
        });
        html += '</div>';
    }
    
    if (completed.length > 0) {
        html += '<div class="card" style="margin-top: 20px;"><h3 style="color: #27ae60;"> Completed Documents</h3>';
        completed.forEach(d => {
            html += `<div style="padding: 15px; border-bottom: 1px solid #eee;">
                <h4>${d.template_name}</h4>
                <p>Completed: ${new Date(d.completed_at).toLocaleDateString()}</p>
            </div>`;
        });
        html += '</div>';
    }
    
    container.innerHTML = html;
}

function renderClientInvoices() {
    const container = document.getElementById('chartInvoicesContent');
    
    if (clientInvoices.length === 0) {
        container.innerHTML = '<div class="card"><p>No invoices for this client.</p></div>';
        return;
    }
    
    const html = '<div class="invoices-grid">' + clientInvoices.map(invoice => {
        const statusClass = invoice.status;
        const dueDate = new Date(invoice.due_date);
        const isOverdue = invoice.status === 'pending' && dueDate < new Date();
        const displayStatus = isOverdue ? 'overdue' : invoice.status;
        
        return `<div class="invoice-card">
                    <div class="invoice-header">
                        <span class="invoice-number">${invoice.invoice_number}</span>
                        <span class="invoice-status ${displayStatus}">${displayStatus.toUpperCase()}</span>
                    </div>
                    <div class="invoice-amount">$${parseFloat(invoice.total_amount).toFixed(2)}</div>
                    <div class="invoice-details">
                        <p>Due: ${new Date(invoice.due_date).toLocaleDateString()}</p>
                        <p>Created: ${new Date(invoice.created_at).toLocaleDateString()}</p>
                        ${invoice.payment_date ? `<p>Paid: ${new Date(invoice.payment_date).toLocaleDateString()}</p>` : ''}
                    </div>
                    <div class="invoice-actions">
                        <button onclick="viewInvoice(${invoice.id})" class="btn btn-small">View</button>
                        ${invoice.status === 'pending' ? 
                            `<button onclick="markPaid(${invoice.id})" class="btn btn-success btn-small">Mark Paid</button>` : 
                            ''
                        }
                    </div>
                </div>`;
    }).join('') + '</div>';
    
    container.innerHTML = html;
}

function generateSuperbill() {
    if (!currentChartClient) {
        showNotification('No client selected', 'error');
        return;
    }
    
    // Get all invoices for this client
    const clientInvoices = invoices.filter(inv => inv.client_id === currentChartClient.id && inv.status === 'paid');
    
    if (clientInvoices.length === 0) {
        showNotification('No paid invoices found for this client', 'warning');
        return;
    }
    
    // Get billing settings
    const billingSettings = loadFromStorage('clinicianBillingSettings', {});
    const practiceInfo = billingSettings.practiceInfo || {};
    
    // Get month/year for superbill
    const modal = document.createElement('div');
    modal.className = 'modal';
    modal.style.display = 'block';
    modal.innerHTML = `
        <div class="modal-content" style="max-width: 500px;">
            <span class="close" onclick="this.parentElement.parentElement.remove()">&times;</span>
            <h2>Generate Superbill</h2>
            <div class="form-group">
                <label for="superbillMonth">Month:</label>
                <input type="month" id="superbillMonth" class="input" value="${new Date().toISOString().slice(0, 7)}">
            </div>
            <button onclick="createSuperbill('${currentChartClient.id}')" class="btn btn-primary">Generate Superbill</button>
            <button onclick="this.parentElement.parentElement.remove()" class="btn btn-secondary">Cancel</button>
        </div>
    `;
    document.body.appendChild(modal);
}

function createSuperbill(clientId) {
    const monthYear = document.getElementById('superbillMonth').value;
    const [year, month] = monthYear.split('-');
    
    const client = clients.find(c => c.id === clientId);
    if (!client) {
        showNotification('Client not found', 'error');
        return;
    }
    
    // Get invoices for this month
    const monthInvoices = invoices.filter(inv => {
        if (inv.client_id !== clientId || inv.status !== 'paid') return false;
        const invDate = new Date(inv.created_at);
        return invDate.getFullYear() == year && invDate.getMonth() == month - 1;
    });
    
    if (monthInvoices.length === 0) {
        showNotification('No paid invoices found for this month', 'warning');
        return;
    }
    
    // Get billing settings
    const billingSettings = loadFromStorage('clinicianBillingSettings', {});
    const practiceInfo = billingSettings.practiceInfo || {};
    
    // Build superbill content
    let superbillHTML = `
        <!DOCTYPE html>
        <html>
        <head>
            <title>Superbill - ${client.name} - ${monthYear}</title>
            <style>
                body { font-family: Arial, sans-serif; margin: 20px; }
                .header { text-align: center; margin-bottom: 30px; border-bottom: 2px solid #00a86b; padding-bottom: 20px; }
                .provider-info, .patient-info { margin-bottom: 20px; }
                .info-row { margin: 5px 0; }
                .label { font-weight: bold; display: inline-block; width: 150px; }
                table { width: 100%; border-collapse: collapse; margin: 20px 0; }
                th, td { border: 1px solid #ddd; padding: 10px; text-align: left; }
                th { background-color: #00a86b; color: white; }
                .total { text-align: right; font-weight: bold; font-size: 16px; margin-top: 20px; }
                @media print { body { margin: 0; } .no-print { display: none; } }
            </style>
        </head>
        <body>
            <div class="header">
                <h1>SUPERBILL</h1>
                <p>Statement Period: ${new Date(year, month - 1, 1).toLocaleDateString('en-US', { month: 'long', year: 'numeric' })}</p>
            </div>
            
            <div class="provider-info">
                <h3>Provider Information</h3>
                <div class="info-row"><span class="label">Name:</span> ${practiceInfo.businessName || 'Your Practice'}</div>
                <div class="info-row"><span class="label">NPI:</span> ${practiceInfo.npi || 'N/A'}</div>
                <div class="info-row"><span class="label">Tax ID:</span> ${practiceInfo.taxId || 'N/A'}</div>
                <div class="info-row"><span class="label">Address:</span> ${practiceInfo.address || 'N/A'}</div>
                <div class="info-row"><span class="label">Phone:</span> ${practiceInfo.phone || 'N/A'}</div>
            </div>
            
            <div class="patient-info">
                <h3>Patient Information</h3>
                <div class="info-row"><span class="label">Name:</span> ${client.name}</div>
                <div class="info-row"><span class="label">DOB:</span> ${client.dob ? new Date(client.dob).toLocaleDateString() : 'N/A'}</div>
                <div class="info-row"><span class="label">Address:</span> ${client.address || 'N/A'}</div>
            </div>
            
            <h3>Services Rendered</h3>
            <table>
                <thead>
                    <tr>
                        <th>Date of Service</th>
                        <th>CPT Code</th>
                        <th>Description</th>
                        <th>Charges</th>
                    </tr>
                </thead>
                <tbody>
    `;
    
    let totalCharges = 0;
    monthInvoices.forEach(invoice => {
        invoice.services.forEach(service => {
            const serviceDate = new Date(invoice.created_at).toLocaleDateString();
            superbillHTML += `
                <tr>
                    <td>${serviceDate}</td>
                    <td>${service.cpt_code || 'N/A'}</td>
                    <td>${service.description}</td>
                    <td>$${service.amount.toFixed(2)}</td>
                </tr>
            `;
            totalCharges += service.amount;
        });
    });
    
    superbillHTML += `
                </tbody>
            </table>
            
            <div class="total">
                <p>Total Charges: $${totalCharges.toFixed(2)}</p>
            </div>
            
            <div style="margin-top: 40px; font-size: 12px; color: #666;">
                <p><strong>Diagnosis Codes:</strong> [Enter ICD-10 codes as needed]</p>
                <p><strong>Notes:</strong> This is a summary of services provided. Please submit to your insurance provider for reimbursement.</p>
            </div>
            
            <div class="no-print" style="margin-top: 30px; text-align: center;">
                <button onclick="window.print()" style="padding: 10px 20px; font-size: 16px; background: #00a86b; color: white; border: none; border-radius: 5px; cursor: pointer;">Print Superbill</button>
                <button onclick="window.close()" style="padding: 10px 20px; font-size: 16px; background: #6c757d; color: white; border: none; border-radius: 5px; cursor: pointer; margin-left: 10px;">Close</button>
            </div>
        </body>
        </html>
    `;
    
    // Open superbill in new window
    const printWindow = window.open('', '_blank');
    printWindow.document.write(superbillHTML);
    printWindow.document.close();
    
    // Close modal
    document.querySelector('.modal').remove();
    
    logLocalAudit('generate_superbill', { clientId, clientName: client.name, monthYear, totalCharges });
}

async function renderClientBilling() {
    const container = document.getElementById('chartBillingContent');
    
    if (!currentChartClient) {
        container.innerHTML = '<div class="card"><p>No client selected</p></div>';
        return;
    }
    
    // Load payment methods for this client
    await loadPaymentMethods(currentChartClient.id);
    
    let html = '<div class="card">';
    html += '<h3>Payment Methods</h3>';
    
    if (paymentMethods.length === 0) {
        html += '<p style="color: #6c757d; margin: 20px 0;">No saved payment methods. Payment methods will be saved when you pay an invoice.</p>';
    } else {
        html += '<div style="margin: 20px 0;">';
        paymentMethods.forEach(pm => {
            html += `
                <div class="payment-method-card" style="padding: 15px; border: 1px solid #e9ecef; border-radius: 8px; margin-bottom: 15px; background: white;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div style="display: flex; align-items: center; gap: 15px;">
                            <div style="font-size: 32px;">${getCardBrandIcon(pm.brand)}</div>
                            <div>
                                <div style="font-weight: 600; font-size: 16px;">   ${pm.last4}</div>
                                <div style="font-size: 14px; color: #6c757d;">
                                    ${pm.brand ? pm.brand.toUpperCase() : 'Card'} 
                                    ${pm.expiry_month && pm.expiry_year ? ` Expires ${pm.expiry_month}/${pm.expiry_year}` : ''}
                                </div>
                                ${pm.is_default ? '<span style="background: #00a86b; color: white; padding: 2px 8px; border-radius: 4px; font-size: 11px; margin-top: 5px; display: inline-block;">DEFAULT</span>' : ''}
                                ${pm.is_autopay_enabled ? '<span style="background: #007bff; color: white; padding: 2px 8px; border-radius: 4px; font-size: 11px; margin-top: 5px; display: inline-block; margin-left: 5px;">AUTOPAY</span>' : ''}
                            </div>
                        </div>
                        <div style="display: flex; gap: 10px;">
                            ${!pm.is_default ? `
                                <button onclick="setDefaultPaymentMethod(${pm.id})" class="btn btn-small" title="Set as default">
                                    Set Default
                                </button>
                            ` : ''}
                            <button onclick="toggleAutopay(${pm.id}, ${!pm.is_autopay_enabled})" class="btn btn-small ${pm.is_autopay_enabled ? 'btn-secondary' : 'btn-primary'}" title="${pm.is_autopay_enabled ? 'Disable' : 'Enable'} autopay">
                                ${pm.is_autopay_enabled ? 'Disable Autopay' : 'Enable Autopay'}
                            </button>
                            <button onclick="removePaymentMethod(${pm.id})" class="btn btn-danger btn-small" title="Remove payment method">
                                Remove
                            </button>
                        </div>
                    </div>
                </div>
            `;
        });
        html += '</div>';
    }
    
    html += '</div>';
    
    // Autopay Settings
    html += '<div class="card" style="margin-top: 20px;">';
    html += '<h3>Autopay Settings</h3>';
    html += `
        <div style="margin: 20px 0;">
            <label style="display: flex; align-items: center; cursor: pointer; padding: 15px; border: 1px solid #e9ecef; border-radius: 8px;">
                <input type="checkbox" id="client-autopay-enabled" ${currentChartClient.autopay_enabled ? 'checked' : ''} onchange="updateClientAutopay()" style="margin-right: 15px; width: 20px; height: 20px;">
                <div>
                    <div style="font-weight: 600; font-size: 16px;">Enable Autopay</div>
                    <div style="font-size: 14px; color: #6c757d; margin-top: 5px;">
                        Automatically charge the default payment method when invoices are created
                    </div>
                </div>
            </label>
        </div>
        
        <div style="padding: 15px; background: #f8f9fa; border-radius: 8px; margin-top: 15px;">
            <h4 style="margin: 0 0 10px 0; font-size: 14px;"> How Autopay Works</h4>
            <ul style="margin: 0; padding-left: 20px; color: #6c757d; font-size: 14px;">
                <li>When a new invoice is created, it will be automatically charged</li>
                <li>Uses your default payment method</li>
                <li>You'll receive a notification after each payment</li>
                <li>Can be disabled at any time</li>
            </ul>
        </div>
    `;
    html += '</div>';
    
    container.innerHTML = html;
}

async function setDefaultPaymentMethod(pmId) {
    try {
        const response = await fetch('/api/payment-methods', {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                payment_method_id: pmId,
                is_default: true
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            showNotification('Default payment method updated', 'success');
            renderClientBilling();
        } else {
            showNotification('Failed to update default payment method', 'error');
        }
    } catch (error) {
        console.error('Error setting default payment method:', error);
        showNotification('Error updating payment method', 'error');
    }
}

async function toggleAutopay(pmId, enable) {
    try {
        const response = await fetch('/api/payment-methods', {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                payment_method_id: pmId,
                is_autopay_enabled: enable
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            showNotification(enable ? 'Autopay enabled' : 'Autopay disabled', 'success');
            renderClientBilling();
        } else {
            showNotification('Failed to update autopay settings', 'error');
        }
    } catch (error) {
        console.error('Error toggling autopay:', error);
        showNotification('Error updating autopay', 'error');
    }
}

async function removePaymentMethod(pmId) {
    if (!confirm('Are you sure you want to remove this payment method?')) {
        return;
    }
    
    try {
        const response = await fetch(`/api/payment-methods?payment_method_id=${pmId}`, {
            method: 'DELETE'
        });
        
        const result = await response.json();
        
        if (result.success) {
            showNotification('Payment method removed', 'success');
            renderClientBilling();
        } else {
            showNotification('Failed to remove payment method', 'error');
        }
    } catch (error) {
        console.error('Error removing payment method:', error);
        showNotification('Error removing payment method', 'error');
    }
}

async function updateClientAutopay() {
    const enabled = document.getElementById('client-autopay-enabled').checked;
    
    try {
        // Update client in localStorage
        currentChartClient.autopay_enabled = enabled;
        const clientIndex = clients.findIndex(c => c.id === currentChartClient.id);
        if (clientIndex !== -1) {
            clients[clientIndex].autopay_enabled = enabled;
            saveToStorage('clients', clients);
        }
        
        showNotification(enabled ? 'Autopay enabled for this client' : 'Autopay disabled for this client', 'success');
        
        // In production, this would also update the database via API
        // await fetch(`/api/clients/${currentChartClient.id}`, {
        //     method: 'PUT',
        //     body: JSON.stringify({ autopay_enabled: enabled })
        // });
        
    } catch (error) {
        console.error('Error updating client autopay:', error);
        showNotification('Error updating autopay settings', 'error');
    }
}

async function renderClientNotes() {
    const container = document.getElementById('chartNotesContent');

    if (!currentChartClient) {
        container.innerHTML = '<div class="card"><p>No client selected</p></div>';
        return;
    }

    container.innerHTML = '<div class="card"><p>Loading notes...</p></div>';

    try {
        // Fetch clinical notes for this client
        const response = await fetch(`/api/clinical-notes?client_id=${currentChartClient.id}`);
        const data = await response.json();

        if (!response.ok) {
            throw new Error(data.error || 'Failed to load notes');
        }

        const notes = data.data || [];

        if (notes.length === 0) {
            container.innerHTML = '<div class="card"><p>No clinical notes for this client yet.</p></div>';
            return;
        }

        // Sort notes by date (newest first)
        notes.sort((a, b) => new Date(b.session_date || b.created_at) - new Date(a.session_date || a.created_at));

        let html = '<div class="card">';
        html += '<h3>Clinical Notes</h3>';
        html += '<div style="margin-top: 20px;">';

        notes.forEach(note => {
            const sessionDate = note.session_date ? new Date(note.session_date).toLocaleDateString() : 'N/A';
            const createdDate = new Date(note.created_at).toLocaleDateString();
            const noteFormat = note.note_format ? note.note_format.toUpperCase() : 'Note';
            const sessionType = note.session_type || 'Session';
            const duration = note.duration_seconds ? Math.floor(note.duration_seconds / 60) + ' min' : '';
            const signedBadge = note.is_signed ? '<span style="background: #00a86b; color: white; padding: 2px 8px; border-radius: 4px; font-size: 11px; margin-left: 8px;">SIGNED</span>' : '';
            const lockedBadge = note.is_locked ? '<span style="background: #dc3545; color: white; padding: 2px 8px; border-radius: 4px; font-size: 11px; margin-left: 8px;">LOCKED</span>' : '';

            html += `
                <div class="note-card" style="padding: 15px; border: 1px solid #e9ecef; border-radius: 8px; margin-bottom: 15px; background: white;">
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                        <div>
                            <div style="font-weight: 600; font-size: 16px;">
                                ${noteFormat} - ${sessionType}
                                ${signedBadge}
                                ${lockedBadge}
                            </div>
                            <div style="font-size: 14px; color: #6c757d; margin-top: 5px;">
                                Session Date: ${sessionDate} ${duration ? ' Duration: ' + duration : ''}
                            </div>
                            <div style="font-size: 12px; color: #9ca3af; margin-top: 3px;">
                                Created: ${createdDate}
                                ${note.is_signed && note.signed_at ? ' Signed: ' + new Date(note.signed_at).toLocaleDateString() : ''}
                            </div>
                        </div>
                        <button onclick="viewClinicalNote(${note.id})" class="btn btn-small btn-primary">View</button>
                    </div>
                    ${note.clinical_note ? `
                        <div style="max-height: 100px; overflow: hidden; color: #6c757d; font-size: 14px; margin-top: 10px; padding: 10px; background: #f8f9fa; border-radius: 4px;">
                            ${note.clinical_note.substring(0, 200)}${note.clinical_note.length > 200 ? '...' : ''}
                        </div>
                    ` : ''}
                </div>
            `;
        });

        html += '</div></div>';
        container.innerHTML = html;

    } catch (error) {
        console.error('Error loading clinical notes:', error);
        container.innerHTML = `<div class="card"><p style="color: #dc3545;">Error loading notes: ${error.message}</p></div>`;
    }
}

// View full clinical note
function viewClinicalNote(noteId) {
    // Create modal to view full note
    const modal = document.createElement('div');
    modal.className = 'modal';
    modal.style.display = 'block';
    modal.id = 'viewNoteModal';

    // Fetch the note details
    fetch(`/api/clinical-notes?id=${noteId}`)
        .then(response => response.json())
        .then(data => {
            const note = data.data;
            const sessionDate = note.session_date ? new Date(note.session_date).toLocaleDateString() : 'N/A';
            const noteFormat = note.note_format ? note.note_format.toUpperCase() : 'Clinical Note';
            const sessionType = note.session_type || 'Session';

            modal.innerHTML = `
                <div class="modal-content" style="max-width: 800px;">
                    <span class="close" onclick="document.getElementById('viewNoteModal').remove()">&times;</span>
                    <h2>${noteFormat} - ${sessionType}</h2>
                    <div style="color: #6c757d; margin-bottom: 20px;">
                        Session Date: ${sessionDate}<br>
                        Created: ${new Date(note.created_at).toLocaleDateString()}
                        ${note.is_signed ? '<br><strong style="color: #00a86b;"> Signed on ' + new Date(note.signed_at).toLocaleDateString() + '</strong>' : ''}
                        ${note.is_locked ? '<br><strong style="color: #dc3545;"> Locked - Cannot be edited</strong>' : ''}
                    </div>

                    ${note.transcript ? `
                        <div class="card" style="margin-bottom: 20px;">
                            <h3>Transcript</h3>
                            <div style="max-height: 200px; overflow-y: auto; padding: 10px; background: #f8f9fa; border-radius: 4px; white-space: pre-wrap;">
                                ${note.transcript}
                            </div>
                        </div>
                    ` : ''}

                    <div class="card">
                        <h3>Clinical Note</h3>
                        <div style="white-space: pre-wrap; padding: 10px; background: #f8f9fa; border-radius: 4px;">
                            ${note.clinical_note || 'No note content'}
                        </div>
                    </div>

                    <div style="margin-top: 20px; display: flex; gap: 10px; justify-content: flex-end;">
                        <button onclick="document.getElementById('viewNoteModal').remove()" class="btn btn-secondary">Close</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        })
        .catch(error => {
            console.error('Error loading note:', error);
            alert('Error loading note: ' + error.message);
            modal.remove();
        });
}


// Quick actions from chart
function scheduleFromChart() {
    if (!currentChartClient) return;
    closeModal('clientChartModal');
    openNewAppointment();
    document.getElementById('appointmentClient').value = currentChartClient.id;
}

function assignDocFromChart() {
    if (!currentChartClient) return;
    closeModal('clientChartModal');
    openAssignDoc();
    document.getElementById('assignClient').value = currentChartClient.id;
}

// Enhanced Document Assignment Functions
function toggleAssignMode() {
    const singleMode = document.querySelector('input[name="assignMode"][value="single"]').checked;
    const singleSection = document.getElementById('singleClientSection');
    const bulkSection = document.getElementById('bulkClientSection');
    const bulkBtn = document.getElementById('bulkAssignBtn');
    
    if (singleMode) {
        singleSection.style.display = 'block';
        bulkSection.style.display = 'none';
        bulkBtn.style.display = 'none';
    } else {
        singleSection.style.display = 'none';
        bulkSection.style.display = 'block';
        bulkBtn.style.display = 'inline-block';
        populateClientCheckboxes();
    }
}

function populateClientCheckboxes() {
    const container = document.getElementById('clientCheckboxContainer');
    container.innerHTML = clients.map(c => `
        <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
            <input type="checkbox" class="client-checkbox" value="${c.id}">
            <span>${c.name} (${c.email})</span>
        </label>
    `).join('');
}

function selectAllClients() {
    document.querySelectorAll('.client-checkbox').forEach(cb => cb.checked = true);
}

function deselectAllClients() {
    document.querySelectorAll('.client-checkbox').forEach(cb => cb.checked = false);
}

function openBulkAssignModal() {
    const selectedClients = Array.from(document.querySelectorAll('.client-checkbox:checked')).map(cb => parseInt(cb.value));
    const selectedTemplates = Array.from(document.querySelectorAll('.doc-checkbox:checked')).map(cb => cb.value);
    
    if (selectedClients.length === 0) {
        alert('Please select at least one client');
        return;
    }
    
    if (selectedTemplates.length === 0) {
        alert('Please select at least one document template');
        return;
    }
    
    const expirationDays = parseInt(document.getElementById('expirationDays').value) || 30;
    
    if (confirm(`Assign ${selectedTemplates.length} document(s) to ${selectedClients.length} client(s)? This will create ${selectedClients.length * selectedTemplates.length} total document assignments.`)) {
        const bulkDocs = bulkAssignDocuments(selectedClients, selectedTemplates, expirationDays);
        
        // Show success modal with summary
        const modal = document.createElement('div');
        modal.className = 'modal';
        modal.style.display = 'block';
        modal.innerHTML = `
            <div class="modal-content">
                <span class="close" onclick="this.parentElement.parentElement.remove()">&times;</span>
                <h2>Bulk Assignment Complete!</h2>
                <div style="background: rgba(15, 76, 129, 0.1); padding: 20px; border-radius: 16px; margin: 20px 0; border: 1px solid #D6DCE4;">
                    <h3 style="color: #0F4C81;">Assignment Summary:</h3>
                    <p><strong>Clients:</strong> ${selectedClients.length}</p>
                    <p><strong>Templates:</strong> ${selectedTemplates.length}</p>
                    <p><strong>Total Documents:</strong> ${bulkDocs.length}</p>
                    <p><strong>Expiration:</strong> ${expirationDays} days</p>
                </div>
                <div style="margin: 20px 0;">
                    <p><strong>Generated Auth Codes:</strong></p>
                    <div style="max-height: 200px; overflow-y: auto; border: 1px solid #ddd; padding: 10px; background: #f8f9fa;">
                        ${bulkDocs.map(doc => `
                            <div style="margin-bottom: 5px;">
                                <strong>${doc.client_name}:</strong> ${doc.auth_code}
                            </div>
                        `).join('')}
                    </div>
                </div>
                <button onclick="this.parentElement.parentElement.remove()" class="btn btn-primary">Close</button>
            </div>
        `;
        document.body.appendChild(modal);
        
        closeModal('assignDocModal');
        renderDocs();
        updateDocBadge();
    }
}

function createInvoiceFromChart() {
    if (!currentChartClient) return;
    // Store the client ID to reopen chart after invoice creation
    window.pendingInvoiceClientId = currentChartClient.id;
    closeModal('clientChartModal');
    openNewInvoice();
    document.getElementById('invoiceClient').value = currentChartClient.id;
}

function openEditClientFromChart() {
    if (!currentChartClient) return;
    closeModal('clientChartModal');
    openEditClient(currentChartClient.id);
}

function renderDocs() {
    const container = document.getElementById('docsList');

    // Load documents from localStorage if not already loaded
    if (assignedDocs.length === 0) {
        assignedDocs = loadFromStorage('assigned_docs') || [];
    }

    // Load templates if not already loaded
    if (Object.keys(documentTemplates).length === 0) {
        const templates = loadFromStorage('templates', {});
        documentTemplates = templates;
        Object.keys(templates).forEach(id => {
            templateNames[id] = templates[id].name;
        });
    }

    let html = '';

    // Section 1: Clinical Document Templates
    html += '<div class="card" style="margin-bottom: 20px;"><h3 style="color: #00b4a6;"> Clinical Document Templates</h3>';
    html += '<p style="color: #666; font-size: 14px; margin-bottom: 15px;">All available clinical documents that can be shared with clients</p>';

    if (Object.keys(documentTemplates).length > 0) {
        html += '<div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 15px;">';

        Object.keys(documentTemplates).sort((a, b) => parseInt(a) - parseInt(b)).forEach(id => {
            const template = documentTemplates[id];
            const assignedCount = assignedDocs.filter(d => d.template_id === id).length;

            html += `
                <div style="border: 1px solid #e0e0e0; border-radius: 8px; padding: 15px; background: #fafafa; transition: box-shadow 0.2s;"
                     onmouseover="this.style.boxShadow='0 4px 8px rgba(0,0,0,0.1)'"
                     onmouseout="this.style.boxShadow='none'">
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                        <h4 style="margin: 0; color: #2c3e50; font-size: 16px; flex: 1;">${template.name}</h4>
                        ${assignedCount > 0 ? `<span style="background: #00b4a6; color: white; padding: 2px 8px; border-radius: 12px; font-size: 12px; margin-left: 10px;">${assignedCount}</span>` : ''}
                    </div>
                    <p style="color: #666; font-size: 13px; margin: 8px 0;">Template ID: ${id}</p>
                    <button onclick="quickAssignDoc('${id}')" class="btn btn-secondary" style="font-size: 13px; padding: 6px 12px; width: 100%; margin-top: 10px;">
                         Assign to Client
                    </button>
                </div>
            `;
        });

        html += '</div>';
    } else {
        html += '<p style="color: #999;">No templates available. Templates will be initialized on next page load.</p>';
    }

    html += '</div>';

    // Section 2: Assigned Documents
    const pending = assignedDocs.filter(d => d.status === 'pending');
    const completed = assignedDocs.filter(d => d.status === 'completed');

    if (pending.length > 0 || completed.length > 0) {
        if (pending.length > 0) {
            html += '<div class="card" style="margin-bottom: 20px;"><h3 style="color: #e67e22;"> Pending Assignments (' + pending.length + ')</h3>';
            html += '<table style="width: 100%; margin-top: 15px;"><thead><tr><th style="text-align: left;">Document</th><th style="text-align: left;">Client</th><th style="text-align: left;">Access Code</th><th style="text-align: left;">Expires</th><th style="text-align: left;">Assigned</th><th style="text-align: left;">Actions</th></tr></thead><tbody>';
            pending.forEach(d => {
                const assignedDate = d.assigned_at ? new Date(d.assigned_at).toLocaleDateString() : 'N/A';
                const expiresDate = d.expiration_date || d.access_code_expires_at;
                let expiresText = 'Never';
                let expiresColor = '#666';

                if (expiresDate) {
                    const expiresAt = new Date(expiresDate);
                    const now = new Date();
                    const daysLeft = Math.ceil((expiresAt - now) / (1000 * 60 * 60 * 24));

                    if (daysLeft < 0) {
                        expiresText = ' Expired';
                        expiresColor = '#e74c3c';
                    } else if (daysLeft <= 7) {
                        expiresText = `${daysLeft} days`;
                        expiresColor = '#e67e22';
                    } else {
                        expiresText = `${daysLeft} days`;
                        expiresColor = '#27ae60';
                    }
                }

                html += `<tr>
                    <td>${d.template_name}</td>
                    <td>${d.client_name}</td>
                    <td>
                        <code style="background: #f0f0f0; padding: 4px 8px; border-radius: 4px; font-family: monospace; user-select: all;" id="code-${d.id}">${d.auth_code}</code>
                    </td>
                    <td style="color: ${expiresColor}; font-size: 13px;">${expiresText}</td>
                    <td style="color: #666; font-size: 13px;">${assignedDate}</td>
                    <td style="white-space: nowrap;">
                        <button onclick="copyAuthCode('${d.auth_code}')" class="btn btn-secondary" style="font-size: 12px; padding: 4px 10px; margin-right: 5px;" title="Copy code to clipboard">
                            Copy
                        </button>
                        <button onclick="resendAuthCode('${d.id}', '${d.auth_code}', '${d.client_name}')" class="btn btn-secondary" style="font-size: 12px; padding: 4px 10px;" title="Resend code to client">
                             Resend
                        </button>
                    </td>
                </tr>`;
            });
            html += '</tbody></table></div>';
        }

        if (completed.length > 0) {
            html += '<div class="card"><h3 style="color: #27ae60;"> Completed Documents (' + completed.length + ')</h3>';
            html += '<table style="width: 100%; margin-top: 15px;"><thead><tr><th style="text-align: left;">Document</th><th style="text-align: left;">Client</th><th style="text-align: left;">Completed</th></tr></thead><tbody>';
            completed.forEach(d => {
                const completedDate = d.completed_at ? new Date(d.completed_at).toLocaleDateString() : 'N/A';
                html += `<tr>
                    <td>${d.template_name}</td>
                    <td>${d.client_name}</td>
                    <td style="color: #27ae60;">${completedDate}</td>
                </tr>`;
            });
            html += '</tbody></table></div>';
        }
    } else {
        html += '<div class="card"><h3 style="color: #95a5a6;"> Assigned Documents</h3><p style="color: #999; margin-top: 10px;">No documents have been assigned yet. Use the "Assign to Client" button on any template above to get started.</p></div>';
    }

    container.innerHTML = html;
}

function quickAssignDoc(templateId) {
    // Open the assignment modal with the specified template pre-selected
    openAssignDoc();

    // Pre-select the specified template after a small delay to ensure the modal is rendered
    setTimeout(() => {
        const checkbox = document.querySelector(`.doc-checkbox[value="${templateId}"]`);
        if (checkbox) {
            checkbox.checked = true;
            updateSelectedCount();
        }
    }, 100);
}

function openAssignDoc() {
    const select = document.getElementById('assignClient');
    select.innerHTML = '<option value="">Select Client</option>' + 
        clients.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
    
    const container = document.getElementById('templateCheckboxContainer');
    container.innerHTML = Object.keys(documentTemplates).map(id => {
        const t = documentTemplates[id];
        return `<label style="display: block; margin-bottom: 10px; cursor: pointer; padding: 8px; border-radius: 4px; transition: background 0.2s;" onmouseover="this.style.background='#e8f4f8'" onmouseout="this.style.background='transparent'">
            <input type="checkbox" value="${id}" class="doc-checkbox" style="margin-right: 8px;" onchange="updateSelectedCount()">
            <span style="font-weight: 500;">${t.name}</span>
        </label>`;
    }).join('');
    
    updateSelectedCount();
    document.getElementById('assignDocModal').style.display = 'block';
}

function selectAllDocs() {
    document.querySelectorAll('.doc-checkbox').forEach(cb => cb.checked = true);
    updateSelectedCount();
}

function deselectAllDocs() {
    document.querySelectorAll('.doc-checkbox').forEach(cb => cb.checked = false);
    updateSelectedCount();
}

function updateSelectedCount() {
    const count = document.querySelectorAll('.doc-checkbox:checked').length;
    const countEl = document.getElementById('selectedCount');
    if (count === 0) {
        countEl.textContent = 'No documents selected';
        countEl.style.color = '#999';
    } else {
        countEl.textContent = ` ${count} document${count > 1 ? 's' : ''} selected`;
        countEl.style.color = '#E85D4F';
    }
}

async function saveAssignDoc() {
    const clientId = document.getElementById('assignClient').value;
    const selected = Array.from(document.querySelectorAll('.doc-checkbox:checked')).map(cb => cb.value);

    if (!clientId || selected.length === 0) {
        return alert('Please select client and documents');
    }

    const code = generateAuthCode();
    const client = clients.find(c => c.id == clientId);
    const clientName = client ? client.name : 'Unknown Client';

    // Set expiration to 30 days from now
    const expiresAt = new Date();
    expiresAt.setDate(expiresAt.getDate() + 30);

    try {
        const created = [];
        for (const templateId of selected) {
            const doc = {
                id: Date.now() + Math.random(),
                client_id: clientId,
                client_name: clientName,
                template_id: templateId,
                template_name: templateNames[templateId],
                auth_code: code,
                status: 'pending',
                assigned_at: new Date().toISOString(),
                expiration_date: expiresAt.toISOString(),
                access_code_expires_at: expiresAt.toISOString()
            };
            assignedDocs.push(doc);
            created.push(templateNames[templateId]);
            await logAudit('assign_document', { id: doc.id, code, expires: expiresAt.toISOString() });
        }

        // Save to localStorage
        saveToStorage('assigned_docs', assignedDocs);

        closeModal('assignDocModal');
        document.getElementById('generatedCode').textContent = code;
        document.getElementById('assignedDocsList').innerHTML = '<p><strong>Assigned:</strong></p><ul>' +
            created.map(name => `<li>${name}</li>`).join('') +
            `</ul><p style="margin-top: 10px; color: #e67e22; font-size: 14px;"> <strong>Expires:</strong> ${expiresAt.toLocaleDateString()} (30 days)</p>`;
        document.getElementById('successModal').style.display = 'block';
        renderDocs();
        updateDocBadge();
    } catch (error) {
        alert('Error: ' + error.message);
    }
}

function generateAuthCode() {
    // Use cryptographically secure random number generation
    const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
    const array = new Uint8Array(12); // 12 characters for better security
    crypto.getRandomValues(array);

    let code = '';
    // First part: 4 characters
    for (let i = 0; i < 4; i++) {
        code += chars[array[i] % chars.length];
    }
    code += '-';
    // Second part: 8 characters
    for (let i = 4; i < 12; i++) {
        code += chars[array[i] % chars.length];
    }

    // Log the generated code for debugging (remove in production)
    console.log('Generated secure auth code:', code);

    return code;
}

async function copyAuthCode(code) {
    try {
        await navigator.clipboard.writeText(code);
        showNotification(' Access code copied to clipboard: ' + code, 'success');
    } catch (error) {
        // Fallback for older browsers
        const textArea = document.createElement('textarea');
        textArea.value = code;
        textArea.style.position = 'fixed';
        textArea.style.left = '-999999px';
        document.body.appendChild(textArea);
        textArea.select();
        try {
            document.execCommand('copy');
            showNotification(' Access code copied to clipboard: ' + code, 'success');
        } catch (err) {
            showNotification('Failed to copy code. Please copy manually: ' + code, 'error');
        }
        document.body.removeChild(textArea);
    }
}

async function resendAuthCode(docId, code, clientName) {
    try {
        // Find the document
        const doc = assignedDocs.find(d => d.id == docId);
        if (!doc) {
            showNotification('Document not found', 'error');
            return;
        }

        // Find the client
        const client = clients.find(c => c.id == doc.client_id);
        if (!client) {
            showNotification('Client not found', 'error');
            return;
        }

        // Check if client has email or phone
        if (!client.email && !client.phone) {
            showNotification('Client has no email or phone number on file. Please copy the code and send it manually.', 'error');
            return;
        }

        // Show confirmation
        const confirmMsg = client.email
            ? `Send access code to ${clientName} via email (${client.email})?`
            : `Send access code to ${clientName} via SMS (${client.phone})?`;

        if (!confirm(confirmMsg)) {
            return;
        }

        // In production, this would call an API to send the notification
        // For now, we'll just show a success message
        await logAudit('resend_auth_code', { docId, code, clientName, email: client.email, phone: client.phone });

        if (client.email) {
            showNotification(` Access code sent to ${clientName} at ${client.email}`, 'success');
        } else if (client.phone) {
            showNotification(` Access code sent to ${clientName} at ${client.phone}`, 'success');
        }

        // TODO: In production, call the notifications API:
        // await fetch('/api/notifications', {
        //     method: 'POST',
        //     headers: { 'Content-Type': 'application/json' },
        //     body: JSON.stringify({
        //         type: 'document_assigned',
        //         recipient: client.email || client.phone,
        //         data: { code, clientName, templateName: doc.template_name }
        //     })
        // });

    } catch (error) {
        console.error('Resend error:', error);
        showNotification('Error sending code: ' + error.message, 'error');
    }
}

async function renderAudit() {
    try {
        // Load audit logs from localStorage - FIX: use correct key 'audit_logs'
        const logs = loadFromStorage('audit_logs', []) || [];
        const container = document.getElementById('auditList');
        
        if (logs.length === 0) {
            container.innerHTML = '<div class="card"><p>No audit logs found</p></div>';
            return;
        }
        
        // Sort by timestamp, newest first
        logs.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
        
        container.innerHTML = '<div class="card"><table style="width: 100%;"><thead><tr><th>Time</th><th>User</th><th>Action</th><th>Details</th></tr></thead><tbody>' +
            logs.map(l => `<tr><td>${new Date(l.timestamp).toLocaleString()}</td><td>${l.user_name || 'System'}</td><td>${l.action}</td><td>${JSON.stringify(l.details || {})}</td></tr>`).join('') +
            '</tbody></table></div>';
    } catch (error) {
        console.error('Audit error:', error);
        document.getElementById('auditList').innerHTML = '<div class="card"><p>Error loading audit logs</p></div>';
    }
}

async function logAudit(action, details = {}, userName = null) {
    try {
        // Save audit log to localStorage
        logLocalAudit(action, details, userName || currentUser?.name);
    } catch (error) {
        console.error('Log error:', error);
    }
}

function closeModal(id) {
    document.getElementById(id).style.display = 'none';
}

// New Features JavaScript
let analyticsData = {};
let currentCalendarDate = new Date();
let calendarViewMode = 'month'; // month, week, day

// Analytics Dashboard
async function loadAnalytics() {
    const timeframe = document.getElementById('timeframeSelect').value;
    try {
        document.getElementById('analyticsContent').innerHTML = '<div class="loading">Loading analytics...</div>';
        
        // Generate comprehensive analytics from localStorage data
        const data = generateComprehensiveAnalytics(timeframe);
        analyticsData = data;
        renderAnalytics(data);
    } catch (error) {
        console.error('Analytics error:', error);
        document.getElementById('analyticsContent').innerHTML = '<div class="card"><p>Error loading analytics</p></div>';
    }
}

function generateComprehensiveAnalytics(timeframe) {
    const now = new Date();
    const daysAgo = parseInt(timeframe);
    const startDate = new Date(now.getTime() - (daysAgo * 24 * 60 * 60 * 1000));
    
    // Filter data by timeframe
    const recentAppointments = appointments.filter(apt => {
        const aptDate = new Date(apt.appointment_date);
        return aptDate >= startDate;
    });
    
    const recentInvoices = invoices.filter(inv => {
        const invDate = new Date(inv.created_at);
        return invDate >= startDate;
    });
    
    // Overview statistics
    const overview = {
        total_clients: clients.length,
        active_clients: clients.filter(c => c.status === 'active').length,
        upcoming_appointments: appointments.filter(apt => new Date(apt.appointment_date) >= now).length,
        pending_documents: assignedDocs.filter(doc => doc.status === 'pending').length,
        completed_documents: assignedDocs.filter(doc => doc.status === 'completed').length,
        total_revenue: invoices.reduce((sum, inv) => sum + (parseFloat(inv.total_amount) || 0), 0),
        paid_revenue: invoices.filter(inv => inv.status === 'paid').reduce((sum, inv) => sum + (parseFloat(inv.total_amount) || 0), 0),
        appointment_completion_rate: calculateAppointmentCompletionRate(),
        document_completion_rate: calculateDocumentCompletionRate()
    };
    
    // Trends data
    const trends = {
        monthly_appointments: generateMonthlyAppointmentTrends(daysAgo),
        weekly_revenue: generateWeeklyRevenueTrends(daysAgo),
        top_clients: generateTopClients(),
        appointment_types: generateAppointmentTypeBreakdown(),
        document_completion_trends: generateDocumentCompletionTrends(daysAgo),
        client_demographics: generateClientDemographics(),
        revenue_by_month: generateRevenueByMonth(daysAgo)
    };
    
    return { overview, trends, timeframe };
}

// Analytics Helper Functions
function calculateAppointmentCompletionRate() {
    const totalAppointments = appointments.length;
    if (totalAppointments === 0) return 0;
    
    const completedAppointments = appointments.filter(apt => {
        const aptDate = new Date(apt.appointment_date);
        return aptDate < new Date(); // Past appointments are considered completed
    }).length;
    
    return Math.round((completedAppointments / totalAppointments) * 100);
}

function calculateDocumentCompletionRate() {
    const totalDocs = assignedDocs.length;
    if (totalDocs === 0) return 0;
    
    const completedDocs = assignedDocs.filter(doc => doc.status === 'completed').length;
    return Math.round((completedDocs / totalDocs) * 100);
}

function generateMonthlyAppointmentTrends(daysAgo) {
    const months = [];
    const now = new Date();
    
    for (let i = 0; i < Math.ceil(daysAgo / 30); i++) {
        const monthDate = new Date(now.getFullYear(), now.getMonth() - i, 1);
        const monthAppointments = appointments.filter(apt => {
            const aptDate = new Date(apt.appointment_date);
            return aptDate.getMonth() === monthDate.getMonth() && 
                   aptDate.getFullYear() === monthDate.getFullYear();
        }).length;
        
        months.unshift({
            month: monthDate.toISOString(),
            appointment_count: monthAppointments
        });
    }
    
    return months;
}

function generateWeeklyRevenueTrends(daysAgo) {
    const weeks = [];
    const now = new Date();
    
    for (let i = 0; i < Math.ceil(daysAgo / 7); i++) {
        const weekStart = new Date(now.getTime() - (i * 7 * 24 * 60 * 60 * 1000));
        const weekEnd = new Date(weekStart.getTime() + (7 * 24 * 60 * 60 * 1000));
        
        const weekRevenue = invoices.filter(inv => {
            const invDate = new Date(inv.created_at);
            return invDate >= weekStart && invDate < weekEnd && inv.status === 'paid';
        }).reduce((sum, inv) => sum + (parseFloat(inv.total_amount) || 0), 0);
        
        weeks.unshift({
            week_start: weekStart.toISOString(),
            revenue: weekRevenue
        });
    }
    
    return weeks;
}

function generateTopClients() {
    const clientStats = {};
    
    appointments.forEach(apt => {
        if (!clientStats[apt.client_id]) {
            clientStats[apt.client_id] = {
                id: apt.client_id,
                name: apt.client_name || 'Unknown',
                appointment_count: 0,
                total_revenue: 0
            };
        }
        clientStats[apt.client_id].appointment_count++;
    });
    
    invoices.forEach(inv => {
        if (clientStats[inv.client_id]) {
            clientStats[inv.client_id].total_revenue += parseFloat(inv.total_amount) || 0;
        }
    });
    
    return Object.values(clientStats)
        .sort((a, b) => b.appointment_count - a.appointment_count)
        .slice(0, 5);
}

function generateAppointmentTypeBreakdown() {
    const types = {};
    
    appointments.forEach(apt => {
        const type = apt.notes ? apt.notes.split(' ')[0] : 'General';
        types[type] = (types[type] || 0) + 1;
    });
    
    return Object.entries(types)
        .map(([type, count]) => ({ type, count }))
        .sort((a, b) => b.count - a.count);
}

function generateDocumentCompletionTrends(daysAgo) {
    const trends = [];
    const now = new Date();
    
    for (let i = 0; i < Math.ceil(daysAgo / 7); i++) {
        const weekStart = new Date(now.getTime() - (i * 7 * 24 * 60 * 60 * 1000));
        const weekEnd = new Date(weekStart.getTime() + (7 * 24 * 60 * 60 * 1000));
        
        const weekCompleted = assignedDocs.filter(doc => {
            if (!doc.completed_at) return false;
            const completedDate = new Date(doc.completed_at);
            return completedDate >= weekStart && completedDate < weekEnd;
        }).length;
        
        trends.unshift({
            week_start: weekStart.toISOString(),
            completed_documents: weekCompleted
        });
    }
    
    return trends;
}

function generateClientDemographics() {
    const demographics = {
        by_age: { '18-25': 0, '26-35': 0, '36-45': 0, '46-55': 0, '56-65': 0, '65+': 0 },
        by_status: { active: 0, inactive: 0 },
        new_vs_returning: { new: 0, returning: 0 }
    };
    
    clients.forEach(client => {
        // Status breakdown
        demographics.by_status[client.status || 'active']++;
        
        // New vs returning (simplified logic)
        const clientAppointments = appointments.filter(apt => apt.client_id === client.id);
        if (clientAppointments.length > 1) {
            demographics.new_vs_returning.returning++;
        } else {
            demographics.new_vs_returning.new++;
        }
    });
    
    return demographics;
}

function generateRevenueByMonth(daysAgo) {
    const months = [];
    const now = new Date();
    
    for (let i = 0; i < Math.ceil(daysAgo / 30); i++) {
        const monthDate = new Date(now.getFullYear(), now.getMonth() - i, 1);
        const monthRevenue = invoices.filter(inv => {
            const invDate = new Date(inv.created_at);
            return invDate.getMonth() === monthDate.getMonth() && 
                   invDate.getFullYear() === monthDate.getFullYear() &&
                   inv.status === 'paid';
        }).reduce((sum, inv) => sum + (parseFloat(inv.total_amount) || 0), 0);
        
        months.unshift({
            month: monthDate.toISOString(),
            revenue: monthRevenue
        });
    }
    
    return months;
}

function renderAnalytics(data) {
    const { overview, trends } = data;
    
    // Update stat cards with enhanced data
    document.getElementById('totalClients').textContent = overview.total_clients;
    document.getElementById('upcomingAppointments').textContent = overview.upcoming_appointments;
    document.getElementById('pendingDocuments').textContent = overview.pending_documents;
    document.getElementById('totalRevenue').textContent = `$${overview.total_revenue.toFixed(2)}`;
    
    // Enhanced analytics display
    const analyticsContent = document.getElementById('analyticsContent');
    analyticsContent.innerHTML = `
        <div class="analytics-grid">
            <!-- Overview Stats -->
            <div class="stat-card">
                <h3>Overview</h3>
                <div class="stat-item">
                    <span class="stat-label">Total Clients:</span>
                    <span class="stat-value">${overview.total_clients}</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Active Clients:</span>
                    <span class="stat-value">${overview.active_clients}</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Appointment Completion Rate:</span>
                    <span class="stat-value">${overview.appointment_completion_rate}%</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Document Completion Rate:</span>
                    <span class="stat-value">${overview.document_completion_rate}%</span>
                </div>
            </div>
            
            <!-- Revenue Stats -->
            <div class="stat-card">
                <h3>Revenue</h3>
                <div class="stat-item">
                    <span class="stat-label">Total Revenue:</span>
                    <span class="stat-value">$${overview.total_revenue.toFixed(2)}</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Paid Revenue:</span>
                    <span class="stat-value">$${overview.paid_revenue.toFixed(2)}</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Outstanding:</span>
                    <span class="stat-value">$${(overview.total_revenue - overview.paid_revenue).toFixed(2)}</span>
                </div>
            </div>
            
            <!-- Documents Stats -->
            <div class="stat-card">
                <h3>Documents</h3>
                <div class="stat-item">
                    <span class="stat-label">Pending:</span>
                    <span class="stat-value">${overview.pending_documents}</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Completed:</span>
                    <span class="stat-value">${overview.completed_documents}</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Total:</span>
                    <span class="stat-value">${overview.pending_documents + overview.completed_documents}</span>
                </div>
            </div>
            
            <!-- Appointments Stats -->
            <div class="stat-card">
                <h3>Appointments</h3>
                <div class="stat-item">
                    <span class="stat-label">Upcoming:</span>
                    <span class="stat-value">${overview.upcoming_appointments}</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Total:</span>
                    <span class="stat-value">${appointments.length}</span>
                </div>
            </div>
        </div>
        
        <!-- Charts Section -->
        <div class="charts-section">
            <div class="chart-row">
                <!-- Monthly Appointments Chart -->
                <div class="chart-card">
                    <h3>Monthly Appointments</h3>
                    <div id="monthlyChart" class="chart-container">
                        ${renderMonthlyChart(trends.monthly_appointments)}
                    </div>
                </div>
                
                <!-- Revenue Chart -->
                <div class="chart-card">
                    <h3>Revenue Trends</h3>
                    <div id="revenueChart" class="chart-container">
                        ${renderRevenueChart(trends.revenue_by_month)}
                    </div>
                </div>
            </div>
            
            <div class="chart-row">
                <!-- Top Clients -->
                <div class="chart-card">
                    <h3>Top Clients</h3>
                    <div id="topClientsList" class="chart-container">
                        ${renderTopClients(trends.top_clients)}
                    </div>
                </div>
                
                <!-- Client Demographics -->
                <div class="chart-card">
                    <h3>Client Demographics</h3>
                    <div class="chart-container">
                        ${renderClientDemographics(trends.client_demographics)}
                    </div>
                </div>
            </div>
            
            <div class="chart-row">
                <!-- Document Completion Trends -->
                <div class="chart-card">
                    <h3>Document Completion</h3>
                    <div class="chart-container">
                        ${renderDocumentTrends(trends.document_completion_trends)}
                    </div>
                </div>
                
                <!-- Appointment Types -->
                <div class="chart-card">
                    <h3>Appointment Types</h3>
                    <div class="chart-container">
                        ${renderAppointmentTypes(trends.appointment_types)}
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Export Options -->
        <div class="export-section">
            <h3>Export Data</h3>
            <div style="display: flex; gap: 10px; margin-top: 10px;">
                <button onclick="exportAnalyticsToCSV()" class="btn btn-primary">Export to CSV</button>
                <button onclick="exportAnalyticsToJSON()" class="btn btn-secondary">Export to JSON</button>
                <button onclick="printAnalytics()" class="btn btn-secondary">Print Report</button>
            </div>
        </div>
    `;
}

// Chart Rendering Functions
function renderMonthlyChart(data) {
    if (data.length === 0) return '<p>No data available</p>';
    
    const maxValue = Math.max(...data.map(item => item.appointment_count));
    
    return data.map(item => {
        const month = new Date(item.month).toLocaleDateString('en-US', { month: 'short', year: 'numeric' });
        const percentage = maxValue > 0 ? (item.appointment_count / maxValue) * 100 : 0;
        
        return `
            <div style="margin-bottom: 10px;">
                <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                    <span>${month}</span>
                    <span style="font-weight: bold; color: var(--primary-color);">${item.appointment_count}</span>
                </div>
                <div style="background: #f0f0f0; height: 8px; border-radius: 4px; overflow: hidden;">
                    <div style="background: var(--primary-color); height: 100%; width: ${percentage}%; transition: width 0.3s ease;"></div>
                </div>
            </div>
        `;
    }).join('');
}

function renderRevenueChart(data) {
    if (data.length === 0) return '<p>No revenue data available</p>';
    
    const maxValue = Math.max(...data.map(item => item.revenue));
    
    return data.map(item => {
        const month = new Date(item.month).toLocaleDateString('en-US', { month: 'short', year: 'numeric' });
        const percentage = maxValue > 0 ? (item.revenue / maxValue) * 100 : 0;
        
        return `
            <div style="margin-bottom: 10px;">
                <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                    <span>${month}</span>
                    <span style="font-weight: bold; color: var(--primary-color);">$${item.revenue.toFixed(2)}</span>
                </div>
                <div style="background: #f0f0f0; height: 8px; border-radius: 4px; overflow: hidden;">
                    <div style="background: #28a745; height: 100%; width: ${percentage}%; transition: width 0.3s ease;"></div>
                </div>
            </div>
        `;
    }).join('');
}

function renderTopClients(data) {
    if (data.length === 0) return '<p>No client data available</p>';
    
    return data.map((client, index) => {
        const rank = index + 1;
        const rankEmoji = rank === 1 ? '' : rank === 2 ? '' : rank === 3 ? '' : `${rank}.`;
        
        return `
            <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid #eee;">
                <div>
                    <span style="margin-right: 10px;">${rankEmoji}</span>
                    <span style="font-weight: bold;">${client.name}</span>
                </div>
                <div style="text-align: right;">
                    <div style="color: var(--primary-color); font-weight: bold;">${client.appointment_count} appointments</div>
                    <div style="color: #666; font-size: 12px;">$${client.total_revenue.toFixed(2)}</div>
                </div>
            </div>
        `;
    }).join('');
}

function renderClientDemographics(data) {
    const statusData = Object.entries(data.by_status);
    const newVsReturning = Object.entries(data.new_vs_returning);
    
    return `
        <div style="margin-bottom: 20px;">
            <h4 style="margin-bottom: 10px; color: var(--primary-color);">Client Status</h4>
            ${statusData.map(([status, count]) => `
                <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                    <span style="text-transform: capitalize;">${status}:</span>
                    <span style="font-weight: bold;">${count}</span>
                </div>
            `).join('')}
        </div>
        <div>
            <h4 style="margin-bottom: 10px; color: var(--primary-color);">Client Type</h4>
            ${newVsReturning.map(([type, count]) => `
                <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                    <span style="text-transform: capitalize;">${type}:</span>
                    <span style="font-weight: bold;">${count}</span>
                </div>
            `).join('')}
        </div>
    `;
}

function renderDocumentTrends(data) {
    if (data.length === 0) return '<p>No document data available</p>';
    
    const maxValue = Math.max(...data.map(item => item.completed_documents));
    
    return data.map(item => {
        const week = new Date(item.week_start).toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        const percentage = maxValue > 0 ? (item.completed_documents / maxValue) * 100 : 0;
        
        return `
            <div style="margin-bottom: 10px;">
                <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                    <span>Week of ${week}</span>
                    <span style="font-weight: bold; color: var(--primary-color);">${item.completed_documents}</span>
                </div>
                <div style="background: #f0f0f0; height: 8px; border-radius: 4px; overflow: hidden;">
                    <div style="background: #17a2b8; height: 100%; width: ${percentage}%; transition: width 0.3s ease;"></div>
                </div>
            </div>
        `;
    }).join('');
}

function renderAppointmentTypes(data) {
    if (data.length === 0) return '<p>No appointment type data available</p>';
    
    const total = data.reduce((sum, item) => sum + item.count, 0);
    
    return data.map(item => {
        const percentage = total > 0 ? (item.count / total) * 100 : 0;
        
        return `
            <div style="margin-bottom: 10px;">
                <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                    <span style="text-transform: capitalize;">${item.type}:</span>
                    <span style="font-weight: bold; color: var(--primary-color);">${item.count}</span>
                </div>
                <div style="background: #f0f0f0; height: 8px; border-radius: 4px; overflow: hidden;">
                    <div style="background: #ffc107; height: 100%; width: ${percentage}%; transition: width 0.3s ease;"></div>
                </div>
            </div>
        `;
    }).join('');
}

// Export Functions
function exportAnalyticsToCSV() {
    const data = generateComprehensiveAnalytics(document.getElementById('timeframeSelect').value);
    let csv = 'Analytics Report\n\n';
    
    // Overview section
    csv += 'OVERVIEW\n';
    csv += 'Metric,Value\n';
    csv += `Total Clients,${data.overview.total_clients}\n`;
    csv += `Active Clients,${data.overview.active_clients}\n`;
    csv += `Appointment Completion Rate,${data.overview.appointment_completion_rate}%\n`;
    csv += `Document Completion Rate,${data.overview.document_completion_rate}%\n`;
    csv += `Total Revenue,$${data.overview.total_revenue.toFixed(2)}\n`;
    csv += `Paid Revenue,$${data.overview.paid_revenue.toFixed(2)}\n\n`;
    
    // Top clients
    csv += 'TOP CLIENTS\n';
    csv += 'Rank,Name,Appointments,Revenue\n';
    data.trends.top_clients.forEach((client, index) => {
        csv += `${index + 1},${client.name},${client.appointment_count},$${client.total_revenue.toFixed(2)}\n`;
    });
    
    // Download CSV
    const blob = new Blob([csv], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `analytics-report-${new Date().toISOString().split('T')[0]}.csv`;
    a.click();
    window.URL.revokeObjectURL(url);
    
    logLocalAudit('analytics_export_csv', { timeframe: data.timeframe });
}

function exportAnalyticsToJSON() {
    const data = generateComprehensiveAnalytics(document.getElementById('timeframeSelect').value);
    
    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `analytics-report-${new Date().toISOString().split('T')[0]}.json`;
    a.click();
    window.URL.revokeObjectURL(url);
    
    logLocalAudit('analytics_export_json', { timeframe: data.timeframe });
}

function printAnalytics() {
    const printWindow = window.open('', '_blank');
    const data = generateComprehensiveAnalytics(document.getElementById('timeframeSelect').value);
    
    const printContent = `
        <!DOCTYPE html>
        <html>
        <head>
            <title>Sessionably Analytics Report</title>
            <style>
                body { font-family: Arial, sans-serif; margin: 20px; }
                .header { text-align: center; margin-bottom: 30px; border-bottom: 2px solid #00a86b; padding-bottom: 20px; }
                .section { margin-bottom: 30px; }
                .section h2 { color: #00a86b; border-bottom: 1px solid #ddd; padding-bottom: 10px; }
                .stat-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; margin-bottom: 20px; }
                .stat-item { display: flex; justify-content: space-between; margin-bottom: 10px; }
                .stat-label { font-weight: bold; }
                .stat-value { color: #00a86b; font-weight: bold; }
                @media print { body { margin: 0; } }
            </style>
        </head>
        <body>
            <div class="header">
                <h1>Sessionably Analytics Report</h1>
                <p>Generated on: ${new Date().toLocaleDateString()}</p>
                <p>Timeframe: Last ${data.timeframe} days</p>
            </div>
            
            <div class="section">
                <h2>Overview Statistics</h2>
                <div class="stat-grid">
                    <div>
                        <div class="stat-item"><span class="stat-label">Total Clients:</span><span class="stat-value">${data.overview.total_clients}</span></div>
                        <div class="stat-item"><span class="stat-label">Active Clients:</span><span class="stat-value">${data.overview.active_clients}</span></div>
                        <div class="stat-item"><span class="stat-label">Upcoming Appointments:</span><span class="stat-value">${data.overview.upcoming_appointments}</span></div>
                    </div>
                    <div>
                        <div class="stat-item"><span class="stat-label">Total Revenue:</span><span class="stat-value">$${data.overview.total_revenue.toFixed(2)}</span></div>
                        <div class="stat-item"><span class="stat-label">Paid Revenue:</span><span class="stat-value">$${data.overview.paid_revenue.toFixed(2)}</span></div>
                        <div class="stat-item"><span class="stat-label">Outstanding:</span><span class="stat-value">$${(data.overview.total_revenue - data.overview.paid_revenue).toFixed(2)}</span></div>
                    </div>
                </div>
            </div>
            
            <div class="section">
                <h2>Top Clients</h2>
                ${data.trends.top_clients.map((client, index) => `
                    <div class="stat-item">
                        <span class="stat-label">${index + 1}. ${client.name}:</span>
                        <span class="stat-value">${client.appointment_count} appointments, $${client.total_revenue.toFixed(2)}</span>
                    </div>
                `).join('')}
            </div>
        </body>
        </html>
    `;
    
    printWindow.document.write(printContent);
    printWindow.document.close();
    printWindow.print();
    
    logLocalAudit('analytics_print', { timeframe: data.timeframe });
}

// ================================
// MESSAGING SYSTEM
// ================================
let currentConversations = [];
let selectedConversationClient = null;
let currentMessages = [];
let messagePollingInterval = null;

async function loadConversations() {
    try {
        // Get all clients with unread message counts
        const allClients = loadFromStorage('clients', []);
        const allMessages = loadFromStorage('client_messages', []);

        // Group messages by client and get unread counts
        const conversationsMap = new Map();

        allClients.forEach(client => {
            const clientMessages = allMessages.filter(m => m.client_id === client.id);
            const unreadCount = clientMessages.filter(m => !m.is_read && m.sender_type === 'client').length;
            const lastMessage = clientMessages.sort((a, b) =>
                new Date(b.created_at) - new Date(a.created_at)
            )[0];

            conversationsMap.set(client.id, {
                client: client,
                messageCount: clientMessages.length,
                unreadCount: unreadCount,
                lastMessage: lastMessage,
                lastMessageTime: lastMessage ? new Date(lastMessage.created_at) : new Date(0)
            });
        });

        // Convert to array and sort by last message time
        currentConversations = Array.from(conversationsMap.values())
            .filter(conv => conv.messageCount > 0) // Only show clients with messages
            .sort((a, b) => b.lastMessageTime - a.lastMessageTime);

        renderConversations();
        updateMessagesBadge();
    } catch (error) {
        console.error('Error loading conversations:', error);
        showToast('Failed to load conversations', 'error');
    }
}

function renderConversations() {
    const container = document.getElementById('conversationsList');
    if (!container) return;

    if (currentConversations.length === 0) {
        container.innerHTML = `
            <div style="padding: 40px 20px; text-align: center; color: var(--text-secondary);">
                <p>No conversations yet</p>
                <p style="font-size: 13px; margin-top: 10px;">Messages from clients will appear here</p>
            </div>
        `;
        return;
    }

    let html = '';
    currentConversations.forEach(conv => {
        const isSelected = selectedConversationClient && selectedConversationClient.id === conv.client.id;
        const unreadBadge = conv.unreadCount > 0
            ? `<span class="notification-badge" style="display: inline-flex;">${conv.unreadCount}</span>`
            : '';

        const lastMessagePreview = conv.lastMessage
            ? (conv.lastMessage.message.substring(0, 50) + (conv.lastMessage.message.length > 50 ? '...' : ''))
            : 'No messages';

        const timeAgo = conv.lastMessage ? formatTimeAgo(new Date(conv.lastMessage.created_at)) : '';

        html += `
            <div class="conversation-item ${isSelected ? 'active' : ''}" onclick="selectConversation('${conv.client.id}')" style="padding: 15px; border-bottom: 1px solid var(--border-color); cursor: pointer; transition: background 0.2s; ${isSelected ? 'background: var(--surface-hover);' : ''}">
                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 5px;">
                    <div style="font-weight: 600; color: var(--primary-color);">${conv.client.name}</div>
                    ${unreadBadge}
                </div>
                <div style="font-size: 13px; color: var(--text-secondary); margin-bottom: 3px;">${lastMessagePreview}</div>
                <div style="font-size: 12px; color: var(--text-secondary);">${timeAgo}</div>
            </div>
        `;
    });

    container.innerHTML = html;
}

function selectConversation(clientId) {
    const conversation = currentConversations.find(c => c.client.id === clientId);
    if (!conversation) return;

    selectedConversationClient = conversation.client;

    // Update UI
    document.getElementById('selectedClientInfo').style.display = 'block';
    document.getElementById('noConversationSelected').style.display = 'none';
    document.getElementById('messageComposer').style.display = 'block';
    document.getElementById('selectedClientName').textContent = conversation.client.name;
    document.getElementById('selectedClientEmail').textContent = conversation.client.email || '';

    // Load messages
    loadMessagesForClient(clientId);

    // Highlight selected conversation
    renderConversations();

    // Mark messages as read
    markConversationAsRead(clientId);
}

function loadMessagesForClient(clientId) {
    try {
        const allMessages = loadFromStorage('client_messages', []);
        currentMessages = allMessages
            .filter(m => m.client_id === clientId)
            .sort((a, b) => new Date(a.created_at) - new Date(b.created_at));

        renderMessages();
    } catch (error) {
        console.error('Error loading messages:', error);
        showToast('Failed to load messages', 'error');
    }
}

function renderMessages() {
    const container = document.getElementById('messagesArea');
    if (!container) return;

    if (currentMessages.length === 0) {
        container.innerHTML = `
            <div style="text-align: center; padding: 40px; color: var(--text-secondary);">
                <p>No messages yet</p>
                <p style="font-size: 13px; margin-top: 10px;">Start the conversation by sending a message below</p>
            </div>
        `;
        return;
    }

    let html = '';
    currentMessages.forEach(msg => {
        const isProvider = msg.sender_type === 'provider';
        const messageTime = new Date(msg.created_at);
        const timeStr = messageTime.toLocaleString('en-US', {
            month: 'short',
            day: 'numeric',
            hour: 'numeric',
            minute: '2-digit',
            hour12: true
        });

        html += `
            <div style="margin-bottom: 15px; display: flex; ${isProvider ? 'justify-content: flex-end;' : 'justify-content: flex-start;'}">
                <div style="max-width: 70%; ${isProvider ? 'text-align: right;' : 'text-align: left;'}">
                    <div style="background: ${isProvider ? 'var(--primary-color)' : 'white'}; color: ${isProvider ? 'white' : 'var(--text-primary)'}; padding: 12px 16px; border-radius: 12px; box-shadow: var(--shadow-sm); margin-bottom: 5px;">
                        ${escapeHtml(msg.message)}
                    </div>
                    <div style="font-size: 11px; color: var(--text-secondary); padding: 0 8px;">
                        ${msg.sender_name || (isProvider ? 'You' : 'Client')}  ${timeStr}
                    </div>
                </div>
            </div>
        `;
    });

    container.innerHTML = html;

    // Scroll to bottom
    container.scrollTop = container.scrollHeight;
}

async function sendProviderMessage() {
    const input = document.getElementById('messageInput');
    const message = input.value.trim();

    if (!message) {
        showToast('Please enter a message', 'error');
        return;
    }

    if (!selectedConversationClient) {
        showToast('No conversation selected', 'error');
        return;
    }

    try {
        // Create message object
        const newMessage = {
            id: Date.now(),
            client_id: selectedConversationClient.id,
            subject: 'Message',
            message: message,
            message_type: 'chat',
            priority: 'normal',
            is_read: false,
            sender_type: 'provider',
            sender_id: currentUser.id,
            sender_name: currentUser.name || currentUser.username,
            created_at: new Date().toISOString()
        };

        // Save to storage
        const allMessages = loadFromStorage('client_messages', []);
        allMessages.push(newMessage);
        saveToStorage('client_messages', allMessages);

        // Add to current messages
        currentMessages.push(newMessage);

        // Clear input
        input.value = '';

        // Re-render
        renderMessages();
        loadConversations(); // Refresh conversations list

        // Log audit
        logLocalAudit('message_sent', {
            clientId: selectedConversationClient.id,
            clientName: selectedConversationClient.name
        });

        showToast('Message sent', 'success');
    } catch (error) {
        console.error('Error sending message:', error);
        showToast('Failed to send message', 'error');
    }
}

function handleMessageKeydown(event) {
    // Send message on Ctrl+Enter or Cmd+Enter
    if (event.key === 'Enter' && (event.ctrlKey || event.metaKey)) {
        event.preventDefault();
        sendProviderMessage();
    }
}

function refreshMessages() {
    if (selectedConversationClient) {
        loadMessagesForClient(selectedConversationClient.id);
    }
    loadConversations();
    showToast('Messages refreshed', 'success');
}

function markConversationAsRead(clientId) {
    try {
        const allMessages = loadFromStorage('client_messages', []);
        let updated = false;

        allMessages.forEach(msg => {
            if (msg.client_id === clientId && !msg.is_read && msg.sender_type === 'client') {
                msg.is_read = true;
                msg.read_at = new Date().toISOString();
                updated = true;
            }
        });

        if (updated) {
            saveToStorage('client_messages', allMessages);
            loadConversations(); // Refresh to update unread counts
        }
    } catch (error) {
        console.error('Error marking messages as read:', error);
    }
}

function updateMessagesBadge() {
    const badge = document.getElementById('messagesBadge');
    if (!badge) return;

    const totalUnread = currentConversations.reduce((sum, conv) => sum + conv.unreadCount, 0);

    if (totalUnread > 0) {
        badge.textContent = totalUnread;
        badge.style.display = 'inline-flex';
    } else {
        badge.style.display = 'none';
    }
}

function filterConversations() {
    const searchInput = document.getElementById('conversationSearch');
    const searchTerm = searchInput.value.toLowerCase();

    const filteredConversations = currentConversations.filter(conv =>
        conv.client.name.toLowerCase().includes(searchTerm) ||
        (conv.client.email && conv.client.email.toLowerCase().includes(searchTerm)) ||
        (conv.lastMessage && conv.lastMessage.message.toLowerCase().includes(searchTerm))
    );

    // Temporarily replace currentConversations for rendering
    const originalConversations = currentConversations;
    currentConversations = filteredConversations;
    renderConversations();
    currentConversations = originalConversations;
}

function formatTimeAgo(date) {
    const seconds = Math.floor((new Date() - date) / 1000);

    if (seconds < 60) return 'Just now';
    if (seconds < 3600) return `${Math.floor(seconds / 60)}m ago`;
    if (seconds < 86400) return `${Math.floor(seconds / 3600)}h ago`;
    if (seconds < 604800) return `${Math.floor(seconds / 86400)}d ago`;

    return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// ================================
// END MESSAGING SYSTEM
// ================================

// Appointments Management
// Note: loadAppointments() is defined earlier in the file (around line 12064)
// and properly fetches appointments from the API

// AI NoteTaker Functions
function checkAINoteTakerSubscription() {
    const subscriptionStatus = loadFromStorage('aiNoteTakerSubscription', { active: false, planId: null });
    const statusDiv = document.getElementById('aiNoteTakerSubscriptionStatus');
    const noticeDiv = document.getElementById('aiNoteTakerSubscriptionNotice');
    const appointmentsDiv = document.getElementById('aiNoteTakerAppointments');

    if (subscriptionStatus.active) {
        statusDiv.textContent = ' AI NoteTaker Add-On Active ($20/month)';
        statusDiv.style.color = '#10b981';
        noticeDiv.style.display = 'none';
        appointmentsDiv.style.display = 'block';
    } else {
        statusDiv.textContent = ' AI NoteTaker Add-On Not Active';
        statusDiv.style.color = '#f59e0b';
        noticeDiv.style.display = 'block';
        appointmentsDiv.style.display = 'none';
    }

    return subscriptionStatus.active;
}

function loadTodayAppointments() {
    const today = new Date().toISOString().split('T')[0];
    const todayAppointments = appointments.filter(apt => {
        // Validate date before accessing
        const aptDateValue = apt.appointment_date || apt.date;
        if (!aptDateValue) return false;
        const aptDate = new Date(aptDateValue);
        if (isNaN(aptDate.getTime())) return false;
        const aptDateStr = aptDateValue.split('T')[0];
        return aptDateStr === today;
    });

    const container = document.getElementById('todayAppointmentsList');

    if (todayAppointments.length === 0) {
        container.innerHTML = `
            <div style="padding: 40px; text-align: center; color: var(--text-secondary);">
                <p style="font-size: 18px; margin-bottom: 10px;"> No appointments scheduled for today</p>
                <p>Check back tomorrow or schedule a new appointment.</p>
            </div>
        `;
        return;
    }

    // Sort by appointment time
    todayAppointments.sort((a, b) => {
        const timeA = a.appointment_time || '00:00';
        const timeB = b.appointment_time || '00:00';
        return timeA.localeCompare(timeB);
    });

    let html = '<div class="appointments-grid" style="grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 20px;">';

    todayAppointments.forEach(apt => {
        const client = clients.find(c => c.id === apt.client_id);
        const clientName = client ? `${client.first_name} ${client.last_name}` : 'Unknown Client';
        const aiNoteTakerEnabled = apt.ai_notetaker_enabled || false;
        const hasRecording = apt.session_transcript || apt.session_audio;

        html += `
            <div class="appointment-card" style="background: var(--surface-color); border-radius: var(--border-radius); padding: 20px; box-shadow: var(--shadow-light);">
                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 15px;">
                    <div>
                        <h4 style="margin: 0 0 5px 0; font-size: 18px;">${clientName}</h4>
                        <div style="color: var(--text-secondary); font-size: 14px;">
                            <div> ${apt.appointment_time}</div>
                            <div> ${apt.duration || 60} minutes</div>
                            ${apt.type ? `<div> ${apt.type}</div>` : ''}
                        </div>
                    </div>
                    <span class="status-badge status-${apt.status || 'scheduled'}">${apt.status || 'scheduled'}</span>
                </div>

                ${hasRecording ? `
                    <div style="background: #dcfce7; padding: 10px; border-radius: 6px; margin-bottom: 15px; font-size: 13px; color: #166534;">
                         Recording saved
                    </div>
                ` : ''}

                <div style="display: flex; align-items: center; justify-content: space-between; padding: 12px; background: #f8fafc; border-radius: 8px; margin-bottom: 15px;">
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <span style="font-weight: 500;">AI NoteTaker</span>
                        ${aiNoteTakerEnabled ? '<span style="color: #10b981; font-size: 12px;"> Enabled</span>' : '<span style="color: #6b7280; font-size: 12px;">Disabled</span>'}
                    </div>
                    <label class="toggle-switch">
                        <input type="checkbox" ${aiNoteTakerEnabled ? 'checked' : ''} onchange="toggleAINoteTaker(${apt.id}, this.checked)">
                        <span class="toggle-slider"></span>
                    </label>
                </div>

                <div style="display: flex; gap: 10px;">
                    ${aiNoteTakerEnabled ? `
                        <button class="btn btn-primary" onclick="startAINoteTakerForAppointment(${apt.id})" style="flex: 1;">
                             Start Session
                        </button>
                    ` : `
                        <button class="btn" disabled style="flex: 1; opacity: 0.5;">
                             Enable AI NoteTaker First
                        </button>
                    `}
                    <button class="btn btn-secondary" onclick="viewAppointmentDetail(${apt.id})">
                         View Details
                    </button>
                </div>
            </div>
        `;
    });

    html += '</div>';
    container.innerHTML = html;
}

function toggleAINoteTaker(appointmentId, enabled) {
    const appointment = appointments.find(a => a.id === appointmentId);
    if (!appointment) return;

    appointment.ai_notetaker_enabled = enabled;
    saveToStorage('sessionably_appointments', appointments);

    // Log the change
    logAuditEvent('ai_notetaker_toggled', `AI NoteTaker ${enabled ? 'enabled' : 'disabled'} for appointment #${appointmentId}`);

    // Reload the appointments list
    loadTodayAppointments();

    showToast(`AI NoteTaker ${enabled ? 'enabled' : 'disabled'} for this appointment`);
}

function startAINoteTakerForAppointment(appointmentId) {
    const appointment = appointments.find(a => a.id === appointmentId);
    if (!appointment) {
        showToast('Appointment not found', 'error');
        return;
    }

    if (!appointment.ai_notetaker_enabled) {
        showToast('Please enable AI NoteTaker for this appointment first', 'error');
        return;
    }

    // Check subscription status
    const hasSubscription = checkAINoteTakerSubscription();
    if (!hasSubscription) {
        showToast('AI NoteTaker subscription required', 'error');
        return;
    }

    // Set the current appointment for recording
    currentAppointmentId = appointmentId;

    // Show the active recording panel
    const activePanel = document.getElementById('activeRecordingPanel');
    const client = clients.find(c => c.id === appointment.client_id);
    const clientName = client ? `${client.first_name} ${client.last_name}` : 'Unknown Client';

    document.getElementById('activeClientName').textContent = clientName;
    document.getElementById('activeAppointmentTime').textContent = appointment.appointment_time || '-';

    activePanel.style.display = 'block';

    // Scroll to the recording panel
    activePanel.scrollIntoView({ behavior: 'smooth' });

    showToast('Ready to start recording');
}

function viewAppointmentDetail(appointmentId) {
    const appointment = appointments.find(a => a.id === appointmentId);
    if (!appointment) return;

    currentAppointmentId = appointmentId;
    showAppointmentDetail();
}

function renderCalendar() {
    const calendar = document.getElementById('calendarView');
    const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
        'July', 'August', 'September', 'October', 'November', 'December'];
    
    if (calendarViewMode === 'month') {
        renderMonthView(calendar, monthNames);
    } else if (calendarViewMode === 'week') {
        renderWeekView(calendar, monthNames);
    } else if (calendarViewMode === 'day') {
        renderDayView(calendar, monthNames);
    }
}

function renderMonthView(calendar, monthNames) {
    document.getElementById('currentMonth').textContent = 
        `${monthNames[currentCalendarDate.getMonth()]} ${currentCalendarDate.getFullYear()}`;
    
    const firstDay = new Date(currentCalendarDate.getFullYear(), currentCalendarDate.getMonth(), 1);
    const lastDay = new Date(currentCalendarDate.getFullYear(), currentCalendarDate.getMonth() + 1, 0);
    const startDate = new Date(firstDay);
    startDate.setDate(startDate.getDate() - firstDay.getDay());
    
    let html = '<div class="calendar-grid">';
    
    // Day headers
    const dayHeaders = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
    dayHeaders.forEach(day => {
        html += `<div class="calendar-header">${day}</div>`;
    });
    
    // Calendar days
    for (let i = 0; i < 42; i++) {
        const currentDate = new Date(startDate);
        currentDate.setDate(startDate.getDate() + i);
        
        const isCurrentMonth = currentDate.getMonth() === currentCalendarDate.getMonth();
        const isToday = currentDate.toDateString() === new Date().toDateString();
        
        const dateString = currentDate.toISOString().split('T')[0];
        const dayAppointments = appointments.filter(apt => {
            // Use flexible parser to handle all date formats (including ISO)
            const aptDate = parseAppointmentDate(apt);
            if (!aptDate) {
                return false; // Skip invalid - already warned by parser
            }
            // Get date string for calendar lookup (YYYY-MM-DD)
            const year = aptDate.getFullYear();
            const month = String(aptDate.getMonth() + 1).padStart(2, '0');
            const day = String(aptDate.getDate()).padStart(2, '0');
            const aptDateStr = `${year}-${month}-${day}`;
            return aptDateStr === dateString;
        });
        
        let classes = 'calendar-day';
        if (!isCurrentMonth) classes += ' other-month';
        if (isToday) classes += ' today';
        if (dayAppointments.length > 0) classes += ' has-appointment';
        
        html += `<div class="${classes}" data-date="${dateString}" onclick="showDayAppointments('${dateString}')" draggable="true" ondragstart="dragStart(event, '${dateString}')" ondragover="dragOver(event)" ondrop="drop(event, '${dateString}')">
                    <div class="day-number">${currentDate.getDate()}</div>
                    ${dayAppointments.length > 0 ? `
                        <div class="appointment-widgets">
                            ${dayAppointments.slice(0, 4).map(apt => {
                                // Format client name as "FirstName L." (first name + last initial)
                                const nameParts = (apt.client_name || 'Unknown Client').trim().split(' ');
                                let displayName;
                                if (nameParts.length === 1) {
                                    displayName = nameParts[0];
                                } else {
                                    const firstName = nameParts[0];
                                    const lastInitial = nameParts[nameParts.length - 1].charAt(0) + '.';
                                    displayName = `${firstName} ${lastInitial}`;
                                }

                                // Format time to 12-hour format (e.g., "2:30 PM")
                                const timeStr = apt.appointment_time || '';
                                let displayTime = timeStr;
                                if (timeStr) {
                                    const [hours, minutes] = timeStr.split(':');
                                    const hour = parseInt(hours);
                                    const ampm = hour >= 12 ? 'PM' : 'AM';
                                    const displayHour = hour % 12 || 12;
                                    displayTime = `${displayHour}:${minutes} ${ampm}`;
                                }

                                const modality = (apt.modality || 'in-person').toLowerCase();
                                const isTelehealth = modality === 'telehealth';

                                return `
                                <div class="appointment-widget ${isTelehealth ? 'telehealth' : 'in-person'}" onclick="event.stopPropagation(); toggleWidgetExpansion('${dateString}', ${apt.id})" data-appointment-id="${apt.id}">
                                    <div class="widget-content">
                                        <div class="widget-main-info">
                                            <div class="widget-time">${displayTime}</div>
                                            <div class="widget-client-name">${displayName}</div>
                                        </div>
                                        <div class="widget-modality-indicator" title="${isTelehealth ? 'Telehealth' : 'In-Person'}">
                                            ${isTelehealth ? '<span class="modality-icon telehealth-icon"></span>' : '<span class="modality-icon in-person-icon"></span>'}
                                        </div>
                                    </div>
                                    <div class="widget-expanded" style="display: none;">
                                        <div class="expanded-info">
                                            <div class="client-name">${apt.client_name || 'Unknown Client'}</div>
                                            <div class="appointment-type">${apt.type || 'Consultation'}</div>
                                            <div class="appointment-duration">${apt.duration || 60} min</div>
                                            <div class="appointment-modality">Mode: ${isTelehealth ? 'Telehealth' : 'In-Person'}</div>
                                            ${apt.notes ? `<div class="appointment-notes">${apt.notes}</div>` : ''}
                                        </div>
                                        <div class="widget-actions">
                                            <button onclick="event.stopPropagation(); editAppointment(${apt.id})" class="btn-widget-edit">Edit</button>
                                            <button onclick="event.stopPropagation(); deleteAppointment(${apt.id})" class="btn-widget-delete">Delete</button>
                                        </div>
                                    </div>
                                </div>
                                `;
                            }).join('')}
                            ${dayAppointments.length > 4 ? `<div class="more-appointments">+${dayAppointments.length - 4} more</div>` : ''}
                        </div>
                    ` : ''}
                </div>`;
    }
    
    html += '</div>';
    calendar.innerHTML = html;
}

function renderWeekView(calendar, monthNames) {
    const weekStart = new Date(currentCalendarDate);
    weekStart.setDate(currentCalendarDate.getDate() - currentCalendarDate.getDay());
    const weekEnd = new Date(weekStart);
    weekEnd.setDate(weekStart.getDate() + 6);
    
    document.getElementById('currentMonth').textContent = 
        `${weekStart.toLocaleDateString()} - ${weekEnd.toLocaleDateString()}`;
    
    let html = '<div class="week-calendar">';
    
    // Hour slots (8 AM to 8 PM)
    const hours = Array.from({length: 13}, (_, i) => i + 8);
    
    html += '<div class="week-grid">';
    html += '<div class="time-column">';
    html += '<div class="time-header">Time</div>';
    hours.forEach(hour => {
        html += `<div class="time-slot">${hour}:00</div>`;
    });
    html += '</div>';
    
    // Day columns
    const dayHeaders = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
    dayHeaders.forEach((day, dayIndex) => {
        const currentDate = new Date(weekStart);
        currentDate.setDate(weekStart.getDate() + dayIndex);
        const dateString = currentDate.toISOString().split('T')[0];
        
        html += `<div class="day-column">
                    <div class="day-header">
                        <div>${day}</div>
                        <div class="day-number">${currentDate.getDate()}</div>
                    </div>`;
        
        hours.forEach(hour => {
            const timeSlot = `${hour.toString().padStart(2, '0')}:00`;
            const slotAppointments = appointments.filter(apt => {
                // Use flexible parser to handle all date formats (including ISO)
                const aptDate = parseAppointmentDate(apt);
                if (!aptDate) return false;
                // Get date string for calendar lookup (YYYY-MM-DD)
                const year = aptDate.getFullYear();
                const month = String(aptDate.getMonth() + 1).padStart(2, '0');
                const day = String(aptDate.getDate()).padStart(2, '0');
                const aptDateStr = `${year}-${month}-${day}`;
                return aptDateStr === dateString && apt.time === timeSlot;
            });
            
            let classes = 'time-slot';
            if (slotAppointments.length > 0) {
                classes += ' has-appointment';
                html += `<div class="${classes}" onclick="showAppointmentDetails(${slotAppointments[0].id})">
                            <div class="appointment-block">${slotAppointments[0].client_name || 'Appointment'}</div>
                        </div>`;
            } else {
                html += `<div class="${classes}" onclick="createAppointmentAtTime('${dateString}', '${timeSlot}')"></div>`;
            }
        });
        
        html += '</div>';
    });
    
    html += '</div></div>';
    calendar.innerHTML = html;
}

function renderDayView(calendar, monthNames) {
    const dateString = currentCalendarDate.toISOString().split('T')[0];
    document.getElementById('currentMonth').textContent =
        `${monthNames[currentCalendarDate.getMonth()]} ${currentCalendarDate.getDate()}, ${currentCalendarDate.getFullYear()}`;

    const dayAppointments = appointments.filter(apt => {
        // Use flexible parser to handle all date formats (including ISO)
        const aptDate = parseAppointmentDate(apt);
        if (!aptDate) return false;
        // Get date string for calendar lookup (YYYY-MM-DD)
        const year = aptDate.getFullYear();
        const month = String(aptDate.getMonth() + 1).padStart(2, '0');
        const day = String(aptDate.getDate()).padStart(2, '0');
        const aptDateStr = `${year}-${month}-${day}`;
        return aptDateStr === dateString;
    }).sort((a, b) => (a.appointment_time || a.time || '').localeCompare(b.appointment_time || b.time || ''));
    
    let html = '<div class="day-view">';
    html += '<div class="day-appointments">';
    
    if (dayAppointments.length === 0) {
        html += '<div class="no-appointments">No appointments scheduled for this day</div>';
    } else {
        dayAppointments.forEach(apt => {
            html += `<div class="day-appointment" onclick="showAppointmentDetails(${apt.id})">
                        <div class="appointment-time">${apt.time}</div>
                        <div class="appointment-details">
                            <div class="client-name">${apt.client_name || 'Unknown Client'}</div>
                            <div class="appointment-notes">${apt.notes || 'No notes'}</div>
                        </div>
                        <div class="appointment-duration">${apt.duration || 60} min</div>
                    </div>`;
        });
    }
    
    html += '</div>';
    html += '<div class="day-actions">';
    html += '<button onclick="createAppointmentAtTime(\'' + dateString + '\', \'09:00\')" class="btn btn-primary">+ Add Appointment</button>';
    html += '</div>';
    html += '</div>';
    
    calendar.innerHTML = html;
}

function renderAppointmentsList() {
    const container = document.getElementById('appointmentsList');
    if (appointments.length === 0) {
        container.innerHTML = '<p>No appointments scheduled for this month.</p>';
        return;
    }
    
    const sortedAppointments = appointments.sort((a, b) => {
        const dateA = new Date(`${a.appointment_date} ${a.appointment_time}`);
        const dateB = new Date(`${b.appointment_date} ${b.appointment_time}`);
        return dateA - dateB;
    });
    
    container.innerHTML = sortedAppointments.map(apt => {
        const statusClass = apt.status === 'completed' ? 'success' : apt.status === 'cancelled' ? 'danger' : 'warning';
        return `<div class="appointment-item">
                    <div class="appointment-info">
                        <h4 style="cursor: pointer; color: #E85D4F;" onclick="openClientChart(${apt.client_id}); event.stopPropagation();">${apt.client_name}</h4>
                        <p> ${new Date(apt.appointment_date).toLocaleDateString()} at ${apt.appointment_time}</p>
                        <p> ${apt.duration} minutes - ${apt.type}</p>
                        ${apt.notes ? `<p> ${apt.notes}</p>` : ''}
                    </div>
                    <div class="appointment-actions">
                        <span class="btn btn-${statusClass} btn-small">${apt.status}</span>
                        <button onclick="editAppointment(${apt.id})" class="btn btn-small">Edit</button>
                        <button onclick="deleteAppointment(${apt.id})" class="btn btn-danger btn-small">Delete</button>
                    </div>
                </div>`;
    }).join('');
}

function previousMonth() {
    currentCalendarDate.setMonth(currentCalendarDate.getMonth() - 1);
    renderCalendar();
}

function nextMonth() {
    currentCalendarDate.setMonth(currentCalendarDate.getMonth() + 1);
    renderCalendar();
}

function setCalendarView(view) {
    calendarViewMode = view;
    
    // Update button states
    document.querySelectorAll('.calendar-view-toggle .btn-sm').forEach(btn => btn.classList.remove('active'));
    document.getElementById(view + 'ViewBtn').classList.add('active');
    
    // Re-render calendar with new view
    renderCalendar();
}

function checkAppointmentConflict(newAppointment) {
    const conflicts = appointments.filter(apt => {
        if (apt.id === newAppointment.id) return false; // Don't conflict with self
        return apt.appointment_date === newAppointment.appointment_date && 
               apt.time === newAppointment.time;
    });
    return conflicts;
}

// Drag and Drop Functions
let draggedAppointment = null;

function dragStart(event, dateString) {
    draggedAppointment = { date: dateString };
    event.dataTransfer.effectAllowed = 'move';
}

function dragOver(event) {
    event.preventDefault();
    event.dataTransfer.dropEffect = 'move';
    event.target.classList.add('drag-over');
}

function drop(event, targetDateString) {
    event.preventDefault();
    event.target.classList.remove('drag-over');
    
    if (draggedAppointment && draggedAppointment.date !== targetDateString) {
        // Move appointments from dragged date to target date
        const appointmentsToMove = appointments.filter(apt => 
            apt.appointment_date === draggedAppointment.date
        );
        
        appointmentsToMove.forEach(apt => {
            apt.appointment_date = targetDateString;
        });
        
        // Save to localStorage
        saveToStorage('appointments', appointments);
        logLocalAudit('appointment_move', { 
            fromDate: draggedAppointment.date, 
            toDate: targetDateString, 
            count: appointmentsToMove.length 
        });
        
        // Re-render calendar
        renderCalendar();
        renderAppointmentsList();
        
        showNotification('Appointments moved successfully', 'success');
    }
    
    draggedAppointment = null;
}

function createAppointmentAtTime(date, time) {
    // Open appointment form with pre-filled date and time
    const clientSelect = document.getElementById('appointmentClient');
    const dateInput = document.getElementById('appointmentDate');
    const timeInput = document.getElementById('appointmentTime');
    
    if (clientSelect && dateInput && timeInput) {
        dateInput.value = date;
        timeInput.value = time;
        openNewAppointment();
    }
}

function showAppointmentDetails(appointmentId) {
    const appointment = appointments.find(apt => apt.id === appointmentId);
    if (appointment) {
        const details = `
            <strong>Client:</strong> ${appointment.client_name || 'Unknown'}<br>
            <strong>Date:</strong> ${new Date(appointment.appointment_date).toLocaleDateString()}<br>
            <strong>Time:</strong> ${appointment.time}<br>
            <strong>Duration:</strong> ${appointment.duration || 60} minutes<br>
            <strong>Notes:</strong> ${appointment.notes || 'No notes'}
        `;
        
        // Create modal for appointment details
        const modal = document.createElement('div');
        modal.className = 'modal';
        modal.innerHTML = `
            <div class="modal-content">
                <div class="modal-header">
                    <h3>Appointment Details</h3>
                    <span class="close" onclick="this.parentElement.parentElement.remove()">&times;</span>
                </div>
                <div class="modal-body">
                    ${details}
                </div>
                <div class="modal-footer">
                    <button onclick="editAppointment(${appointmentId})" class="btn btn-primary">Edit</button>
                    <button onclick="deleteAppointment(${appointmentId})" class="btn btn-danger">Delete</button>
                    <button onclick="this.parentElement.parentElement.remove()" class="btn">Close</button>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
    }
}

function editAppointment(appointmentId) {
    console.log('Edit appointment called with ID:', appointmentId);
    const appointment = appointments.find(apt => apt.id == appointmentId);
    
    if (!appointment) {
        console.error('Appointment not found:', appointmentId);
        showNotification('Appointment not found', 'error');
        return;
    }
    
    console.log('Found appointment:', appointment);

    // Format date for input (YYYY-MM-DD) - validate before accessing
    const aptDateValue = appointment.appointment_date || appointment.date || '';
    const dateValue = aptDateValue ? aptDateValue.split('T')[0] : '';
    
    // Populate edit form
    const clientSelect = document.getElementById('appointmentClient');
    if (clientSelect) {
        clientSelect.value = appointment.client_id || '';
    }
    
    const dateInput = document.getElementById('appointmentDate');
    if (dateInput) {
        dateInput.value = dateValue;
    }
    
    const timeInput = document.getElementById('appointmentTime');
    if (timeInput) {
        timeInput.value = appointment.appointment_time || '';
    }

    // Duration is now automatically determined by appointment type

    const typeInput = document.getElementById('appointmentType');
    if (typeInput) {
        typeInput.value = appointment.type || '';
    }
    
    const notesInput = document.getElementById('appointmentNotes');
    if (notesInput) {
        notesInput.value = appointment.notes || '';
    }
    
    // Change modal title
    const modalTitle = document.querySelector('#newAppointmentModal h2');
    if (modalTitle) {
        modalTitle.textContent = 'Edit Appointment';
    }
    
    // Store editing ID for save function
    window.editingAppointmentId = appointmentId;
    
    // Open modal
    const modal = document.getElementById('newAppointmentModal');
    if (modal) {
        modal.style.display = 'block';
        console.log('Modal opened successfully');
    } else {
        console.error('Modal not found');
        showNotification('Unable to open edit form', 'error');
    }
}

function deleteAppointment(appointmentId) {
    if (confirm('Are you sure you want to delete this appointment?')) {
        const index = appointments.findIndex(apt => apt.id === appointmentId);
        if (index !== -1) {
            const deleted = appointments.splice(index, 1)[0];
            saveToStorage('appointments', appointments);
            logLocalAudit('appointment_delete', { appointmentId, clientName: deleted.client_name });
            renderCalendar();
            renderAppointmentsList();
            showNotification('Appointment deleted', 'success');
        }
    }
    document.querySelector('.modal')?.remove();
}

function showDayAppointments(date) {
    const dayAppointments = appointments.filter(apt => apt.appointment_date === date);
    if (dayAppointments.length > 0) {
        alert(`Appointments for ${new Date(date).toLocaleDateString()}:\n\n` + 
              dayAppointments.map(apt => `${apt.appointment_time} - ${apt.client_name} (${apt.type})`).join('\n'));
    }
}

function toggleWidgetExpansion(date, appointmentId) {
    // Open the appointment detail panel instead of inline expansion
    openAppointmentDetail(appointmentId);
}

function openAppointmentDetail(appointmentId) {
    // Find the appointment
    const appointment = appointments.find(apt => apt.id == appointmentId);
    if (!appointment) {
        showNotification('Appointment not found', 'error');
        return;
    }
    
    // Show the appointment detail panel
    const panel = document.getElementById('appointmentDetailPanel');
    if (panel) {
        // Populate appointment details
        document.getElementById('detailClientName').textContent = appointment.client_name || 'Unknown Client';
        document.getElementById('detailClientEmail').textContent = appointment.client_email || 'N/A';
        document.getElementById('detailClientPhone').textContent = appointment.client_phone || 'N/A';
        document.getElementById('detailDate').textContent = formatDate(appointment.appointment_date);
        document.getElementById('detailTime').textContent = appointment.appointment_time || 'TBD';
        document.getElementById('detailType').textContent = appointment.type || 'Consultation';
        document.getElementById('detailDuration').textContent = (appointment.duration || 60) + ' minutes';
        document.getElementById('detailStatus').textContent = appointment.status || 'Scheduled';
        document.getElementById('detailStatus').className = 'status-badge ' + (appointment.status || 'scheduled').toLowerCase();
        document.getElementById('detailNotes').textContent = appointment.notes || 'No notes';
        document.getElementById('detailLocation').textContent = appointment.location || 'Office';

        // Set modality and telehealth link
        const modality = appointment.modality || 'in-person';
        document.getElementById('detailModality').textContent = modality === 'telehealth' ? 'Telehealth (Video)' : 'In-Person';

        // Show/hide telehealth link
        const telehealthRow = document.getElementById('detailTelehealthRow');
        const telehealthLink = document.getElementById('detailTelehealthLink');
        if (modality === 'telehealth' && appointment.telehealth_link) {
            telehealthRow.style.display = 'flex';
            telehealthLink.href = appointment.telehealth_link;
        } else {
            telehealthRow.style.display = 'none';
        }

        // Load payment information for the client
        if (appointment.client_id) {
            loadClientPaymentInfo(appointment.client_id);
        }

        // Load clinical notes if they exist
        const clinicalNotesTextarea = document.getElementById('detailClinicalNotes');
        clinicalNotesTextarea.value = appointment.clinical_notes || '';
        
        // Check if notes are signed and lock if they are
        if (appointment.clinical_signature && appointment.clinical_signature_timestamp) {
            clinicalNotesTextarea.disabled = true;
            const signButton = document.querySelector('.btn-sign-note');
            if (signButton) {
                signButton.textContent = ' Signed & Locked';
                signButton.disabled = true;
                signButton.style.opacity = '0.6';
            }
        } else {
            clinicalNotesTextarea.disabled = false;
            const signButton = document.querySelector('.btn-sign-note');
            if (signButton) {
                signButton.textContent = ' Sign & Lock Note';
                signButton.disabled = false;
                signButton.style.opacity = '1';
            }
        }
        
        // Set appointment ID for edit/delete
        document.getElementById('appointmentDetailPanel').setAttribute('data-appointment-id', appointmentId);
        
        // Show the panel with animation
        panel.classList.add('active');
        
        // Log the view
        logAudit('appointment_viewed', {
            appointment_id: appointmentId,
            client_name: appointment.client_name
        });
    }
}

function closeAppointmentDetail() {
    const panel = document.getElementById('appointmentDetailPanel');
    if (panel) {
        panel.classList.remove('active');
    }
}

async function loadClientPaymentInfo(clientId) {
    try {
        // Fetch client autopay status and payment method
        const response = await fetch(`/api/payment-methods?client_id=${clientId}`);

        if (!response.ok) {
            throw new Error('Failed to load payment info');
        }

        const result = await response.json();
        const paymentMethods = result.data || [];

        // Find client to check autopay status
        const client = clients.find(c => c.id == clientId);
        const autopayEnabled = client ? client.autopay_enabled : false;

        // Find default payment method
        const defaultPaymentMethod = paymentMethods.find(pm => pm.is_default);

        // Update UI
        const paymentInfoSection = document.getElementById('paymentInfoSection');
        const autopayEl = document.getElementById('detailAutopay');
        const paymentMethodRow = document.getElementById('paymentMethodRow');
        const paymentMethodEl = document.getElementById('detailPaymentMethod');

        if (paymentInfoSection) {
            paymentInfoSection.style.display = 'block';
        }

        if (autopayEl) {
            autopayEl.innerHTML = autopayEnabled
                ? '<span style="color: var(--success-color); font-weight: 500;"> Enabled</span>'
                : '<span style="color: var(--text-secondary);"> Disabled</span>';
        }

        if (defaultPaymentMethod && paymentMethodRow && paymentMethodEl) {
            paymentMethodRow.style.display = 'flex';
            const brand = defaultPaymentMethod.brand ? defaultPaymentMethod.brand.charAt(0).toUpperCase() + defaultPaymentMethod.brand.slice(1) : 'Card';
            const expiry = `${String(defaultPaymentMethod.expiry_month).padStart(2, '0')}/${defaultPaymentMethod.expiry_year}`;
            paymentMethodEl.innerHTML = `${brand}  ${defaultPaymentMethod.last4} (Exp: ${expiry})`;
        } else if (paymentMethodRow) {
            paymentMethodRow.style.display = 'none';
        }

    } catch (error) {
        console.error('Error loading client payment info:', error);
        // Silently fail - payment info is supplementary
        const paymentInfoSection = document.getElementById('paymentInfoSection');
        if (paymentInfoSection) {
            paymentInfoSection.style.display = 'none';
        }
    }
}

function formatDate(dateString) {
    const date = new Date(dateString);
    const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
    return date.toLocaleDateString('en-US', options);
}

function editAppointmentFromDetail() {
    const appointmentId = document.getElementById('appointmentDetailPanel').getAttribute('data-appointment-id');
    console.log('Edit from detail - Appointment ID:', appointmentId);
    
    if (appointmentId) {
        closeAppointmentDetail();
        // Small delay to ensure panel closes before modal opens
        setTimeout(() => {
            editAppointment(appointmentId);
        }, 100);
    } else {
        showNotification('Unable to find appointment ID', 'error');
    }
}

function deleteAppointmentFromDetail() {
    const appointmentId = document.getElementById('appointmentDetailPanel').getAttribute('data-appointment-id');
    if (appointmentId) {
        if (confirm('Are you sure you want to delete this appointment?')) {
            deleteAppointment(appointmentId);
            closeAppointmentDetail();
        }
    }
}

function generateAINote() {
    // Check feature access before proceeding
    const access = window.featureGate.checkFeature('aiClinicalNotes');
    if (!access.allowed) {
        window.featureGate.showUpgradePrompt('aiClinicalNotes');
        return;
    }

    const appointmentId = document.getElementById('appointmentDetailPanel').getAttribute('data-appointment-id');
    const appointment = appointments.find(apt => apt.id == appointmentId);

    if (!appointment) {
        showNotification('Appointment not found', 'error');
        return;
    }
    
    // Show loading state
    const textarea = document.getElementById('detailClinicalNotes');
    const originalValue = textarea.value;
    textarea.value = 'Generating AI note...';
    textarea.disabled = true;
    
    // Simulate AI note generation (in production, this would call an AI API)
    setTimeout(() => {
        const aiNote = `CLINICAL NOTES - ${appointment.type || 'Session'}
Date: ${formatDate(appointment.appointment_date)}
Duration: ${appointment.duration || 60} minutes

CLIENT PRESENTATION:
- Client arrived on time
- Appeared ${['calm', 'anxious', 'engaged', 'withdrawn'][Math.floor(Math.random() * 4)]}
- ${appointment.notes || 'No specific concerns noted at start of session'}

INTERVENTIONS USED:
- Active listening and reflection
- Cognitive behavioral techniques
- Psychoeducation on ${['anxiety management', 'emotional regulation', 'communication skills', 'stress management'][Math.floor(Math.random() * 4)]}

CLIENT RESPONSE:
- Client engaged in discussion
- Demonstrated understanding of concepts
- Expressed willingness to practice techniques

PROGRESS NOTES:
- Client is making progress toward treatment goals
- Continue with current treatment plan

PLAN:
- Continue weekly sessions
- Assign homework: practice techniques discussed
- Review progress in next session

CLINICIAN: ${currentUser.name || 'Clinician'}
DATE: ${new Date().toLocaleDateString()}`;
        
        textarea.value = aiNote;
        textarea.disabled = false;
        
        logAudit('ai_note_generated', {
            appointment_id: appointmentId,
            client_name: appointment.client_name
        });
        
        showNotification('AI note generated successfully!', 'success');
    }, 1500);
}

function saveClinicalNote() {
    const appointmentId = document.getElementById('appointmentDetailPanel').getAttribute('data-appointment-id');
    const clinicalNotes = document.getElementById('detailClinicalNotes').value;
    
    if (!appointmentId) {
        showNotification('No appointment selected', 'error');
        return;
    }
    
    if (!clinicalNotes.trim()) {
        showNotification('Please enter clinical notes before saving', 'error');
        return;
    }
    
    // Find and update the appointment
    const appointment = appointments.find(apt => apt.id == appointmentId);
    if (appointment) {
        appointment.clinical_notes = clinicalNotes;
        appointment.clinical_notes_updated = new Date().toISOString();
        
        // Save to localStorage
        saveToStorage('appointments', appointments);
        
        // Log the update
        logAudit('clinical_notes_saved', {
            appointment_id: appointmentId,
            client_name: appointment.client_name
        });
        
        showNotification('Clinical notes saved successfully!', 'success');
    } else {
        showNotification('Appointment not found', 'error');
    }
}

function signClinicalNote() {
    const appointmentId = document.getElementById('appointmentDetailPanel').getAttribute('data-appointment-id');
    const clinicalNotes = document.getElementById('detailClinicalNotes').value;
    
    if (!appointmentId) {
        showNotification('No appointment selected', 'error');
        return;
    }
    
    if (!clinicalNotes.trim()) {
        showNotification('Please enter clinical notes before signing', 'error');
        return;
    }
    
    // Find the appointment
    const appointment = appointments.find(apt => apt.id == appointmentId);
    if (!appointment) {
        showNotification('Appointment not found', 'error');
        return;
    }
    
    // Check if already signed
    if (appointment.clinical_signature && appointment.clinical_signature_timestamp) {
        const signedDate = new Date(appointment.clinical_signature_timestamp).toLocaleString();
        if (!confirm(`This note was already signed by ${appointment.clinical_signature} on ${signedDate}. Sign again?`)) {
            return;
        }
    }
    
    // Get clinician name
    const clinicianName = currentUser.name || 'Clinician';
    
    // Sign the note
    appointment.clinical_notes = clinicalNotes;
    appointment.clinical_signature = clinicianName;
    appointment.clinical_signature_timestamp = new Date().toISOString();
    appointment.clinical_notes_updated = new Date().toISOString();
    
    // Save to localStorage
    saveToStorage('appointments', appointments);
    
    // Auto-delete transcript after 7 days when note is signed
    if (appointment.session_transcript) {
        appointment.transcript_auto_delete = new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toISOString();
        saveToStorage('appointments', appointments);
    }
    
    // Log the signature
    logAudit('clinical_notes_signed', {
        appointment_id: appointmentId,
        client_name: appointment.client_name,
        clinician_name: clinicianName,
        timestamp: appointment.clinical_signature_timestamp
    });

    // Automatically mark appointment as complete and generate invoice
    if (appointment.status !== 'completed') {
        try {
            // Update appointment status
            appointment.status = 'completed';
            appointment.completed_at = new Date().toISOString();
            saveToStorage('appointments', appointments);

            // Auto-generate invoice
            const client = clients.find(c => c.id === appointment.client_id);
            if (client) {
                // Get service fee from billing settings
                const serviceFee = getServiceRate(appointment.cpt_code || '90834');
                const cptCode = appointment.cpt_code || '90834';

                // Get service name from CPT code
                const cptServiceNames = {
                    '90791': 'Psychiatric Diagnostic Evaluation',
                    '90834': 'Psychotherapy 45 min',
                    '90837': 'Psychotherapy 60 min',
                    '90847': 'Family Psychotherapy',
                    '90853': 'Group Psychotherapy'
                };
                const serviceName = cptServiceNames[cptCode] || 'Therapy Session';

                // Get practice info for invoice
                const practiceInfo = loadFromStorage('practice_info') || {
                    name: 'Your Practice Name',
                    address: 'Practice Address',
                    phone: 'Practice Phone'
                };

                // Create invoice
                const invoice = {
                    id: Date.now(),
                    client_id: appointment.client_id,
                    client_name: appointment.client_name,
                    invoice_number: generateInvoiceNumber(),
                    services: [{
                        description: serviceName,
                        cpt_code: cptCode,
                        amount: serviceFee
                    }],
                    total_amount: serviceFee,
                    due_date: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
                    appointment_id: appointment.id,
                    created_at: new Date().toISOString(),
                    status: 'pending',
                    payment_tracking: {
                        status: 'pending',
                        payment_history: [],
                        reminders_sent: 0
                    },
                    practice_info: practiceInfo
                };

                // Add to invoices
                invoices.push(invoice);
                saveToStorage('invoices', invoices);

                // Log audit
                logAudit('appointment_completed', {
                    appointment_id: appointment.id,
                    client_id: appointment.client_id,
                    invoice_id: invoice.id
                });

                // Send notification
                notifyInvoiceCreated(invoice);

                // Refresh displays
                renderCalendar();
                renderAppointmentsList();
                renderInvoices();
                refreshClientChartData();

                showNotification(`Clinical notes signed! Appointment completed & Invoice ${invoice.invoice_number} created for $${serviceFee.toFixed(2)}`, 'success');
            } else {
                showNotification('Clinical notes signed and locked successfully!', 'success');
            }
        } catch (error) {
            console.error('Error completing appointment and generating invoice:', error);
            showNotification('Notes signed, but error creating invoice', 'warning');
        }
    } else {
        showNotification('Clinical notes signed and locked successfully!', 'success');
    }

    // Disable editing
    document.getElementById('detailClinicalNotes').disabled = true;

    // Update button text
    const signButton = document.querySelector('.btn-sign-note');
    if (signButton) {
        signButton.textContent = ' Signed & Locked';
        signButton.disabled = true;
        signButton.style.opacity = '0.6';
    }
}

// Session Recording Functions
let mediaRecorder = null;
let audioChunks = [];
let recognition = null;
let recordingStartTime = null;
let recordingInterval = null;
let transcriptChunks = [];

async function startSessionRecording() {
    // Get appointment ID from either AI NoteTaker tab or appointment detail panel
    let appointmentId = currentAppointmentId;
    if (!appointmentId) {
        const detailPanel = document.getElementById('appointmentDetailPanel');
        if (detailPanel) {
            appointmentId = detailPanel.getAttribute('data-appointment-id');
        }
    }

    const appointment = appointments.find(apt => apt.id == appointmentId);

    if (!appointment) {
        showNotification('Appointment not found', 'error');
        return;
    }
    
    // Check for client consent
    const client = clients.find(c => c.id == appointment.client_id);
    if (!client || !client.ai_consent_signed) {
        if (!confirm(' Client consent for AI transcription is required. Has the client signed the AI consent form?\n\nClick OK to continue anyway (for testing) or Cancel to assign the consent form first.')) {
            return;
        }
    }
    
    try {
        // Request microphone access
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        
        // Set up MediaRecorder
        mediaRecorder = new MediaRecorder(stream);
        audioChunks = [];
        transcriptChunks = [];
        
        mediaRecorder.ondataavailable = (event) => {
            audioChunks.push(event.data);
        };
        
        mediaRecorder.onstop = () => {
            // Create audio blob
            const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
            
            // Save to appointment
            appointment.session_audio = URL.createObjectURL(audioBlob);
            appointment.session_transcript = transcriptChunks.join(' ');
            appointment.transcript_created_at = new Date().toISOString();
            
            saveToStorage('appointments', appointments);
            
            // Update UI
            document.getElementById('recordingStatus').textContent = ' Session Recorded';
            document.getElementById('recordingControls').style.display = 'none';
            document.getElementById('recordingTimer').style.display = 'none';
            document.getElementById('liveTranscript').style.display = 'none';
            document.getElementById('recordingActions').style.display = 'flex';
            document.getElementById('noteFormatSelector').style.display = 'block';
            
            // Stop all tracks
            stream.getTracks().forEach(track => track.stop());
            
            logAudit('session_recorded', {
                appointment_id: appointmentId,
                client_name: appointment.client_name,
                duration: Math.floor((Date.now() - recordingStartTime) / 1000)
            });
            
            showNotification('Session recorded successfully!', 'success');
        };
        
        // Start recording
        mediaRecorder.start();
        recordingStartTime = Date.now();
        
        // Start transcription (Web Speech API)
        if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            recognition = new SpeechRecognition();
            recognition.continuous = true;
            recognition.interimResults = true;
            recognition.lang = 'en-US';
            
            recognition.onresult = (event) => {
                let interimTranscript = '';
                let finalTranscript = '';
                
                for (let i = event.resultIndex; i < event.results.length; i++) {
                    const transcript = event.results[i][0].transcript;
                    if (event.results[i].isFinal) {
                        finalTranscript += transcript + ' ';
                    } else {
                        interimTranscript += transcript;
                    }
                }
                
                if (finalTranscript) {
                    transcriptChunks.push(finalTranscript.trim());
                }
                
                // Update live transcript display
                document.getElementById('transcriptText').textContent = 
                    transcriptChunks.join(' ') + (interimTranscript ? '\n' + interimTranscript : '');
            };
            
            recognition.onerror = (event) => {
                console.error('Speech recognition error:', event.error);
            };
            
            recognition.start();
        }
        
        // Start timer
        recordingInterval = setInterval(() => {
            const elapsed = Math.floor((Date.now() - recordingStartTime) / 1000);
            const minutes = Math.floor(elapsed / 60);
            const seconds = elapsed % 60;
            document.getElementById('recordingTimer').textContent = 
                `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }, 1000);
        
        // Update UI
        document.getElementById('recordingStatus').textContent = ' Recording Session';
        document.getElementById('recordingStatus').style.color = '#dc3545';
        document.getElementById('startRecordingBtn').style.display = 'none';
        document.getElementById('recordingTimer').style.display = 'block';
        document.getElementById('recordingTimer').classList.add('recording');
        document.getElementById('liveTranscript').style.display = 'block';
        
        // Add pause/stop buttons
        const controls = document.getElementById('recordingControls');
        controls.innerHTML = `
            <button class="btn btn-secondary" onclick="pauseRecording()"> Pause</button>
            <button class="btn btn-danger" onclick="stopRecording()"> Stop Recording</button>
        `;
        
        showNotification('Recording started', 'success');
        
    } catch (error) {
        console.error('Error starting recording:', error);
        showNotification('Failed to start recording. Please check microphone permissions.', 'error');
    }
}

function pauseRecording() {
    if (mediaRecorder && mediaRecorder.state === 'recording') {
        mediaRecorder.pause();
        if (recognition) recognition.stop();
        if (recordingInterval) clearInterval(recordingInterval);
        
        document.getElementById('recordingStatus').textContent = ' Recording Paused';
        
        const controls = document.getElementById('recordingControls');
        controls.innerHTML = `
            <button class="btn btn-primary" onclick="resumeRecording()"> Resume</button>
            <button class="btn btn-danger" onclick="stopRecording()"> Stop Recording</button>
        `;
    }
}

function resumeRecording() {
    if (mediaRecorder && mediaRecorder.state === 'paused') {
        mediaRecorder.resume();
        if (recognition) recognition.start();
        
        recordingInterval = setInterval(() => {
            const elapsed = Math.floor((Date.now() - recordingStartTime) / 1000);
            const minutes = Math.floor(elapsed / 60);
            const seconds = elapsed % 60;
            document.getElementById('recordingTimer').textContent = 
                `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }, 1000);
        
        document.getElementById('recordingStatus').textContent = ' Recording Session';
        
        const controls = document.getElementById('recordingControls');
        controls.innerHTML = `
            <button class="btn btn-secondary" onclick="pauseRecording()"> Pause</button>
            <button class="btn btn-danger" onclick="stopRecording()"> Stop Recording</button>
        `;
    }
}

function stopRecording() {
    if (mediaRecorder && mediaRecorder.state !== 'inactive') {
        mediaRecorder.stop();
        if (recognition) recognition.stop();
        if (recordingInterval) clearInterval(recordingInterval);
    }
}

function viewTranscript() {
    const appointmentId = document.getElementById('appointmentDetailPanel').getAttribute('data-appointment-id');
    const appointment = appointments.find(apt => apt.id == appointmentId);
    
    if (appointment && appointment.session_transcript) {
        alert('Session Transcript:\n\n' + appointment.session_transcript);
    } else {
        showNotification('No transcript available', 'error');
    }
}

function generateNoteFromTranscript() {
    const appointmentId = document.getElementById('appointmentDetailPanel').getAttribute('data-appointment-id');
    const appointment = appointments.find(apt => apt.id == appointmentId);
    
    if (!appointment || !appointment.session_transcript) {
        showNotification('No transcript available. Please record a session first.', 'error');
        return;
    }
    
    const format = document.getElementById('noteFormat').value;
    const transcript = appointment.session_transcript;
    
    // Show loading state
    const textarea = document.getElementById('detailClinicalNotes');
    textarea.value = 'Generating AI note from transcript...';
    textarea.disabled = true;
    
    // Simulate AI processing (in production, this would call an AI API)
    setTimeout(() => {
        const note = generateNoteFromTranscriptContent(transcript, format, appointment);
        textarea.value = note;
        textarea.disabled = false;
        
        logAudit('ai_note_generated_from_transcript', {
            appointment_id: appointmentId,
            client_name: appointment.client_name,
            format: format
        });
        
        showNotification('AI note generated successfully from transcript!', 'success');
    }, 2000);
}

function generateNoteFromTranscriptContent(transcript, format, appointment) {
    // Parse transcript for key information
    const lines = transcript.split('\n').filter(l => l.trim());
    
    let note = '';
    
    if (format === 'dap') {
        note = `DAP NOTE - ${appointment.type || 'Session'}
Date: ${formatDate(appointment.appointment_date)}
Duration: ${appointment.duration || 60} minutes

DATA:
${transcript.substring(0, 500)}...

ASSESSMENT:
Based on the session, the client demonstrated ${['engagement', 'progress', 'insight', 'resilience'][Math.floor(Math.random() * 4)]} in addressing ${appointment.notes || 'treatment goals'}. Current mental status appears stable with no immediate safety concerns.

PLAN:
- Continue with current treatment approach
- Review progress in next session
- ${appointment.notes ? 'Address concerns raised in session' : 'Maintain therapeutic alliance'}

CLINICIAN: ${currentUser.name || 'Clinician'}
DATE: ${new Date().toLocaleDateString()}`;
    } else if (format === 'soap') {
        note = `SOAP NOTE - ${appointment.type || 'Session'}
Date: ${formatDate(appointment.appointment_date)}

SUBJECTIVE:
${transcript.substring(0, 400)}...

OBJECTIVE:
Client presented ${['appropriately', 'calmly', 'anxiously', 'engaged'][Math.floor(Math.random() * 4)]}. Session duration: ${appointment.duration || 60} minutes.

ASSESSMENT:
Client is making progress toward treatment goals. No safety concerns identified.

PLAN:
Continue weekly sessions. Review progress in next appointment.

CLINICIAN: ${currentUser.name || 'Clinician'}
DATE: ${new Date().toLocaleDateString()}`;
    } else if (format === 'birp') {
        note = `BIRP NOTE - ${appointment.type || 'Session'}
Date: ${formatDate(appointment.appointment_date)}

BEHAVIOR:
${transcript.substring(0, 400)}...

INTERVENTION:
Used ${['active listening', 'CBT techniques', 'DBT skills', 'psychoeducation'][Math.floor(Math.random() * 4)]} to address client concerns.

RESPONSE:
Client responded ${['positively', 'thoughtfully', 'engaged', 'receptively'][Math.floor(Math.random() * 4)]} to interventions.

PLAN:
Continue treatment plan. Schedule follow-up appointment.

CLINICIAN: ${currentUser.name || 'Clinician'}
DATE: ${new Date().toLocaleDateString()}`;
    } else {
        // Narrative format
        note = `CLINICAL NOTE - ${appointment.type || 'Session'}
Date: ${formatDate(appointment.appointment_date)}
Duration: ${appointment.duration || 60} minutes

SUMMARY:
${transcript.substring(0, 600)}...

CLINICIAN: ${currentUser.name || 'Clinician'}
DATE: ${new Date().toLocaleDateString()}`;
    }
    
    return note;
}

function deleteRecording() {
    const appointmentId = document.getElementById('appointmentDetailPanel').getAttribute('data-appointment-id');
    const appointment = appointments.find(apt => apt.id == appointmentId);
    
    if (appointment && confirm('Are you sure you want to delete this recording and transcript?')) {
        delete appointment.session_transcript;
        delete appointment.session_audio;
        delete appointment.transcript_created_at;
        
        saveToStorage('appointments', appointments);
        
        // Reset UI
        document.getElementById('recordingStatus').textContent = 'Ready to Record';
        document.getElementById('recordingStatus').style.color = '';
        document.getElementById('recordingControls').innerHTML = `
            <button id="startRecordingBtn" class="btn btn-primary" onclick="startSessionRecording()">
                 Start Recording
            </button>
        `;
        document.getElementById('recordingTimer').style.display = 'none';
        document.getElementById('liveTranscript').style.display = 'none';
        document.getElementById('recordingActions').style.display = 'none';
        document.getElementById('noteFormatSelector').style.display = 'none';
        
        showNotification('Recording deleted', 'success');
    }
}

async function markAppointmentComplete() {
    if (!window.currentAppointmentId) {
        showNotification('No appointment selected', 'error');
        return;
    }
    
    const appointment = appointments.find(apt => apt.id === window.currentAppointmentId);
    if (!appointment) {
        showNotification('Appointment not found', 'error');
        return;
    }
    
    if (appointment.status === 'completed') {
        showNotification('Appointment is already completed', 'warning');
        return;
    }
    
    // Confirm completion
    if (!confirm(`Mark this appointment as completed and generate invoice for ${appointment.client_name}?`)) {
        return;
    }
    
    try {
        // Update appointment status
        appointment.status = 'completed';
        appointment.completed_at = new Date().toISOString();
        saveToStorage('appointments', appointments);
        
        // Auto-generate invoice
        const client = clients.find(c => c.id === appointment.client_id);
        if (!client) {
            showNotification('Client not found', 'error');
            return;
        }
        
        // Get service fee from billing settings
        const serviceFee = getServiceRate(appointment.cpt_code || '90834');
        const cptCode = appointment.cpt_code || '90834';
        
        // Get service name from CPT code
        const cptServiceNames = {
            '90791': 'Psychiatric Diagnostic Evaluation',
            '90834': 'Psychotherapy 45 min',
            '90837': 'Psychotherapy 60 min',
            '90847': 'Family Psychotherapy',
            '90853': 'Group Psychotherapy'
        };
        const serviceName = cptServiceNames[cptCode] || 'Therapy Session';

        // Get practice info for invoice
        const practiceInfo = loadFromStorage('practice_info') || {
            name: 'Your Practice Name',
            address: 'Practice Address',
            phone: 'Practice Phone'
        };

        // Create invoice
        const invoice = {
            id: Date.now(),
            client_id: appointment.client_id,
            client_name: appointment.client_name,
            invoice_number: generateInvoiceNumber(),
            services: [{
                description: serviceName,
                cpt_code: cptCode,
                amount: serviceFee
            }],
            total_amount: serviceFee,
            due_date: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
            appointment_id: appointment.id,
            created_at: new Date().toISOString(),
            status: 'pending',
            payment_tracking: {
                status: 'pending',
                payment_history: [],
                reminders_sent: 0
            },
            practice_info: practiceInfo
        };
        
        // Add to invoices
        invoices.push(invoice);
        saveToStorage('invoices', invoices);
        
        // Log audit
        logAudit('appointment_completed', {
            appointment_id: appointment.id,
            client_id: appointment.client_id,
            invoice_id: invoice.id
        });
        
        // Send notification
        notifyInvoiceCreated(invoice);
        
        // Refresh displays
        renderCalendar();
        renderAppointmentsList();
        renderInvoices();
        refreshClientChartData();
        
        // Close detail modal
        closeModal('appointmentDetailModal');
        
        showNotification(`Appointment completed! Invoice ${invoice.invoice_number} created for $${serviceFee.toFixed(2)}`, 'success');
        
    } catch (error) {
        console.error('Error marking appointment complete:', error);
        showNotification('Error completing appointment', 'error');
    }
}

function openNewAppointment() {
    console.log(' Opening new appointment modal, clients:', clients.length);

    // Prepare clients list with test client if enabled
    let clientsToDisplay = [...clients];
    if (isTestClientEnabled()) {
        const testClient = getTestClient();
        clientsToDisplay = [testClient, ...clients];
    }

    if (clientsToDisplay.length === 0) {
        alert('No clients found. Please add a client first.');
        return;
    }

    const select = document.getElementById('appointmentClient');
    select.innerHTML = '<option value="">Select Client</option>' +
        clientsToDisplay.map(c => {
            const badge = c.is_test_client ? ' [TEST]' : '';
            return `<option value="${c.id}">${c.name}${badge}</option>`;
        }).join('');

    // Set default date to today
    document.getElementById('appointmentDate').value = new Date().toISOString().split('T')[0];
    document.getElementById('newAppointmentModal').style.display = 'block';
}

// FLEXIBLE DATE PARSER - Handles multiple date formats including ISO
function parseAppointmentDate(appointment) {
    // Handle multiple date formats
    let dateValue = appointment.appointment_date ||
                    appointment.appointmentDate ||
                    appointment.date ||
                    appointment.dateTime;

    if (!dateValue) {
        console.warn('No date field found:', appointment);
        return null;
    }

    // Parse the date - works with both formats:
    // '2025-11-30' AND '2025-11-30T00:00:00.000Z'
    let parsedDate = new Date(dateValue);

    // Check if valid
    if (isNaN(parsedDate.getTime())) {
        console.warn('Could not parse date:', dateValue);
        return null;
    }

    // Combine with time if separate
    if (appointment.appointment_time || appointment.appointmentTime || appointment.time) {
        const timeStr = appointment.appointment_time || appointment.appointmentTime || appointment.time;
        const [hours, minutes] = timeStr.split(':');
        parsedDate.setHours(parseInt(hours), parseInt(minutes), 0, 0);
    }

    return parsedDate;
}

// FIXED CODE - Add this date validation function
function parseAppointmentDateTime(dateStr, timeStr) {
    // Validate inputs exist
    if (!dateStr || !timeStr) {
        console.error('Missing date or time:', { dateStr, timeStr });
        return null;
    }

    // Parse the date
    const dateTime = new Date(`${dateStr}T${timeStr}`);

    // Validate the result is a valid date
    if (isNaN(dateTime.getTime())) {
        console.error('Invalid date created:', { dateStr, timeStr });
        return null;
    }

    return dateTime;
}

async function saveAppointment() {
    console.log(' Saving appointment...');

    const clientId = document.getElementById('appointmentClient').value;
    const appointmentDate = document.getElementById('appointmentDate').value;
    const appointmentTime = document.getElementById('appointmentTime').value;

    if (!clientId) {
        showNotification('Please select a client', 'error');
        return;
    }

    if (!appointmentDate || !appointmentTime) {
        showNotification('Please select date and time', 'error');
        return;
    }

    const modality = document.getElementById('appointmentModality').value;

    // Check telehealth feature access
    if (modality === 'telehealth') {
        const access = window.featureGate && window.featureGate.checkFeature('integratedTelehealth');
        if (access && !access.allowed) {
            window.featureGate.showUpgradePrompt('integratedTelehealth');
            return;
        }
    }

    const appointmentData = {
        client_id: parseInt(clientId),
        title: document.getElementById('appointmentTitle').value || 'Session',
        appointment_date: appointmentDate,
        appointment_time: appointmentTime,
        duration_minutes: parseInt(document.getElementById('appointmentDuration').value),
        appointment_type: document.getElementById('appointmentType').value,
        cpt_code: document.getElementById('appointmentType').value,
        notes: document.getElementById('appointmentNotes').value,
        modality: modality,
        status: document.getElementById('appointmentStatus').value
    };

    console.log('[NOTE] Appointment data:', appointmentData);

    try {
        let telehealthInfo = null;

        // If telehealth, create WebRTC video room before saving
        if (modality === 'telehealth') {
            console.log(' Creating WebRTC video room for telehealth appointment...');
            try {
                const tempId = Date.now();
                const videoResponse = await fetch('/api/webrtc-signaling', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'create-room',
                        appointmentId: tempId,
                        roomName: `appointment-${tempId}`
                    })
                });

                const videoData = await videoResponse.json();
                if (videoData.success) {
                    telehealthInfo = {
                        room_id: videoData.room.roomId,
                        link: window.location.origin + videoData.link
                    };
                    appointmentData.telehealth_room_id = telehealthInfo.room_id;
                    appointmentData.telehealth_link = telehealthInfo.link;
                    console.log(' WebRTC room created:', telehealthInfo.room_id);
                }
            } catch (videoError) {
                console.error(' Error creating video room:', videoError);
            }
        }

        // Save appointment to database
        const response = await fetch('/api/appointments', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(appointmentData)
        });

        const result = await response.json();

        if (!response.ok) {
            throw new Error(result.error || 'Failed to save appointment');
        }

        if (!result.data || !result.data.id) {
            throw new Error('Failed to create appointment - no data returned from server');
        }

        await logAudit('create_appointment', { id: result.data.id, client_id: appointmentData.client_id });

        // Schedule SMS reminder - validate date before calling
        const appointmentDateTime = parseAppointmentDateTime(
            appointmentData.appointment_date,
            appointmentData.appointment_time
        );

        if (appointmentDateTime) {
            // Safe to format the date for SMS
            const formattedDate = appointmentDateTime.toLocaleDateString('en-US', {
                weekday: 'long', month: 'long', day: 'numeric'
            });
            const formattedTime = appointmentDateTime.toLocaleTimeString('en-US', {
                hour: 'numeric', minute: '2-digit', hour12: true
            });
            console.log(' SMS scheduled for:', formattedDate, formattedTime);

            try {
                await scheduleAppointmentSMSReminder(result.data);
            } catch (smsError) {
                console.error('Error scheduling SMS reminder:', smsError);
            }
        } else {
            console.error('Invalid date - SMS reminder not scheduled');
        }

        showNotification('Appointment saved successfully!', 'success');
        closeModal('newAppointmentModal');

        // Clear form
        document.getElementById('appointmentClient').value = '';
        document.getElementById('appointmentTitle').value = 'Session';
        document.getElementById('appointmentDate').value = '';
        document.getElementById('appointmentTime').value = '';
        document.getElementById('appointmentDuration').value = '60';
        document.getElementById('appointmentType').value = '';
        document.getElementById('appointmentNotes').value = '';
        document.getElementById('appointmentStatus').value = 'scheduled';

        // Reload appointments
        await loadAppointments();
        renderCalendar();
        renderAppointmentsList();

    } catch (error) {
        console.error(' Error saving appointment:', error);
        showNotification('Error: ' + error.message, 'error');
    }
}

// Invoices Management
async function loadInvoices() {
    try {
        // Invoices already loaded from localStorage
        renderInvoices();
    } catch (error) {
        console.error('Invoices error:', error);
    }
}

function renderInvoices() {
    const container = document.getElementById('invoicesList');
    
    // Load invoices from localStorage if not already loaded
    if (invoices.length === 0) {
        invoices = loadFromStorage('invoices') || [];
    }
    
    if (invoices.length === 0) {
        container.innerHTML = '<p>No invoices found.</p>';
        return;
    }
    
    container.innerHTML = invoices.map(invoice => {
        const statusClass = invoice.status;
        const dueDate = new Date(invoice.due_date);
        const isOverdue = invoice.status === 'pending' && dueDate < new Date();
        const displayStatus = isOverdue ? 'overdue' : invoice.status;
        
        return `<div class="invoice-card">
                    <div class="invoice-header">
                        <span class="invoice-number">${invoice.invoice_number}</span>
                        <span class="invoice-status ${displayStatus}">${displayStatus.toUpperCase()}</span>
                    </div>
                    <h4>${invoice.client_name}</h4>
                    <div class="invoice-amount">$${parseFloat(invoice.total_amount).toFixed(2)}</div>
                    <div class="invoice-details">
                        <p>Due: ${new Date(invoice.due_date).toLocaleDateString()}</p>
                        <p>Created: ${new Date(invoice.created_at).toLocaleDateString()}</p>
                        ${invoice.payment_date ? `<p>Paid: ${new Date(invoice.payment_date).toLocaleDateString()}</p>` : ''}
                    </div>
                    <div class="invoice-actions">
                        <button onclick="viewInvoice(${invoice.id})" class="btn btn-small">View</button>
                        ${invoice.status === 'pending' ? 
                            `<button onclick="openPaymentModal(${invoice.id})" class="btn btn-primary btn-small"> Pay Now</button>
                             <button onclick="markPaid(${invoice.id})" class="btn btn-success btn-small">Mark Paid</button>
                             <button onclick="window.open('https://thrizerusers.b2clogin.com/ThrizerUsers.onmicrosoft.com/b2c_1_signupsignin/oauth2/v2.0/authorize?response_type=code&redirect_uri=https%3A%2F%2Fauths.thrizer.com%2F_api%2Fauth%2Fauthenticate%2Fcallback&scope=https%3A%2F%2FThrizerUsers.onmicrosoft.com%2Fapi%2Fread&client_id=f9cdf777-115e-4338-89f7-1929859f6e85', '_blank')" class="btn btn-secondary btn-small" title="Submit to Thrizer for out-of-network claims">Submit OON Claim</button>` : 
                            ''
                        }
                        ${invoice.status === 'paid' ? 
                            `<button onclick="openRefundModal(${invoice.id})" class="btn btn-warning btn-small">Refund</button>` : 
                            ''
                        }
                    </div>
                </div>`;
    }).join('');
}

function viewInvoice(invoiceId) {
    const invoice = invoices.find(inv => inv.id === invoiceId);
    if (!invoice) {
        alert('Invoice not found');
        return;
    }

    const client = clients.find(c => c.id === invoice.client_id);
    const clientName = client ? client.name : invoice.client_name || 'Unknown Client';
    const clientAddress = client ? client.address : '';

    // Get practice info
    const practiceInfo = invoice.practice_info || loadFromStorage('practice_info') || {
        name: 'Your Practice Name',
        address: 'Practice Address',
        phone: 'Practice Phone'
    };

    // Create modal with invoice details
    const modal = document.createElement('div');
    modal.className = 'modal';
    modal.style.display = 'block';
    modal.innerHTML = `
        <div class="modal-content" style="max-width: 700px;">
            <span class="close" onclick="this.parentElement.parentElement.remove()">&times;</span>

            <!-- Practice Header -->
            <div style="text-align: center; padding: 20px; border-bottom: 3px solid #0F4C81; background: linear-gradient(135deg, #F5F7FA 0%, #E8EDF2 100%);">
                <h2 style="margin: 0 0 10px 0; color: #0F4C81;">${practiceInfo.name}</h2>
                <p style="margin: 0; color: #4A5568;">${practiceInfo.address || ''}</p>
                <p style="margin: 0; color: #4A5568;">${practiceInfo.phone || ''}</p>
            </div>

            <!-- Invoice Header -->
            <div style="padding: 20px; background: white;">
                <h3 style="margin: 0 0 15px 0; color: #333;">INVOICE</h3>
                <div style="display: flex; justify-content: space-between; margin-bottom: 20px;">
                    <div>
                        <p style="margin: 5px 0;"><strong>Invoice #:</strong> ${invoice.invoice_number}</p>
                        <p style="margin: 5px 0;"><strong>Date:</strong> ${new Date(invoice.created_at || invoice.date_issued).toLocaleDateString()}</p>
                        <p style="margin: 5px 0;"><strong>Due Date:</strong> ${new Date(invoice.due_date).toLocaleDateString()}</p>
                        <p style="margin: 5px 0;"><strong>Status:</strong> <span class="badge badge-${invoice.status}">${invoice.status.toUpperCase()}</span></p>
                    </div>
                    <div style="text-align: right;">
                        <p style="margin: 5px 0;"><strong>Bill To:</strong></p>
                        <p style="margin: 5px 0;">${clientName}</p>
                        ${clientAddress ? `<p style="margin: 5px 0; color: #666;">${clientAddress}</p>` : ''}
                    </div>
                </div>

                <!-- Services Table -->
                ${invoice.services ? `
                    <div style="margin: 20px 0;">
                        <table style="width: 100%; border-collapse: collapse;">
                            <thead>
                                <tr style="background: #f8f9fa; border-bottom: 2px solid #dee2e6;">
                                    <th style="padding: 12px; text-align: left;">CPT Code</th>
                                    <th style="padding: 12px; text-align: left;">Service Description</th>
                                    <th style="padding: 12px; text-align: right;">Amount</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${invoice.services.map(s => {
                                    const cptCode = s.cpt_code || 'N/A';
                                    const serviceName = s.description || '';
                                    const amount = s.amount || 0;
                                    return `
                                        <tr style="border-bottom: 1px solid #dee2e6;">
                                            <td style="padding: 12px; font-weight: 600; color: #0066cc;">${cptCode}</td>
                                            <td style="padding: 12px;">${serviceName}</td>
                                            <td style="padding: 12px; text-align: right; font-weight: 500;">$${amount.toFixed(2)}</td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                            <tfoot>
                                <tr style="background: linear-gradient(135deg, #0F4C81 0%, #1B5F9A 100%); color: white; font-weight: bold; font-size: 16px;">
                                    <td colspan="2" style="padding: 12px; text-align: right;">TOTAL:</td>
                                    <td style="padding: 12px; text-align: right;">$${parseFloat(invoice.total_amount).toFixed(2)}</td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                ` : ''}

                ${invoice.notes ? `
                    <div style="margin: 20px 0; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                        <p style="margin: 0;"><strong>Notes:</strong></p>
                        <p style="margin: 5px 0 0 0;">${invoice.notes}</p>
                    </div>
                ` : ''}

                ${invoice.payment_tracking && invoice.payment_tracking.amount_paid > 0 ? `
                    <div style="margin-top: 20px; padding: 15px; background: #d4edda; border: 1px solid #c3e6cb; border-radius: 8px;">
                        <h4 style="margin: 0 0 10px 0; color: #155724;">Payment Information</h4>
                        <p style="margin: 5px 0;"><strong>Amount Paid:</strong> $${(invoice.payment_tracking.amount_paid || 0).toFixed(2)}</p>
                        <p style="margin: 5px 0;"><strong>Balance:</strong> $${(parseFloat(invoice.total_amount) - (invoice.payment_tracking.amount_paid || 0)).toFixed(2)}</p>
                    </div>
                ` : ''}
            </div>

            <!-- Sessionably Footer -->
            <div style="text-align: center; padding: 15px; background: #f8f9fa; border-top: 1px solid #dee2e6; font-size: 12px; color: #6c757d;">
                <p style="margin: 0;">Provided by Sessionably</p>
            </div>

            <!-- Actions -->
            <div style="text-align: right; padding: 20px; background: white;">
                ${invoice.status === 'pending' ?
                    `<button onclick="markPaid(${invoice.id}); this.parentElement.parentElement.parentElement.remove();" class="btn btn-success">Mark Paid</button>` :
                    ''
                }
                <button onclick="this.parentElement.parentElement.remove()" class="btn">Close</button>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
}

async function markPaid(invoiceId) {
    const invoice = invoices.find(inv => inv.id === invoiceId);
    if (!invoice) {
        showNotification('Invoice not found', 'error');
        return;
    }
    
    if (invoice.status === 'paid') {
        showNotification('Invoice is already marked as paid', 'warning');
        return;
    }
    
    try {
        // Update invoice status
        invoice.status = 'paid';
        invoice.payment_date = new Date().toISOString();
        
        // Initialize payment tracking if it doesn't exist
        if (!invoice.payment_tracking) {
            invoice.payment_tracking = {
                status: 'paid',
                payment_history: [],
                reminders_sent: 0
            };
        }
        
        // Add payment record
        invoice.payment_tracking.payment_history.push({
            amount: invoice.total_amount,
            date: new Date().toISOString(),
            method: 'manual',
            reference_number: 'MANUAL-' + Date.now()
        });
        
        // Save to localStorage
        saveToStorage('invoices', invoices);
        
        // Log audit event
        logAudit('invoice_marked_paid', {
            invoice_id: invoiceId,
            amount: invoice.total_amount,
            method: 'manual'
        });
        
        showNotification('Invoice marked as paid', 'success');
        
        // Send payment received notification
        notifyPaymentReceived(invoice);
        
        // Refresh displays
        renderInvoices();
        refreshClientChartData();
        
    } catch (error) {
        console.error('Error marking invoice as paid:', error);
        showNotification('Error marking invoice as paid', 'error');
    }
}

function openNewInvoice() {
    console.log(' Opening new invoice modal, clients:', clients.length);
    
    if (clients.length === 0) {
        alert('No clients found. Please add a client first.');
        return;
    }
    
    const select = document.getElementById('invoiceClient');
    select.innerHTML = '<option value="">Select Client</option>' + 
        clients.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
    
    // Set default due date to 30 days from now
    const dueDate = new Date();
    dueDate.setDate(dueDate.getDate() + 30);
    document.getElementById('invoiceDueDate').value = dueDate.toISOString().split('T')[0];
    
    document.getElementById('newInvoiceModal').style.display = 'block';
}

function addService() {
    const servicesList = document.getElementById('servicesList');
    const serviceItem = document.createElement('div');
    serviceItem.className = 'service-item';
    serviceItem.style.display = 'flex';
    serviceItem.style.gap = '10px';
    serviceItem.style.marginBottom = '10px';
    serviceItem.innerHTML = `
        <input type="text" placeholder="Service Description" class="input service-desc" style="flex: 2;">
        <select class="input service-cpt" style="flex: 1;" onchange="updateServiceFromCPT(this)">
            <option value="">CPT Code</option>
            <option value="90791">90791 - Psychiatric Diagnostic Evaluation</option>
            <option value="90834">90834 - Psychotherapy 45 min</option>
            <option value="90837">90837 - Psychotherapy 60 min</option>
            <option value="90847">90847 - Family Psychotherapy</option>
            <option value="90853">90853 - Group Psychotherapy</option>
        </select>
        <input type="number" placeholder="Amount" class="input service-amount" step="0.01" style="flex: 1;" onchange="updateInvoiceTotal()">
        <button onclick="removeService(this)" class="btn btn-danger btn-small">Remove</button>
    `;
    servicesList.appendChild(serviceItem);
    updateInvoiceTotal();
}

function removeService(button) {
    button.parentElement.remove();
    updateInvoiceTotal();
}

function updateInvoiceTotal() {
    const amounts = Array.from(document.querySelectorAll('.service-amount')).map(input => 
        parseFloat(input.value) || 0
    );
    const total = amounts.reduce((sum, amount) => sum + amount, 0);
    document.getElementById('invoiceTotal').textContent = total.toFixed(2);
}

function updateServiceFromCPT(selectElement) {
    const cptCode = selectElement.value;
    const serviceItem = selectElement.closest('.service-item');
    const descInput = serviceItem.querySelector('.service-desc');
    const amountInput = serviceItem.querySelector('.service-amount');
    
    // CPT code to service mapping
    const cptServices = {
        '90791': { name: 'Psychiatric Diagnostic Evaluation', rate: 200.00 },
        '90834': { name: 'Psychotherapy 45 min', rate: 150.00 },
        '90837': { name: 'Psychotherapy 60 min', rate: 180.00 },
        '90847': { name: 'Family Psychotherapy', rate: 200.00 },
        '90853': { name: 'Group Psychotherapy', rate: 100.00 }
    };
    
    if (cptCode && cptServices[cptCode]) {
        const service = cptServices[cptCode];
        descInput.value = service.name;
        amountInput.value = service.rate.toFixed(2);
        updateInvoiceTotal();
    } else {
        descInput.value = '';
        amountInput.value = '';
        updateInvoiceTotal();
    }
}

async function saveInvoice() {
    console.log(' Saving invoice...');
    
    const clientId = document.getElementById('invoiceClient').value;
    if (!clientId) {
        alert('Please select a client');
        return;
    }
    
    const services = Array.from(document.querySelectorAll('.service-item')).map(item => {
        const desc = item.querySelector('.service-desc').value;
        const cpt = item.querySelector('.service-cpt').value;
        const amount = parseFloat(item.querySelector('.service-amount').value) || 0;
        return { description: desc, cpt_code: cpt, amount: amount };
    }).filter(service => service.description && service.amount > 0);
    
    if (services.length === 0) {
        alert('Please add at least one service with a description and amount');
        return;
    }
    
    const dueDate = document.getElementById('invoiceDueDate').value;
    if (!dueDate) {
        alert('Please select a due date');
        return;
    }
    
    const totalAmount = services.reduce((sum, service) => sum + service.amount, 0);
    
    const invoice = {
        client_id: document.getElementById('invoiceClient').value,
        client_name: clients.find(c => c.id == document.getElementById('invoiceClient').value)?.name,
        services: services,
        total_amount: totalAmount,
        due_date: document.getElementById('invoiceDueDate').value,
        notes: document.getElementById('invoiceNotes').value,
        invoice_number: generateInvoiceNumber(),
        payment_tracking: {
            status: 'pending',
            payment_history: [],
            reminders_sent: 0
        },
        insurance_info: {
            claim_id: '',
            insurance_provider: '',
            coverage_percentage: 0
        }
    };
    
    try {
        // Add ID and timestamp
        invoice.id = Date.now();
        invoice.created_at = new Date().toISOString();
        invoice.status = 'pending';
        
        // Save to localStorage
        invoices.push(invoice);
        saveToStorage('invoices', invoices);
        
        await logAudit('create_invoice', { id: invoice.id, client_id: invoice.client_id, amount: totalAmount });
        closeModal('newInvoiceModal');
        renderInvoices();
        
        // Send invoice created notification
        notifyInvoiceCreated(invoice);
        
        // Check if email invoice option is selected
        const emailInvoiceOption = document.getElementById('emailInvoiceOption').checked;
        if (emailInvoiceOption) {
            console.log(' Email invoice option selected, sending email...');
            try {
                await sendInvoiceEmail(invoice);
                console.log(' Invoice email sent successfully');
            } catch (error) {
                console.error(' Error sending invoice email:', error);
                showNotification('Invoice created but email failed to send. Please try again.', 'warning');
            }
        }
        
        // If invoice was created from client chart, reopen it
        if (window.pendingInvoiceClientId) {
            const clientId = window.pendingInvoiceClientId;
            window.pendingInvoiceClientId = null;
            
            // Small delay to ensure modal closes properly
            setTimeout(() => {
                openClientChart(clientId);
                // Switch to invoices tab to show the new invoice
                setTimeout(() => {
                    const invoicesTabBtn = document.querySelector('.chart-tab-btn[onclick*="invoices"]');
                    if (invoicesTabBtn) {
                        invoicesTabBtn.click();
                    }
                }, 100);
            }, 300);
        }
        
        // ALWAYS refresh client chart if it's open (for instant population)
        refreshClientChartData();
        
        alert(' Invoice created!');
    } catch (error) {
        alert('Error: ' + error.message);
    }
}

// Stripe Payment Processing Functions
async function processPayment(invoiceId) {
    const invoice = invoices.find(inv => inv.id == invoiceId);
    if (!invoice) {
        showNotification('Invoice not found', 'error');
        return;
    }
    
    const saveForFuture = document.getElementById('save-payment-method')?.checked || false;
    const enableAutopay = document.getElementById('enable-autopay')?.checked || false;
    
    try {
        let result;
        
        // Check if using saved payment method
        if (selectedPaymentMethod) {
            // Use saved payment method
            const response = await fetch('/api/create-payment-intent', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    amount: Math.round(invoice.total_amount * 100),
                    currency: 'usd',
                    invoice_id: invoice.id,
                    client_name: invoice.client_name,
                    client_id: invoice.client_id,
                    payment_method_id: selectedPaymentMethod.stripe_payment_method_id
                })
            });
            
            const data = await response.json();
            
            if (data.requiresAction) {
                // Handle 3D Secure or other actions
                result = await stripe.confirmCardPayment(data.clientSecret);
            } else {
                result = { paymentIntent: { id: data.paymentIntentId, status: data.status } };
            }
        } else {
            // Create payment intent for new card
            const response = await fetch('/api/create-payment-intent', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    amount: Math.round(invoice.total_amount * 100),
                    currency: 'usd',
                    invoice_id: invoice.id,
                    client_name: invoice.client_name,
                    client_id: invoice.client_id,
                    save_for_future: saveForFuture,
                    enable_autopay: enableAutopay
                })
            });
            
            const { clientSecret } = await response.json();
            
            // Confirm payment with Stripe
            result = await stripe.confirmCardPayment(clientSecret, {
                payment_method: {
                    card: window.cardElement,
                    billing_details: {
                        name: invoice.client_name
                    }
                }
            });
            
            // If payment succeeded and user wants to save, attach to customer
            if (result.paymentIntent && result.paymentIntent.status === 'succeeded' && saveForFuture) {
                try {
                    const paymentMethodId = result.paymentIntent.payment_method;
                    await fetch('/api/payment-methods', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            client_id: invoice.client_id,
                            payment_method_id: paymentMethodId,
                            save_for_future: true,
                            enable_autopay: enableAutopay
                        })
                    });
                } catch (error) {
                    console.error('Error saving payment method:', error);
                }
            }
        }
        
        if (result.error) {
            showNotification('Payment failed: ' + result.error.message, 'error');
            notifyPaymentFailed(invoice, result.error.message);
        } else {
            // Payment succeeded
            invoice.status = 'paid';
            invoice.payment_date = new Date().toISOString();
            
            if (!invoice.payment_tracking) {
                invoice.payment_tracking = {
                    status: 'paid',
                    payment_history: [],
                    reminders_sent: 0
                };
            }
            
            invoice.payment_tracking.status = 'paid';
            invoice.payment_tracking.payment_history.push({
                amount: invoice.total_amount,
                date: new Date().toISOString(),
                method: 'card',
                transaction_id: result.paymentIntent.id
            });
            
            saveToStorage('invoices', invoices);
            
            logAudit('payment_processed', {
                invoice_id: invoice.id,
                amount: invoice.total_amount,
                transaction_id: result.paymentIntent.id
            });
            
            showNotification('Payment successful!', 'success');
            
            // Send payment received notification
            notifyPaymentReceived(invoice);
            
            closeModal('paymentModal');
            renderInvoices();
            
            // Refresh client chart if open
            refreshClientChartData();
        }
    } catch (error) {
        console.error('Payment error:', error);
        showNotification('Payment processing error', 'error');
    }
}

// Global variables for payment methods
let paymentMethods = [];
let selectedPaymentMethod = null;

async function openPaymentModal(invoiceId) {
    const invoice = invoices.find(inv => inv.id == invoiceId);
    if (!invoice) {
        showNotification('Invoice not found', 'error');
        return;
    }
    
    // Load saved payment methods for this client
    await loadPaymentMethods(invoice.client_id);
    
    // Create payment modal
    const modal = document.createElement('div');
    modal.className = 'modal';
    modal.id = 'paymentModal';
    modal.innerHTML = `
        <div class="modal-content" style="max-width: 550px;">
            <span class="close" onclick="closeModal('paymentModal')">&times;</span>
            <h2>Process Payment</h2>
            <div class="payment-details" style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                <h3 style="margin: 0 0 10px 0;">Invoice #${invoice.invoice_number}</h3>
                <p style="margin: 5px 0;"><strong>Client:</strong> ${invoice.client_name}</p>
                <p style="margin: 5px 0;"><strong>Amount:</strong> $${invoice.total_amount.toFixed(2)}</p>
            </div>
            
            ${paymentMethods.length > 0 ? `
                <div style="margin-bottom: 20px;">
                    <h3 style="font-size: 14px; margin-bottom: 10px;">Saved Payment Methods</h3>
                    <div id="saved-payment-methods" style="margin-bottom: 15px;">
                        ${paymentMethods.map(pm => `
                            <label class="payment-method-option" style="display: flex; align-items: center; padding: 12px; border: 2px solid #e9ecef; border-radius: 8px; margin-bottom: 10px; cursor: pointer; transition: all 0.2s;">
                                <input type="radio" name="payment-method" value="${pm.id}" onchange="selectPaymentMethod(${pm.id})" style="margin-right: 10px;">
                                <div style="flex: 1;">
                                    <div style="display: flex; align-items: center; gap: 10px;">
                                        <span class="card-brand-icon" style="font-size: 24px;">${getCardBrandIcon(pm.brand)}</span>
                                        <div>
                                            <div style="font-weight: 600;">   ${pm.last4}</div>
                                            <div style="font-size: 12px; color: #6c757d;">${pm.brand ? pm.brand.toUpperCase() : 'Card'} ${pm.expiry_month && pm.expiry_year ? `- ${pm.expiry_month}/${pm.expiry_year}` : ''}</div>
                                            ${pm.is_default ? '<span style="background: #00a86b; color: white; padding: 2px 8px; border-radius: 4px; font-size: 11px; margin-left: 8px;">DEFAULT</span>' : ''}
                                        </div>
                                    </div>
                                </div>
                            </label>
                        `).join('')}
                    </div>
                    <div style="text-align: center; margin: 15px 0;">
                        <button onclick="showNewCardForm()" class="btn btn-secondary" style="padding: 8px 20px; font-size: 14px;">+ Use Different Card</button>
                    </div>
                </div>
            ` : ''}
            
            <div id="new-card-form" style="${paymentMethods.length > 0 ? 'display: none;' : ''}">
                <h3 style="font-size: 14px; margin-bottom: 10px;">${paymentMethods.length > 0 ? 'New Card Details' : 'Payment Information'}</h3>
                <div id="card-element" style="margin: 15px 0; padding: 15px; border: 1px solid #e9ecef; border-radius: 8px; background: white;">
                    <!-- Stripe Elements will create form elements here -->
                </div>
                <div id="card-errors" role="alert" style="color: #dc3545; font-size: 14px; margin-bottom: 15px;"></div>
                
                <div style="margin: 15px 0;">
                    <label style="display: flex; align-items: center; cursor: pointer; padding: 10px; border: 1px solid #e9ecef; border-radius: 8px;">
                        <input type="checkbox" id="save-payment-method" style="margin-right: 10px;">
                        <div>
                            <div style="font-weight: 500;">Save for future payments</div>
                            <div style="font-size: 12px; color: #6c757d;">Securely store this card with Stripe</div>
                        </div>
                    </label>
                </div>
                
                <div style="margin: 15px 0;">
                    <label style="display: flex; align-items: center; cursor: pointer; padding: 10px; border: 1px solid #e9ecef; border-radius: 8px;">
                        <input type="checkbox" id="enable-autopay" style="margin-right: 10px;">
                        <div>
                            <div style="font-weight: 500;">Enable autopay for future invoices</div>
                            <div style="font-size: 12px; color: #6c757d;">Automatically charge this card when invoices are created</div>
                        </div>
                    </label>
                </div>
            </div>
            
            <button onclick="processPayment(${invoiceId})" class="btn btn-primary" style="width: 100%; padding: 15px; font-size: 16px; font-weight: 600;">
                Pay $${invoice.total_amount.toFixed(2)}
            </button>
        </div>
    `;
    
    document.body.appendChild(modal);
    modal.style.display = 'block';
    
    // Initialize Stripe Elements
    const elements = stripe.elements();
    const cardElement = elements.create('card', {
        style: {
            base: {
                fontSize: '16px',
                color: '#424770',
                '::placeholder': {
                    color: '#aab7c4',
                },
            },
        },
    });
    cardElement.mount('#card-element');
    
    // Store card element globally
    window.cardElement = cardElement;
    
    // Handle real-time validation errors
    cardElement.on('change', ({error}) => {
        const displayError = document.getElementById('card-errors');
        if (error) {
            displayError.textContent = error.message;
        } else {
            displayError.textContent = '';
        }
    });
}

function getCardBrandIcon(brand) {
    const icons = {
        'visa': '',
        'mastercard': '',
        'amex': '',
        'discover': ''
    };
    return icons[brand?.toLowerCase()] || '';
}

function selectPaymentMethod(pmId) {
    selectedPaymentMethod = paymentMethods.find(pm => pm.id === pmId);
    document.getElementById('new-card-form').style.display = 'none';
}

function showNewCardForm() {
    document.querySelectorAll('input[name="payment-method"]').forEach(radio => radio.checked = false);
    selectedPaymentMethod = null;
    document.getElementById('new-card-form').style.display = 'block';
}

async function loadPaymentMethods(clientId) {
    try {
        const response = await fetch(`/api/payment-methods?client_id=${clientId}`);
        const result = await response.json();
        paymentMethods = result.data || [];
    } catch (error) {
        console.error('Error loading payment methods:', error);
        paymentMethods = [];
    }
}

// Thrizer Integration
function submitToThrizer(invoiceId) {
    const invoice = invoices.find(inv => inv.id == invoiceId);
    if (!invoice) {
        showNotification('Invoice not found', 'error');
        return;
    }
    
    // Prepare invoice details for clipboard
    const invoiceDetails = `
Invoice Number: ${invoice.invoice_number}
Client: ${invoice.client_name}
Amount: $${invoice.total_amount.toFixed(2)}
Date: ${new Date(invoice.created_at).toLocaleDateString()}
Due Date: ${new Date(invoice.due_date).toLocaleDateString()}
Services:
${invoice.services ? invoice.services.map(s => {
    const cptCode = s.cpt_code || '';
    const serviceName = s.description || '';
    const amount = s.amount || 0;
    const displayText = cptCode ? `  - ${cptCode} (${serviceName}): $${amount.toFixed(2)}` : `  - ${serviceName}: $${amount.toFixed(2)}`;
    return displayText;
}).join('\n') : 'N/A'}
    `.trim();
    
    // Copy to clipboard
    navigator.clipboard.writeText(invoiceDetails).then(() => {
        showNotification('Invoice details copied! Opening OON claim portal...', 'success');
        
        // Open Thrizer in new tab
        setTimeout(() => {
            window.open('https://app.thrizer.com/clinician/teams/thrizergYfjxDe/', '_blank');
        }, 500);
        
        // Update invoice status (optional - manual tracking)
        if (!invoice.thrizer_claim_status) {
            invoice.thrizer_claim_status = 'submitted';
            saveToStorage('invoices', invoices);
        }
    }).catch(err => {
        console.error('Failed to copy:', err);
        showNotification('Failed to copy details. Opening OON claim portal...', 'warning');
        window.open('https://app.thrizer.com/clinician/teams/thrizergYfjxDe/', '_blank');
    });
}

// Refund Processing
async function openRefundModal(invoiceId) {
    const invoice = invoices.find(inv => inv.id == invoiceId);
    if (!invoice) {
        showNotification('Invoice not found', 'error');
        return;
    }
    
    if (invoice.status !== 'paid') {
        showNotification('Can only refund paid invoices', 'error');
        return;
    }
    
    const modal = document.createElement('div');
    modal.className = 'modal';
    modal.id = 'refundModal';
    modal.innerHTML = `
        <div class="modal-content" style="max-width: 500px;">
            <span class="close" onclick="closeModal('refundModal')">&times;</span>
            <h2>Process Refund</h2>
            <div class="payment-details" style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                <p style="margin: 5px 0;"><strong>Invoice:</strong> ${invoice.invoice_number}</p>
                <p style="margin: 5px 0;"><strong>Client:</strong> ${invoice.client_name}</p>
                <p style="margin: 5px 0;"><strong>Amount Paid:</strong> $${invoice.total_amount.toFixed(2)}</p>
                ${invoice.refund_amount ? `<p style="margin: 5px 0; color: #dc3545;"><strong>Already Refunded:</strong> $${invoice.refund_amount.toFixed(2)}</p>` : ''}
            </div>
            
            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 10px; font-weight: 500;">Refund Type</label>
                <select id="refund-type" class="input" onchange="updateRefundAmount()">
                    <option value="full">Full Refund ($${invoice.total_amount.toFixed(2)})</option>
                    <option value="partial">Partial Refund</option>
                </select>
            </div>
            
            <div id="partial-amount-section" style="display: none; margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 10px; font-weight: 500;">Refund Amount</label>
                <input type="number" id="refund-amount" class="input" min="0.01" max="${invoice.total_amount}" step="0.01" placeholder="0.00">
            </div>
            
            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 10px; font-weight: 500;">Reason for Refund</label>
                <select id="refund-reason" class="input">
                    <option value="">Select reason...</option>
                    <option value="duplicate">Duplicate payment</option>
                    <option value="fraudulent">Fraudulent transaction</option>
                    <option value="requested_by_customer">Requested by customer</option>
                    <option value="cancelled">Cancelled service</option>
                    <option value="other">Other</option>
                </select>
            </div>
            
            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 10px; font-weight: 500;">Additional Notes</label>
                <textarea id="refund-notes" class="input" rows="3" placeholder="Optional details..."></textarea>
            </div>
            
            <button onclick="processRefund(${invoiceId})" class="btn btn-warning" style="width: 100%; padding: 12px;">
                Process Refund
            </button>
        </div>
    `;
    
    document.body.appendChild(modal);
    modal.style.display = 'block';
}

function updateRefundAmount() {
    const refundType = document.getElementById('refund-type').value;
    const partialSection = document.getElementById('partial-amount-section');
    
    if (refundType === 'partial') {
        partialSection.style.display = 'block';
    } else {
        partialSection.style.display = 'none';
    }
}

async function processRefund(invoiceId) {
    const invoice = invoices.find(inv => inv.id == invoiceId);
    if (!invoice) {
        showNotification('Invoice not found', 'error');
        return;
    }
    
    const refundType = document.getElementById('refund-type').value;
    const refundAmount = refundType === 'full' 
        ? invoice.total_amount 
        : parseFloat(document.getElementById('refund-amount').value);
    const reason = document.getElementById('refund-reason').value;
    const notes = document.getElementById('refund-notes').value;
    
    if (!reason) {
        showNotification('Please select a reason for the refund', 'error');
        return;
    }
    
    if (refundType === 'partial' && (!refundAmount || refundAmount <= 0 || refundAmount > invoice.total_amount)) {
        showNotification('Please enter a valid refund amount', 'error');
        return;
    }
    
    try {
        const response = await fetch('/api/refunds', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                invoice_id: invoiceId,
                amount: refundAmount,
                reason: notes || reason,
                refund_type: refundType
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            // Update invoice locally
            invoice.refund_amount = (invoice.refund_amount || 0) + refundAmount;
            invoice.refund_reason = notes || reason;
            
            if (refundAmount >= invoice.total_amount) {
                invoice.status = 'refunded';
            } else {
                invoice.status = 'partially_refunded';
            }
            
            saveToStorage('invoices', invoices);
            
            logAudit('refund_processed', {
                invoice_id: invoiceId,
                amount: refundAmount,
                reason: notes || reason
            });
            
            showNotification(`Refund of $${refundAmount.toFixed(2)} processed successfully`, 'success');
            
            // Send refund processed notification
            notifyRefundProcessed(invoice, refundAmount);
            
            closeModal('refundModal');
            renderInvoices();
            
            // Refresh client chart if open
            refreshClientChartData();
        } else {
            showNotification('Refund failed: ' + (result.error || 'Unknown error'), 'error');
        }
    } catch (error) {
        console.error('Refund error:', error);
        showNotification('Refund processing error', 'error');
    }
}

// Enhanced Invoice Management Functions
function generateInvoiceNumber() {
    const today = new Date();
    const year = today.getFullYear();
    const month = String(today.getMonth() + 1).padStart(2, '0');
    const day = String(today.getDate()).padStart(2, '0');
    
    // Find the highest invoice number for today
    const todayInvoices = invoices.filter(inv => inv.invoice_number?.startsWith(`INV-${year}${month}${day}`));
    const nextNumber = todayInvoices.length + 1;
    
    return `INV-${year}${month}${day}-${String(nextNumber).padStart(3, '0')}`;
}

function generateInvoicesFromAppointments(appointmentIds, invoiceTemplate = null) {
    const selectedAppointments = appointments.filter(apt => appointmentIds.includes(apt.id));
    const generatedInvoices = [];
    
    selectedAppointments.forEach(appointment => {
        const client = clients.find(c => c.id === appointment.client_id);
        if (!client) return;
        
        // Generate invoice from appointment
        const invoice = {
            id: Date.now() + Math.random(),
            client_id: appointment.client_id,
            client_name: appointment.client_name || client.name,
            invoice_number: generateInvoiceNumber(),
            services: [{
                description: `Appointment - ${appointment.notes || 'Medical Consultation'}`,
                cpt_code: appointment.cpt_code || '99213', // Default CPT code
                amount: parseFloat(appointment.service_fee) || 150.00
            }],
            total_amount: parseFloat(appointment.service_fee) || 150.00,
            due_date: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toISOString().split('T')[0], // 30 days from now
            appointment_id: appointment.id,
            created_at: new Date().toISOString(),
            status: 'pending',
            payment_tracking: {
                status: 'pending',
                payment_history: [],
                reminders_sent: 0
            },
            insurance_info: {
                claim_id: '',
                insurance_provider: '',
                coverage_percentage: 0
            }
        };
        
        generatedInvoices.push(invoice);
    });
    
    // Add to invoices array and save
    invoices.push(...generatedInvoices);
    saveToStorage('invoices', invoices);
    
    logLocalAudit('bulk_invoice_generation', { 
        appointmentCount: selectedAppointments.length, 
        invoiceCount: generatedInvoices.length,
        totalAmount: generatedInvoices.reduce((sum, inv) => sum + inv.total_amount, 0)
    });
    
    return generatedInvoices;
}

function trackPayment(invoiceId, paymentData) {
    const invoice = invoices.find(inv => inv.id === invoiceId);
    if (!invoice) return;
    
    const payment = {
        id: Date.now(),
        amount: parseFloat(paymentData.amount),
        payment_method: paymentData.method || 'cash',
        payment_date: new Date().toISOString(),
        reference_number: paymentData.reference || '',
        notes: paymentData.notes || ''
    };
    
    // Add to payment history
    if (!invoice.payment_tracking) {
        invoice.payment_tracking = { status: 'pending', payment_history: [], reminders_sent: 0 };
    }
    
    invoice.payment_tracking.payment_history.push(payment);
    
    // Calculate total paid
    const totalPaid = invoice.payment_tracking.payment_history.reduce((sum, p) => sum + p.amount, 0);
    
    // Update status
    if (totalPaid >= invoice.total_amount) {
        invoice.status = 'paid';
        invoice.payment_tracking.status = 'completed';
        invoice.payment_date = payment.payment_date;
    } else {
        invoice.status = 'partial';
        invoice.payment_tracking.status = 'partial';
    }
    
    saveToStorage('invoices', invoices);
    logLocalAudit('invoice_payment', { 
        invoiceId, 
        amount: payment.amount, 
        totalPaid, 
        status: invoice.status 
    });
    
    return invoice;
}

function checkOverdueInvoices() {
    const today = new Date();
    const overdueInvoices = invoices.filter(inv => {
        if (inv.status === 'paid') return false;
        const dueDate = new Date(inv.due_date);
        return dueDate < today;
    });
    
    if (overdueInvoices.length > 0) {
        showNotification(`${overdueInvoices.length} invoices are overdue`, 'warning');
        logLocalAudit('overdue_invoices_check', { overdueCount: overdueInvoices.length });
        
        // Send reminders for overdue invoices
        overdueInvoices.forEach(invoice => {
            if (!invoice.payment_tracking) {
                invoice.payment_tracking = { status: 'pending', payment_history: [], reminders_sent: 0 };
            }
            
            if (invoice.payment_tracking.reminders_sent < 3) { // Max 3 reminders
                sendInvoiceReminder(invoice);
                invoice.payment_tracking.reminders_sent++;
                saveToStorage('invoices', invoices);
            }
        });
    }
    
    return overdueInvoices;
}

function sendInvoiceReminder(invoice) {
    // Simulate sending reminder (in real app, this would send email/SMS)
    const reminder = {
        id: Date.now(),
        invoice_id: invoice.id,
        sent_date: new Date().toISOString(),
        type: 'overdue_reminder',
        recipient: invoice.client_name,
        message: `Reminder: Invoice ${invoice.invoice_number} for $${invoice.total_amount.toFixed(2)} is overdue.`
    };
    
    logLocalAudit('invoice_reminder_sent', { 
        invoiceId: invoice.id, 
        clientName: invoice.client_name, 
        reminderNumber: invoice.payment_tracking.reminders_sent + 1 
    });
    
    return reminder;
}

function addInsuranceClaim(invoiceId, claimData) {
    const invoice = invoices.find(inv => inv.id === invoiceId);
    if (!invoice) return;
    
    if (!invoice.insurance_info) {
        invoice.insurance_info = { claim_id: '', insurance_provider: '', coverage_percentage: 0 };
    }
    
    invoice.insurance_info = {
        claim_id: claimData.claim_id,
        insurance_provider: claimData.provider,
        coverage_percentage: parseFloat(claimData.coverage_percentage) || 0,
        claim_date: new Date().toISOString(),
        claim_status: 'submitted'
    };
    
    saveToStorage('invoices', invoices);
    logLocalAudit('insurance_claim_added', { 
        invoiceId, 
        claimId: claimData.claim_id, 
        provider: claimData.provider 
    });
    
    return invoice;
}

function bulkInvoiceActions(action, invoiceIds) {
    const selectedInvoices = invoices.filter(inv => invoiceIds.includes(inv.id));
    
    switch (action) {
        case 'mark_paid':
            selectedInvoices.forEach(invoice => {
                invoice.status = 'paid';
                invoice.payment_date = new Date().toISOString();
                if (!invoice.payment_tracking) {
                    invoice.payment_tracking = { status: 'completed', payment_history: [], reminders_sent: 0 };
                } else {
                    invoice.payment_tracking.status = 'completed';
                }
            });
            break;
            
        case 'send_reminders':
            selectedInvoices.forEach(invoice => {
                if (invoice.status === 'pending') {
                    sendInvoiceReminder(invoice);
                    if (!invoice.payment_tracking) {
                        invoice.payment_tracking = { status: 'pending', payment_history: [], reminders_sent: 0 };
                    }
                    invoice.payment_tracking.reminders_sent++;
                }
            });
            break;
            
        case 'delete':
            if (confirm(`Are you sure you want to delete ${selectedInvoices.length} invoice(s)?`)) {
                invoices = invoices.filter(inv => !invoiceIds.includes(inv.id));
            }
            break;
    }
    
    saveToStorage('invoices', invoices);
    logLocalAudit('bulk_invoice_action', { action, invoiceCount: selectedInvoices.length });
    
    renderInvoices();
    return selectedInvoices;
}

function getInvoiceAnalytics() {
    const totalInvoices = invoices.length;
    const paidInvoices = invoices.filter(inv => inv.status === 'paid').length;
    const pendingInvoices = invoices.filter(inv => inv.status === 'pending').length;
    const overdueInvoices = checkOverdueInvoices().length;
    
    const totalRevenue = invoices.reduce((sum, inv) => sum + parseFloat(inv.total_amount), 0);
    const paidRevenue = invoices.filter(inv => inv.status === 'paid').reduce((sum, inv) => sum + parseFloat(inv.total_amount), 0);
    const outstandingRevenue = totalRevenue - paidRevenue;
    
    const avgPaymentTime = calculateAveragePaymentTime();
    
    return {
        totalInvoices,
        paidInvoices,
        pendingInvoices,
        overdueInvoices,
        totalRevenue,
        paidRevenue,
        outstandingRevenue,
        avgPaymentTime,
        paymentRate: totalInvoices > 0 ? (paidInvoices / totalInvoices * 100).toFixed(1) : 0
    };
}

function calculateAveragePaymentTime() {
    const paidInvoices = invoices.filter(inv => inv.status === 'paid' && inv.payment_date && inv.created_at);
    if (paidInvoices.length === 0) return 'N/A';
    
    const totalDays = paidInvoices.reduce((sum, inv) => {
        const created = new Date(inv.created_at);
        const paid = new Date(inv.payment_date);
        return sum + (paid - created) / (1000 * 60 * 60 * 24);
    }, 0);
    
    const avgDays = Math.round(totalDays / paidInvoices.length);
    return `${avgDays} days`;
}

// Enhanced showTab function
const originalShowTab = showTab;
showTab = function(tab) {
    document.querySelectorAll('.tab-content').forEach(el => el.style.display = 'none');
    document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
    document.getElementById(tab + 'Content').style.display = 'block';
    event.target.classList.add('active');

    if (tab === 'dashboard') {
        loadDashboard();
    } else if (tab === 'clients') {
        renderClients();
    } else if (tab === 'messages') {
        loadConversations();
    } else if (tab === 'appointments') {
        loadAppointments();
    } else if (tab === 'documents') {
        renderDocs();
    } else if (tab === 'invoices') {
        loadInvoices();
    } else if (tab === 'audit') {
        renderAudit();
    } else if (tab === 'analytics') {
        loadAnalyticsPage();
    } else if (tab === 'ainotetaker') {
        refreshAINoteTakerAppointments();
    }
};

// Enhanced UI Functions
function showNotification(message, type = 'info', duration = 5000) {
    const notification = document.createElement('div');
    notification.className = `notification ${type}`;
    notification.innerHTML = `
        <div style="display: flex; align-items: center; gap: 12px;">
            <span style="font-size: 18px;">
                ${type === 'success' ? '' : type === 'error' ? '' : type === 'warning' ? '' : ''}
            </span>
            <span>${message}</span>
            <button onclick="this.parentElement.parentElement.remove()" style="background: none; border: none; font-size: 18px; cursor: pointer; margin-left: auto;"></button>
        </div>
    `;
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
        if (notification.parentElement) {
            notification.style.animation = 'slideOutRight 0.3s ease-out forwards';
            setTimeout(() => notification.remove(), 300);
        }
    }, duration);
}

function setLoading(element, isLoading) {
    if (isLoading) {
        element.classList.add('loading');
        const spinner = element.querySelector('.loading-spinner');
        if (spinner) spinner.style.display = 'inline-block';
    } else {
        element.classList.remove('loading');
        const spinner = element.querySelector('.loading-spinner');
        if (spinner) spinner.style.display = 'none';
    }
}

function validateInput(input, validator) {
    const value = input.value.trim();
    const isValid = validator(value);
    
    if (isValid) {
        input.classList.remove('input-error');
        const errorMsg = input.parentElement.querySelector('.error-message');
        if (errorMsg) errorMsg.style.display = 'none';
    } else {
        input.classList.add('input-error');
        const errorMsg = input.parentElement.querySelector('.error-message');
        if (errorMsg) errorMsg.style.display = 'block';
    }
    
    return isValid;
}

// Enhanced form validation
const validators = {
    username: (value) => value.length >= 3,
    password: (value) => value.length >= 6,
    email: (value) => /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(value),
    phone: (value) => /^[\+]?[1-9][\d]{0,15}$/.test(value.replace(/[\s\-\(\)]/g, '')),
    required: (value) => value.length > 0
};

// New Dashboard Functions
function loadDashboard() {
    loadTodayAppointments();
    loadActiveClients();
    loadUnreadMessages();
    loadWeeklyRevenue();
    loadRecentActivity();
}

function loadTodayAppointments() {
    const today = new Date().toISOString().split('T')[0];
    const todayAppts = appointments.filter(apt => apt.appointment_date === today);

    // Update count
    document.getElementById('todayAppointmentsCount').textContent = todayAppts.length;

    // Render list
    const listEl = document.getElementById('todayAppointmentsList');
    if (todayAppts.length === 0) {
        listEl.innerHTML = '<p style="color: var(--text-secondary); text-align: center; padding: 20px;">No appointments scheduled for today</p>';
        return;
    }

    listEl.innerHTML = todayAppts.sort((a, b) => a.appointment_time.localeCompare(b.appointment_time)).map(apt => {
        const client = clients.find(c => c.id === apt.client_id);
        const statusClass = apt.status === 'completed' ? 'success' : apt.status === 'cancelled' ? 'error' : 'warning';
        const isUpcoming = apt.status !== 'completed' && apt.status !== 'cancelled';

        // Parse time for display
        const timeMatch = apt.appointment_time.match(/(\d{1,2}):(\d{2})/);
        let displayTime = apt.appointment_time;
        if (timeMatch) {
            const hour = parseInt(timeMatch[1]);
            const min = timeMatch[2];
            const ampm = hour >= 12 ? 'PM' : 'AM';
            const displayHour = hour > 12 ? hour - 12 : (hour === 0 ? 12 : hour);
            displayTime = `${displayHour}:${min} ${ampm}`;
        }

        return `
            <div style="padding: 20px; margin-bottom: 12px; background: #f8f9fa; border-radius: 8px; display: flex; align-items: center; gap: 20px;">
                <div style="min-width: 80px;">
                    <div style="font-weight: 700; font-size: 18px; color: var(--text-color);">${displayTime}</div>
                    <div style="font-size: 13px; color: var(--text-secondary);">${apt.duration_minutes || 45} min</div>
                </div>
                <div style="flex: 1;">
                    <h4 style="margin: 0 0 5px 0; font-size: 16px; font-weight: 600;">${client?.name || 'Unknown Client'}</h4>
                    <p style="margin: 0; color: var(--text-secondary); font-size: 14px;">
                        ${apt.appointment_type || 'Initial Consultation'}
                    </p>
                </div>
                <div>
                    ${isUpcoming ?
                        `<button onclick="viewAppointment(${apt.id}); event.stopPropagation();" class="btn btn-primary" style="background: #10b981; border: none; padding: 10px 20px; border-radius: 6px; font-weight: 600;">
                            Join
                        </button>` :
                        `<button onclick="viewAppointment(${apt.id}); event.stopPropagation();" class="btn btn-secondary" style="padding: 10px 20px; border-radius: 6px; font-weight: 600;">
                            View
                        </button>`
                    }
                </div>
            </div>
        `;
    }).join('');
}

function loadWeeklyRevenue() {
    const now = new Date();
    const weekAgo = new Date(now.getTime() - (7 * 24 * 60 * 60 * 1000));

    const weeklyInvoices = invoices.filter(inv => {
        const invDate = new Date(inv.created_at || inv.invoice_date);
        return invDate >= weekAgo && inv.status === 'paid';
    });

    const revenue = weeklyInvoices.reduce((sum, inv) => sum + (parseFloat(inv.total_amount) || 0), 0);
    document.getElementById('weeklyRevenue').textContent = '$' + revenue.toFixed(2);
}

function loadUnreadMessages() {
    // Since we don't have a messages array yet, we'll set to 0 for now
    // This can be updated when messages are implemented
    const unreadCount = 0;
    document.getElementById('unreadMessagesCount').textContent = unreadCount;
}

function loadPendingDocuments() {
    const pendingDocs = assignedDocs.filter(doc => doc.status === 'pending');
    document.getElementById('pendingDocumentsCount').textContent = pendingDocs.length;
}

function loadActiveClients() {
    // Count active clients (all clients that are not archived/inactive)
    const activeClients = clients.filter(client => client.status !== 'inactive' && client.status !== 'archived');
    document.getElementById('activeClientsCount').textContent = activeClients.length;
}

function loadRecentActivity() {
    const listEl = document.getElementById('recentActivityList');
    const activities = [];

    // Get recent appointments (last 5 created)
    const recentAppts = [...appointments]
        .sort((a, b) => new Date(b.created_at || 0) - new Date(a.created_at || 0))
        .slice(0, 3);

    recentAppts.forEach(apt => {
        const client = clients.find(c => c.id === apt.client_id);
        const timeAgo = getTimeAgo(new Date(apt.created_at));
        activities.push({
            iconBg: '#3b82f6',
            text: `New appointment booked`,
            detail: client?.name || 'Unknown Client',
            time: timeAgo
        });
    });

    // Get recent payments (last 2)
    const recentPayments = [...invoices]
        .filter(inv => inv.status === 'paid')
        .sort((a, b) => new Date(b.updated_at || b.created_at || 0) - new Date(a.updated_at || a.created_at || 0))
        .slice(0, 2);

    recentPayments.forEach(inv => {
        const client = clients.find(c => c.id === inv.client_id);
        const timeAgo = getTimeAgo(new Date(inv.updated_at || inv.created_at));
        activities.push({
            iconBg: '#10b981',
            text: `Payment received`,
            detail: `from ${client?.name || 'Unknown Client'}`,
            time: timeAgo
        });
    });

    // Sort by most recent
    activities.sort((a, b) => {
        // Simple sort - items are already relatively ordered
        return 0;
    });

    if (activities.length === 0) {
        listEl.innerHTML = '<p style="color: var(--text-secondary); text-align: center; padding: 20px;">No recent activity</p>';
        return;
    }

    listEl.innerHTML = activities.slice(0, 5).map(activity => `
        <div style="display: flex; align-items: center; gap: 15px; padding: 15px 0; border-bottom: 1px solid var(--border-color);">
            <div style="width: 40px; height: 40px; border-radius: 50%; background: ${activity.iconBg}; flex-shrink: 0;">
            </div>
            <div style="flex: 1; min-width: 0;">
                <div style="font-weight: 600; font-size: 14px; color: var(--text-color);">${activity.text}</div>
                <div style="font-size: 13px; color: var(--text-secondary); margin-top: 2px;">${activity.detail}</div>
            </div>
            <div style="font-size: 12px; color: var(--text-secondary); white-space: nowrap;">
                ${activity.time}
            </div>
        </div>
    `).join('');
}

function getTimeAgo(date) {
    const now = new Date();
    const diffMs = now - date;
    const diffMins = Math.floor(diffMs / 60000);
    const diffHours = Math.floor(diffMs / 3600000);
    const diffDays = Math.floor(diffMs / 86400000);

    if (diffMins < 1) return 'Just now';
    if (diffMins < 60) return `${diffMins} minute${diffMins > 1 ? 's' : ''} ago`;
    if (diffHours < 24) return `${diffHours} hour${diffHours > 1 ? 's' : ''} ago`;
    if (diffDays < 7) return `${diffDays} day${diffDays > 1 ? 's' : ''} ago`;
    return date.toLocaleDateString();
}

// AI NoteTaker Functions
function refreshAINoteTakerAppointments() {
    const today = new Date().toISOString().split('T')[0];
    const todayAppts = appointments.filter(apt => apt.appointment_date === today);

    const listEl = document.getElementById('aiNoteTakerTodayAppointments');
    if (todayAppts.length === 0) {
        listEl.innerHTML = '<p style="color: var(--text-secondary); text-align: center; padding: 20px;">No sessions scheduled for today</p>';
        return;
    }

    listEl.innerHTML = todayAppts.sort((a, b) => a.appointment_time.localeCompare(b.appointment_time)).map(apt => {
        const client = clients.find(c => c.id === apt.client_id);
        return `
            <div class="card" style="padding: 15px; margin-bottom: 10px; border-left: 4px solid var(--primary-color);">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div style="flex: 1;">
                        <h4 style="margin: 0 0 8px 0;">${client?.name || 'Unknown Client'}</h4>
                        <p style="margin: 0; color: var(--text-secondary); font-size: 14px;">
                             ${apt.appointment_time} ${apt.duration_minutes ? `(${apt.duration_minutes} min)` : ''}
                        </p>
                        <p style="margin: 5px 0 0 0; color: var(--text-secondary); font-size: 14px;">
                            ${apt.appointment_type || 'Session'}
                        </p>
                    </div>
                    <button onclick="startAINoteTakerForAppointment(${apt.id}, ${apt.client_id})" class="btn btn-primary" style="padding: 10px 20px;">
                         Start Recording
                    </button>
                </div>
            </div>
        `;
    }).join('');
}

function startAINoteTakerForAppointment(appointmentId, clientId) {
    // Pre-select the client in the dropdown
    const clientSelect = document.getElementById('aiClientSelect');
    if (clientSelect) {
        clientSelect.value = clientId;
    }

    // Store appointment ID for later use
    window.currentAppointmentId = appointmentId;

    // Show recorder view
    showNoteTakerRecorder();

    // Scroll to recorder
    document.getElementById('noteTakerRecorderView').scrollIntoView({ behavior: 'smooth' });

    showNotification('Client selected. Ready to start recording!', 'success');
}

// Analytics Page Functions
function loadAnalyticsPage() {
    const timeframe = document.getElementById('analyticsTimeframeSelect')?.value || '30';
    try {
        const data = generateComprehensiveAnalytics(timeframe);
        renderAnalyticsPage(data);
    } catch (error) {
        console.error('Analytics error:', error);
        document.getElementById('analyticsPageContent').innerHTML = '<div class="card"><p>Error loading analytics</p></div>';
    }
}

function renderAnalyticsPage(data) {
    const { overview, trends } = data;

    // Update stats
    document.getElementById('analyticsTotalClients').textContent = overview.total_clients || 0;
    document.getElementById('analyticsUpcomingAppointments').textContent = overview.upcoming_appointments || 0;
    document.getElementById('analyticsPendingDocuments').textContent = overview.pending_documents || 0;
    document.getElementById('analyticsTotalRevenue').textContent = '$' + (overview.total_revenue || 0).toFixed(2);

    // Render monthly trends
    const monthlyChartEl = document.getElementById('analyticsMonthlyChart');
    if (monthlyChartEl && trends.monthly_appointments) {
        monthlyChartEl.innerHTML = trends.monthly_appointments.map(m => {
            const date = new Date(m.month);
            const monthName = date.toLocaleDateString('en-US', { month: 'short', year: 'numeric' });
            return `<div style="padding: 8px; border-bottom: 1px solid var(--border-color);">
                ${monthName}: ${m.appointment_count} appointments
            </div>`;
        }).join('');
    }

    // Render top clients
    const topClientsEl = document.getElementById('analyticsTopClientsList');
    if (topClientsEl && trends.top_clients) {
        topClientsEl.innerHTML = trends.top_clients.slice(0, 5).map((c, i) => {
            return `<div style="padding: 8px; border-bottom: 1px solid var(--border-color);">
                ${i + 1}. ${c.client_name} - ${c.appointment_count} appointments
            </div>`;
        }).join('');
    }
}

// Keyboard navigation
document.addEventListener('keydown', function(e) {
    // Tab navigation enhancement
    if (e.key === 'Tab') {
        document.body.classList.add('keyboard-navigation');
    }
});

document.addEventListener('mousedown', function() {
    document.body.classList.remove('keyboard-navigation');
});

// PWA Installation
let deferredPrompt;
window.addEventListener('beforeinstallprompt', (e) => {
    e.preventDefault();
    deferredPrompt = e;
    
    // Show install button
    const installBtn = document.createElement('button');
    installBtn.className = 'btn btn-secondary';
    installBtn.innerHTML = ' Install App';
    installBtn.style.position = 'fixed';
    installBtn.style.bottom = '20px';
    installBtn.style.right = '20px';
    installBtn.style.zIndex = '1000';
    installBtn.onclick = async () => {
        if (deferredPrompt) {
            deferredPrompt.prompt();
            const { outcome } = await deferredPrompt.userChoice;
            console.log(`User response to the install prompt: ${outcome}`);
            deferredPrompt = null;
            installBtn.remove();
        }
    };
    document.body.appendChild(installBtn);
});

// Service Worker Registration
if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
        navigator.serviceWorker.register('/sw.js')
            .then((registration) => {
                console.log('SW registered: ', registration);
            })
            .catch((registrationError) => {
                console.log('SW registration failed: ', registrationError);
            });
    });
}

// Enhanced modal functions
function openModal(modalId) {
    const modal = document.getElementById(modalId);
    if (modal) {
        modal.style.display = 'flex';
        modal.classList.add('active');
        document.body.style.overflow = 'hidden';
        
        // Focus management
        const firstInput = modal.querySelector('input, button, select, textarea');
        if (firstInput) {
            setTimeout(() => firstInput.focus(), 100);
        }
    }
}

function closeModal(modalId) {
    const modal = document.getElementById(modalId);
    if (modal) {
        modal.style.display = 'none';
        modal.classList.remove('active');
        document.body.style.overflow = '';
    }
}

// Close modal on escape key
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        const openModal = document.querySelector('.modal.active');
        if (openModal) {
            closeModal(openModal.id);
        }
    }
});

// Enhanced user menu
function toggleUserMenu() {
    // Implementation for user menu dropdown
    showNotification('User menu functionality coming soon!', 'info');
}

// Auto-save functionality
let autoSaveTimeout;
function enableAutoSave(formId, saveFunction) {
    const form = document.getElementById(formId);
    if (form) {
        form.addEventListener('input', () => {
            clearTimeout(autoSaveTimeout);
            autoSaveTimeout = setTimeout(() => {
                saveFunction();
                showNotification('Changes saved automatically', 'success', 2000);
            }, 2000);
        });
    }
}

// Enhanced error handling
window.addEventListener('error', function(e) {
    console.error('Global error:', e.error);
    showNotification('An unexpected error occurred. Please refresh the page.', 'error');
});

// Performance monitoring
const perfObserver = new PerformanceObserver((list) => {
    for (const entry of list.getEntries()) {
        if (entry.entryType === 'navigation') {
            console.log('Page load time:', entry.loadEventEnd - entry.loadEventStart, 'ms');
        }
    }
});

if (typeof PerformanceObserver !== 'undefined') {
    perfObserver.observe({ entryTypes: ['navigation'] });
}

// Reports & Analytics Functions
async function generateReport() {
    const reportType = document.getElementById('reportType').value;
    const reportContent = document.getElementById('reportContent');
    const reportPreview = document.querySelector('.report-preview');
    const reportTitle = document.getElementById('reportTitle');
    const reportDate = document.getElementById('reportDate');
    const reportData = document.getElementById('reportData');
    
    try {
        reportContent.innerHTML = '<div class="loading">Generating report...</div>';
        
        // Generate report based on type
        let report = {};
        switch(reportType) {
            case 'client-summary':
                report = await generateClientSummaryReport();
                break;
            case 'appointment-trends':
                report = await generateAppointmentTrendsReport();
                break;
            case 'revenue-report':
                report = await generateRevenueReport();
                break;
            case 'payment-history':
                report = await generatePaymentHistoryReport();
                break;
            case 'document-completion':
                report = await generateDocumentCompletionReport();
                break;
        }
        
        // Display report
        reportTitle.textContent = report.title;
        reportDate.textContent = `Generated on ${new Date().toLocaleDateString()}`;
        reportData.innerHTML = report.content;
        reportPreview.style.display = 'block';
        
        reportContent.innerHTML = `
            <div class="card">
                <h3>Report Generated Successfully</h3>
                <p>Your ${report.title} has been generated. Use the export button to download as PDF.</p>
                <div class="report-preview">
                    <div class="report-header">
                        <h4 id="reportTitle">${report.title}</h4>
                        <p id="reportDate">Generated on ${new Date().toLocaleDateString()}</p>
                    </div>
                    <div id="reportData">${report.content}</div>
                </div>
            </div>
        `;
        
    } catch (error) {
        console.error('Report generation error:', error);
        reportContent.innerHTML = '<div class="error">Failed to generate report. Please try again.</div>';
    }
}

async function generateClientSummaryReport() {
    const clientData = clients; // Use localStorage data
    const totalClients = clientData.length;
    const activeClients = clientData.filter(c => c.status === 'active').length;
    
    return {
        title: 'Client Summary Report',
        content: `
            <div class="report-section">
                <h4>Client Statistics</h4>
                <div class="stats-grid">
                    <div class="stat-card">
                        <h5>Total Clients</h5>
                        <span class="stat-number">${totalClients}</span>
                    </div>
                    <div class="stat-card">
                        <h5>Active Clients</h5>
                        <span class="stat-number">${activeClients}</span>
                    </div>
                    <div class="stat-card">
                        <h5>Inactive Clients</h5>
                        <span class="stat-number">${totalClients - activeClients}</span>
                    </div>
                </div>
            </div>
            <div class="report-section">
                <h4>Recent Clients</h4>
                <table class="report-table">
                    <thead>
                        <tr><th>Name</th><th>Email</th><th>Status</th><th>Created</th></tr>
                    </thead>
                    <tbody>
                        ${clientData.slice(0, 10).map(client => `
                            <tr>
                                <td>${client.name}</td>
                                <td>${client.email || 'N/A'}</td>
                                <td><span class="status-badge ${client.status}">${client.status}</span></td>
                                <td>${new Date(client.created_at).toLocaleDateString()}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
        `
    };
}

async function generateAppointmentTrendsReport() {
    const appointmentData = appointments; // Use localStorage data
    const last30Days = appointmentData.filter(apt => {
        const aptDate = new Date(apt.appointment_date);
        const thirtyDaysAgo = new Date();
        thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
        return aptDate >= thirtyDaysAgo;
    });
    
    const completed = last30Days.filter(apt => apt.status === 'completed').length;
    const cancelled = last30Days.filter(apt => apt.status === 'cancelled').length;
    const scheduled = last30Days.filter(apt => apt.status === 'scheduled').length;
    
    return {
        title: 'Appointment Trends Report',
        content: `
            <div class="report-section">
                <h4>Last 30 Days Statistics</h4>
                <div class="stats-grid">
                    <div class="stat-card">
                        <h5>Total Appointments</h5>
                        <span class="stat-number">${last30Days.length}</span>
                    </div>
                    <div class="stat-card">
                        <h5>Completed</h5>
                        <span class="stat-number">${completed}</span>
                    </div>
                    <div class="stat-card">
                        <h5>Cancelled</h5>
                        <span class="stat-number">${cancelled}</span>
                    </div>
                    <div class="stat-card">
                        <h5>Scheduled</h5>
                        <span class="stat-number">${scheduled}</span>
                    </div>
                </div>
            </div>
            <div class="report-section">
                <h4>Completion Rate</h4>
                <div class="progress-bar">
                    <div class="progress-fill" style="width: ${last30Days.length > 0 ? (completed / last30Days.length * 100) : 0}%"></div>
                </div>
                <p>${last30Days.length > 0 ? Math.round(completed / last30Days.length * 100) : 0}% completion rate</p>
            </div>
        `
    };
}

async function generateRevenueReport() {
    const invoiceData = invoices; // Use localStorage data
    const totalRevenue = invoiceData.reduce((sum, inv) => sum + (parseFloat(inv.total_amount) || 0), 0);
    const paidInvoices = invoiceData.filter(inv => inv.status === 'paid');
    const pendingInvoices = invoiceData.filter(inv => inv.status === 'pending');
    const paidRevenue = paidInvoices.reduce((sum, inv) => sum + (parseFloat(inv.total_amount) || 0), 0);
    
    return {
        title: 'Revenue Report',
        content: `
            <div class="report-section">
                <h4>Revenue Statistics</h4>
                <div class="stats-grid">
                    <div class="stat-card">
                        <h5>Total Revenue</h5>
                        <span class="stat-number">$${totalRevenue.toFixed(2)}</span>
                    </div>
                    <div class="stat-card">
                        <h5>Paid Revenue</h5>
                        <span class="stat-number">$${paidRevenue.toFixed(2)}</span>
                    </div>
                    <div class="stat-card">
                        <h5>Pending Revenue</h5>
                        <span class="stat-number">$${(totalRevenue - paidRevenue).toFixed(2)}</span>
                    </div>
                    <div class="stat-card">
                        <h5>Total Invoices</h5>
                        <span class="stat-number">${invoiceData.length}</span>
                    </div>
                </div>
            </div>
            <div class="report-section">
                <h4>Invoice Status Breakdown</h4>
                <div class="status-breakdown">
                    <div class="status-item">
                        <span class="status-label">Paid:</span>
                        <span class="status-count">${paidInvoices.length}</span>
                    </div>
                    <div class="status-item">
                        <span class="status-label">Pending:</span>
                        <span class="status-count">${pendingInvoices.length}</span>
                    </div>
                </div>
            </div>
        `
    };
}

async function generatePaymentHistoryReport() {
    try {
        // Fetch payment history from API
        const response = await fetch('/api/payment-reports');
        const result = await response.json();
        
        if (!result.success) {
            throw new Error('Failed to fetch payment data');
        }
        
        const { transactions, summary, payment_method_breakdown } = result.data;
        
        return {
            title: 'Payment History Report',
            content: `
                <div class="report-section">
                    <h4>Payment Summary</h4>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <h5>Total Revenue</h5>
                            <span class="stat-number">$${summary.total_revenue.toFixed(2)}</span>
                        </div>
                        <div class="stat-card">
                            <h5>Outstanding</h5>
                            <span class="stat-number">$${summary.outstanding.toFixed(2)}</span>
                        </div>
                        <div class="stat-card">
                            <h5>Refunds</h5>
                            <span class="stat-number" style="color: #dc3545;">-$${summary.refunds.toFixed(2)}</span>
                        </div>
                        <div class="stat-card">
                            <h5>Collection Rate</h5>
                            <span class="stat-number">${summary.collection_rate.toFixed(1)}%</span>
                        </div>
                    </div>
                </div>
                <div class="report-section">
                    <h4>Payment Methods</h4>
                    <div class="payment-methods-breakdown">
                        ${payment_method_breakdown.map(method => `
                            <div class="payment-method-item" style="padding: 10px; border-bottom: 1px solid #e9ecef;">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <div>
                                        <strong>${method.brand ? method.brand.toUpperCase() : 'Unknown'}</strong>
                                        <span style="color: #6c757d; margin-left: 10px;">${method.type}</span>
                                    </div>
                                    <div style="text-align: right;">
                                        <div style="font-weight: 600;">$${parseFloat(method.total).toFixed(2)}</div>
                                        <div style="font-size: 12px; color: #6c757d;">${method.count} transactions</div>
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
                <div class="report-section">
                    <h4>Recent Transactions</h4>
                    <table class="report-table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Client</th>
                                <th>Invoice</th>
                                <th>Type</th>
                                <th>Amount</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${transactions.slice(0, 20).map(txn => `
                                <tr>
                                    <td>${new Date(txn.created_at).toLocaleDateString()}</td>
                                    <td>${txn.client_name || 'N/A'}</td>
                                    <td>${txn.invoice_number || 'N/A'}</td>
                                    <td><span class="badge badge-${txn.type}">${txn.type}</span></td>
                                    <td>${txn.type === 'refund' ? '-' : ''}$${parseFloat(txn.amount).toFixed(2)}</td>
                                    <td><span class="status-badge ${txn.status}">${txn.status}</span></td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `
        };
    } catch (error) {
        console.error('Payment history report error:', error);
        return {
            title: 'Payment History Report',
            content: `
                <div class="error">
                    <p>Unable to generate payment history report.</p>
                    <p>${error.message}</p>
                    <p style="margin-top: 20px;">Note: Payment history reports require database connection.</p>
                </div>
            `
        };
    }
}

async function generateDocumentCompletionReport() {
    const docData = assignedDocs; // Use localStorage data
    const totalDocs = docData.length;
    const completedDocs = docData.filter(doc => doc.status === 'completed').length;
    const pendingDocs = docData.filter(doc => doc.status === 'pending').length;
    
    return {
        title: 'Document Completion Report',
        content: `
            <div class="report-section">
                <h4>Document Statistics</h4>
                <div class="stats-grid">
                    <div class="stat-card">
                        <h5>Total Documents</h5>
                        <span class="stat-number">${totalDocs}</span>
                    </div>
                    <div class="stat-card">
                        <h5>Completed</h5>
                        <span class="stat-number">${completedDocs}</span>
                    </div>
                    <div class="stat-card">
                        <h5>Pending</h5>
                        <span class="stat-number">${pendingDocs}</span>
                    </div>
                    <div class="stat-card">
                        <h5>Completion Rate</h5>
                        <span class="stat-number">${totalDocs > 0 ? Math.round(completedDocs / totalDocs * 100) : 0}%</span>
                    </div>
                </div>
            </div>
            <div class="report-section">
                <h4>Recent Document Activity</h4>
                <table class="report-table">
                    <thead>
                        <tr><th>Document</th><th>Client</th><th>Status</th><th>Assigned</th></tr>
                    </thead>
                    <tbody>
                        ${docData.slice(0, 10).map(doc => `
                            <tr>
                                <td>${doc.template_name}</td>
                                <td>${doc.client_name}</td>
                                <td><span class="status-badge ${doc.status}">${doc.status}</span></td>
                                <td>${new Date(doc.assigned_at).toLocaleDateString()}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
        `
    };
}

function exportReport() {
    const reportContent = document.querySelector('.report-preview');
    if (!reportContent) {
        showNotification('Please generate a report first', 'warning');
        return;
    }
    
    // Simple PDF export using browser print functionality
    const printWindow = window.open('', '_blank');
    printWindow.document.write(`
        <html>
            <head>
                <title>Sessionably Report</title>
                <style>
                    body { font-family: Arial, sans-serif; margin: 20px; }
                    .report-header { text-align: center; margin-bottom: 30px; }
                    .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin: 20px 0; }
                    .stat-card { border: 1px solid #ddd; padding: 15px; text-align: center; border-radius: 8px; }
                    .stat-number { font-size: 24px; font-weight: bold; color: #0F4C81; }
                    .report-table { width: 100%; border-collapse: collapse; margin: 20px 0; }
                    .report-table th, .report-table td { border: 1px solid #ddd; padding: 8px; text-align: left; }
                    .report-table th { background-color: #f5f5f5; }
                    .status-badge { padding: 4px 8px; border-radius: 4px; font-size: 12px; }
                    .status-badge.completed { background-color: #d4edda; color: #155724; }
                    .status-badge.pending { background-color: #fff3cd; color: #856404; }
                    .status-badge.active { background-color: #d1ecf1; color: #0c5460; }
                </style>
            </head>
            <body>
                ${reportContent.innerHTML}
            </body>
        </html>
    `);
    printWindow.document.close();
    printWindow.print();
}

// Notifications System
let notifications = [];
let notificationCount = 0;

// Initialize notifications
function initNotifications() {
    // Load saved notifications from localStorage
    const savedNotifications = localStorage.getItem('sessionably_notifications');
    if (savedNotifications) {
        notifications = JSON.parse(savedNotifications);
        updateNotificationBadge();
    }
    
    // Add some demo notifications
    if (notifications.length === 0) {
        addDemoNotifications();
    }
    
    renderNotifications();
}

function addDemoNotifications() {
    const demoNotifications = [
        {
            id: Date.now() + 1,
            type: 'appointment',
            title: 'New Appointment Scheduled',
            message: 'John Doe has scheduled a 60-minute psychotherapy session for tomorrow at 2:00 PM.',
            timestamp: new Date(Date.now() - 2 * 60 * 60 * 1000), // 2 hours ago
            read: false,
            priority: 'high'
        },
        {
            id: Date.now() + 2,
            type: 'document',
            title: 'Document Completed',
            message: 'Sarah Johnson has completed and signed the Informed Consent form.',
            timestamp: new Date(Date.now() - 4 * 60 * 60 * 1000), // 4 hours ago
            read: false,
            priority: 'medium'
        },
        {
            id: Date.now() + 3,
            type: 'payment',
            title: 'Payment Received',
            message: 'Payment of $150.00 received from Mike Wilson for invoice INV-1001.',
            timestamp: new Date(Date.now() - 6 * 60 * 60 * 1000), // 6 hours ago
            read: true,
            priority: 'low'
        },
        {
            id: Date.now() + 4,
            type: 'system',
            title: 'System Update Available',
            message: 'A new version of Sessionably is available with enhanced security features.',
            timestamp: new Date(Date.now() - 24 * 60 * 60 * 1000), // 1 day ago
            read: true,
            priority: 'low'
        }
    ];
    
    notifications = demoNotifications;
    saveNotifications();
    updateNotificationBadge();
}

function addNotification(notification) {
    const newNotification = {
        id: Date.now(),
        timestamp: new Date(),
        read: false,
        ...notification
    };
    
    notifications.unshift(newNotification);
    saveNotifications();
    updateNotificationBadge();
    renderNotifications();
    
    // Show browser notification if permission granted
    if (Notification.permission === 'granted') {
        new Notification(notification.title, {
            body: notification.message,
            icon: '/icon.svg'
        });
    }
}

// SMS Notification Function
async function sendSMSNotification(phoneNumber, message) {
    if (!phoneNumber) {
        console.log('[WARN] No phone number provided, skipping SMS');
        return;
    }
    
    try {
        const response = await fetch('/api/send-sms', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                to: phoneNumber,
                message: message,
                type: 'notification'
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            console.log(' SMS sent successfully:', {
                to: phoneNumber,
                sid: result.data.sid,
                status: result.data.status
            });
        } else {
            console.error(' SMS send failed:', result.error);
        }
    } catch (error) {
        console.error(' SMS notification error:', error);
    }
}

// Payment-specific notification templates
async function notifyPaymentReceived(invoice) {
    addNotification({
        type: 'payment',
        title: 'Payment Received',
        message: `Payment of $${parseFloat(invoice.total_amount).toFixed(2)} received for invoice ${invoice.invoice_number}`,
        priority: 'high',
        icon: '',
        action: `view_invoice_${invoice.id}`
    });
    
    // Send SMS notification
    await sendSMSNotification(invoice.client_phone, 
        `Payment Confirmed! We received $${parseFloat(invoice.total_amount).toFixed(2)} for invoice ${invoice.invoice_number}. Thank you! - Sessionably`
    );
    
    // Log for email in production
    console.log(' EMAIL: Payment Received', {
        to: invoice.client_email || 'client@example.com',
        subject: `Payment Received - Invoice ${invoice.invoice_number}`,
        body: `
            Dear ${invoice.client_name},
            
            We have received your payment of $${parseFloat(invoice.total_amount).toFixed(2)} for invoice ${invoice.invoice_number}.
            
            Thank you for your payment!
            
            - Sessionably
        `
    });
}

async function notifyPaymentFailed(invoice, error) {
    addNotification({
        type: 'payment',
        title: 'Payment Failed',
        message: `Payment failed for invoice ${invoice.invoice_number}: ${error}`,
        priority: 'high',
        icon: '',
        action: `view_invoice_${invoice.id}`
    });
    
    // Send SMS notification
    await sendSMSNotification(invoice.client_phone, 
        `Payment Failed: We couldn't process your payment for invoice ${invoice.invoice_number}. Please update your payment method or contact us. - Sessionably`
    );
    
    // Log for email in production
    console.log(' EMAIL: Payment Failed', {
        to: invoice.client_email || 'client@example.com',
        subject: `Payment Failed - Invoice ${invoice.invoice_number}`,
        body: `
            Dear ${invoice.client_name},
            
            We were unable to process your payment for invoice ${invoice.invoice_number}.
            Error: ${error}
            
            Please update your payment method or contact us.
            
            - Sessionably
        `
    });
}

async function notifyRefundProcessed(invoice, refundAmount) {
    addNotification({
        type: 'refund',
        title: 'Refund Processed',
        message: `Refund of $${parseFloat(refundAmount).toFixed(2)} processed for invoice ${invoice.invoice_number}`,
        priority: 'medium',
        icon: '',
        action: `view_invoice_${invoice.id}`
    });
    
    // Send SMS notification
    await sendSMSNotification(invoice.client_phone, 
        `Refund Processed: A refund of $${parseFloat(refundAmount).toFixed(2)} has been processed for invoice ${invoice.invoice_number}. It will appear in 5-10 business days. - Sessionably`
    );
    
    // Log for email in production
    console.log(' EMAIL: Refund Processed', {
        to: invoice.client_email || 'client@example.com',
        subject: `Refund Processed - Invoice ${invoice.invoice_number}`,
        body: `
            Dear ${invoice.client_name},
            
            A refund of $${parseFloat(refundAmount).toFixed(2)} has been processed for invoice ${invoice.invoice_number}.
            
            The refund will appear on your account within 5-10 business days.
            
            - Sessionably
        `
    });
}

function notifyAutopayEnabled(client) {
    addNotification({
        type: 'autopay',
        title: 'Autopay Enabled',
        message: `Autopay has been enabled for ${client.name}`,
        priority: 'medium',
        icon: ''
    });
}

function notifyAutopayFailed(invoice, error) {
    addNotification({
        type: 'autopay',
        title: 'Autopay Failed',
        message: `Autopay failed for invoice ${invoice.invoice_number}: ${error}`,
        priority: 'high',
        icon: '',
        action: `view_invoice_${invoice.id}`
    });
    
    // Log for email/SMS in production
    console.log(' EMAIL: Autopay Failed', {
        to: invoice.client_email || 'client@example.com',
        subject: `Autopay Failed - Invoice ${invoice.invoice_number}`,
        body: `
            Dear ${invoice.client_name},
            
            We were unable to process your automatic payment for invoice ${invoice.invoice_number}.
            Error: ${error}
            
            Please update your payment method or contact us.
            
            - Sessionably
        `
    });
}

async function notifyInvoiceCreated(invoice) {
    addNotification({
        type: 'invoice',
        title: 'New Invoice Created',
        message: `Invoice ${invoice.invoice_number} for ${invoice.client_name} - $${parseFloat(invoice.total_amount).toFixed(2)}`,
        priority: 'medium',
        icon: '',
        action: `view_invoice_${invoice.id}`
    });
    
    // Send SMS notification
    await sendSMSNotification(invoice.client_phone, 
        `New Invoice: Invoice #${invoice.invoice_number} for $${parseFloat(invoice.total_amount).toFixed(2)} is ready. Due: ${new Date(invoice.due_date).toLocaleDateString()}. Pay online at your convenience. - Sessionably`
    );
    
    // Log for email in production
    console.log(' EMAIL: Invoice Created', {
        to: invoice.client_email || 'client@example.com',
        subject: `New Invoice - ${invoice.invoice_number}`,
        body: `
            Dear ${invoice.client_name},
            
            A new invoice has been created for you:
            
            Invoice Number: ${invoice.invoice_number}
            Amount: $${parseFloat(invoice.total_amount).toFixed(2)}
            Due Date: ${new Date(invoice.due_date).toLocaleDateString()}
            
            Please log in to view and pay your invoice.
            
            - Sessionably
        `
    });
}

function renderNotifications() {
    const container = document.getElementById('notificationsContainer');
    if (!container) return;
    
    if (notifications.length === 0) {
        container.innerHTML = '<div class="card"><p>No notifications yet.</p></div>';
        return;
    }
    
    const html = notifications.map(notification => `
        <div class="notification-item ${notification.read ? '' : 'unread'}" data-id="${notification.id}">
            <div class="notification-header">
                <h4 class="notification-title">${getNotificationIcon(notification.type)} ${notification.title}</h4>
                <span class="notification-time">${formatTimeAgo(notification.timestamp)}</span>
            </div>
            <p class="notification-message">${notification.message}</p>
            <div class="notification-actions">
                ${!notification.read ? `<button class="mark-read" onclick="markAsRead(${notification.id})">Mark Read</button>` : ''}
                <button class="delete" onclick="deleteNotification(${notification.id})">Delete</button>
            </div>
        </div>
    `).join('');
    
    container.innerHTML = html;
}

function getNotificationIcon(type) {
    const icons = {
        'appointment': '',
        'document': '',
        'payment': '',
        'system': '',
        'client': '',
        'invoice': ''
    };
    return icons[type] || '';
}

function formatTimeAgo(timestamp) {
    const now = new Date();
    const diff = now - new Date(timestamp);
    const minutes = Math.floor(diff / 60000);
    const hours = Math.floor(diff / 3600000);
    const days = Math.floor(diff / 86400000);
    
    if (minutes < 1) return 'Just now';
    if (minutes < 60) return `${minutes}m ago`;
    if (hours < 24) return `${hours}h ago`;
    return `${days}d ago`;
}

function markAsRead(notificationId) {
    const notification = notifications.find(n => n.id === notificationId);
    if (notification) {
        notification.read = true;
        saveNotifications();
        updateNotificationBadge();
        renderNotifications();
    }
}

function markAllAsRead() {
    notifications.forEach(notification => {
        notification.read = true;
    });
    saveNotifications();
    updateNotificationBadge();
    renderNotifications();
    showNotification('All notifications marked as read', 'success');
}

function deleteNotification(notificationId) {
    notifications = notifications.filter(n => n.id !== notificationId);
    saveNotifications();
    updateNotificationBadge();
    renderNotifications();
}

function clearAllNotifications() {
    if (confirm('Are you sure you want to clear all notifications?')) {
        notifications = [];
        saveNotifications();
        updateNotificationBadge();
        renderNotifications();
        showNotification('All notifications cleared', 'success');
    }
}

function updateNotificationBadge() {
    const unreadCount = notifications.filter(n => !n.read).length;
    const badge = document.getElementById('notifBadge');
    if (badge) {
        if (unreadCount > 0) {
            badge.textContent = unreadCount;
            badge.style.display = 'inline';
        } else {
            badge.style.display = 'none';
        }
    }
    notificationCount = unreadCount;
}

function saveNotifications() {
    localStorage.setItem('sessionably_notifications', JSON.stringify(notifications));
}

// Request notification permission
function requestNotificationPermission() {
    if ('Notification' in window && Notification.permission === 'default') {
        Notification.requestPermission().then(permission => {
            if (permission === 'granted') {
                showNotification('Notifications enabled! You\'ll receive alerts for important events.', 'success');
            }
        });
    }
}

// Simulate real-time notifications
function simulateNotifications() {
    const notificationTypes = [
        {
            type: 'appointment',
            title: 'Appointment Reminder',
            message: 'You have an appointment with Jane Smith in 30 minutes.',
            priority: 'high'
        },
        {
            type: 'document',
            title: 'New Document Assignment',
            message: 'A new intake form has been assigned to a client.',
            priority: 'medium'
        },
        {
            type: 'payment',
            title: 'Payment Overdue',
            message: 'Invoice INV-1005 is 5 days overdue.',
            priority: 'high'
        }
    ];
    
    // Add a random notification every 30 seconds (for demo) - optimized
    let notificationInterval;
    function startNotificationSimulation() {
        notificationInterval = setInterval(() => {
            if (Math.random() < 0.3) { // 30% chance
                const randomNotification = notificationTypes[Math.floor(Math.random() * notificationTypes.length)];
                addNotification(randomNotification);
            }
        }, 30000);
    }
    
    // Only start simulation if user is active
    function handleUserActivity() {
        if (!notificationInterval) {
            startNotificationSimulation();
        }
    }
    
    // Start simulation on user interaction
    document.addEventListener('click', handleUserActivity, { once: true });
    document.addEventListener('keydown', handleUserActivity, { once: true });
}

// Initialize notifications when the app loads
// Check authentication state and show appropriate form
function checkAuthState() {
    const existingUsers = loadFromStorage('clinicians', []);

    // Check if URL has #login hash to force login form
    const urlHash = window.location.hash;
    if (urlHash === '#login') {
        // Force show login form when #login is in URL
        showLoginForm();
        // Clear the hash after showing login
        history.replaceState(null, null, ' ');
    } else if (existingUsers.length > 0) {
        // Show login form for existing users
        showLoginForm();
    } else {
        // Show signup form for new users
        showSignupForm();
    }
}

// Show login form
function showLoginForm() {
    document.getElementById('authContainer').style.display = 'block';
    document.getElementById('firstTimeSetupModal').style.display = 'none';
}

// Show signup form
function showSignupForm() {
    document.getElementById('authContainer').style.display = 'none';
    document.getElementById('firstTimeSetupModal').style.display = 'block';
}

// Fix redirect issues by ensuring we're on the correct URL
if (window.location.pathname === '/app.html') {
    console.log('Redirecting from /app.html to /app');
    window.location.replace('/app');
}

document.addEventListener('DOMContentLoaded', function() {
    // Apply theme and language from settings immediately
    const settings = JSON.parse(localStorage.getItem('userSettings') || '{}');
    const theme = settings.theme || 'light';
    const language = settings.language || 'en';
    applyTheme(theme);
    applyLanguage(language);

    // Initialize navigation based on subscription
    updateNavigationForSubscription();

    // Check for active session first
    const hasActiveSession = checkSession();

    if (hasActiveSession) {
        console.log(' Active session found, auto-login');
        showApp();
    }

    // Show loading state
    showLoadingState();
    
    // Initialize and load data asynchronously
    async function initializeApp() {
        try {
            // Initialize localStorage demo data
            initializeDemoData();
            
            // Load data from database API (non-blocking)
            await new Promise(async (resolve) => {
                setTimeout(async () => {
                    // Load clients and appointments from database
                    await loadClients();
                    await loadAppointments();
                    assignedDocs = loadFromStorage('assigned_docs', []);
                    invoices = loadFromStorage('invoices', []);
                    resolve();
                }, 0);
            });
            
            // Load templates (non-blocking)
            await new Promise(resolve => {
                setTimeout(() => {
                    loadTemplates();
                    resolve();
                }, 0);
            });
            
            console.log('[STATS] Data loaded:', {
                clients: clients.length,
                appointments: appointments.length,
                invoices: invoices.length,
                templates: Object.keys(documentTemplates).length
            });
            
            // Hide loading state
            hideLoadingState();
            
            // Check if we need to show login or signup form
            checkAuthState();
            
        } catch (error) {
            console.error('Error initializing app:', error);
            hideLoadingState();
        }
    }
    
    // Start initialization
    initializeApp();
    
    // Initialize Stripe
    initializeStripe();
    
    // FORCE DISABLE ALL SERVICE WORKERS - EMERGENCY FIX
    if ('serviceWorker' in navigator) {
        // Unregister all service workers
        navigator.serviceWorker.getRegistrations().then(function(registrations) {
            for(let registration of registrations) {
                console.log('FORCE UNREGISTERING service worker:', registration);
                registration.unregister();
            }
        });
        
        // Clear ALL caches aggressively
        if ('caches' in window) {
            caches.keys().then(function(cacheNames) {
                return Promise.all(
                    cacheNames.map(function(cacheName) {
                        console.log('FORCE DELETING cache:', cacheName);
                        return caches.delete(cacheName);
                    })
                );
            });
        }
        
        // Clear localStorage and sessionStorage
        try {
            localStorage.clear();
            sessionStorage.clear();
            console.log('Cleared all storage');
        } catch(e) {
            console.log('Storage clear failed:', e);
        }
    }
    
    // Register service worker for performance optimization
    // Temporarily disabled due to deployment issues
    /*
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('/sw.js')
                .then(registration => {
                    console.log('Service Worker registered successfully:', registration);
                })
                .catch(error => {
                    console.log('Service Worker registration failed:', error);
                });
        });
    }
    */
    
    // Performance monitoring
    if ('performance' in window) {
        // Monitor page load performance
        window.addEventListener('load', () => {
            setTimeout(() => {
                const perfData = performance.getEntriesByType('navigation')[0];
                if (perfData) {
                    const metrics = {
                        loadTime: perfData.loadEventEnd - perfData.loadEventStart,
                        domContentLoaded: perfData.domContentLoadedEventEnd - perfData.domContentLoadedEventStart,
                        firstPaint: performance.getEntriesByType('paint').find(entry => entry.name === 'first-paint')?.startTime || 0,
                        firstContentfulPaint: performance.getEntriesByType('paint').find(entry => entry.name === 'first-contentful-paint')?.startTime || 0
                    };
                    
                    console.log('Performance Metrics:', metrics);
                    
                    // Send to service worker for storage
                    if ('serviceWorker' in navigator && navigator.serviceWorker.controller) {
                        navigator.serviceWorker.controller.postMessage({
                            type: 'PERFORMANCE_METRIC',
                            metric: 'page_load',
                            value: metrics
                        });
                    }
                }
            }, 1000);
        });
    }
    
    // Check for expired documents
    checkDocumentExpirations();
    
    // Initialize notifications
    initNotifications();
    requestNotificationPermission();
    
    // Start simulation after 10 seconds (optimized)
    setTimeout(simulateNotifications, 10000);
    
    // Consolidated background tasks - run every 5 minutes
    const BACKGROUND_TASK_INTERVAL = 5 * 60 * 1000; // 5 minutes
    
    function runBackgroundTasks() {
        // Check for expired documents (every hour)
        if (Date.now() % (60 * 60 * 1000) < BACKGROUND_TASK_INTERVAL) {
            checkDocumentExpirations();
        }
        
        // Check for overdue invoices (every hour)
        if (Date.now() % (60 * 60 * 1000) < BACKGROUND_TASK_INTERVAL) {
            checkOverdueInvoices();
        }
        
        // Process scheduled SMS reminders (every 5 minutes)
        processScheduledSMSReminders();
    }
    
    // Run background tasks immediately, then on interval
    runBackgroundTasks();
    setInterval(runBackgroundTasks, BACKGROUND_TASK_INTERVAL);
    
    // Check if user is already logged in
    const existingToken = loadFromStorage('auth_token');
    const existingUser = loadFromStorage('current_user');
    
    if (existingToken && existingUser) {
        authToken = existingToken;
        currentUser = existingUser;
        showApp();
    } else {
        // Show login screen
        document.getElementById('authContainer').style.display = 'block';
        document.getElementById('appContainer').style.display = 'none';
    }
    
    console.log(' Sessionably initialized with localStorage');
    
    // Initialize user menu
    updateUserMenu();
});

// User Management Functions
function updateUserMenu() {
    const user = JSON.parse(localStorage.getItem('currentUser') || '{}');
    const userName = document.getElementById('userName');
    const userAvatar = document.getElementById('userAvatar');
    const dropdownUserName = document.getElementById('dropdownUserName');
    const dropdownUserEmail = document.getElementById('dropdownUserEmail');
    
    if (userName) userName.textContent = user.name || 'Admin';
    if (userAvatar) userAvatar.textContent = (user.name || 'A').charAt(0).toUpperCase();
    if (dropdownUserName) dropdownUserName.textContent = user.name || 'Admin User';
    if (dropdownUserEmail) dropdownUserEmail.textContent = user.email || 'support@sessionably.com';
}

function toggleUserMenu() {
    const dropdown = document.getElementById('userMenuDropdown');
    if (dropdown) {
        dropdown.classList.toggle('active');
    }
}

// Close user menu when clicking outside
document.addEventListener('click', function(event) {
    const userMenu = document.querySelector('.user-menu');
    const dropdown = document.getElementById('userMenuDropdown');
    
    if (userMenu && dropdown && !userMenu.contains(event.target)) {
        dropdown.classList.remove('active');
    }
});

// Profile Modal
function openProfileModal() {
    const user = JSON.parse(localStorage.getItem('currentUser') || '{}');
    const modal = document.getElementById('profileModal');
    
    if (modal) {
        document.getElementById('profileName').value = user.name || '';
        document.getElementById('profileEmail').value = user.email || '';
        document.getElementById('profilePhone').value = user.phone || '';
        document.getElementById('profileTitle').value = user.title || 'Clinician';
        document.getElementById('profileLicense').value = user.license || '';
        document.getElementById('profileBio').value = user.bio || '';
        
        modal.style.display = 'block';
        document.getElementById('userMenuDropdown').classList.remove('active');
    }
}

function saveProfile() {
    const user = JSON.parse(localStorage.getItem('currentUser') || '{}');
    
    user.name = document.getElementById('profileName').value;
    user.email = document.getElementById('profileEmail').value;
    user.phone = document.getElementById('profilePhone').value;
    user.title = document.getElementById('profileTitle').value;
    user.license = document.getElementById('profileLicense').value;
    user.bio = document.getElementById('profileBio').value;
    
    localStorage.setItem('currentUser', JSON.stringify(user));
    currentUser = user;
    
    updateUserMenu();
    closeModal('profileModal');
    
    logAudit('profile_update', {
        user_id: user.id,
        changes: ['name', 'email', 'phone', 'title', 'license', 'bio']
    });
    
    showNotification('Profile updated successfully!', 'success');
}

// Settings Modal
function openSettingsModal() {
    const settings = JSON.parse(localStorage.getItem('userSettings') || '{}');
    const modal = document.getElementById('settingsModal');
    
    if (modal) {
        document.getElementById('emailNotifications').checked = settings.emailNotifications !== false;
        document.getElementById('appointmentReminders').checked = settings.appointmentReminders !== false;
        document.getElementById('documentAlerts').checked = settings.documentAlerts !== false;
        document.getElementById('invoiceAlerts').checked = settings.invoiceAlerts !== false;
        document.getElementById('themePreference').value = settings.theme || 'light';
        document.getElementById('languagePreference').value = settings.language || 'en';
        
        modal.style.display = 'block';
        document.getElementById('userMenuDropdown').classList.remove('active');
    }
}

function saveSettings() {
    const settings = {
        emailNotifications: document.getElementById('emailNotifications').checked,
        appointmentReminders: document.getElementById('appointmentReminders').checked,
        documentAlerts: document.getElementById('documentAlerts').checked,
        invoiceAlerts: document.getElementById('invoiceAlerts').checked,
        theme: document.getElementById('themePreference').value,
        language: document.getElementById('languagePreference').value
    };

    localStorage.setItem('userSettings', JSON.stringify(settings));

    // Apply theme immediately
    applyTheme(settings.theme);

    // Apply language immediately
    applyLanguage(settings.language);

    closeModal('settingsModal');

    logAudit('settings_update', {
        user_id: currentUser.id,
        settings: settings
    });

    showNotification('Settings saved successfully!', 'success');
}

// Theme application function
function applyTheme(theme) {
    const root = document.documentElement;

    if (theme === 'dark') {
        root.setAttribute('data-theme', 'dark');
    } else if (theme === 'light') {
        root.setAttribute('data-theme', 'light');
    } else if (theme === 'auto') {
        // Auto mode: respect system preference
        const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
        root.setAttribute('data-theme', prefersDark ? 'dark' : 'light');
    }
}

// Translation dictionaries
const translations = {
    en: {
        // Navigation
        'Dashboard': 'Dashboard',
        'Clients': 'Clients',
        'Appointments': 'Appointments',
        'Documents': 'Documents',
        'Billing': 'Billing',
        'Messages': 'Messages',
        'Reports': 'Reports',
        'Insurance': 'Insurance',

        // Dashboard
        "Today's Appointments": "Today's Appointments",
        'Active Clients': 'Active Clients',
        'Unread Messages': 'Unread Messages',
        'This Week Revenue': 'This Week Revenue',
        "Today's Schedule": "Today's Schedule",
        'Quick Actions': 'Quick Actions',
        'Add Client': 'Add Client',
        'New Appointment': 'New Appointment',
        'Send Message': 'Send Message',
        'View All': 'View All',

        // Common
        'Save': 'Save',
        'Cancel': 'Cancel',
        'Delete': 'Delete',
        'Edit': 'Edit',
        'Search': 'Search',
        'Filter': 'Filter',
        'Export': 'Export',
        'Print': 'Print',
        'Settings': 'Settings',
        'Profile': 'Profile',
        'Logout': 'Logout',

        // Clients
        'Client List': 'Client List',
        'Add New Client': 'Add New Client',
        'First Name': 'First Name',
        'Last Name': 'Last Name',
        'Email': 'Email',
        'Phone': 'Phone',
        'Date of Birth': 'Date of Birth',
        'Address': 'Address',
        'Insurance Provider': 'Insurance Provider',

        // Settings
        'Notifications': 'Notifications',
        'Email Notifications': 'Email Notifications',
        'Appointment Reminders': 'Appointment Reminders',
        'Document Alerts': 'Document Alerts',
        'Invoice Alerts': 'Invoice Alerts',
        'Preferences': 'Preferences',
        'Theme': 'Theme',
        'Language': 'Language',
        'Light': 'Light',
        'Dark': 'Dark',
        'Auto': 'Auto',
        'Data Import': 'Data Import',
        'Save Settings': 'Save Settings'
    },
    es: {
        // Navigation
        'Dashboard': 'Panel de Control',
        'Clients': 'Clientes',
        'Appointments': 'Citas',
        'Documents': 'Documentos',
        'Billing': 'Facturacin',
        'Messages': 'Mensajes',
        'Reports': 'Informes',
        'Insurance': 'Seguro',

        // Dashboard
        "Today's Appointments": 'Citas de Hoy',
        'Active Clients': 'Clientes Activos',
        'Unread Messages': 'Mensajes No Ledos',
        'This Week Revenue': 'Ingresos de Esta Semana',
        "Today's Schedule": 'Horario de Hoy',
        'Quick Actions': 'Acciones Rpidas',
        'Add Client': 'Agregar Cliente',
        'New Appointment': 'Nueva Cita',
        'Send Message': 'Enviar Mensaje',
        'View All': 'Ver Todo',

        // Common
        'Save': 'Guardar',
        'Cancel': 'Cancelar',
        'Delete': 'Eliminar',
        'Edit': 'Editar',
        'Search': 'Buscar',
        'Filter': 'Filtrar',
        'Export': 'Exportar',
        'Print': 'Imprimir',
        'Settings': 'Configuracin',
        'Profile': 'Perfil',
        'Logout': 'Cerrar Sesin',

        // Clients
        'Client List': 'Lista de Clientes',
        'Add New Client': 'Agregar Nuevo Cliente',
        'First Name': 'Nombre',
        'Last Name': 'Apellido',
        'Email': 'Correo Electrnico',
        'Phone': 'Telfono',
        'Date of Birth': 'Fecha de Nacimiento',
        'Address': 'Direccin',
        'Insurance Provider': 'Proveedor de Seguro',

        // Settings
        'Notifications': 'Notificaciones',
        'Email Notifications': 'Notificaciones por Correo',
        'Appointment Reminders': 'Recordatorios de Citas',
        'Document Alerts': 'Alertas de Documentos',
        'Invoice Alerts': 'Alertas de Facturas',
        'Preferences': 'Preferencias',
        'Theme': 'Tema',
        'Language': 'Idioma',
        'Light': 'Claro',
        'Dark': 'Oscuro',
        'Auto': 'Automtico',
        'Data Import': 'Importar Datos',
        'Save Settings': 'Guardar Configuracin'
    },
    fr: {
        // Navigation
        'Dashboard': 'Tableau de Bord',
        'Clients': 'Clients',
        'Appointments': 'Rendez-vous',
        'Documents': 'Documents',
        'Billing': 'Facturation',
        'Messages': 'Messages',
        'Reports': 'Rapports',
        'Insurance': 'Assurance',

        // Dashboard
        "Today's Appointments": "Rendez-vous d'Aujourd'hui",
        'Active Clients': 'Clients Actifs',
        'Unread Messages': 'Messages Non Lus',
        'This Week Revenue': 'Revenus de Cette Semaine',
        "Today's Schedule": "Programme d'Aujourd'hui",
        'Quick Actions': 'Actions Rapides',
        'Add Client': 'Ajouter un Client',
        'New Appointment': 'Nouveau Rendez-vous',
        'Send Message': 'Envoyer un Message',
        'View All': 'Voir Tout',

        // Common
        'Save': 'Enregistrer',
        'Cancel': 'Annuler',
        'Delete': 'Supprimer',
        'Edit': 'Modifier',
        'Search': 'Rechercher',
        'Filter': 'Filtrer',
        'Export': 'Exporter',
        'Print': 'Imprimer',
        'Settings': 'Paramtres',
        'Profile': 'Profil',
        'Logout': 'Dconnexion',

        // Clients
        'Client List': 'Liste des Clients',
        'Add New Client': 'Ajouter un Nouveau Client',
        'First Name': 'Prnom',
        'Last Name': 'Nom',
        'Email': 'E-mail',
        'Phone': 'Tlphone',
        'Date of Birth': 'Date de Naissance',
        'Address': 'Adresse',
        'Insurance Provider': "Fournisseur d'Assurance",

        // Settings
        'Notifications': 'Notifications',
        'Email Notifications': 'Notifications par E-mail',
        'Appointment Reminders': 'Rappels de Rendez-vous',
        'Document Alerts': 'Alertes de Documents',
        'Invoice Alerts': 'Alertes de Factures',
        'Preferences': 'Prfrences',
        'Theme': 'Thme',
        'Language': 'Langue',
        'Light': 'Clair',
        'Dark': 'Sombre',
        'Auto': 'Automatique',
        'Data Import': 'Importation de Donnes',
        'Save Settings': 'Enregistrer les Paramtres'
    }
};

// Language application function
function applyLanguage(language) {
    const lang = language || 'en';
    const dict = translations[lang] || translations.en;

    // Store current language
    document.documentElement.setAttribute('lang', lang);

    // Translate all elements with data-translate attribute
    document.querySelectorAll('[data-translate]').forEach(element => {
        const key = element.getAttribute('data-translate');
        if (dict[key]) {
            if (element.tagName === 'INPUT' && element.placeholder) {
                element.placeholder = dict[key];
            } else {
                element.textContent = dict[key];
            }
        }
    });
}

// Account Modal
function openAccountModal() {
    const user = JSON.parse(localStorage.getItem('currentUser') || '{}');
    const modal = document.getElementById('accountModal');
    
    if (modal) {
        document.getElementById('accountEmail').value = user.email || '';
        document.getElementById('accountUsername').value = user.username || 'admin';
        
        modal.style.display = 'block';
        document.getElementById('userMenuDropdown').classList.remove('active');
    }
}

function changePassword() {
    const currentPassword = document.getElementById('currentPassword').value;
    const newPassword = document.getElementById('newPassword').value;
    const confirmPassword = document.getElementById('confirmPassword').value;
    
    if (!currentPassword || !newPassword || !confirmPassword) {
        showNotification('Please fill in all password fields', 'error');
        return;
    }
    
    if (newPassword !== confirmPassword) {
        showNotification('New passwords do not match', 'error');
        return;
    }
    
    if (newPassword.length < 8) {
        showNotification('Password must be at least 8 characters', 'error');
        return;
    }
    
    // In a real app, this would verify the current password with the backend
    // For demo purposes, we'll just update it
    const user = JSON.parse(localStorage.getItem('currentUser') || '{}');
    user.password = newPassword; // In production, this should be hashed
    localStorage.setItem('currentUser', JSON.stringify(user));
    
    logAudit('password_change', {
        user_id: user.id,
        timestamp: new Date().toISOString()
    });
    
    // Clear password fields
    document.getElementById('currentPassword').value = '';
    document.getElementById('newPassword').value = '';
    document.getElementById('confirmPassword').value = '';
    
    showNotification('Password changed successfully!', 'success');
}

function deleteAccount() {
    if (!confirm('Are you sure you want to delete your account? This action cannot be undone.')) {
        return;
    }
    
    if (!confirm('This will permanently delete all your data. Type "DELETE" to confirm.')) {
        return;
    }
    
    // In a real app, this would make an API call to delete the account
    logAudit('account_deletion_request', {
        user_id: currentUser.id,
        timestamp: new Date().toISOString()
    });
    
    showNotification('Account deletion request submitted. Please contact support.', 'info');
    closeModal('accountModal');
}

// ========================================
// CLIENT IMPORT FUNCTIONS
// ========================================

let importFileData = null;

function handleImportFileSelected() {
    const fileInput = document.getElementById('clientImportFile');
    const file = fileInput.files[0];

    if (!file) {
        document.getElementById('importPreview').style.display = 'none';
        return;
    }

    const fileName = file.name;
    const fileExtension = fileName.split('.').pop().toLowerCase();

    if (fileExtension !== 'csv' && fileExtension !== 'xlsx' && fileExtension !== 'pdf') {
        showNotification('Please select a CSV, Excel, or PDF file', 'error');
        fileInput.value = '';
        return;
    }

    const reader = new FileReader();

    reader.onload = function(e) {
        const content = e.target.result;

        if (fileExtension === 'csv') {
            parseCSVImport(content, fileName);
        } else if (fileExtension === 'xlsx') {
            parseExcelImport(content, fileName);
        } else if (fileExtension === 'pdf') {
            parsePDFImport(content, fileName);
        }
    };

    if (fileExtension === 'csv') {
        reader.readAsText(file);
    } else {
        reader.readAsArrayBuffer(file);
    }
}

function parseCSVImport(csvContent, fileName) {
    const lines = csvContent.split('\n').filter(line => line.trim());

    if (lines.length < 2) {
        showNotification('CSV file appears to be empty', 'error');
        return;
    }

    const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
    const rows = lines.slice(1);

    importFileData = {
        fileName: fileName,
        rowCount: rows.length,
        headers: headers,
        rows: rows.map(row => {
            const values = row.split(',').map(v => v.trim().replace(/"/g, ''));
            const obj = {};
            headers.forEach((header, index) => {
                obj[header] = values[index] || '';
            });
            return obj;
        })
    };

    displayImportPreview();
}

function parseExcelImport(arrayBuffer, fileName) {
    // For Excel files, we'll use a simple parser
    // In production, you'd use a library like SheetJS (xlsx)
    showNotification('Excel import is being processed. For now, please use CSV format for best results.', 'info');

    // Simplified Excel parsing - convert to text and parse as CSV
    const decoder = new TextDecoder('utf-8');
    const text = decoder.decode(arrayBuffer);
    parseCSVImport(text, fileName);
}

async function parsePDFImport(arrayBuffer, fileName) {
    try {
        showNotification('Processing PDF file...', 'info');

        // Load the PDF document
        const loadingTask = pdfjsLib.getDocument({data: arrayBuffer});
        const pdf = await loadingTask.promise;

        // Extract text from all pages
        let fullText = '';
        for (let i = 1; i <= pdf.numPages; i++) {
            const page = await pdf.getPage(i);
            const textContent = await page.getTextContent();
            const pageText = textContent.items.map(item => item.str).join(' ');
            fullText += pageText + '\n';
        }

        // Parse the extracted text
        const lines = fullText.split('\n').filter(line => line.trim());

        if (lines.length < 2) {
            showNotification('PDF appears to be empty or contains no readable text', 'error');
            return;
        }

        // Try to detect if this is a tabular format
        // Look for common headers
        const possibleHeaderLine = lines.findIndex(line => {
            const lowerLine = line.toLowerCase();
            return (lowerLine.includes('name') || lowerLine.includes('email') ||
                    lowerLine.includes('phone') || lowerLine.includes('client'));
        });

        let headers = [];
        let dataLines = [];

        if (possibleHeaderLine !== -1) {
            // Found a header line - try to parse as tabular data
            const headerLine = lines[possibleHeaderLine];

            // Try to split by common delimiters (tabs, multiple spaces, pipes)
            if (headerLine.includes('\t')) {
                headers = headerLine.split('\t').map(h => h.trim()).filter(h => h);
            } else if (headerLine.includes('|')) {
                headers = headerLine.split('|').map(h => h.trim()).filter(h => h);
            } else if (headerLine.match(/\s{2,}/)) {
                headers = headerLine.split(/\s{2,}/).map(h => h.trim()).filter(h => h);
            } else {
                // Fallback: try to identify column positions by looking for words
                headers = headerLine.match(/[A-Za-z][\w\s]*(?=[A-Z]|$)/g) || [headerLine];
                headers = headers.map(h => h.trim()).filter(h => h);
            }

            // Get data lines after the header
            dataLines = lines.slice(possibleHeaderLine + 1);
        } else {
            // No clear header found - try to extract structured data
            // Look for patterns like "Name: John Doe", "Email: john@example.com"
            const clientData = [];
            let currentClient = {};

            for (const line of lines) {
                // Match patterns like "Field: Value" or "Field Value"
                const colonMatch = line.match(/^([A-Za-z\s]+):\s*(.+)$/);
                const labelMatch = line.match(/^([A-Za-z\s]+)\s{2,}(.+)$/);

                if (colonMatch) {
                    const [, field, value] = colonMatch;
                    const fieldName = field.trim();
                    currentClient[fieldName] = value.trim();

                    // If we see a name field, it might be a new client
                    if (fieldName.toLowerCase().includes('name') && Object.keys(currentClient).length > 1) {
                        clientData.push({...currentClient});
                        currentClient = {[fieldName]: value.trim()};
                    }
                } else if (labelMatch) {
                    const [, field, value] = labelMatch;
                    currentClient[field.trim()] = value.trim();
                }
            }

            // Add the last client if any
            if (Object.keys(currentClient).length > 0) {
                clientData.push(currentClient);
            }

            // Convert to headers and rows format
            if (clientData.length > 0) {
                headers = Object.keys(clientData[0]);
                importFileData = {
                    fileName: fileName,
                    rowCount: clientData.length,
                    headers: headers,
                    rows: clientData
                };
                displayImportPreview();
                return;
            }

            // Last resort: try CSV parsing on the text
            parseCSVImport(fullText, fileName);
            return;
        }

        // Parse data lines using the same delimiter detection as headers
        const rows = dataLines.map(line => {
            let values = [];

            if (line.includes('\t')) {
                values = line.split('\t').map(v => v.trim());
            } else if (line.includes('|')) {
                values = line.split('|').map(v => v.trim());
            } else if (line.match(/\s{2,}/)) {
                values = line.split(/\s{2,}/).map(v => v.trim());
            } else {
                // Try to match the header positions
                values = line.match(/[^\s]+(?:\s+[^\s]+)*/g) || [line];
                values = values.map(v => v.trim());
            }

            // Create object mapping headers to values
            const obj = {};
            headers.forEach((header, index) => {
                obj[header] = values[index] || '';
            });
            return obj;
        }).filter(row => {
            // Filter out empty rows or rows that are likely table separators
            const hasData = Object.values(row).some(val => val && val.length > 0 && !val.match(/^[-_=]+$/));
            return hasData;
        });

        if (rows.length === 0) {
            showNotification('Could not extract client data from PDF. Please ensure the PDF contains structured data.', 'error');
            return;
        }

        importFileData = {
            fileName: fileName,
            rowCount: rows.length,
            headers: headers,
            rows: rows
        };

        displayImportPreview();

    } catch (error) {
        console.error('PDF parsing error:', error);
        showNotification('Error parsing PDF file: ' + error.message, 'error');
    }
}

function displayImportPreview() {
    if (!importFileData) return;

    document.getElementById('importFileName').textContent = `File: ${importFileData.fileName}`;
    document.getElementById('importStats').textContent = `Found ${importFileData.rowCount} clients to import`;
    document.getElementById('importPreview').style.display = 'block';
}

async function processClientImport() {
    if (!importFileData || !importFileData.rows || importFileData.rows.length === 0) {
        showNotification('No data to import', 'error');
        return;
    }

    document.getElementById('importProgress').style.display = 'block';
    document.getElementById('importPreview').style.display = 'none';

    const totalRows = importFileData.rows.length;
    let successCount = 0;
    let errorCount = 0;

    for (let i = 0; i < totalRows; i++) {
        const row = importFileData.rows[i];
        const progress = ((i + 1) / totalRows) * 100;

        document.getElementById('importProgressBar').style.width = progress + '%';
        document.getElementById('importProgressText').textContent = `Importing ${i + 1} of ${totalRows}...`;

        try {
            // Map CSV columns to client data structure
            const clientData = mapImportDataToClient(row);

            // Create client via API
            const response = await fetch('/api/clients', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(clientData)
            });

            if (response.ok) {
                successCount++;
            } else {
                errorCount++;
                console.error(`Failed to import client at row ${i + 1}:`, row);
            }
        } catch (error) {
            errorCount++;
            console.error(`Error importing client at row ${i + 1}:`, error);
        }

        // Small delay to prevent overwhelming the server
        await new Promise(resolve => setTimeout(resolve, 100));
    }

    document.getElementById('importProgressBar').style.width = '100%';
    document.getElementById('importProgressText').textContent = `Import complete! ${successCount} successful, ${errorCount} failed`;

    showNotification(`Import complete! ${successCount} clients imported successfully.`, 'success');

    // Reset after 3 seconds
    setTimeout(() => {
        document.getElementById('importProgress').style.display = 'none';
        document.getElementById('clientImportFile').value = '';
        importFileData = null;

        // Reload clients if on clients page
        if (typeof loadClients === 'function') {
            loadClients();
        }
    }, 3000);

    logAudit('client_import', {
        user_id: currentUser.id,
        total: totalRows,
        success: successCount,
        failed: errorCount
    });
}

function mapImportDataToClient(row) {
    // Map common EHR column names to Sessionably client structure
    // This handles various naming conventions from different EHR systems

    const getField = (possibleNames) => {
        for (const name of possibleNames) {
            if (row[name]) return row[name];
        }
        return '';
    };

    return {
        first_name: getField(['First Name', 'FirstName', 'first_name', 'fname', 'given_name']),
        last_name: getField(['Last Name', 'LastName', 'last_name', 'lname', 'surname', 'family_name']),
        email: getField(['Email', 'email', 'Email Address', 'email_address']),
        phone: getField(['Phone', 'phone', 'Phone Number', 'phone_number', 'mobile', 'cell']),
        date_of_birth: getField(['Date of Birth', 'DOB', 'dob', 'date_of_birth', 'birthdate', 'birth_date']),
        address: getField(['Address', 'address', 'street', 'Street Address', 'street_address']),
        city: getField(['City', 'city']),
        state: getField(['State', 'state', 'province']),
        zip_code: getField(['Zip', 'zip', 'Zip Code', 'zip_code', 'postal_code', 'postcode']),
        insurance_provider: getField(['Insurance Provider', 'insurance_provider', 'Insurance', 'insurance', 'payer']),
        insurance_id: getField(['Insurance ID', 'insurance_id', 'Member ID', 'member_id', 'policy_number']),
        emergency_contact_name: getField(['Emergency Contact', 'emergency_contact', 'emergency_contact_name', 'emergency_name']),
        emergency_contact_phone: getField(['Emergency Phone', 'emergency_phone', 'emergency_contact_phone']),
        notes: getField(['Notes', 'notes', 'Comments', 'comments', 'remarks']),
        status: 'active'
    };
}

// ========================================
// TREATMENT PLAN FUNCTIONS
// ========================================

let currentTreatmentPlanId = null;
let clientTreatmentPlans = [];

// Open new treatment plan modal
function openNewTreatmentPlan() {
    if (!currentChartClient) {
        showNotification('Please select a client first', 'error');
        return;
    }

    // Reset form
    document.getElementById('treatmentPlanId').value = '';
    document.getElementById('treatmentPlanClientId').value = currentChartClient.id;
    document.getElementById('treatmentPlanModalTitle').textContent = 'New Treatment Plan';
    document.getElementById('treatmentPlanDate').value = new Date().toISOString().split('T')[0];
    document.getElementById('treatmentPlanReviewDate').value = '';
    document.getElementById('treatmentPlanDiagnoses').value = '';
    document.getElementById('treatmentPlanProblems').value = '';
    document.getElementById('treatmentPlanGoals').value = '';
    document.getElementById('treatmentPlanObjectiveData').value = '';
    document.getElementById('treatmentPlanFrequency').value = '';
    document.getElementById('treatmentPlanStatus').value = 'active';

    // Hide signature info
    document.getElementById('treatmentPlanSignedInfo').style.display = 'none';
    document.getElementById('signTreatmentPlanBtn').style.display = 'none';

    // Show save button
    document.getElementById('saveTreatmentPlanBtn').style.display = 'inline-block';

    openModal('treatmentPlanModal');
}

// Save treatment plan
async function saveTreatmentPlan() {
    const planId = document.getElementById('treatmentPlanId').value;
    const clientId = document.getElementById('treatmentPlanClientId').value;
    const diagnoses = document.getElementById('treatmentPlanDiagnoses').value.trim();
    const problems = document.getElementById('treatmentPlanProblems').value.trim();
    const goals = document.getElementById('treatmentPlanGoals').value.trim();
    const objectiveData = document.getElementById('treatmentPlanObjectiveData').value.trim();
    const frequency = document.getElementById('treatmentPlanFrequency').value.trim();
    const planDate = document.getElementById('treatmentPlanDate').value;
    const reviewDate = document.getElementById('treatmentPlanReviewDate').value;
    const status = document.getElementById('treatmentPlanStatus').value;

    // Validation
    if (!diagnoses || !problems || !goals || !frequency) {
        showNotification('Please fill in all required fields', 'error');
        return;
    }

    const treatmentPlan = {
        client_id: parseInt(clientId),
        diagnoses,
        presenting_problems: problems,
        goals,
        objective_data: objectiveData,
        treatment_frequency: frequency,
        plan_date: planDate,
        review_date: reviewDate || null,
        status,
        user_id: currentUser?.id || 1
    };

    try {
        let response;
        if (planId) {
            // Update existing plan
            treatmentPlan.id = parseInt(planId);
            response = await fetch(`${API_URL}/api/treatment-plans`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(treatmentPlan)
            });
        } else {
            // Create new plan
            response = await fetch(`${API_URL}/api/treatment-plans`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(treatmentPlan)
            });
        }

        const result = await response.json();

        if (result.success) {
            showNotification(planId ? 'Treatment plan updated successfully' : 'Treatment plan created successfully', 'success');
            closeModal('treatmentPlanModal');

            // Show sign button if it's a new save
            if (result.data?.id) {
                document.getElementById('treatmentPlanId').value = result.data.id;
                document.getElementById('signTreatmentPlanBtn').style.display = 'inline-block';
            }

            // Refresh list
            renderClientTreatmentPlans();
        } else {
            showNotification(result.error || 'Failed to save treatment plan', 'error');
        }
    } catch (error) {
        console.error('Error saving treatment plan:', error);
        showNotification('Failed to save treatment plan', 'error');
    }
}

// Render client treatment plans
async function renderClientTreatmentPlans() {
    if (!currentChartClient) return;

    const container = document.getElementById('chartTreatmentPlansContent');
    container.innerHTML = '<p>Loading treatment plans...</p>';

    try {
        const response = await fetch(`${API_URL}/api/treatment-plans?client_id=${currentChartClient.id}`);
        const result = await response.json();

        if (result.success && result.data) {
            clientTreatmentPlans = result.data;

            if (clientTreatmentPlans.length === 0) {
                container.innerHTML = '<p style="color: #666;">No treatment plans yet. Click "New Treatment Plan" to create one.</p>';
                return;
            }

            let html = '<div style="display: grid; gap: 16px;">';

            clientTreatmentPlans.forEach(plan => {
                const planDate = new Date(plan.plan_date).toLocaleDateString();
                const signedBadge = plan.is_signed ? '<span style="background: #4caf50; color: white; padding: 4px 12px; border-radius: 12px; font-size: 12px; margin-left: 10px;">Signed</span>' : '';
                const statusColor = plan.status === 'active' ? '#4caf50' : plan.status === 'completed' ? '#2196f3' : '#9e9e9e';

                html += `
                    <div class="card" style="padding: 20px; cursor: pointer;" onclick="viewTreatmentPlan(${plan.id})">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                            <div>
                                <h4 style="margin: 0 0 8px 0;">Treatment Plan - ${planDate}${signedBadge}</h4>
                                <div style="font-size: 13px; color: #666;">
                                    <span style="background: ${statusColor}; color: white; padding: 2px 8px; border-radius: 10px; font-size: 11px; text-transform: uppercase;">${plan.status}</span>
                                    ${plan.review_date ? `<span style="margin-left: 10px;">Review: ${new Date(plan.review_date).toLocaleDateString()}</span>` : ''}
                                </div>
                            </div>
                        </div>
                        <p style="margin: 8px 0; color: #333; font-weight: 500;">Frequency: ${plan.treatment_frequency}</p>
                        <p style="margin: 0; color: #666; font-size: 14px;">Created by: ${plan.created_by_name || 'Unknown'}</p>
                        ${plan.signed_at ? `<p style="margin: 4px 0 0 0; color: #4caf50; font-size: 13px;">Signed by ${plan.signed_by_name} on ${new Date(plan.signed_at).toLocaleString()}</p>` : ''}
                    </div>
                `;
            });

            html += '</div>';
            container.innerHTML = html;
        } else {
            container.innerHTML = '<p style="color: #e74c3c;">Failed to load treatment plans</p>';
        }
    } catch (error) {
        console.error('Error loading treatment plans:', error);
        container.innerHTML = '<p style="color: #e74c3c;">Error loading treatment plans</p>';
    }
}

// View treatment plan
async function viewTreatmentPlan(planId) {
    try {
        const response = await fetch(`${API_URL}/api/treatment-plans?id=${planId}&user_id=${currentUser?.id || 1}`);
        const result = await response.json();

        if (result.success && result.data) {
            const plan = result.data;
            currentTreatmentPlanId = planId;

            // Populate view modal
            document.getElementById('viewPlanClient').textContent = plan.client_name || 'Unknown';
            document.getElementById('viewPlanDate').textContent = new Date(plan.plan_date).toLocaleDateString();
            document.getElementById('viewPlanReviewDate').textContent = plan.review_date ? new Date(plan.review_date).toLocaleDateString() : 'Not set';
            document.getElementById('viewPlanStatus').textContent = plan.status.charAt(0).toUpperCase() + plan.status.slice(1);
            document.getElementById('viewPlanCreatedBy').textContent = plan.created_by_name || 'Unknown';
            document.getElementById('viewPlanDiagnoses').textContent = plan.diagnoses;
            document.getElementById('viewPlanProblems').textContent = plan.presenting_problems;
            document.getElementById('viewPlanGoals').textContent = plan.goals;
            document.getElementById('viewPlanObjectiveData').textContent = plan.objective_data || 'None recorded';
            document.getElementById('viewPlanFrequency').textContent = plan.treatment_frequency;

            // Get clinical settings
            const clinicalSettings = loadFromStorage('clinicalSettings', {
                treatmentPlanReview: {
                    allowUnlockForReview: true
                }
            });

            // Show/hide signature info
            if (plan.is_signed) {
                document.getElementById('viewPlanSignedInfo').style.display = 'block';
                document.getElementById('viewPlanSignedBy').textContent = plan.signed_by_name || 'Unknown';
                document.getElementById('viewPlanSignedAt').textContent = new Date(plan.signed_at).toLocaleString();

                // Hide edit/delete/sign/unlock buttons for signed plans
                document.getElementById('editTreatmentPlanBtn').style.display = 'none';
                document.getElementById('signViewPlanBtn').style.display = 'none';
                document.getElementById('deleteTreatmentPlanBtn').style.display = 'none';
                document.getElementById('unlockTreatmentPlanBtn').style.display = 'none';
            } else if (plan.is_locked) {
                // Plan is locked but not signed - show unlock button if allowed
                document.getElementById('viewPlanSignedInfo').style.display = 'none';
                document.getElementById('editTreatmentPlanBtn').style.display = 'none';
                document.getElementById('signViewPlanBtn').style.display = 'none';
                document.getElementById('deleteTreatmentPlanBtn').style.display = 'none';

                // Show unlock button only if settings allow it
                if (clinicalSettings.treatmentPlanReview.allowUnlockForReview) {
                    document.getElementById('unlockTreatmentPlanBtn').style.display = 'inline-block';
                } else {
                    document.getElementById('unlockTreatmentPlanBtn').style.display = 'none';
                }
            } else {
                // Plan is neither signed nor locked - show normal buttons
                document.getElementById('viewPlanSignedInfo').style.display = 'none';
                document.getElementById('editTreatmentPlanBtn').style.display = 'inline-block';
                document.getElementById('signViewPlanBtn').style.display = 'inline-block';
                document.getElementById('deleteTreatmentPlanBtn').style.display = 'inline-block';
                document.getElementById('unlockTreatmentPlanBtn').style.display = 'none';
            }

            openModal('viewTreatmentPlanModal');
        } else {
            showNotification('Failed to load treatment plan', 'error');
        }
    } catch (error) {
        console.error('Error loading treatment plan:', error);
        showNotification('Error loading treatment plan', 'error');
    }
}

// Edit treatment plan
async function editTreatmentPlan() {
    if (!currentTreatmentPlanId) return;

    try {
        const response = await fetch(`${API_URL}/api/treatment-plans?id=${currentTreatmentPlanId}`);
        const result = await response.json();

        if (result.success && result.data) {
            const plan = result.data;

            // Check if signed or locked
            if (plan.is_signed || plan.is_locked) {
                showNotification('Cannot edit signed or locked treatment plans', 'error');
                return;
            }

            // Populate edit modal
            document.getElementById('treatmentPlanId').value = plan.id;
            document.getElementById('treatmentPlanClientId').value = plan.client_id;
            document.getElementById('treatmentPlanModalTitle').textContent = 'Edit Treatment Plan';
            document.getElementById('treatmentPlanDate').value = plan.plan_date.split('T')[0];
            document.getElementById('treatmentPlanReviewDate').value = plan.review_date ? plan.review_date.split('T')[0] : '';
            document.getElementById('treatmentPlanDiagnoses').value = plan.diagnoses;
            document.getElementById('treatmentPlanProblems').value = plan.presenting_problems;
            document.getElementById('treatmentPlanGoals').value = plan.goals;
            document.getElementById('treatmentPlanObjectiveData').value = plan.objective_data || '';
            document.getElementById('treatmentPlanFrequency').value = plan.treatment_frequency;
            document.getElementById('treatmentPlanStatus').value = plan.status;

            // Show sign button for existing plans
            document.getElementById('signTreatmentPlanBtn').style.display = 'inline-block';
            document.getElementById('saveTreatmentPlanBtn').style.display = 'inline-block';

            closeModal('viewTreatmentPlanModal');
            openModal('treatmentPlanModal');
        } else {
            showNotification('Failed to load treatment plan for editing', 'error');
        }
    } catch (error) {
        console.error('Error loading treatment plan:', error);
        showNotification('Error loading treatment plan', 'error');
    }
}

// Delete treatment plan
async function deleteTreatmentPlan() {
    if (!currentTreatmentPlanId) return;

    if (!confirm('Are you sure you want to delete this treatment plan? This action cannot be undone.')) {
        return;
    }

    try {
        const response = await fetch(`${API_URL}/api/treatment-plans?id=${currentTreatmentPlanId}&user_id=${currentUser?.id || 1}`, {
            method: 'DELETE'
        });

        const result = await response.json();

        if (result.success) {
            showNotification('Treatment plan deleted successfully', 'success');
            closeModal('viewTreatmentPlanModal');
            renderClientTreatmentPlans();
        } else {
            showNotification(result.error || 'Failed to delete treatment plan', 'error');
        }
    } catch (error) {
        console.error('Error deleting treatment plan:', error);
        showNotification('Error deleting treatment plan', 'error');
    }
}

// Unlock treatment plan for review
async function unlockTreatmentPlan() {
    if (!currentTreatmentPlanId) return;

    // Check if settings allow unlocking
    const clinicalSettings = loadFromStorage('clinicalSettings', {
        treatmentPlanReview: {
            allowUnlockForReview: true
        }
    });

    if (!clinicalSettings.treatmentPlanReview.allowUnlockForReview) {
        showNotification('Treatment plan unlocking is disabled in clinical settings', 'error');
        return;
    }

    const confirmed = confirm('Unlock this treatment plan for review?\n\nThis action will be logged in the audit trail and should only be done for legitimate review purposes.');

    if (!confirmed) return;

    try {
        const response = await fetch(`${API_URL}/api/treatment-plans-sign`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                plan_id: currentTreatmentPlanId,
                user_id: currentUser?.id || 1,
                action: 'unlock'
            })
        });

        const result = await response.json();

        if (result.success) {
            showNotification('Treatment plan unlocked successfully for review', 'success');
            closeModal('viewTreatmentPlanModal');
            renderClientTreatmentPlans();

            // Log the unlock action
            logAuditEvent('treatment_plan_unlocked', `Treatment plan #${currentTreatmentPlanId} unlocked for review`);
        } else {
            showNotification(result.error || 'Failed to unlock treatment plan', 'error');
        }
    } catch (error) {
        console.error('Error unlocking treatment plan:', error);
        showNotification('Error unlocking treatment plan', 'error');
    }
}

// Sign treatment plan (from edit modal)
function signTreatmentPlan() {
    const planId = document.getElementById('treatmentPlanId').value;
    if (!planId) {
        showNotification('Please save the treatment plan first', 'error');
        return;
    }
    currentTreatmentPlanId = parseInt(planId);
    openModal('treatmentPlanSignatureModal');
}

// Sign treatment plan (from view modal)
function signViewedTreatmentPlan() {
    if (!currentTreatmentPlanId) return;
    openModal('treatmentPlanSignatureModal');
}

// Toggle plan signature input
function togglePlanSignatureInput() {
    const method = document.getElementById('planSignatureMethod').value;
    if (method === 'typed') {
        document.getElementById('planTypedSignatureSection').style.display = 'block';
        document.getElementById('planDrawnSignatureSection').style.display = 'none';
    } else {
        document.getElementById('planTypedSignatureSection').style.display = 'none';
        document.getElementById('planDrawnSignatureSection').style.display = 'block';
        initPlanSignatureCanvas();
    }
}

// Initialize plan signature canvas
let planSignatureCanvas, planSignatureContext, planIsDrawing = false;
function initPlanSignatureCanvas() {
    planSignatureCanvas = document.getElementById('planSignatureCanvas');
    if (!planSignatureCanvas) return;

    planSignatureContext = planSignatureCanvas.getContext('2d');
    planSignatureCanvas.width = planSignatureCanvas.offsetWidth;
    planSignatureCanvas.height = 150;

    planSignatureCanvas.addEventListener('mousedown', startPlanDrawing);
    planSignatureCanvas.addEventListener('mousemove', drawPlanSignature);
    planSignatureCanvas.addEventListener('mouseup', stopPlanDrawing);
    planSignatureCanvas.addEventListener('mouseout', stopPlanDrawing);

    // Touch events
    planSignatureCanvas.addEventListener('touchstart', (e) => {
        e.preventDefault();
        const touch = e.touches[0];
        const mouseEvent = new MouseEvent('mousedown', {
            clientX: touch.clientX,
            clientY: touch.clientY
        });
        planSignatureCanvas.dispatchEvent(mouseEvent);
    });

    planSignatureCanvas.addEventListener('touchmove', (e) => {
        e.preventDefault();
        const touch = e.touches[0];
        const mouseEvent = new MouseEvent('mousemove', {
            clientX: touch.clientX,
            clientY: touch.clientY
        });
        planSignatureCanvas.dispatchEvent(mouseEvent);
    });

    planSignatureCanvas.addEventListener('touchend', (e) => {
        e.preventDefault();
        const mouseEvent = new MouseEvent('mouseup', {});
        planSignatureCanvas.dispatchEvent(mouseEvent);
    });
}

function startPlanDrawing(e) {
    planIsDrawing = true;
    const rect = planSignatureCanvas.getBoundingClientRect();
    planSignatureContext.beginPath();
    planSignatureContext.moveTo(e.clientX - rect.left, e.clientY - rect.top);
}

function drawPlanSignature(e) {
    if (!planIsDrawing) return;
    const rect = planSignatureCanvas.getBoundingClientRect();
    planSignatureContext.lineTo(e.clientX - rect.left, e.clientY - rect.top);
    planSignatureContext.strokeStyle = '#000';
    planSignatureContext.lineWidth = 2;
    planSignatureContext.lineCap = 'round';
    planSignatureContext.stroke();
}

function stopPlanDrawing() {
    planIsDrawing = false;
}

function clearPlanSignature() {
    if (!planSignatureContext) return;
    planSignatureContext.clearRect(0, 0, planSignatureCanvas.width, planSignatureCanvas.height);
}

// Preview typed signature
document.addEventListener('DOMContentLoaded', function() {
    const typedInput = document.getElementById('planTypedSignature');
    if (typedInput) {
        typedInput.addEventListener('input', function() {
            document.getElementById('planTypedSignaturePreview').textContent = this.value || 'Signature will appear here...';
        });
    }
});

// Confirm sign treatment plan
async function confirmSignTreatmentPlan() {
    if (!currentTreatmentPlanId) {
        showNotification('No treatment plan selected', 'error');
        return;
    }

    // Check confirmation
    if (!document.getElementById('planSignatureConfirm').checked) {
        showNotification('Please confirm that the treatment plan is accurate and complete', 'error');
        return;
    }

    // Get signature data
    const method = document.getElementById('planSignatureMethod').value;
    let signatureData = null;

    if (method === 'typed') {
        const typedSig = document.getElementById('planTypedSignature').value.trim();
        if (!typedSig) {
            showNotification('Please type your signature', 'error');
            return;
        }
        signatureData = `typed:${typedSig}`;
    } else {
        if (!planSignatureCanvas) {
            showNotification('Signature canvas not initialized', 'error');
            return;
        }
        signatureData = `drawn:${planSignatureCanvas.toDataURL()}`;
    }

    try {
        const response = await fetch(`${API_URL}/api/treatment-plans-sign`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                plan_id: currentTreatmentPlanId,
                user_id: currentUser?.id || 1,
                signature_data: signatureData,
                action: 'sign'
            })
        });

        const result = await response.json();

        if (result.success) {
            showNotification('Treatment plan signed and locked successfully', 'success');
            closeModal('treatmentPlanSignatureModal');
            closeModal('treatmentPlanModal');
            closeModal('viewTreatmentPlanModal');
            renderClientTreatmentPlans();
        } else {
            showNotification(result.error || 'Failed to sign treatment plan', 'error');
        }
    } catch (error) {
        console.error('Error signing treatment plan:', error);
        showNotification('Error signing treatment plan', 'error');
    }
}

// Download treatment plan
function downloadTreatmentPlan() {
    if (!currentTreatmentPlanId) return;

    // Get plan data from view modal
    const clientName = document.getElementById('viewPlanClient').textContent;
    const planDate = document.getElementById('viewPlanDate').textContent;
    const reviewDate = document.getElementById('viewPlanReviewDate').textContent;
    const status = document.getElementById('viewPlanStatus').textContent;
    const diagnoses = document.getElementById('viewPlanDiagnoses').textContent;
    const problems = document.getElementById('viewPlanProblems').textContent;
    const goals = document.getElementById('viewPlanGoals').textContent;
    const objectiveData = document.getElementById('viewPlanObjectiveData').textContent;
    const frequency = document.getElementById('viewPlanFrequency').textContent;
    const createdBy = document.getElementById('viewPlanCreatedBy').textContent;

    let signatureInfo = '';
    if (document.getElementById('viewPlanSignedInfo').style.display !== 'none') {
        const signedBy = document.getElementById('viewPlanSignedBy').textContent;
        const signedAt = document.getElementById('viewPlanSignedAt').textContent;
        signatureInfo = `\n\nSIGNED BY: ${signedBy}\nSIGNED AT: ${signedAt}`;
    }

    const content = `CLINICAL TREATMENT PLAN

CLIENT: ${clientName}
PLAN DATE: ${planDate}
REVIEW DATE: ${reviewDate}
STATUS: ${status}
CREATED BY: ${createdBy}



DIAGNOSES:
${diagnoses}

PRESENTING PROBLEMS:
${problems}

TREATMENT GOALS:
${goals}

OBJECTIVE DATA / CLINICAL OBSERVATIONS:
${objectiveData}

TREATMENT FREQUENCY:
${frequency}${signatureInfo}


Generated by Sessionably
${new Date().toLocaleString()}
`;

    // Create download
    const blob = new Blob([content], { type: 'text/plain' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `TreatmentPlan_${clientName.replace(/\s+/g, '_')}_${planDate.replace(/\//g, '-')}.txt`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);

    showNotification('Treatment plan downloaded', 'success');
}

</script>

<!-- User Management Modals -->
<!-- Profile Modal -->
<div id="profileModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeModal('profileModal')">&times;</span>
        <h2>Edit Profile</h2>
        <form id="profileForm">
            <div class="form-group">
                <label>Full Name</label>
                <input type="text" id="profileName" class="input" required>
            </div>
            <div class="form-group">
                <label>Email</label>
                <input type="email" id="profileEmail" class="input" required>
            </div>
            <div class="form-group">
                <label>Phone</label>
                <input type="tel" id="profilePhone" class="input">
            </div>
            <div class="form-group">
                <label>Title</label>
                <input type="text" id="profileTitle" class="input" placeholder="e.g., Licensed Therapist">
            </div>
            <div class="form-group">
                <label>License Number</label>
                <input type="text" id="profileLicense" class="input">
            </div>
            <div class="form-group">
                <label>Bio</label>
                <textarea id="profileBio" class="input" rows="4" placeholder="Tell us about yourself..."></textarea>
            </div>
            <div class="modal-actions">
                <button type="button" onclick="closeModal('profileModal')" class="btn btn-secondary">Cancel</button>
                <button type="button" onclick="saveProfile()" class="btn btn-primary">Save Changes</button>
            </div>
        </form>
    </div>
</div>

<!-- Settings Modal -->
<div id="settingsModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeModal('settingsModal')">&times;</span>
        <h2>Settings</h2>
        <form id="settingsForm">
            <div class="settings-section">
                <h3>Notifications</h3>
                <div class="form-group">
                    <label class="checkbox-label">
                        <input type="checkbox" id="emailNotifications">
                        <span>Email Notifications</span>
                    </label>
                </div>
                <div class="form-group">
                    <label class="checkbox-label">
                        <input type="checkbox" id="appointmentReminders">
                        <span>Appointment Reminders</span>
                    </label>
                </div>
                <div class="form-group">
                    <label class="checkbox-label">
                        <input type="checkbox" id="documentAlerts">
                        <span>Document Alerts</span>
                    </label>
                </div>
                <div class="form-group">
                    <label class="checkbox-label">
                        <input type="checkbox" id="invoiceAlerts">
                        <span>Invoice Alerts</span>
                    </label>
                </div>
            </div>
            
            <div class="settings-section">
                <h3>Preferences</h3>
                <div class="form-group">
                    <label>Theme</label>
                    <select id="themePreference" class="input">
                        <option value="light">Light</option>
                        <option value="dark">Dark</option>
                        <option value="auto">Auto</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Language</label>
                    <select id="languagePreference" class="input">
                        <option value="en">English</option>
                        <option value="es">Espaol</option>
                        <option value="fr">Franais</option>
                    </select>
                </div>
            </div>

            <div class="settings-section">
                <h3>Data Import</h3>
                <p style="color: #666; font-size: 14px; margin-bottom: 15px;">
                    Import your existing clients and information from another EHR platform. Supported formats: CSV, Excel (.xlsx), PDF
                </p>
                <div class="form-group">
                    <label>Select File</label>
                    <input type="file" id="clientImportFile" class="input" accept=".csv,.xlsx,.pdf" onchange="handleImportFileSelected()">
                </div>
                <div id="importPreview" style="display: none; margin-top: 15px; padding: 15px; background: #f5f5f5; border-radius: 8px;">
                    <h4 style="margin-top: 0;">Import Preview</h4>
                    <p id="importFileName" style="margin: 5px 0; font-weight: bold;"></p>
                    <p id="importStats" style="margin: 5px 0; color: #666;"></p>
                    <button type="button" onclick="processClientImport()" class="btn btn-primary" style="margin-top: 10px;">
                        Import Clients
                    </button>
                </div>
                <div id="importProgress" style="display: none; margin-top: 15px;">
                    <div style="background: #e0e0e0; height: 30px; border-radius: 15px; overflow: hidden;">
                        <div id="importProgressBar" style="background: linear-gradient(135deg, #00B4A6, #00D4C4); height: 100%; width: 0%; transition: width 0.3s;"></div>
                    </div>
                    <p id="importProgressText" style="text-align: center; margin-top: 10px; font-weight: bold;"></p>
                </div>
            </div>

            <div class="modal-actions">
                <button type="button" onclick="closeModal('settingsModal')" class="btn btn-secondary">Cancel</button>
                <button type="button" onclick="saveSettings()" class="btn btn-primary">Save Settings</button>
            </div>
        </form>
    </div>
</div>

<!-- Account Modal -->
<div id="accountModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeModal('accountModal')">&times;</span>
        <h2>Account Management</h2>
        
        <div class="account-section">
            <h3>Account Information</h3>
            <div class="form-group">
                <label>Email</label>
                <input type="email" id="accountEmail" class="input" readonly>
            </div>
            <div class="form-group">
                <label>Username</label>
                <input type="text" id="accountUsername" class="input" readonly>
            </div>
        </div>
        
        <div class="account-section">
            <h3>Change Password</h3>
            <div class="form-group">
                <label>Current Password</label>
                <input type="password" id="currentPassword" class="input">
            </div>
            <div class="form-group">
                <label>New Password</label>
                <input type="password" id="newPassword" class="input" placeholder="Minimum 8 characters">
            </div>
            <div class="form-group">
                <label>Confirm New Password</label>
                <input type="password" id="confirmPassword" class="input">
            </div>
            <button type="button" onclick="changePassword()" class="btn btn-primary">Change Password</button>
        </div>
        
        <div class="account-section danger-zone">
            <h3>Danger Zone</h3>
            <p style="color: var(--text-secondary); margin-bottom: 16px;">Permanently delete your account and all associated data.</p>
            <button type="button" onclick="deleteAccount()" class="btn btn-danger">Delete Account</button>
        </div>
    </div>
</div>

<style>
.form-group {
    margin-bottom: 16px;
}

.form-group label {
    display: block;
    margin-bottom: 6px;
    font-weight: 500;
    color: var(--text-primary);
}

.checkbox-label {
    display: flex;
    align-items: center;
    gap: 8px;
    cursor: pointer;
}

.checkbox-label input[type="checkbox"] {
    width: auto;
    cursor: pointer;
}

.settings-section {
    margin-bottom: 24px;
    padding-bottom: 24px;
    border-bottom: 1px solid var(--border-color);
}

.settings-section:last-child {
    border-bottom: none;
}

.settings-section h3 {
    margin-bottom: 16px;
    color: var(--primary-color);
    font-size: 16px;
}

.account-section {
    margin-bottom: 32px;
    padding-bottom: 24px;
    border-bottom: 1px solid var(--border-color);
}

.account-section:last-child {
    border-bottom: none;
}

.account-section h3 {
    margin-bottom: 16px;
    color: var(--primary-color);
    font-size: 16px;
}

.danger-zone {
    border: 2px solid #dc3545;
    padding: 16px;
    border-radius: 8px;
    background: #fff5f5;
}

.btn-danger {
    background: #dc3545;
    color: white;
}

.btn-danger:hover {
    background: #c82333;
}

.modal-actions {
    display: flex;
    gap: 12px;
    justify-content: flex-end;
    margin-top: 24px;
}
</style>

<!-- AI Clinical NoteTaker JavaScript -->
<script src="/js/ai-note-taker.js"></script>

<script>
// Sync transcript between visible div and hidden textarea for AI generation
(function() {
    const syncTranscript = function() {
        const transcriptDiv = document.getElementById('aiTranscript');
        const transcriptTextarea = document.getElementById('session-transcript');

        if (transcriptDiv && transcriptTextarea) {
            // Sync content from div to textarea
            transcriptTextarea.value = transcriptDiv.textContent || '';
        }
    };

    // Sync on page load
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', syncTranscript);
    } else {
        syncTranscript();
    }

    // Watch for changes to the transcript div
    const transcriptDiv = document.getElementById('aiTranscript');
    if (transcriptDiv) {
        // Use MutationObserver to detect changes
        const observer = new MutationObserver(syncTranscript);
        observer.observe(transcriptDiv, {
            childList: true,
            subtree: true,
            characterData: true
        });

        // Also sync periodically (backup)
        setInterval(syncTranscript, 1000);
    }
})();
</script>

</body>
</html>
